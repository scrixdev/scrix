<!DOCTYPE html>
<!-- 
    SCRIX - √âditeur de Code Professionnel
    Version corrig√©e ‚Äî F√©vrier 2026
    ‚úÖ Corrections : XSS (DOMPurify), rate limiting IA, try/catch Firebase,
       CSP, ARIA accessibilit√©, touch targets mobiles, linter debounce 1000ms
-->
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>SCRIX - √âditeur de Code Professionnel</title>

    <!-- ‚úÖ SEO & R√©f√©rencement -->
    <meta name="description" content="SCRIX ‚Äî √âditeur de code en ligne gratuit. Codez HTML, CSS, JavaScript et Python dans votre navigateur, sans installation.">
    <meta name="keywords" content="√©diteur code en ligne, html css javascript, coding gratuit, code playground, scrix">
    <meta name="author" content="SCRIX">
    <meta property="og:title" content="SCRIX - √âditeur de Code Professionnel">
    <meta property="og:description" content="Codez HTML, CSS, JS et Python dans votre navigateur. Gratuit, sans inscription.">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary">
    <!-- ‚úÖ S√©curit√© : Content Security Policy de base -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data: blob:;">
    <!-- ‚úÖ DOMPurify pour sanitisation XSS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js"></script>
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAYAAAD0eNT6AAARs0lEQVR4nO3WyYHj2pEFUHR7ID+0a/9N0E5+fBPUi1L9HIpJAuAbYjjHgWTiRdy4xwEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAr/+udf/9n9G4A9/nf3DwD2+H38lQDoSQGAhr4ffSUA+lEAoJmfjr0SAL0oANDIqyOvBEAfCgA0cfa4KwHQgwIADVw96koA1KcAQHF3j7kSALUpAFDYu0dcCYC6FAAoatTxVgKgJgUAChp9tJUAqEcBgGJmHWslAGpRAKCQ2UdaCYA6FAAoYtVxVgKgBgUAClh9lJUAyE8BgOR2HWMlAHJTACCx3Ud4998H7lMAIKkoxzfK7wCuUQAgoWhHN9rvAV5TACCZqMc26u8CHlMAIJHoRzb67wM+KACQRJbjmuV3QncKACSQ7ahm+73QkQIAwWU9pll/N3ShAEBg2Y9o9t8PlSkAEFSV41nl/4BqFAAIqNrRrPb/QAUKAART9VhW/b8gKwUAAql+JKv/f5CJAgBBdDmOXf5PiE4BgAC6HcVu/y9EpADAZl2PYdf/G6JQAGCj7kew+/8POykAsInj94vvAHsoALCBo/eV7wHrKQCwmGP3mO8CaykAsJAj95zvA+soALCI43aO7wRrKACwgKN2je8F8ykAMJljdo/vBnMpADCRI/Ye3w/mUQBgEsdrDN8R5lAAYAJHayzfE8ZTAGAwx2oO3xXGUgBgIEdqLt8XxlEAYBDHaQ3fGcZQAGAAR2kt3xvepwDAmxyjPXx3eI8CAG9whPby/eE+BQBucnxi8A5wjwIANzg6sXgPuE4BgIscm5i8C1yjAMAFjkxs3gfOUwDgJMclB+8E5ygAcIKjkov3gtcUAHjBMcnJu8FzCgA84Yjk5v3gZwoA/MDxqME7wmMKADzgaNTiPeFPCgB841jU5F3hKwUAPnEkavO+8EEBgP9yHHrwzvCLAgCHo9CN9wYFAByDprw73SkAtOYI9Ob96UwBoC3hz3GYA/pSAGhJ6POZeaAjBYB2hD2PmAu6UQBoRcjzjPmgEwWANoQ7Z5gTulAAaEGoc4V5oQMFgPKEOXeYG6pTAChNiPMO80NlCgBlCW9GMEdUpQBQktBmJPNERQoA5QhrZjBXVKMAUIqQZibzRSUKAGUIZ1YwZ1ShAFCCUGYl80YFCgDpCWN2MHdkpwCQmhBmJ/NHZgoAaQlfIjCHZKUAkJLQJRLzSEYKAOkIWyIyl2SjAJCKkCUy80kmCgBpCFcyMKdkoQCQglAlE/NKBgoA4QlTMjK3RKcAEJoQJTPzS2QKAGEJTyowx0SlABCS0KQS80xECgDhCEsqMtdEowAQipCkMvNNJAoAYQhHOjDnRKEAEIJQpBPzTgQKANsJQzoy9+ymALCVEKQz889OCgDbCD+wB+yjALCF0IMP9oEdFACWE3bwJ3vBagoASwk5+Jn9YCUFgGWEG7xmT1hFAWAJoQbn2RdWUACYTpjBdfaG2RQAphJicJ/9YSYFgGmEF7zPHjGLAsAUQgvGsU/MoAAwnLCC8ewVoykADCWkYB77xUgKAMMIJ5jPnjGKAsAQQgnWsW+MoADwNmEE69k73qUA8BYhBPvYP96hAHCb8IH97CF3KQDcInQgDvvIHQoAlwkbiMdecpUCwCVCBuKyn1yhAHCacIH47ClnKQCcIlQgD/vKGQoALwkTyMfe8ooCwFNCBPKyvzyjAPAj4QH52WN+ogDwkNCAOuwzjygA/EFYQD32mu8UAL4QElCX/eYzBYC/CQeoz57zmwLAcRxCATqx7xyHAsAhDKAje48C0JwQgL7sf28KQGOWH5ADfSkATVl64Dd50JMC0JBlB76TC/0oAM1YcuAn8qEXBaARyw28Iif6UACasNTAWfKiBwWgAcsMXCU36lMAirPEwF3yozYFoDDLC7xLjtSlABRlaYFR5ElNCkBBlhUYTa7UowAUY0mBWeRLLQpAIZYTmE3O1KEAFGEpgVXkTQ0KQAGWEVhN7uSnACRnCYFd5E9uCkBilg/YTQ7lpQAkZemAKORRTgpAQpYNiEYu5aMAJGPJgKjkUy4KQCKWC4hOTuWhACRhqYAs5FUOCkAClgnIRm7FpwAEZ4mArORXbApAYJYHyE6OxaUABGVpgCrkWUwKQECWBahGrsWjAARjSYCq5FssCkAglgOoTs7FoQAEYSmALuRdDApAAJYB6Ebu7acAbGYJgK7k314KwEaGH+hODu6jAGxi6AF+kYd7KAAbGHaAr+TiegrAYoYc4DH5uJYCsJDhBnhOTq6jACxiqAHOkZdrKAALGGaAa+TmfArAZIYY4B75OZcCMJHhBXiPHJ1HAZjE0AKMIU/nUAAmMKwAY8nV8RSAwQwpwBzydSwFYCDDCTCXnB1HARjEUAKsIW/HUAAGMIwAa8nd9ykAbzKEAHvI3/coAG8wfAB7yeH7FICbDB1ADPL4HgXgBsMGEItcvk4BuMiQAcQkn69RAC4wXACxyenzFICTDBVADvL6HAXgBMMEkIvcfk0BeMEQAeQkv59TAJ4wPAC5yfGfKQA/MDQANcjzxxSABwwLQC1y/U8KwDeGBKAm+f6VAvCJ4QCoTc5/UAD+y1AA9CDvf1EADsMA0I3cVwAMAUBT3fO/dQHo/vgA3XW+A20LQOdHB+BD13vQsgB0fWwAHut4F9oVgI6PDMBr3e5DqwLQ7XEBuKbTnWhTADo9KgD3dbkXLQpAl8cEYIwOd6N8AejwiACMV/1+lC4A1R8PgLkq35GyBaDyowGwTtV7UrIAVH0sAPaoeFfKFYCKjwTAftXuS6kCUO1xAIil0p0pUwAqPQoAcVW5NyUKQJXHACCHCncnfQGo8AgA5JP9/qQuANk/PgC5Zb5DaQtA5o8OQB1Z71HKApD1YwNQU8a7lK4AZPzIANSX7T6lKgDZPi4AvWS6U2kKQKaPCkBfWe5VigKQ5WMCwHHkuFvhC0CGjwgA30W/X+ELwP/9+x//s/s3AMBV0e9X+AJwHPE/IgB8luFupSgAx5HjYwJAlnuVpgAcR56PCkBPme5UqgJwHLk+LgB9ZLtP6QrAceT7yADUlvEupSwAx5HzYwNQT9Z7lLYAHEfejw5ADZnvUOoCcBy5Pz4AeWW/P+kLwHHkfwQAcqlwd0oUgOOo8RgAxFfl3pQpAMdR51EAiKnSnSlVAI6j1uMAEEe1+1KuABxHvUcCYK+Kd6VkATiOmo8FwHpV70nZAnAcdR8NgDUq35HSBeA4aj8eAPNUvx/lC8Bx1H9EAMbqcDdaFIDj6PGYALyvy71oUwCOo8+jAnBPpzvRqgAcR6/HBeC8bvehXQE4jn6PDMBzHe9CywJwHD0fG4A/db0HbQvAcfR9dAB+6XwHWheA4+j9+ACddc//9gXgOAwBQDdyXwH4m2EA6EHe/6IAfGIoAGqT8x8UgG8MB0BN8v0rBeABQwJQi1z/kwLwA8MCUIM8f0wBeMLQAOQmx3+mALxgeABykt/PKQAnGCKAXOT2awrASYYJIAd5fY4CcIGhAohNTp+nAFxkuABiks/XKAA3GDKAWOTydQrATYYNIAZ5fI8C8AZDB7CXHL5PAXiT4QPYQ/6+RwEYwBACrCV336cADGIYAdaQt2MoAAMZSoC55Ow4CsBghhNgDvk6lgIwgSEFGEuujqcATGJYAcaQp3MoABMZWoD3yNF5FIDJDC/APfJzLgVgAUMMcI3cnE8BWMQwA5wjL9dQABYy1ADPycl1FIDFDDfAY/JxLQVgA0MO8JVcXE8B2MSwA/wiD/dQADYy9EB3cnAfBWAzww90Jf/2UgACsARAN3JvPwUgCMsAdCHvYlAAArEUQHVyLg4FIBjLAVQl32JRAAKyJEA1ci0eBSAoywJUIc9iUgACszRAdnIsLgUgOMsDZCW/YlMAErBEQDZyKz4FIAnLBGQhr3JQABKxVEB0cioPBSAZywVEJZ9yUQASsmRANHIpHwUgKcsGRCGPclIAErN0wG5yKC8FIDnLB+wif3JTAAqwhMBqcic/BaAIywisIm9qUAAKsZTAbHKmDgWgGMsJzCJfalEACrKkwGhypR4FoCjLCowiT2pSAAqztMC75EhdCkBxlhe4S37UpgA0YImBq+RGfQpAE5YZOEte9KAANGKpgVfkRB8KQDOWG/iJfOhFAWjIkgPfyYV+FICmLDvwmzzoSQFozNIDcqAvBaA5yw992f/eFACEADRk71EAOI5DGEAn9p3jUAD4RChAffac3xQAvhAOUJf95jMFgD8ICajHXvOdAsBDwgLqsM88ogDwI6EB+dljfqIA8JTwgLzsL88oALwkRCAfe8srCgCnCBPIw75yhgLAaUIF4rOnnKUAcIlwgbjsJ1coAFwmZCAee8lVCgC3CBuIwz5yhwLAbUIH9rOH3KUA8BbhA/vYP96hAPA2IQTr2TvepQAwhDCCdewbIygADCOUYD57xigKAEMJJ5jHfjGSAsBwQgrGs1eMpgAwhbCCcewTMygATCO04H32iFkUAKYSXnCf/WEmBYDphBhcZ2+YTQFgCWEG59kXVlAAWEaowWv2hFUUAJYSbvAz+8FKCgDLCTn4k71gNQWALYQdfLAP7KAAsI3QA3vAPgoAWwk/OjP/7KQAsJ0QpCNzz24KACEIQzox70SgABCGUKQDc04UCgChCEcqM99EogAQjpCkInNNNAoAIQlLKjHPRKQAEJbQpAJzTFQKAKEJTzIzv0SmABCeECUjc0t0CgApCFMyMa9koACQhlAlA3NKFgoAqQhXIjOfZKIAkI6QJSJzSTYKACkJWyIxj2SkAJCW0CUCc0hWCgCpCV92Mn9kpgCQnhBmB3NHdgoAJQhjVjJvVKAAUIZQZgVzRhUKAKUIZ2YyX1SiAFCOkGYGc0U1CgAlCWtGMk9UpABQltBmBHNEVQoApQlv3mF+qEwBoDwhzh3mhuoUAFoQ5lxhXuhAAaANoc4Z5oQuFABaEe48Yz7oRAGgHSHPI+aCbhQAWhL2fGYe6EgBoC2hz3GYA/pSAGhN+Pfm/elMAaA9R6An7053CgAcjkE33hsUAPibo9CDd4ZfFAD4xHGozfvCBwUAvnEkavKu8JUCAA84FrV4T/iTAgA/cDRq8I7wmAIATzgeuXk/+JkCAC84Ijl5N3hOAYATHJNcvBe8pgDASY5KDt4JzlEA4ALHJTbvA+cpAHCRIxOTd4FrFAC4wbGJxXvAdQoA3OToxOAd4B4FAN7g+Ozl+8N9CgC8yRHaw3eH9ygAMIBjtJbvDe9TAGAQR2kN3xnGUABgIMdpLt8XxlEAYDBHag7fFcZSAGACx2os3xPGUwBgEkdrDN8R5lAAYCLH6z2+H8yjAMBkjtg9vhvMpQDAAo7ZNb4XzKcAwCKO2jm+E6yhAMBCjttzvg+sowDAYo7cY74LrKUAwAaO3Ve+B6ynAMAmjt4vvgPsoQDARt2PX/f/H3ZSAGCzrkew6/8NUSgAEEC3Y9jt/4WIFAAIostR7PJ/QnQKAARS/ThW//8gEwUAgql6JKv+X5CVAgABVTuW1f4fqEABgKCqHM0q/wdUowBAYNmPZ/bfD5UpABBc1iOa9XdDFwoAJJDtmGb7vdCRAgBJZDmqWX4ndKcAQCLRj2v03wd8UAAgmahHNurvAh5TACChaMc22u8BXlMAIKkoRzfK7wCuUQAgsd3Hd/ffB+5TACC5XUfY8YfcFAAoYPUxdvwhPwUAilh1lB1/qEEBgEJmH2fHH+pQAKCYWUfa8YdaFAAoaPSxdvyhHgUAihp1tB1/qEkBgMLePd6OP9SlAEBxd4+44w+1KQDQwNVj7vhDfQoANHH2qDv+0IMCAI28Ou6OP/ShAEAzPx15xx96UQCgoe/H3vEHgEb+9c+//rP7NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHDZ/wNYdsdVh2fHRAAAAABJRU5ErkJggg==">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800;900&family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&family=Space+Grotesk:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Prism.js pour coloration syntaxique -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet" />

    <!-- CodeMirror pour coloration syntaxique dans les √©diteurs -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/nord.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/solarized.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closetag.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/comment/comment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/searchcursor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/javascript-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/css-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/html-hint.min.js"></script>
    

    <!-- Skulpt ‚Äî vrai Python en JS pur, sans WebAssembly -->
    <script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt-stdlib.js"></script>

    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- JSZip pour export ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- CodeMirror Fold Code -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/brace-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/xml-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/indent-fold.min.js"></script>
    <!-- CodeMirror Active Line -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/selection/active-line.min.js"></script>
    <!-- html2canvas pour capture thumbnail projets -->
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, updateProfile } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, deleteDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js';

        // =============================================
        // üîß REMPLACE CES VALEURS PAR TES CL√âS FIREBASE
        // =============================================
        // ‚ö†Ô∏è S√âCURIT√â : Ces cl√©s sont publiques ‚Äî c'est normal pour Firebase Client.
        // OBLIGATOIRE : Configurer les r√®gles Firestore + restreindre l'API key dans Google Cloud Console
        // (Restrictions > Applications HTTP : ajouter ton domaine uniquement)
        // https://console.cloud.google.com/apis/credentials
        const firebaseConfig = {
            apiKey: "AIzaSyAUzRgupz7ykTxprH6xxlq11fwH4WROyuE",
            authDomain: "strix-6e321.firebaseapp.com",
            projectId: "strix-6e321",
            storageBucket: "strix-6e321.firebasestorage.app",
            messagingSenderId: "455788434951",
            appId: "1:455788434951:web:8e865e12e8a97ae2eebca2"
        };
        // =============================================

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Exposer globalement
        window._fbAuth = auth;
        window._fbDb = db;
        window._fbGoogleProvider = new GoogleAuthProvider();
        window._fbFns = { signInWithPopup, signOut, onAuthStateChanged, doc, setDoc, getDoc, collection, getDocs, deleteDoc, serverTimestamp, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, updateProfile };

        // Observer l'√©tat de connexion
        onAuthStateChanged(auth, (user) => {
            try {
                window._fbUser = user || null;
                if (typeof window.onFirebaseAuthChange === 'function') {
                    window.onFirebaseAuthChange(user);
                }
            } catch(e) {
                console.error('[SCRIX] Erreur lors du changement d\'√©tat d\'authentification:', e);
            }
        });

        console.log('[SCRIX] Firebase initialis√©');
    </script>
    
    <!-- Pas de Pyodide - trop lourd et buggy -->
    <style>
        :root {
            /* SCRIX ‚Äî Nextmove-style Dark Professional Palette */
            --primary-purple: #4f8ef7;
            --purple-dark: #1a3a8f;
            --purple-light: #7eb3ff;
            --purple-glow: rgba(79, 142, 247, 0.35);
            
            /* Deep charcoal backgrounds ‚Äî inspired by Nextmove */
            --bg-primary: #111112;
            --bg-secondary: #161618;
            --bg-tertiary: #1c1c1f;
            --bg-elevated: #242428;
            
            --surface-glass: rgba(255, 255, 255, 0.04);
            --surface-hover: rgba(255, 255, 255, 0.07);
            
            --border-subtle: rgba(255, 255, 255, 0.07);
            --border-default: rgba(255, 255, 255, 0.1);
            --border-strong: rgba(255, 255, 255, 0.2);
            
            --text-primary: #f4f4f5;
            --text-secondary: #a1a1aa;
            --text-tertiary: #71717a;
            
            /* Accent Colors */
            --accent-pink: #7eb3ff;
            --accent-blue: #60a5fa;
            --accent-green: #34d399;
            --accent-amber: #fbbf24;
            --accent-red: #f87171;
            
            /* Active nav gradient ‚Äî Space blue glow */
            --nav-active-bg: linear-gradient(90deg, rgba(10, 15, 40, 0.95) 0%, rgba(20, 40, 100, 0.6) 70%, rgba(30, 70, 180, 0.9) 100%);
            --nav-active-accent: linear-gradient(180deg, #7eb3ff 0%, #1a3a8f 100%);
            
            /* Code Editor Colors */
            --editor-html: #f87060;
            --editor-css: #60a5fa;
            --editor-js: #fde68a;
            --editor-python: #7dd3fc;
            
            /* Typography */
            --font-display: 'DM Sans', -apple-system, sans-serif;
            --font-sans: 'DM Sans', -apple-system, sans-serif;
            --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
        }


        /* ===== HEADER HIDE MODE ===== */
        .header {
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.35s ease, margin 0.35s ease;
        }
        body.header-hidden .header {
            transform: translateY(-110%);
            opacity: 0;
            pointer-events: none;
            margin-bottom: -80px; /* collapse space */
            position: relative;
        }
        .show-topbar-btn {
            display: none;
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            background: var(--primary-purple);
            color: #fff;
            border: none;
            border-radius: 20px;
            padding: 5px 18px;
            font-size: 12px;
            font-family: var(--font-sans);
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 20px var(--purple-glow);
            opacity: 0.7;
            transition: opacity 0.2s;
            letter-spacing: 0.5px;
        }
        .show-topbar-btn:hover { opacity: 1; }
        body.header-hidden .show-topbar-btn { display: block; }

        /* ===== THEMES ===== */

        /* Th√®me 1: DARK (d√©faut - d√©j√† dans :root) */

        /* Th√®me 2: NEO - N√©on arc-en-ciel anim√© */
        [data-theme="neo"] {
            --primary-purple: #ff00ff;
            --purple-dark: #cc00cc;
            --purple-light: #ff66ff;
            --purple-glow: rgba(255, 0, 255, 0.4);

            --bg-primary: #07000f;
            --bg-secondary: #0d0018;
            --bg-tertiary: #130020;
            --bg-elevated: #1a0028;

            --surface-glass: rgba(255, 0, 255, 0.07);
            --surface-hover: rgba(255, 0, 255, 0.14);

            --border-subtle: rgba(255, 0, 255, 0.2);
            --border-default: rgba(255, 0, 255, 0.4);
            --border-strong: rgba(255, 0, 255, 0.7);

            --text-primary: #fff0ff;
            --text-secondary: #ddaaff;
            --text-tertiary: #996699;

            --accent-pink: #ff0099;
            --accent-blue: #00ffff;
            --accent-green: #00ff88;
            --accent-amber: #ffff00;
        }

        /* Animation n√©on arc-en-ciel */
        @keyframes neonHue {
            0%   { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        @keyframes neonGlow {
            0%, 100% { text-shadow: 0 0 8px currentColor, 0 0 20px currentColor, 0 0 40px currentColor; }
            50%       { text-shadow: 0 0 4px currentColor, 0 0 10px currentColor, 0 0 20px currentColor; }
        }

        /* hue-rotate sur html = TOUT change de couleur, sans exception */
        [data-theme="neo"] {
            animation: neonHue 6s linear infinite;
        }

        /* Th√®me 3: CYBERPUNK - Jaune/Rose n√©on sur noir */
        [data-theme="cyberpunk"] {
            --primary-purple: #ffd700;
            --purple-dark: #cc9900;
            --purple-light: #ffe44d;
            --purple-glow: rgba(255, 215, 0, 0.4);

            --bg-primary: #0a0008;
            --bg-secondary: #110010;
            --bg-tertiary: #1a0018;
            --bg-elevated: #240022;

            --surface-glass: rgba(255, 0, 200, 0.08);
            --surface-hover: rgba(255, 215, 0, 0.12);

            --border-subtle: rgba(255, 0, 200, 0.2);
            --border-default: rgba(255, 215, 0, 0.35);
            --border-strong: rgba(255, 215, 0, 0.6);

            --text-primary: #fff5e0;
            --text-secondary: #ffcc80;
            --text-tertiary: #cc8855;

            --accent-pink: #ff00cc;
            --accent-blue: #aa00ff;
            --accent-green: #00ff88;
            --accent-amber: #ffd700;
        }

        /* Th√®me 4: TERMINAL - Vert phosphore style r√©tro */
        [data-theme="terminal"] {
            --primary-purple: #00ff41;
            --purple-dark: #00bb30;
            --purple-light: #66ff80;
            --purple-glow: rgba(0, 255, 65, 0.35);

            --bg-primary: #020d02;
            --bg-secondary: #041204;
            --bg-tertiary: #061806;
            --bg-elevated: #082008;

            --surface-glass: rgba(0, 255, 65, 0.07);
            --surface-hover: rgba(0, 255, 65, 0.12);

            --border-subtle: rgba(0, 255, 65, 0.15);
            --border-default: rgba(0, 255, 65, 0.3);
            --border-strong: rgba(0, 255, 65, 0.55);

            --text-primary: #ccffcc;
            --text-secondary: #88cc88;
            --text-tertiary: #447744;

            --accent-pink: #00ff41;
            --accent-blue: #00cc88;
            --accent-green: #00ff41;
            --accent-amber: #88ff00;

            --font-mono: 'JetBrains Mono', 'Courier New', monospace;
        }

        /* Th√®me 5: GLACE - Bleu glac√© arctique */
        [data-theme="glace"] {
            --primary-purple: #88d4f5;
            --purple-dark: #4ab8e8;
            --purple-light: #c4eaff;
            --purple-glow: rgba(136, 212, 245, 0.4);

            --bg-primary: #020810;
            --bg-secondary: #040d1a;
            --bg-tertiary: #071223;
            --bg-elevated: #0a182e;

            --surface-glass: rgba(136, 212, 245, 0.06);
            --surface-hover: rgba(136, 212, 245, 0.12);

            --border-subtle: rgba(136, 212, 245, 0.12);
            --border-default: rgba(136, 212, 245, 0.25);
            --border-strong: rgba(136, 212, 245, 0.5);

            --text-primary: #dff3ff;
            --text-secondary: #8bbcdd;
            --text-tertiary: #456e8a;

            --accent-pink: #b8e4ff;
            --accent-blue: #00aaff;
            --accent-green: #40e0d0;
            --accent-amber: #7fd8ff;
        }

        /* Effet givre sur les bordures */
        @keyframes frostShimmer {
            0%, 100% { opacity: 0.6; }
            50%       { opacity: 1; }
        }

        [data-theme="glace"] .editor-header,
        [data-theme="glace"] .preview-header,
        [data-theme="glace"] .toolbar {
            border-color: rgba(136, 212, 245, 0.3);
            box-shadow: 0 0 20px rgba(136, 212, 245, 0.05), inset 0 1px 0 rgba(200, 240, 255, 0.08);
        }

        [data-theme="glace"] .btn-primary {
            background: linear-gradient(135deg, #4ab8e8, #88d4f5);
            box-shadow: 0 0 15px rgba(136, 212, 245, 0.3), 0 0 40px rgba(136, 212, 245, 0.1);
        }

        /* ===== THEME SWITCHER PANEL ===== */
        .theme-switcher-panel {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .theme-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            background: none;
            border: 2px solid var(--border-subtle);
            border-radius: 10px;
            padding: 8px 10px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 11px;
            font-family: var(--font-sans);
            transition: all 0.2s ease;
            min-width: 58px;
        }

        .theme-btn:hover {
            border-color: var(--border-strong);
            color: var(--text-primary);
            transform: translateY(-2px);
        }

        .theme-btn.active {
            border-color: var(--primary-purple);
            color: var(--primary-purple);
            background: var(--surface-glass);
        }

        .theme-preview {
            width: 36px;
            height: 22px;
            border-radius: 5px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .preview-dark   { background: linear-gradient(135deg, #111112 50%, #4f8ef7 100%); }
        .preview-neo    { background: linear-gradient(135deg, #07000f 30%, #ff00ff 60%, #00ffff 100%); animation: neonHue 3s linear infinite; }
        .preview-cyber  { background: linear-gradient(135deg, #0a0008 50%, #ffd700 100%); }
        .preview-term   { background: linear-gradient(135deg, #020d02 50%, #00ff41 100%); }
        .preview-glace  { background: linear-gradient(135deg, #020810 50%, #88d4f5 100%); }

        /* ===== CUSTOM CONFIRM MODAL ===== */
        .confirm-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.75);
            backdrop-filter: blur(16px);
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .confirm-card {
            background: var(--bg-secondary);
            border: 1.5px solid var(--border-default);
            border-radius: 20px;
            padding: 32px 36px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5), 0 0 0 1px rgba(167,139,250,0.1);
            animation: slideInUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .confirm-icon {
            display: none; /* replaced by inline icon div */
        }

        .confirm-title {
            font-family: var(--font-sans);
            font-size: 17px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            text-align: center;
        }

        .confirm-desc {
            font-size: 13px;
            color: var(--text-tertiary);
            text-align: center;
            margin-bottom: 26px;
            line-height: 1.5;
        }

        .confirm-btns {
            display: flex;
            gap: 10px;
        }

        .confirm-btn {
            flex: 1;
            padding: 11px;
            border-radius: 11px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            font-family: var(--font-sans);
            transition: all 0.2s ease;
        }

        .confirm-btn-cancel {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1.5px solid var(--border-subtle);
        }

        .confirm-btn-cancel:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .confirm-btn-ok {
            background: linear-gradient(135deg, var(--primary-purple), var(--purple-dark));
            color: white;
            box-shadow: 0 4px 16px var(--purple-glow);
        }

        .confirm-btn-ok:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 22px var(--purple-glow);
        }

        .confirm-btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 16px rgba(239,68,68,0.3);
        }

        .confirm-btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 22px rgba(239,68,68,0.4);
        }

        /* ===== RESTORE SESSION MODAL ===== */
        .restore-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.88);
            backdrop-filter: blur(24px);
            z-index: 99998;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .restore-card {
            background: var(--bg-secondary);
            border: 1.5px solid var(--border-default);
            border-radius: 24px;
            padding: 40px 44px;
            max-width: 460px;
            width: 92%;
            box-shadow: 0 30px 60px rgba(0,0,0,0.5), 0 0 0 1px rgba(167,139,250,0.15);
            animation: slideInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            text-align: center;
        }

        .restore-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .restore-title {
            font-family: var(--font-display);
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .restore-desc {
            font-size: 14px;
            color: var(--text-tertiary);
            margin-bottom: 28px;
            line-height: 1.6;
        }

        .restore-project-name {
            display: inline-block;
            background: var(--surface-glass);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: 4px 14px;
            font-family: var(--font-mono);
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 28px;
        }

        .restore-btns {
            display: flex;
            gap: 12px;
        }

        .restore-btn {
            flex: 1;
            padding: 13px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            font-family: var(--font-sans);
            transition: all 0.2s ease;
        }

        .restore-btn-load {
            background: linear-gradient(135deg, var(--primary-purple), var(--purple-dark));
            color: white;
            box-shadow: 0 4px 20px var(--purple-glow);
        }

        .restore-btn-load:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 28px var(--purple-glow);
        }

        .restore-btn-clear {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1.5px solid var(--border-subtle);
        }

        .restore-btn-clear:hover {
            background: rgba(239,68,68,0.12);
            border-color: rgba(239,68,68,0.4);
            color: #ef4444;
        }

        /* ===== INTRO SCREEN ===== */
        #intro {
            position: fixed;
            inset: 0;
            z-index: 99999;
            background: #060612;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #intro.hide {
            animation: introOut 0.9s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes introOut {
            0%   { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.04); visibility: hidden; pointer-events: none; }
        }

        /* Canvas plein fond pour particules */
        #introCanvas {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
        }

        /* Halo central */
        .intro-glow {
            position: absolute;
            width: 600px;
            height: 600px;
            border-radius: 50%;
            background: radial-gradient(ellipse, rgba(79,142,247,0.07) 0%, transparent 70%);
            animation: glowPulse 4s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes glowPulse {
            0%, 100% { transform: scale(1); opacity: 0.6; }
            50%       { transform: scale(1.15); opacity: 1; }
        }

        /* Wrapper central */
        .intro-center {
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 28px;
        }

        /* Logo icon */
        .intro-icon {
            width: 88px;
            height: 88px;
            border-radius: 24px;
            background: linear-gradient(145deg, #1a2a6c, #2a4aad, #4f8ef7);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow:
                0 0 0 1px rgba(79,142,247,0.3),
                0 20px 60px rgba(79,142,247,0.35),
                0 0 120px rgba(79,142,247,0.12),
                inset 0 1px 0 rgba(255,255,255,0.2);
            animation: iconEntry 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) 0.2s both;
        }

        @keyframes iconEntry {
            from { opacity: 0; transform: scale(0.5) translateY(20px); }
            to   { opacity: 1; transform: scale(1) translateY(0); }
        }

        .intro-icon svg {
            width: 52px;
            height: 52px;
            overflow: visible;
        }

        /* SCRIX wordmark */
        .intro-wordmark {
            position: relative;
            display: flex;
            gap: 0;
            font-family: 'Space Grotesk', sans-serif;
            font-size: clamp(3rem, 8vw, 5.5rem);
            font-weight: 800;
            letter-spacing: -0.02em;
            line-height: 1;
        }

        .intro-wordmark .wl {
            display: inline-block;
            opacity: 0;
            transform: translateY(30px) rotateX(-90deg);
            color: #f0f4ff;
            animation: letterReveal 0.5s cubic-bezier(0.34, 1.3, 0.64, 1) forwards;
        }

        .intro-wordmark .wl:nth-child(1) { animation-delay: 0.55s; }
        .intro-wordmark .wl:nth-child(2) { animation-delay: 0.65s; }
        .intro-wordmark .wl:nth-child(3) { animation-delay: 0.75s; color: #7eb3ff; }
        .intro-wordmark .wl:nth-child(4) { animation-delay: 0.85s; color: #7eb3ff; }
        .intro-wordmark .wl:nth-child(5) {
            animation-delay: 0.95s;
            background: linear-gradient(135deg, #4f8ef7, #818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        @keyframes letterReveal {
            to { opacity: 1; transform: translateY(0) rotateX(0deg); }
        }

        /* Tagline */
        .intro-tagline {
            font-family: 'Inter', sans-serif;
            font-size: 0.7rem;
            letter-spacing: 0.45em;
            text-transform: uppercase;
            color: #3d5a8a;
            font-weight: 600;
            opacity: 0;
            animation: fadeUp 0.7s ease 1.3s forwards;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(10px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* Barre de progression */
        .intro-progress-wrap {
            width: 180px;
            height: 2px;
            background: rgba(255,255,255,0.06);
            border-radius: 2px;
            overflow: hidden;
            opacity: 0;
            animation: fadeUp 0.5s ease 1.5s forwards;
        }

        .intro-progress-bar {
            height: 100%;
            width: 0%;
            border-radius: 2px;
            background: linear-gradient(90deg, #4f8ef7, #818cf8, #4f8ef7);
            background-size: 200% 100%;
            animation:
                progressFill 2.2s cubic-bezier(0.25, 1, 0.5, 1) 1.6s forwards,
                progressShine 1.5s linear 1.6s infinite;
            box-shadow: 0 0 12px rgba(79,142,247,0.6);
        }

        @keyframes progressFill {
            to { width: 100%; }
        }

        @keyframes progressShine {
            0%   { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* MASQUAGE GLOBAL DES SCROLLBARS - ULTRA AGRESSIF */
        * {
            scrollbar-width: none !important; /* Firefox */
            -ms-overflow-style: none !important; /* IE/Edge */
        }
        
        *::-webkit-scrollbar {
            display: none !important; /* Chrome/Safari/Opera */
            width: 0 !important;
            height: 0 !important;
            background: transparent !important;
        }
        
        *::-webkit-scrollbar-thumb {
            display: none !important;
            background: transparent !important;
        }
        
        *::-webkit-scrollbar-track {
            display: none !important;
            background: transparent !important;
        }

        /* Forcer sur html et body aussi */
        html, body {
            scrollbar-width: none !important;
            -ms-overflow-style: none !important;
        }
        
        html::-webkit-scrollbar,
        body::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
        }

        body {
            font-family: var(--font-sans);
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            position: relative;
        }

        /* Subtle dark ambient */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 0%, rgba(79, 142, 247, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 100%, rgba(190, 24, 93, 0.04) 0%, transparent 40%);
            pointer-events: none;
            z-index: 0;
        }

        @keyframes bgPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* No floating particles - cleaner look */
        body::after {
            content: none;
        }

        @keyframes particleFloat {
            0% { background-position: 0 0, 40px 60px, 130px 270px, 70px 100px; }
            100% { background-position: 200px 200px, 240px 260px, 330px 470px, 270px 300px; }
        }

        .app-wrapper {
            position: relative;
            z-index: 2;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Premium Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
            padding: 14px 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1000;
        }

        .header::after { display: none; }

        @keyframes headerFlow {
            0%, 100% { opacity: 0.4; transform: translateX(0); }
            50% { opacity: 0.8; transform: translateX(10px); }
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 28px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
            position: relative;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #2a1a2e 0%, #1e1020 100%);
            border: 1px solid rgba(79, 142, 247, 0.3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 4px 16px rgba(79, 142, 247, 0.2);
        }

        .logo-icon .mini-s,
        .logo-icon .mini-x {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.5rem;
            font-weight: 800;
            position: absolute;
            line-height: 1;
        }

        .logo-icon .mini-s {
            color: #ffffff;
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.3);
            transform: translate(-2px, -2px);
            z-index: 2;
        }

        .logo-icon .mini-x {
            background: linear-gradient(135deg, #7eb3ff, #1a3a8f);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            transform: translate(2px, 2px);
            z-index: 1;
            opacity: 0.95;
        }

        .logo-icon .mini-fusion {
            position: absolute;
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            z-index: 3;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.9);
            animation: miniFusionPulse 3s ease-in-out infinite;
        }

        @keyframes miniFusionPulse {
            0%, 100% { box-shadow: 0 0 15px rgba(255, 255, 255, 0.7); }
            50% { box-shadow: 0 0 25px rgba(255, 255, 255, 1); }
        }

        @keyframes iconGlow {
            0%, 100% { box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1), 0 8px 32px var(--purple-glow), inset 0 1px 0 rgba(255, 255, 255, 0.3); }
            50% { box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2), 0 12px 48px var(--purple-glow), inset 0 1px 0 rgba(255, 255, 255, 0.4); }
        }

        .logo-text {
            font-family: 'DM Sans', sans-serif;
            font-size: 22px;
            font-weight: 700;
            letter-spacing: 0.08em;
            display: flex;
            gap: 0.02em;
        }

        .logo-text .letter {
            color: var(--text-primary);
            animation: headerLetterPop 0.5s ease both;
        }

        .logo-text .letter:nth-child(1) { animation-delay: 3.2s; }
        .logo-text .letter:nth-child(2) { animation-delay: 3.3s; }
        .logo-text .letter:nth-child(3) { animation-delay: 3.4s; }
        .logo-text .letter:nth-child(4) { animation-delay: 3.5s; }
        .logo-text .letter:nth-child(5) { animation-delay: 3.6s; }

        .logo-text .highlight {
            background: linear-gradient(135deg, #7eb3ff, #1a3a8f);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        @keyframes headerLetterPop {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .tagline {
            font-size: 10px;
            color: var(--text-tertiary);
            font-weight: 400;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            opacity: 0.7;
        }

        .project-name-container { position: relative; min-width: 280px; }

        .project-name { width: 100%; height: 48px; background: rgba(0,0,0,0.6); border: none; border-bottom: 2px solid rgba(50,50,50,0.8); outline: none; padding: 0 1rem; color: var(--text-secondary); font-size: 13px; font-weight: 500; font-family: var(--font-mono); caret-color: var(--text-secondary); z-index: 10; transition: background 0.3s ease, border-color 0.3s ease; letter-spacing: 0.05em; }

        .project-label { position: absolute; top: 0.9rem; left: 1rem; color: #7eb3ff; opacity: 1; text-transform: uppercase; letter-spacing: 0.15em; pointer-events: none; transition: all 0.3s ease; z-index: 11; font-size: 11px; font-weight: 600; font-family: var(--font-mono); }

        .project-name:focus + .project-label, .project-name:not(:placeholder-shown) + .project-label { top: -1.3rem; left: 0; font-size: 9px; opacity: 1; color: var(--text-secondary); }

        .project-name:focus + .project-label::before, .project-name:focus + .project-label::after { content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        .project-name:focus + .project-label::before { color: var(--accent-pink); animation: glitch-project 0.4s cubic-bezier(0.25,0.46,0.45,0.94) both; }

        .project-name:focus + .project-label::after { color: var(--text-secondary); animation: glitch-project 0.4s cubic-bezier(0.25,0.46,0.45,0.94) reverse both; }

        .project-scanline, .project-glow { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

        .project-corners { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

        .project-corners .corner { position: absolute; transition: all 0.3s ease; opacity: 0.5; }

        .corner::before, .corner::after { content: ''; position: absolute; background: var(--purple-light); transition: all 0.3s ease; }

        .corner-tl { top:-2px; left:-2px; } .corner-tl::before { width:12px; height:2px; top:0; left:0; } .corner-tl::after { width:2px; height:12px; top:0; left:0; }
        .corner-tr { top:-2px; right:-2px; } .corner-tr::before { width:12px; height:2px; top:0; right:0; } .corner-tr::after { width:2px; height:12px; top:0; right:0; }
        .corner-bl { bottom:-2px; left:-2px; } .corner-bl::before { width:12px; height:2px; bottom:0; left:0; } .corner-bl::after { width:2px; height:12px; bottom:0; left:0; }
        .corner-br { bottom:-2px; right:-2px; } .corner-br::before { width:12px; height:2px; bottom:0; right:0; } .corner-br::after { width:2px; height:12px; bottom:0; right:0; }

        .project-glow { background: radial-gradient(ellipse at center, rgba(167,139,250,0.2) 0%, transparent 70%); opacity: 0; transition: opacity 0.4s ease; }

        .project-scanline { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; background: linear-gradient(to bottom, transparent 0%, rgba(167,139,250,0.1) 48%, rgba(167,139,250,0.3) 50%, rgba(167,139,250,0.1) 52%, transparent 100%); opacity:0; }

        .project-name:focus { border-color:transparent; outline: none !important; box-shadow: none !important; background:rgba(0,0,0,0.8); }

        .project-name:focus ~ .project-corners .corner::before { width:20px; }
        .project-name:focus ~ .project-corners .corner::after { height:20px; }
        .project-name:focus ~ .project-corners .corner { opacity:1; }
        .project-name:focus ~ .project-corners .corner-tl { top:-6px; left:-6px; }
        .project-name:focus ~ .project-corners .corner-tr { top:-6px; right:-6px; }
        .project-name:focus ~ .project-corners .corner-bl { bottom:-6px; left:-6px; }
        .project-name:focus ~ .project-corners .corner-br { bottom:-6px; right:-6px; }
        .project-name:focus ~ .project-glow { opacity:1; }
        .project-name:focus ~ .project-scanline { animation: scan-project 4s linear infinite; }

        @keyframes glitch-project { 0% { transform:translate(0); clip-path:inset(0 0 0 0); } 20% { transform:translate(-0.2rem,0.1rem); clip-path:inset(50% 0 20% 0); } 40% { transform:translate(0.1rem,-0.1rem); clip-path:inset(20% 0 60% 0); } 60% { transform:translate(-0.15rem,0.1rem); clip-path:inset(80% 0 5% 0); } 80% { transform:translate(0.15rem,-0.15rem); clip-path:inset(30% 0 45% 0); } 100% { transform:translate(0); clip-path:inset(0 0 0 0); } }

        @keyframes scan-project { 0% { opacity:0; transform:translateY(-100%); } 25% { opacity:0.5; } 75% { opacity:0.5; } 100% { opacity:0; transform:translateY(100%); } }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            background: var(--surface-glass);
            color: var(--text-secondary);
            border: 1px solid var(--border-default);
            padding: 9px 18px;
            border-radius: 9px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            font-family: var(--font-sans);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 7px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
            transition: left 0.5s;
        }

        .btn:hover {
            background: var(--surface-hover);
            border-color: var(--border-strong);
            color: var(--text-primary);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f8ef7, #1a3a8f);
            color: white;
            border: 1px solid rgba(79, 142, 247, 0.6);
            box-shadow: 0 2px 12px rgba(79, 142, 247, 0.4);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #7eb3ff, #2a5abf);
            box-shadow: 0 4px 20px rgba(79, 142, 247, 0.6);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
            border: 1px solid rgba(52, 211, 153, 0.3);
            box-shadow: 0 2px 12px rgba(5, 150, 105, 0.3);
        }

        .btn-success:hover {
            box-shadow: 0 4px 20px rgba(5, 150, 105, 0.45);
            color: white;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 90px);
            position: relative;
        }
        body.header-hidden .container {
            height: 100vh;
        }

        /* Preview Section */
        .preview-section {
            flex: 1;
            background: var(--bg-secondary);
            position: relative;
            display: flex;
            flex-direction: column;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .preview-section.editor-collapsed {
            flex: 1;
        }

        /* Hide only the preview header when collapsed */
        .preview-section.preview-collapsed .preview-header {
            display: none;
        }

        .preview-section.preview-collapsed .responsive-toolbar {
            display: none;
        }

        /* Show floating button when header is hidden */
        .preview-section.preview-collapsed .show-header-btn {
            display: flex !important;
        }

        /* Floating button to show header */
        .show-header-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: linear-gradient(135deg, var(--primary-purple), var(--purple-light));
            border: 2px solid var(--border-default);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            font-family: var(--font-sans);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px var(--purple-glow);
            padding: 0;
        }

        .show-header-btn:hover {
            transform: translateY(-2px) scale(1.1);
            box-shadow: 0 6px 24px var(--purple-glow);
        }

        .show-header-btn:active {
            transform: scale(0.95);
        }

        .preview-header {
            background: var(--bg-secondary);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-subtle);
        }

        .preview-title {
            color: var(--text-primary);
            font-weight: 800;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2.5px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .preview-icon {
            width: 32px;
            height: 32px;
            background: none;
            border-radius: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: none;
            line-height: 1;
            position: relative;
            top: -1px;
        }

        .preview-controls {
            display: flex;
            gap: 8px;
        }

        .control-btn {
            background: var(--surface-glass);
            border: 1px solid var(--border-default);
            color: var(--text-secondary);
            padding: 9px 18px;
            border-radius: 9px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
            font-family: var(--font-sans);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 6px;
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            background: var(--surface-hover);
            color: var(--primary-purple);
            border-color: var(--primary-purple);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--purple-glow);
        }

        #preview {
            flex: 1;
            border: none;
            background: #050505;
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Vue Desktop - iframe plein √©cran sans marge */
        .preview-wrapper #preview:not(.tablet-view):not(.mobile-view) {
            width: 100% !important;
            height: 100% !important;
            position: absolute;
            top: 0; left: 0;
            right: 0; bottom: 0;
        }

        /* Editor Section with Tabs */
        .editor-section {
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            flex: 1;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .editor-section.collapsed {
            flex: none !important;
            height: 44px !important;
            min-height: 0 !important;
        }

        /* ===== RESIZER ===== */
        .resizer {
            width: 100%;
            height: 14px;
            background: var(--bg-secondary);
            cursor: row-resize;
            flex-shrink: 0;
            position: relative;
            z-index: 100;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .resizer::before {
            content: '';
            position: absolute;
            top: -6px;
            bottom: -6px;
            left: 0;
            right: 0;
        }
        .resizer::after {
            content: '';
            width: 50px;
            height: 4px;
            border-radius: 4px;
            background: var(--border-strong);
            transition: background 0.2s, width 0.2s, height 0.2s;
        }
        .resizer:hover,
        .resizer.dragging {
            background: rgba(79, 142, 247, 0.15);
        }
        .resizer:hover::after,
        .resizer.dragging::after {
            background: var(--primary-purple);
            width: 70px;
            height: 5px;
        }

        /* Language Tabs */
        .language-tabs {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
            padding: 6px 20px 0;
            display: flex;
            gap: 4px;
            align-items: center;
            justify-content: space-between;
        }

        .tabs-left {
            display: flex;
            gap: 8px;
        }

        .collapse-btn {
            background: var(--surface-glass);
            border: 1px solid var(--border-default);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .collapse-btn:hover {
            background: var(--surface-hover);
            color: var(--primary-purple);
            border-color: var(--primary-purple);
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: var(--text-tertiary);
            padding: 8px 20px;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            font-size: 13px;
            font-weight: 700;
            font-family: var(--font-sans);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 3px solid transparent;
            position: relative;
        }

        .tab-btn:hover {
            background: var(--surface-glass);
            color: var(--text-secondary);
        }

        .tab-btn.active {
            background: rgba(79, 142, 247, 0.08);
            color: var(--text-primary);
            border-bottom-color: var(--tab-color);
        }

        .tab-btn.html-tab { --tab-color: var(--editor-html); }
        .tab-btn.css-tab { --tab-color: var(--editor-css); }
        .tab-btn.js-tab { --tab-color: var(--editor-js); }
        .tab-btn.python-tab { --tab-color: var(--editor-python); }

        .tab-icon {
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .tab-icon svg {
            width: 16px;
            height: 16px;
            display: block;
        }

        /* Editor Container */
        .editor-container {
            flex: 1;
            position: relative;
            background: var(--bg-primary);
            overflow: hidden;
        }

        .editor-content {
            display: none;
            height: 100%;
            flex-direction: column;
        }

        .editor-content.active {
            display: flex;
        }

        .editor-toolbar {
            background: var(--bg-secondary);
            padding: 6px 20px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 8px;
        }

        .toolbar-btn {
            background: transparent;
            border: 1px solid var(--border-default);
            color: var(--text-tertiary);
            padding: 7px 16px;
            border-radius: 7px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            font-family: var(--font-sans);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }


        /* Undo/Redo button states */
        .toolbar-btn.undo-btn,
        .toolbar-btn.redo-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 7px 10px;
            opacity: 0.4;
            cursor: not-allowed;
        }
        .toolbar-btn.undo-btn.has-history,
        .toolbar-btn.redo-btn.has-history {
            opacity: 1;
            cursor: pointer;
            border-color: var(--border-default);
            color: var(--text-tertiary);
        }
        .toolbar-btn.undo-btn.has-history:hover,
        .toolbar-btn.redo-btn.has-history:hover {
            background: var(--surface-glass);
            border-color: var(--primary-purple);
            color: var(--primary-purple);
            transform: translateY(-1px);
        }
        .toolbar-btn:hover {
            background: var(--surface-glass);
            border-color: var(--primary-purple);
            color: var(--primary-purple);
            transform: translateY(-1px);
        }

        textarea {
            flex: 1;
            width: 100%;
            background: transparent;
            color: var(--text-primary);
            border: none;
            padding: 22px;
            font-family: var(--font-mono);
            font-size: 14px;
            line-height: 1.8;
            resize: none;
            outline: none;
            tab-size: 2;
            letter-spacing: 0.3px;
        }

        /* ===== CODEMIRROR STYLES ===== */
        :root { --editor-font-size: 14px; }
        .CodeMirror {
            flex: 1;
            min-height: 0;
            width: 100% !important;
            height: auto !important;
            font-family: var(--font-mono) !important;
            font-size: var(--editor-font-size) !important;
            line-height: 1.5 !important;
            background: transparent !important;
            color: #f8f8f2 !important;
            padding: 0 !important;
        }
        .CodeMirror,
        .CodeMirror-scroll,
        .CodeMirror-sizer,
        .CodeMirror-gutter,
        .CodeMirror-lines,
        .CodeMirror-code,
        div.CodeMirror,
        .cm-s-dracula.CodeMirror { background: transparent !important; }
        .CodeMirror-scroll {
            height: 100% !important;
            min-height: 0 !important;
            overflow-y: auto !important;
            overflow-x: auto !important;
            padding-left: 4px !important;
        }
        .cm-s-dracula .CodeMirror-gutters {
            background: rgba(0,0,0,0.15) !important;
            border-right: 1px solid rgba(167,139,250,0.15) !important;
        }
        .CodeMirror-selected { background: rgba(124,58,237,0.3) !important; }
        .CodeMirror-linenumber {
            color: rgba(167,139,250,0.4) !important;
            font-size: 12px !important;
            padding: 0 10px !important;
        }
        .CodeMirror-cursor {
            border-left: 2px solid var(--purple-light) !important;
        }
        .CodeMirror-selected {
            background: rgba(124,58,237,0.3) !important;
        }
        .CodeMirror-focused .CodeMirror-selected {
            background: rgba(124,58,237,0.4) !important;
        }
        .CodeMirror-activeline-background {
            background: rgba(124,58,237,0.06) !important;
        }
        .cm-editor-wrap {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        textarea::selection {
            background: rgba(79, 142, 247, 0.35);
            color: var(--text-primary);
        }

        textarea::placeholder {
            color: var(--text-tertiary);
            font-style: italic;
            opacity: 0.4;
        }

        /* Scrollbar - CACH√âE */
        textarea::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
        }

        textarea::-webkit-scrollbar-track {
            display: none !important;
        }

        textarea::-webkit-scrollbar-thumb {
            display: none !important;
        }

        textarea::-webkit-scrollbar-thumb:hover {
            display: none !important;
        }
        
        textarea {
            scrollbar-width: none !important;
            -ms-overflow-style: none !important;
        }

        /* Python Output Panel */
        .python-output {
            background: var(--bg-secondary);
            border-top: 2px solid var(--editor-python);
            padding: 20px;
            font-family: var(--font-mono);
            font-size: 13px;
            color: var(--text-primary);
            max-height: 250px;
            overflow-y: auto;
            display: none;
        }

        .python-output.active {
            display: block;
        }

        .python-output-header {
            color: var(--editor-python);
            font-weight: 800;
            margin-bottom: 12px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .python-close-btn {
            background: transparent;
            border: 1px solid var(--border-default);
            color: var(--text-tertiary);
            padding: 7px 16px;
            border-radius: 7px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            font-family: var(--font-sans);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: none;
            letter-spacing: 0;
        }
        
        .python-close-btn:hover {
            background: var(--surface-glass);
            border-color: var(--primary-purple);
            color: var(--primary-purple);
            transform: translateY(-1px);
        }

        .python-result {
            background: var(--surface-glass);
            border: 1px solid var(--border-default);
            border-radius: 10px;
            padding: 18px;
            margin-top: 10px;
        }

        /* Console Panel */
        .console-panel {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-subtle);
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .console-panel.active {
            max-height: 280px;
        }

        .console-header {
            background: var(--surface-glass);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-subtle);
        }

        .console-title {
            color: var(--text-secondary);
            font-weight: 800;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2.5px;
        }

        .console-content {
            padding: 18px;
            font-family: var(--font-mono);
            font-size: 12px;
            color: var(--text-primary);
            overflow-y: auto;
            max-height: 220px;
        }

        .console-log {
            padding: 7px 14px;
            border-left: 3px solid var(--accent-green);
            margin: 7px 0;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 5px;
        }

        .console-error {
            color: var(--accent-red);
            border-left-color: var(--accent-red);
            background: rgba(239, 68, 68, 0.1);
        }

        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 280px;
            height: 100vh;
            background: #1a1a1e;
            border-left: 1px solid rgba(255,255,255,0.07);
            box-shadow: -20px 0 60px rgba(0,0,0,0.6);
            z-index: 99999;
            transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            scrollbar-width: none;
            -ms-overflow-style: none;
            transform: translateX(100%);
        }
        .settings-panel::-webkit-scrollbar { display: none; }

        .settings-panel.active {
            transform: translateX(0);
        }

        .settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 22px 20px 18px;
            border-bottom: 1px solid rgba(255,255,255,0.07);
            position: sticky;
            top: 0;
            background: #1a1a1e;
            z-index: 10;
            flex-shrink: 0;
        }

        .settings-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: 0.03em;
            font-family: var(--font-sans);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .close-settings {
            width: 32px;
            height: 32px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            color: var(--text-tertiary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .close-settings:hover {
            background: rgba(255,255,255,0.09);
            color: var(--text-primary);
            border-color: rgba(255,255,255,0.14);
        }

        .settings-content {
            padding: 10px 12px;
            flex: 1;
        }

        .settings-section {
            margin-bottom: 8px;
        }

        .settings-section-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: var(--text-tertiary);
            padding: 8px 10px 4px;
        }

        .setting-item {
            margin: 2px 0;
        }

        .setting-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            padding: 6px 10px 4px;
        }

        .setting-input {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.09);
            border-radius: 10px;
            padding: 10px 12px;
            color: var(--text-primary);
            font-size: 13px;
            font-family: var(--font-sans);
            outline: none;
            transition: all 0.2s;
            box-sizing: border-box;
        }

        /* FIX: Style pour les menus d√©roulants (select) - CORRIG√â ‚úÖ */
        .setting-select {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.09);
            border-radius: 10px;
            padding: 10px 12px;
            color: var(--text-primary);
            font-size: 13px;
            font-family: var(--font-sans);
            outline: none;
            transition: all 0.2s;
            cursor: pointer;
            box-sizing: border-box;
        }

        /* Style des options du menu d√©roulant */
        .setting-select option {
            background: #1a1a1e;
            color: var(--text-primary);
            padding: 10px;
        }

        .setting-input:focus, .setting-select:focus {
            border-color: rgba(79, 142, 247, 0.5);
            background: rgba(255,255,255,0.07);
        }

        .setting-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            background: transparent;
            border: none;
            border-radius: 10px;
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            font-family: var(--font-sans);
        }

        .setting-toggle:hover {
            background: rgba(255,255,255,0.05);
            color: var(--text-primary);
        }

        .toggle-switch {
            width: 40px;
            height: 22px;
            background: rgba(255,255,255,0.1);
            border-radius: 11px;
            position: relative;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: var(--text-tertiary);
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: all 0.2s;
        }

        .setting-toggle.active .toggle-switch {
            background: var(--primary-purple);
        }

        .setting-toggle.active .toggle-switch::after {
            left: 21px;
            background: white;
        }

        /* Status Bar */
        .status-bar {
            background: var(--bg-secondary);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-top: 1px solid var(--border-subtle);
            padding: 12px 28px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .status-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--primary-purple), transparent);
            opacity: 0.5;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-secondary);
            font-weight: 600;
            font-family: var(--font-mono);
            font-size: 11px;
        }

        .status-indicator {
            width: 9px;
            height: 9px;
            border-radius: 50%;
            background: var(--accent-green);
            box-shadow: 
                0 0 0 3px rgba(16, 185, 129, 0.2),
                0 0 16px var(--accent-green);
            animation: statusPulse 2.5s ease-in-out infinite;
        }

        @keyframes statusPulse {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
            }
            50% { 
                opacity: 0.7; 
                transform: scale(1.15);
            }
        }

        /* Mini Games Modal */
        .minigames-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            display: none;
            align-items: stretch;
            justify-content: flex-end;
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .minigames-modal.active {
            display: flex;
            opacity: 1;
            pointer-events: all;
        }

        .minigames-container {
            background: #1a1a1e;
            border-left: 1px solid rgba(255,255,255,0.07);
            width: 75%;
            max-width: 780px;
            height: 100vh;
            overflow: hidden;
            box-shadow: -20px 0 60px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .minigames-modal.active .minigames-container {
            transform: translateX(0);
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .minigames-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 22px 20px 18px;
            border-bottom: 1px solid rgba(255,255,255,0.07);
            flex-shrink: 0;
            background: #1a1a1e;
            gap: 12px;
            position: relative;
        }

        .minigames-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: var(--font-sans);
            letter-spacing: 0.03em;
        }

        .minigames-close {
            width: 32px;
            height: 32px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            color: var(--text-tertiary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .minigames-close:hover {
            background: rgba(255,255,255,0.09);
            color: var(--text-primary);
            border-color: rgba(255,255,255,0.14);
        }

        .minigames-content {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.1) transparent;
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 14px;
            margin-bottom: 20px;
        }

        /* Force all cards in the grid to the same height */
        #gamesMenu { align-items: stretch; }

        .game-card {
            background: rgba(79,142,247,0.04);
            border: 1px solid rgba(79,142,247,0.25);
            border-radius: 12px;
            padding: 0;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .game-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(79,142,247,0.08), transparent);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .game-card:hover {
            border-color: rgba(79,142,247,0.7);
            background: rgba(79,142,247,0.1);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(79,142,247,0.2);
        }

        .game-card:hover::before {
            opacity: 1;
        }

        .game-icon {
            font-size: 42px;
            position: relative;
            z-index: 1;
        }

        .game-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            position: relative;
            z-index: 1;
        }

        .game-desc {
            font-size: 11px;
            color: var(--text-tertiary);
            line-height: 1.3;
            padding: 0 8px;
            position: relative;
            z-index: 1;
        }

        /* ===== FULLSCREEN GAME OVERLAY ===== */
        .game-fullscreen-overlay {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 20000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .game-fullscreen-overlay.active {
            display: flex;
            animation: gameFadeIn 0.25s ease;
        }
        @keyframes gameFadeIn {
            from { opacity: 0; transform: scale(0.97); }
            to { opacity: 1; transform: scale(1); }
        }
        .game-fullscreen-topbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 52px;
            background: linear-gradient(135deg, rgba(26,15,46,0.95), rgba(36,24,56,0.95));
            backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 20001;
            gap: 12px;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .game-fullscreen-topbar.hidden {
            transform: translateY(-100%);
            opacity: 0;
            pointer-events: none;
        }
        .game-fullscreen-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            font-family: var(--font-sans);
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .game-fullscreen-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .game-fs-btn {
            background: rgba(124,58,237,0.2);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            font-family: var(--font-sans);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .game-fs-btn:hover {
            background: rgba(124,58,237,0.4);
            color: var(--text-primary);
            border-color: var(--primary-purple);
        }
        .game-fs-btn.danger:hover {
            background: rgba(239,68,68,0.2);
            border-color: #ef4444;
            color: #ef4444;
        }
        .game-fs-toggle-bar {
            position: fixed;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20002;
            background: rgba(124,58,237,0.7);
            backdrop-filter: blur(8px);
            border: 1px solid var(--border-default);
            border-radius: 20px;
            padding: 4px 14px;
            font-size: 11px;
            font-weight: 600;
            color: #fff;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
            white-space: nowrap;
        }
        .game-fullscreen-overlay.active .game-fs-toggle-bar {
            opacity: 0;
        }
        .game-fullscreen-topbar.hidden ~ .game-fs-toggle-bar,
        .game-fs-toggle-bar.visible {
            opacity: 1;
        }
        /* Canvas + iframe in fullscreen */
        .game-fullscreen-overlay #gameCanvas {
            position: fixed;
            top: 52px;
            left: 0;
            width: 100vw !important;
            height: calc(100vh - 52px) !important;
            border: none;
            border-radius: 0;
            box-shadow: none;
            display: block;
        }
        .game-fullscreen-overlay #customGameIframe {
            position: fixed;
            top: 52px;
            left: 0;
            width: 100vw;
            height: calc(100vh - 52px);
            border: none;
            border-radius: 0;
            z-index: 20000;
        }
        .game-fullscreen-overlay .game-info {
            position: fixed;
            top: 14px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20003;
            background: rgba(0,0,0,0.6);
            color: var(--text-secondary);
            font-family: var(--font-mono);
            font-size: 14px;
            font-weight: 700;
            padding: 4px 14px;
            border-radius: 20px;
            pointer-events: none;
        }

        /* ===== GAMES GRID SIZES ===== */
        #gamesMenu.gsize-lg {
            grid-template-columns: repeat(3, 1fr);
        }
        #gamesMenu.gsize-md {
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        #gamesMenu.gsize-md .game-card { aspect-ratio: 1; }
        #gamesMenu.gsize-md .game-icon { font-size: 34px; }
        #gamesMenu.gsize-md .game-title { font-size: 12px; }
        #gamesMenu.gsize-sm {
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }
        #gamesMenu.gsize-sm .game-card { aspect-ratio: 1; }
        #gamesMenu.gsize-sm .game-icon { font-size: 26px; }
        #gamesMenu.gsize-sm .game-title { font-size: 11px; }
        #gamesMenu.gsize-sm .game-desc { display: none; }
        #gamesMenu.gsize-sm .custom-game-thumb { height: 50px; }
        #gamesMenu.gsize-list {
            grid-template-columns: 1fr;
            gap: 6px;
        }
        #gamesMenu.gsize-list .game-card {
            flex-direction: row;
            aspect-ratio: unset;
            height: 54px;
            padding: 0 16px;
            border-radius: 10px;
            gap: 14px;
            justify-content: flex-start;
            text-align: left;
        }
        #gamesMenu.gsize-list .game-icon {
            font-size: 26px;
            flex-shrink: 0;
            width: 36px;
            text-align: center;
            padding: 0;
        }
        #gamesMenu.gsize-list .game-title {
            font-size: 13px;
            flex-shrink: 0;
        }
        #gamesMenu.gsize-list .game-desc {
            font-size: 11px;
            color: var(--text-tertiary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-left: 8px;
            flex: 1;
            padding: 0;
        }
        #gamesMenu.gsize-list .custom-game-thumb {
            width: 44px;
            height: 36px;
            margin-bottom: 0;
            border-radius: 6px;
            flex-shrink: 0;
            object-fit: cover;
        }
        #gamesMenu.gsize-list .custom-game-name-el { font-size: 13px; flex-shrink: 0; }
        #gamesMenu.gsize-list .custom-game-actions { margin-top: 0; margin-left: auto; flex-shrink: 0; }
        #gamesMenu.gsize-list .project-card { flex-direction: row; border-radius: 10px; aspect-ratio: unset; height: 54px; overflow: hidden; }
        #gamesMenu.gsize-list .project-card .project-card-thumb { width: 80px; height: 54px; min-height: unset; flex-shrink: 0; flex: none; align-self: auto; border-bottom: none; border-right: 1px solid rgba(255,255,255,0.07); border-radius: 0; }
        #gamesMenu.gsize-list .project-card .project-card-body { flex: 1; padding: 8px 12px; }
        #gamesMenu.gsize-list .project-card .project-card-name { font-size: 13px; }
        #gamesMenu.gsize-list .project-card .project-card-date { font-size: 11px; }
        #gamesMenu.gsize-list .add-game-icon { font-size: 22px; width: 36px; text-align: center; }
        #gamesMenu.gsize-list .add-game-label { font-size: 13px; }

        /* ===== PROJECT-CARD DANS GAMES MENU : taille uniforme avec game-card ===== */
        #gamesMenu .project-card {
            aspect-ratio: 1;
            height: auto;
            background: rgba(79,142,247,0.04);
            border: 1px solid rgba(79,142,247,0.25);
            border-radius: 12px;
        }
        #gamesMenu .project-card:hover {
            border-color: rgba(79,142,247,0.7);
            background: rgba(79,142,247,0.1);
            box-shadow: 0 8px 24px rgba(79,142,247,0.2);
        }
        #gamesMenu .project-card .project-card-thumb {
            flex: 1;
            min-height: 0;
            flex-shrink: 1;
        }
        #gamesMenu .project-card .project-card-body {
            padding: 8px 10px;
            flex-shrink: 0;
        }
        #gamesMenu .project-card .project-card-name {
            font-size: 13px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #gamesMenu .project-card .project-card-date {
            font-size: 11px;
        }
        #gamesMenu .project-card .project-card-actions {
            gap: 3px;
        }
        /* Ajustements par taille de grille ‚Äî on supprime les hauteurs fixes et on laisse aspect-ratio:1 faire le travail */
        #gamesMenu.gsize-md .project-card {
            aspect-ratio: 1;
            height: auto;
        }
        #gamesMenu.gsize-md .project-card .project-card-thumb {
            height: auto;
        }
        #gamesMenu.gsize-sm .project-card {
            aspect-ratio: 1;
            height: auto;
        }
        #gamesMenu.gsize-sm .project-card .project-card-thumb {
            height: auto;
        }
        #gamesMenu.gsize-sm .project-card .project-card-body {
            padding: 4px 6px;
        }
        #gamesMenu.gsize-sm .project-card .project-card-name {
            font-size: 11px;
        }
        #gamesMenu.gsize-sm .project-card .project-card-date {
            font-size: 10px;
        }
        /* add-game-card : m√™me taille que les autres cartes selon la grille */
        #gamesMenu.gsize-md .add-game-card {
            aspect-ratio: 1;
            height: auto;
        }
        #gamesMenu.gsize-sm .add-game-card {
            aspect-ratio: 1;
            height: auto;
        }

        /* Custom game card actions (like project cards) */
        .custom-game-actions {
            display: flex;
            gap: 4px;
            margin-top: 8px;
            justify-content: flex-end;
        }
        .custom-game-btn {
            background: rgba(124,58,237,0.15);
            border: 1px solid var(--border-subtle);
            color: var(--text-tertiary);
            width: 30px;
            height: 30px;
            border-radius: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.18s;
        }
        .custom-game-btn:hover { background: rgba(124,58,237,0.3); color: var(--text-primary); border-color: var(--primary-purple); }
        .custom-game-btn.danger:hover { background: rgba(239,68,68,0.2); border-color: #ef4444; color: #ef4444; }
        .custom-game-name-el {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            cursor: default;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .custom-game-name-el[title] { cursor: pointer; }

        /* ===== CUSTOM MINIGAMES ===== */
        .custom-game-card {
            position: relative;
        }
        .custom-game-thumb {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
            display: block;
            background: var(--bg-elevated);
        }
        .custom-game-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(239,68,68,0.85);
            border: none;
            color: white;
            width: 26px;
            height: 26px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s;
            z-index: 10;
        }
        .game-card:hover .custom-game-delete {
            opacity: 1;
        }
        .add-game-card {
            border: 2px dashed rgba(79,142,247,0.4);
            background: transparent;
        }
        .add-game-card:hover {
            border-color: rgba(79,142,247,0.8);
            background: rgba(79,142,247,0.05);
            transform: translateY(-4px);
        }
        .add-game-icon {
            font-size: 40px;
            color: var(--primary-purple);
        }
        .add-game-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Modal s√©lection projet pour mini-jeu */
        .proj-selector-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.45);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            display: none;
            align-items: stretch;
            justify-content: flex-end;
            z-index: 11000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .proj-selector-modal.active {
            display: flex;
            opacity: 1;
            pointer-events: all;
        }
        .proj-selector-box {
            background: #1a1a1e;
            border-left: 1px solid rgba(255,255,255,0.07);
            width: 75%;
            max-width: 780px;
            height: 100vh;
            overflow: hidden;
            box-shadow: -20px 0 60px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.16,1,0.3,1);
            position: relative;
        }
        .proj-selector-modal.active .proj-selector-box {
            transform: translateX(0);
        }
        .proj-selector-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 22px 20px 18px;
            border-bottom: 1px solid rgba(255,255,255,0.07);
            flex-shrink: 0;
            background: #1a1a1e;
            gap: 12px;
            position: relative;
        }
        .proj-selector-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: var(--font-sans);
            letter-spacing: 0.03em;
        }
        .proj-selector-close {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .proj-selector-close:hover { background: rgba(255,255,255,0.12); color: var(--text-primary); transform: rotate(90deg); }

        .proj-view-switcher {
            display: flex;
            align-items: center;
            gap: 2px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px;
            padding: 3px;
        }
        .proj-view-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            width: 30px;
            height: 30px;
            border-radius: 7px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        .proj-view-btn:hover { background: rgba(255,255,255,0.08); color: var(--text-primary); }
        .proj-view-btn.active { background: var(--primary-purple); color: #fff; }

        .proj-selector-list {
            overflow-y: auto;
            padding: 16px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            align-content: start;
        }
        .proj-selector-card {
            background: rgba(79,142,247,0.04);
            border: 1px solid rgba(79,142,247,0.2);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
        }
        .proj-selector-card:hover {
            border-color: rgba(79,142,247,0.7);
            background: rgba(79,142,247,0.1);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(79,142,247,0.2);
        }
        .proj-selector-thumb-wrap {
            width: 100%;
            aspect-ratio: 1;
            overflow: hidden;
            background: var(--bg-elevated);
            flex-shrink: 0;
        }
        .proj-selector-thumb {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .proj-selector-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 8px 10px;
            border-top: 1px solid rgba(255,255,255,0.06);
            flex-shrink: 0;
        }

        .game-canvas-container {
            background: #000;
            border-radius: 16px;
            padding: 20px;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .game-canvas-container.active {
            display: flex;
        }

        #gameCanvas {
            border: 3px solid var(--primary-purple);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(79, 142, 247, 0.45);
        }

        .game-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .game-btn {
            background: var(--primary-purple);
            color: white;
            border: 2px solid var(--purple-light);
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .game-btn:hover {
            background: var(--purple-dark);
            transform: scale(1.05);
        }

        .game-info {
            color: var(--text-secondary);
            font-family: var(--font-mono);
            font-size: 18px;
            font-weight: 600;
        }

        /* Loading Animation - New Generating Design */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: transparent;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            padding: 0;
            border-radius: 0;
            border: none;
            box-shadow: none;
            display: none;
            z-index: 1000;
        }

        .loading.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0;
            animation: loadingFadeIn 0.4s ease;
        }

        @keyframes loadingFadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        /* From Uiverse.io by dexter-st */
        .loader-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 180px;
            height: 180px;
            font-family: var(--font-sans);
            font-size: 1.2em;
            font-weight: 300;
            color: white;
            border-radius: 50%;
            background-color: transparent;
            user-select: none;
        }

        .loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 50%;
            background-color: transparent;
            animation: loader-rotate 2s linear infinite;
            z-index: 0;
        }

        @keyframes loader-rotate {
            0% {
                transform: rotate(90deg);
                box-shadow:
                    0 10px 20px 0 #fff inset,
                    0 20px 30px 0 #ad5fff inset,
                    0 60px 60px 0 #471eec inset;
            }
            50% {
                transform: rotate(270deg);
                box-shadow:
                    0 10px 20px 0 #fff inset,
                    0 20px 10px 0 #d60a47 inset,
                    0 40px 60px 0 #311e80 inset;
            }
            100% {
                transform: rotate(450deg);
                box-shadow:
                    0 10px 20px 0 #fff inset,
                    0 20px 30px 0 #ad5fff inset,
                    0 60px 60px 0 #471eec inset;
            }
        }

        .loader-letter {
            display: inline-block;
            opacity: 0.4;
            transform: translateY(0);
            animation: loader-letter-anim 2s infinite;
            z-index: 1;
            border-radius: 50ch;
            border: none;
        }

        .loader-letter:nth-child(1) {
            animation-delay: 0s;
        }

        .loader-letter:nth-child(2) {
            animation-delay: 0.1s;
        }

        .loader-letter:nth-child(3) {
            animation-delay: 0.2s;
        }

        .loader-letter:nth-child(4) {
            animation-delay: 0.3s;
        }

        .loader-letter:nth-child(5) {
            animation-delay: 0.4s;
        }

        .loader-letter:nth-child(6) {
            animation-delay: 0.5s;
        }

        .loader-letter:nth-child(7) {
            animation-delay: 0.6s;
        }

        .loader-letter:nth-child(8) {
            animation-delay: 0.7s;
        }

        .loader-letter:nth-child(9) {
            animation-delay: 0.8s;
        }

        .loader-letter:nth-child(10) {
            animation-delay: 0.9s;
        }

        @keyframes loader-letter-anim {
            0%,
            100% {
                opacity: 0.4;
                transform: translateY(0);
            }
            20% {
                opacity: 1;
                transform: scale(1.15);
            }
            40% {
                opacity: 0.7;
                transform: translateY(0);
            }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 110px;
            right: 32px;
            background: var(--bg-tertiary);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 2px solid var(--border-default);
            color: var(--text-primary);
            padding: 20px 28px;
            padding-left: 24px;
            border-radius: 16px;
            box-shadow: 
                0 0 0 1px rgba(255, 255, 255, 0.1),
                0 20px 60px rgba(0, 0, 0, 0.7),
                0 0 30px rgba(79, 142, 247, 0.25);
            font-weight: 600;
            font-size: 14px;
            z-index: 100000;
            animation: slideInRight 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            min-width: 320px;
            max-width: 400px;
            overflow: hidden;
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .notification::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            background: var(--primary-purple);
            box-shadow: 0 0 20px currentColor;
            border-radius: 16px 0 0 16px;
        }

        .notification::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary-purple), transparent);
            opacity: 0.6;
            animation: shimmerTop 3s ease-in-out infinite;
        }

        @keyframes shimmerTop {
            0%, 100% { opacity: 0.3; transform: translateX(-100%); }
            50% { opacity: 0.8; transform: translateX(100%); }
        }

        .notification-icon {
            font-size: 24px;
            flex-shrink: 0;
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            filter: drop-shadow(0 0 8px currentColor);
        }

        @keyframes bounceIn {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .notification-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .notification-title {
            font-weight: 800;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.9;
        }

        .notification-message {
            font-weight: 500;
            font-size: 14px;
            line-height: 1.4;
        }

        @keyframes slideInRight {
            0% {
                opacity: 0;
                transform: translateX(150px) scale(0.8) rotate(10deg);
            }
            100% {
                opacity: 1;
                transform: translateX(0) scale(1) rotate(0deg);
            }
        }

        @keyframes slideOutRight {
            0% {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateX(150px) scale(0.8);
            }
        }

        .notification.success::before { 
            background: linear-gradient(180deg, var(--accent-green), #059669);
            box-shadow: 0 0 20px var(--accent-green);
        }
        
        .notification.error::before { 
            background: linear-gradient(180deg, var(--accent-red), #dc2626);
            box-shadow: 0 0 20px var(--accent-red);
        }
        
        .notification.info::before { 
            background: linear-gradient(180deg, var(--primary-purple), var(--purple-dark));
            box-shadow: 0 0 20px var(--primary-purple);
        }

        .notification.success {
            border-color: rgba(16, 185, 129, 0.4);
            box-shadow: 
                0 0 0 1px rgba(16, 185, 129, 0.2),
                0 20px 60px rgba(0, 0, 0, 0.7),
                0 0 40px rgba(16, 185, 129, 0.3);
        }

        .notification.success .notification-icon {
            color: var(--accent-green);
        }

        .notification.error {
            border-color: rgba(239, 68, 68, 0.4);
            box-shadow: 
                0 0 0 1px rgba(239, 68, 68, 0.2),
                0 20px 60px rgba(0, 0, 0, 0.7),
                0 0 40px rgba(239, 68, 68, 0.3);
        }

        .notification.error .notification-icon {
            color: var(--accent-red);
        }

        .notification.info {
            border-color: rgba(79, 142, 247, 0.35);
            box-shadow: 
                0 0 0 1px rgba(79, 142, 247, 0.2),
                0 20px 60px rgba(0, 0, 0, 0.7),
                0 0 40px rgba(79, 142, 247, 0.35);
        }

        .notification.info .notification-icon {
            color: var(--primary-purple);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .logo-text {
                font-size: 24px;
            }

            .project-name, .tagline {
                display: none;
            }

            .header {
                padding: 16px 20px;
            }

            .settings-panel {
                width: 100%;
            }
        }

        /* ‚úÖ Accessibilit√© : touch targets minimum 44√ó44px sur mobile */
        @media (max-width: 768px) {
            button,
            .tab-btn,
            .control-btn,
            .menu-item,
            .btn,
            [role="button"] {
                min-height: 44px;
                min-width: 44px;
            }
        }

        /* ‚úÖ Accessibilit√© : focus visible pour navigation clavier */
        :focus-visible {
            outline: 2px solid var(--primary-purple);
            outline-offset: 2px;
            border-radius: 4px;
        }

        .project-name:focus-visible {
            outline: none !important;
            box-shadow: none !important;
        }

        /* ‚úÖ Skip link pour accessibilit√© */
        .skip-link {
            position: absolute;
            top: -100%;
            left: 8px;
            background: var(--primary-purple);
            color: #fff;
            padding: 8px 16px;
            border-radius: 0 0 8px 8px;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            z-index: 99999;
            transition: top 0.2s;
        }
        .skip-link:focus {
            top: 0;
        }

        /* ========== NOUVELLES FONCTIONNALIT√âS ========== */
        
        /* Theme Switcher */


        /* Templates Modal */
        .templates-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 10000;
            display: none;
            align-items: stretch;
            justify-content: flex-end;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .templates-modal.active {
            display: flex;
            opacity: 1;
            pointer-events: all;
        }

        .templates-content {
            background: #1a1a1e;
            border-left: 1px solid rgba(255,255,255,0.07);
            width: 75%;
            max-width: 780px;
            height: 100vh;
            overflow-y: auto;
            box-shadow: -20px 0 60px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.1) transparent;
        }

        .templates-modal.active .templates-content {
            transform: translateX(0);
        }

        .templates-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 22px 20px 18px;
            border-bottom: 1px solid rgba(255,255,255,0.07);
            flex-shrink: 0;
            background: #1a1a1e;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .templates-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: var(--font-sans);
            letter-spacing: 0.03em;
        }

        .templates-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 14px;
            padding: 24px;
        }

        .template-card {
            background: rgba(79,142,247,0.05);
            border: 1px solid rgba(79,142,247,0.25);
            border-radius: 12px;
            padding: 0;
            cursor: pointer;
            transition: all 0.2s ease;
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-align: center;
        }

        .template-card:hover {
            transform: translateY(-2px);
            border-color: rgba(79,142,247,0.7);
            background: rgba(79,142,247,0.1);
            box-shadow: 0 8px 24px rgba(79,142,247,0.2);
        }

        .template-icon {
            font-size: 38px;
        }

        .template-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-primary);
        }

        .template-desc {
            font-size: 11px;
            color: var(--text-tertiary);
            line-height: 1.3;
            padding: 0 8px;
        }

        /* Responsive Preview */
        .responsive-toolbar {
            display: none; /* Masquer par d√©faut, accessible via le menu */
            gap: 10px;
            padding: 10px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
            position: relative;
            z-index: 2;
        }

        /* Conteneur pour les previews responsive */
        .preview-wrapper {
            flex: 1;
            overflow: hidden;
            display: flex;
            align-items: stretch;
            justify-content: stretch;
            padding: 0;
            background-color: #0c0c0c;
            position: relative;
        }
        /* Grille visible uniquement en vue tablet/mobile */
        .preview-wrapper.show-grid {
            align-items: center;
            justify-content: center;
            padding: 20px;
            --grid-color: #1e1e1e;
            background-image: linear-gradient(
                0deg,
                transparent 24%,
                var(--grid-color) 25%,
                var(--grid-color) 26%,
                transparent 27%,
                transparent 74%,
                var(--grid-color) 75%,
                var(--grid-color) 76%,
                transparent 77%,
                transparent
            ),
            linear-gradient(
                90deg,
                transparent 24%,
                var(--grid-color) 25%,
                var(--grid-color) 26%,
                transparent 27%,
                transparent 74%,
                var(--grid-color) 75%,
                var(--grid-color) 76%,
                transparent 77%,
                transparent
            );
            background-size: 55px 55px;
        }

        .preview-wrapper::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
        }

        .preview-wrapper::-webkit-scrollbar-track {
            display: none !important;
        }

        .preview-wrapper::-webkit-scrollbar-thumb {
            display: none !important;
        }

        .preview-wrapper::-webkit-scrollbar-thumb:hover {
            display: none !important;
        }
        
        .preview-wrapper {
            scrollbar-width: none !important;
            -ms-overflow-style: none !important;
        }

        /* Container pour centrer et scaler les devices */
        .device-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            min-height: 400px;
        }

        /* Device Preview Mockups */
        .preview-section {
            position: relative;
        }

        .device-mockup {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            pointer-events: none;
        }

        .device-mockup.active {
            display: block;
            pointer-events: all;
        }

        /* Tablet Mockup */
        .tablet-mockup {
            width: 768px;
            height: 900px;
            background: linear-gradient(135deg, #1f1f1f, #2d2d2d);
            border-radius: 40px;
            padding: 60px 40px;
            box-shadow: 
                0 0 0 12px #0a0a0a,
                0 0 0 14px #333,
                0 30px 80px rgba(0,0,0,0.5);
            max-width: 80%;
            max-height: 80vh;
        }

        .tablet-mockup::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 6px;
            background: #444;
            border-radius: 3px;
        }

        .tablet-mockup::after {
            content: 'üì±';
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
        }

        .tablet-mockup iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 8px;
            background: white;
        }

        /* Mobile Mockup */
        .mobile-mockup {
            width: 375px;
            height: 667px;
            background: linear-gradient(135deg, #1a1a1a, #252525);
            border-radius: 45px;
            padding: 70px 20px 70px 20px;
            box-shadow: 
                0 0 0 8px #000,
                0 0 0 10px #222,
                0 25px 60px rgba(0,0,0,0.6);
            max-width: 90%;
            max-height: 85vh;
        }

        .mobile-mockup::before {
            content: '';
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 6px;
            background: #333;
            border-radius: 3px;
        }

        .mobile-mockup::after {
            content: '';
            position: absolute;
            top: 25px;
            right: 60px;
            width: 12px;
            height: 12px;
            background: #444;
            border-radius: 50%;
        }

        .mobile-mockup iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 4px;
            background: white;
        }

        .device-close-btn {
            position: absolute;
            top: -50px;
            right: 0;
            background: var(--primary-purple);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            pointer-events: all;
            z-index: 1000;
        }

        .device-close-btn:hover {
            background: var(--purple-dark);
            transform: translateY(-2px);
        }

        /* Desktop view stays as iframe */
        #preview.tablet-view,
        #preview.mobile-view {
            display: block;
            position: relative;
            flex: none;
            transform-origin: center center;
            overflow: hidden !important;
        }

        /* Cacher compl√®tement les scrollbars dans les vues mobile et tablette */
        #preview.mobile-view::-webkit-scrollbar,
        #preview.tablet-view::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
        }

        #preview.mobile-view,
        #preview.tablet-view {
            -ms-overflow-style: none !important;  /* IE and Edge */
            scrollbar-width: none !important;  /* Firefox */
        }

        /* S'assurer que le contenu de l'iframe n'affiche pas de scrollbars */
        #preview.mobile-view::after,
        #preview.tablet-view::after {
            pointer-events: none;
        }

        /* Mobile view with phone frame - TAILLE ENCORE PLUS R√âDUITE */
        #preview.mobile-view {
            width: 280px;
            height: 500px;
            margin: 0 auto;
            border: 10px solid #1f1f1f;
            border-top-width: 14px;
            border-bottom-width: 14px;
            border-radius: 30px;
            position: relative;
            background: #000;
            box-shadow: 
                inset 0 0 0 2px #2a2a2a,
                0 0 0 2px rgba(255, 255, 255, 0.1),
                0 20px 50px rgba(0, 0, 0, 0.7);
        }

        /* Notch de l'iPhone */
        #preview.mobile-view::before {
            content: '';
            position: absolute;
            top: -14px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 20px;
            background: #1f1f1f;
            border-radius: 0 0 14px 14px;
            z-index: 10;
        }

        /* Capteur/haut-parleur */
        #preview.mobile-view::after {
            content: '';
            position: absolute;
            top: -9px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 4px;
            background: #0a0a0a;
            border-radius: 2px;
            z-index: 11;
        }

        /* Tablet view with tablet frame - TAILLE R√âDUITE */
        #preview.tablet-view {
            width: 700px;
            height: 500px;
            margin: 0 auto;
            border: 35px solid #2a2a2a;
            border-top-width: 45px;
            border-bottom-width: 45px;
            border-radius: 30px;
            position: relative;
            background: #000;
            box-shadow: 
                inset 0 0 0 3px #3a3a3a,
                0 0 0 2px rgba(255, 255, 255, 0.1),
                0 30px 70px rgba(0, 0, 0, 0.7);
        }

        /* Cam√©ra de la tablette */
        #preview.tablet-view::before {
            content: '';
            position: absolute;
            top: -28px;
            left: 50%;
            transform: translateX(-50%);
            width: 9px;
            height: 9px;
            border-radius: 50%;
            background: radial-gradient(circle, #1a1a1a 40%, #0a0a0a 100%);
            border: 2px solid #0a0a0a;
            z-index: 10;
        }

        /* Bouton home de la tablette */
        #preview.tablet-view::after {
            content: '';
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 45px;
            height: 45px;
            border: 3px solid #1a1a1a;
            border-radius: 50%;
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            box-shadow: 
                inset 0 2px 4px rgba(255, 255, 255, 0.1),
                0 2px 8px rgba(0, 0, 0, 0.5);
            z-index: 11;
        }

        /* Adaptation responsive avec media queries */
        @media (max-height: 800px) {
            #preview.tablet-view {
                transform: scale(0.8);
            }
            #preview.mobile-view {
                transform: scale(0.85);
            }
        }

        @media (max-height: 650px) {
            #preview.tablet-view {
                transform: scale(0.65);
            }
            #preview.mobile-view {
                transform: scale(0.7);
            }
        }

        @media (max-height: 550px) {
            #preview.mobile-view {
                transform: scale(0.6);
            }
        }

        @media (max-width: 900px) {
            #preview.tablet-view {
                transform: scale(0.7);
            }
        }

        @media (max-width: 500px) {
            #preview.mobile-view {
                transform: scale(0.75);
            }
        }

        .device-btn {
            background: var(--surface-glass);
            border: 1px solid var(--border-default);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-primary);
        }

        .device-btn:hover {
            background: var(--surface-hover);
            border-color: var(--primary-purple);
        }

        .device-btn.active {
            background: var(--primary-purple);
            color: white;
            border-color: var(--primary-purple);
        }

        /* Share Modal */
        .share-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 10000;
            display: none;
            align-items: stretch;
            justify-content: flex-end;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .share-modal.active {
            display: flex;
            opacity: 1;
            pointer-events: all;
        }

        .share-content {
            background: #1a1a1e;
            border-left: 1px solid rgba(255,255,255,0.07);
            width: 55%;
            max-width: 520px;
            height: 100vh;
            overflow-y: auto;
            box-shadow: -20px 0 60px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.1) transparent;
            position: relative;
        }

        .share-modal.active .share-content {
            transform: translateX(0);
        }

        .share-url {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.08);
            padding: 14px 16px;
            border-radius: 10px;
            word-break: break-all;
            font-family: var(--font-mono);
            font-size: 11px;
            line-height: 1.6;
            max-height: 200px;
            overflow-y: auto;
            color: var(--text-secondary);
        }

        #qrcode {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 16px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            min-height: 200px;
        }

        #qrcode canvas { display: block !important; margin: 0 auto; }
        #qrcode img { display: block !important; margin: 0 auto; }

        /* Tutorial Overlay */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .tutorial-overlay.active {
            display: flex;
        }

        .tutorial-content {
            background: var(--bg-primary);
            border: 2px solid var(--border-default);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            text-align: center;
        }

        .tutorial-step {
            display: none;
        }

        .tutorial-step.active {
            display: block;
        }

        .tutorial-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 30px;
        }

        /* Shortcuts Help Modal */
        .shortcuts-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 10000;
            display: none;
            align-items: stretch;
            justify-content: flex-end;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .shortcuts-modal.active {
            display: flex;
            opacity: 1;
            pointer-events: all;
        }

        .shortcuts-content {
            background: #1a1a1e;
            border-left: 1px solid rgba(255,255,255,0.07);
            width: 75%;
            max-width: 780px;
            height: 100vh;
            overflow-y: auto;
            box-shadow: -20px 0 60px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.1) transparent;
        }

        .shortcuts-modal.active .shortcuts-content {
            transform: translateX(0);
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            margin: 2px 0;
            background: transparent;
            border-radius: 8px;
            border: none;
            transition: background 0.15s;
        }

        .shortcut-item:hover {
            background: rgba(255,255,255,0.04);
        }

        .shortcut-keys {
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 3px 10px;
            border-radius: 6px;
            font-family: var(--font-mono);
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Code Editor Line Numbers */
        .editor-with-lines {
            display: flex;
            height: 100%;
        }

        .line-numbers {
            background: var(--bg-secondary);
            padding: 22px 10px;
            border-right: 1px solid var(--border-subtle);
            font-family: var(--font-mono);
            font-size: 14px;
            line-height: 1.8;
            color: var(--text-tertiary);
            text-align: right;
            user-select: none;
            min-width: 50px;
        }

        /* Find & Replace Panel */
        .find-replace-panel {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
            padding: 10px 20px;
            display: none;
            gap: 10px;
            align-items: center;
        }

        .find-replace-panel.active {
            display: flex;
        }

        .find-input, .replace-input {
            background: var(--surface-glass);
            border: 1px solid var(--border-default);
            padding: 8px 12px;
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            outline: none;
        }

        .find-input:focus, .replace-input:focus {
            border-color: var(--primary-purple);
        }

        /* Enhanced Console */
        .console-log.warn {
            color: var(--accent-amber);
            border-left-color: var(--accent-amber);
            background: rgba(245, 158, 11, 0.1);
        }

        .console-log.error {
            border-left-color: var(--accent-red);
            background: rgba(239, 68, 68, 0.08);
        }

        .console-timestamp {
            color: var(--text-tertiary);
            font-size: 10px;
            margin-right: 10px;
        }

        .console-clear-btn {
            background: var(--surface-glass);
            border: 1px solid var(--border-default);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s;
        }

        .console-clear-btn:hover {
            background: var(--accent-red);
            color: white;
        }

        /* Pulsation badge erreur sur le bouton Console */
        @keyframes errorPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.5); }
            50%       { box-shadow: 0 0 0 4px rgba(239,68,68,0); }
        }

        .control-btn[style*="ef4444"] {
            animation: errorPulse 1.5s ease-in-out infinite;
        }

        /* Console entry apparition anim√©e */
        @keyframes consoleFadeIn {
            from { opacity: 0; transform: translateX(-6px); }
            to   { opacity: 1; transform: translateX(0); }
        }

        .console-content .console-log {
            animation: consoleFadeIn 0.15s ease;
        }

        /* Scrollbar visible dans la console */
        .console-content::-webkit-scrollbar {
            width: 4px !important;
            display: block !important;
        }
        .console-content::-webkit-scrollbar-track { background: transparent; }
        .console-content::-webkit-scrollbar-thumb { background: var(--border-default); border-radius: 4px; }

        /* Filtres console */
        .console-filters { display: flex; gap: 4px; }
        .console-filter-btn {
            background: none; border: 1px solid var(--border-subtle);
            border-radius: 4px; padding: 2px 8px; font-size: 10px;
            color: var(--text-tertiary); cursor: pointer; transition: all 0.2s;
            font-family: var(--font-sans);
        }
        .console-filter-btn:hover { border-color: var(--primary-purple); color: var(--text-primary); }
        .console-filter-btn.active { background: var(--primary-purple); color: #fff; border-color: var(--primary-purple); }

        /* Recherche console */
        .console-search-input {
            background: var(--bg-tertiary); border: 1px solid var(--border-default);
            border-radius: 6px; padding: 3px 10px; font-size: 11px;
            color: var(--text-primary); outline: none; width: 160px;
            font-family: var(--font-mono);
        }
        .console-search-input:focus { border-color: var(--primary-purple); }

        /* Log cliquable pour copier */
        .console-log { cursor: pointer; transition: background 0.15s; }
        .console-log:hover { background: rgba(167,139,250,0.08); }
        .console-log.copied { background: rgba(16,185,129,0.15) !important; }

        /* Mode focus */
        body.focus-mode .toolbar,
        body.focus-mode .preview-section,
        body.focus-mode .tabs-bar { display: none !important; }
        body.focus-mode .editor-section { width: 100% !important; max-width: 100% !important; }
        body.focus-mode #focusModeBtn { color: var(--accent-green); }

        /* Th√®mes √©diteur */
        .editor-theme-btn {
            padding: 5px 12px; border: 1px solid var(--border-subtle);
            border-radius: 6px; cursor: pointer; font-size: 11px;
            background: none; color: var(--text-secondary); transition: all 0.2s;
            font-family: var(--font-mono);
        }
        .editor-theme-btn:hover { border-color: var(--primary-purple); color: var(--text-primary); }
        .editor-theme-btn.active { background: var(--primary-purple); color: #fff; border-color: var(--primary-purple); }

        /* Historique */
        .history-entry {
            padding: 4px 8px; border-radius: 4px; font-size: 10px;
            font-family: var(--font-mono); color: var(--text-tertiary);
            border-left: 2px solid var(--border-subtle); margin-bottom: 4px;
            cursor: pointer; transition: all 0.15s;
        }
        .history-entry:hover { border-color: var(--primary-purple); color: var(--text-primary); background: var(--surface-glass); }
        .history-entry.has-error { border-color: #ef4444; color: #ef4444; }
        .history-entry.success { border-color: #10b981; }

        /* Badge ligne cliquable dans la console */
        .console-line-badge {
            display: inline-block;
            margin-left: 10px;
            padding: 1px 8px;
            background: rgba(79, 142, 247, 0.2);
            border: 1px solid rgba(79, 142, 247, 0.45);
            border-radius: 4px;
            font-size: 10px;
            color: #a78bfa;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            vertical-align: middle;
        }
        .console-line-badge:hover {
            background: rgba(79, 142, 247, 0.45);
            color: #fff;
            transform: scale(1.05);
            box-shadow: 0 0 8px rgba(79, 142, 247, 0.35);
        }

        /* Ligne d'erreur surlign√©e dans CodeMirror */
        .cm-error-line {
            background: rgba(239, 68, 68, 0.18) !important;
            border-left: 3px solid #ef4444 !important;
            animation: errorLineFlash 0.4s ease 3;
        }
        /* Soulignements linter */
        .scrix-underline-error {
            text-decoration: underline wavy #f87171 !important;
            text-underline-offset: 3px;
        }
        .scrix-underline-warning {
            text-decoration: underline wavy #fbbf24 !important;
            text-underline-offset: 3px;
        }
        .scrix-underline-info {
            text-decoration: underline wavy #60a5fa !important;
            text-underline-offset: 3px;
        }
        @keyframes errorLineFlash {
            0%, 100% { background: rgba(239, 68, 68, 0.18); }
            50%       { background: rgba(239, 68, 68, 0.38); }
        }

        /* Projects Manager */
        .projects-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            display: none;
            align-items: stretch;
            justify-content: flex-end;
            z-index: 5000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .projects-panel.active {
            display: flex;
            opacity: 1;
            pointer-events: all;
        }

        .projects-panel-inner {
            background: #1a1a1e;
            border-left: 1px solid rgba(255,255,255,0.07);
            width: 75%;
            max-width: 780px;
            height: 100vh;
            overflow: hidden;
            box-shadow: -20px 0 60px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .projects-panel.active .projects-panel-inner {
            transform: translateX(0);
        }

        .projects-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 22px 20px 18px;
            border-bottom: 1px solid rgba(255,255,255,0.07);
            gap: 12px;
            flex-shrink: 0;
            background: #1a1a1e;
            position: relative;
        }

        /* ===== SIZE SELECTOR BUTTONS ===== */
        .projects-size-btns {
            display: flex;
            gap: 4px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 10px;
            padding: 4px;
        }

        .proj-size-btn {
            background: transparent;
            border: none;
            color: var(--text-tertiary);
            width: 30px;
            height: 30px;
            border-radius: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .proj-size-btn:hover {
            background: rgba(255,255,255,0.07);
            color: var(--text-primary);
        }

        .proj-size-btn.active {
            background: var(--primary-purple);
            color: #fff;
        }

        /* Bouton changer image ‚Äî appara√Æt au hover sur la miniature */
        .proj-change-img-btn {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0,0,0,0.65);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease, background 0.2s ease;
            z-index: 10;
        }
        .project-card:hover .proj-change-img-btn {
            opacity: 1;
        }
        .proj-change-img-btn:hover {
            background: var(--primary-purple);
            border-color: var(--primary-purple);
        }

        /* Fix layout card-body */
        .project-card-body {
            padding: 10px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            flex: 1;
            background: rgba(255,255,255,0.02);
        }
        .project-card-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .project-card-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }
        .project-card-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.08);
            color: var(--text-tertiary);
            width: 28px;
            height: 28px;
            padding: 0;
            border-radius: 7px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .project-card-btn:hover {
            background: rgba(255,255,255,0.06);
            border-color: var(--primary-purple);
            color: var(--primary-purple);
            transform: translateY(-1px);
        }
        .project-card-btn.danger:hover {
            background: rgba(239,68,68,0.12);
            border-color: rgba(239,68,68,0.5);
            color: #ef4444;
        }
        #projectsList.size-xl {
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        #projectsList.size-xl .project-card-thumb { height: 190px; }

        #projectsList.size-md {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 14px;
        }

        #projectsList.size-sm {
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }
        #projectsList.size-sm .project-card-thumb { height: 90px; font-size: 20px; }
        #projectsList.size-sm .project-card-name { font-size: 12px; }
        #projectsList.size-sm .project-card-date { font-size: 10px; }
        #projectsList.size-sm .project-card-body { padding: 8px 10px; }
        #projectsList.size-sm .project-card-actions { gap: 3px; }

        #projectsList.size-list {
            grid-template-columns: 1fr;
            gap: 6px;
        }
        #projectsList.size-list .project-card {
            flex-direction: row;
            border-radius: 10px;
        }
        #projectsList.size-list .project-card-thumb {
            width: 100px;
            height: auto;
            align-self: stretch;
            flex-shrink: 0;
            border-bottom: none;
            border-right: 1px solid rgba(255,255,255,0.07);
            border-radius: 0;
            font-size: 18px;
        }
        #projectsList.size-list .project-card-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        #projectsList.size-list .project-card-body {
            flex: 1;
            padding: 10px 14px;
        }
        #projectsList.size-list .project-card-name { font-size: 13px; margin-bottom: 1px; }
        #projectsList.size-list .project-card-date { font-size: 11px; }

        .projects-modal-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: var(--font-sans);
            letter-spacing: 0.03em;
        }

        .projects-modal-close {
            width: 32px;
            height: 32px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            color: var(--text-tertiary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
            font-family: var(--font-sans);
            flex-shrink: 0;
        }

        .projects-modal-close:hover {
            background: rgba(255,255,255,0.09);
            color: var(--text-primary);
            border-color: rgba(255,255,255,0.14);
        }

        .projects-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.1) transparent;
        }

        /* ===== PROJECTS GRID ===== */
        #projectsList {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 14px;
        }

        .project-card {
            background: rgba(79,142,247,0.04);
            border: 1px solid rgba(79,142,247,0.25);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .project-card:hover {
            border-color: rgba(79, 142, 247, 0.7);
            background: rgba(79,142,247,0.1);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(79,142,247,0.2);
        }

        .project-card-thumb {
            width: 100%;
            height: 130px;
            background: rgba(79, 142, 247, 0.06);
            border-bottom: 1px solid rgba(255,255,255,0.07);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
        }

        .project-card-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .project-card-thumb-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, transparent 50%, rgba(0,0,0,0.5) 100%);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .project-card:hover .project-card-thumb-overlay {
            opacity: 1;
        }

        .project-card-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-card-date {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .delete-project-btn:hover svg {
            stroke: #ff6b6b;
            filter: drop-shadow(0 0 4px rgba(239,68,68,0.6));
        }

        .delete-project-btn:active {
            transform: scale(0.95);
        }



        /* ===== PROFILE PANEL ===== */
        .profile-panel {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 75%;
            max-width: 780px;
            background: #1a1a1e;
            border-left: 1px solid rgba(255,255,255,0.07);
            box-shadow: -20px 0 60px rgba(0,0,0,0.6);
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .profile-panel.active {
            transform: translateX(0);
            opacity: 1;
            pointer-events: all;
        }
        .profile-panel-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 9999;
            display: none;
        }
        .profile-panel-overlay.active { display: block; }

        /* ‚îÄ‚îÄ HEADER PROFIL ‚îÄ‚îÄ */
        .profile-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 22px 20px 18px;
            border-bottom: 1px solid rgba(255,255,255,0.07);
            flex-shrink: 0;
            background: #1a1a1e;
            gap: 12px;
        }
        .profile-header-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: var(--font-sans);
        }
        /* ‚îÄ‚îÄ CLOSE BTN ‚îÄ‚îÄ */
        .profile-close-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.08);
            color: var(--text-tertiary);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .profile-close-btn:hover {
            background: rgba(255,255,255,0.09);
            color: var(--text-primary);
            border-color: rgba(255,255,255,0.14);
        }

        /* ‚îÄ‚îÄ BANNER ‚îÄ‚îÄ */
        .profile-banner {
            width: 100%;
            height: 240px;
            background: linear-gradient(135deg, #1a0a2e 0%, #2d1060 50%, #0f0829 100%);
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        .profile-banner img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center 30%;
            display: block;
        }
        .profile-banner-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .profile-banner:hover .profile-banner-overlay { opacity: 1; }
        .profile-banner-overlay span {
            font-size: 12px;
            color: white;
            font-weight: 600;
            background: rgba(0,0,0,0.5);
            padding: 4px 10px;
            border-radius: 6px;
        }

        /* ‚îÄ‚îÄ AVATAR AREA ‚îÄ‚îÄ */
        .profile-avatar-row {
            display: flex;
            align-items: flex-end;
            padding: 0 18px;
            margin-top: -40px;
            margin-bottom: 10px;
            position: relative;
        }
        .profile-avatar-wrap {
            position: relative;
            width: 80px;
            height: 80px;
            flex-shrink: 0;
            cursor: pointer;
        }
        .profile-avatar-wrap:hover #avatarOverlay { opacity: 1 !important; }
        .profile-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid var(--bg-secondary);
            object-fit: cover;
            box-shadow: 0 0 0 2px var(--primary-purple);
            display: block;
        }
        .profile-avatar-fallback-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid var(--bg-secondary);
            background: linear-gradient(135deg, var(--primary-purple), var(--accent-pink));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 700;
            color: white;
            box-shadow: 0 0 0 2px var(--primary-purple);
        }

        /* ‚îÄ‚îÄ BODY ‚îÄ‚îÄ */
        .profile-body {
            padding: 0 24px 24px;
            overflow-y: hidden;
            flex: 1;
        }
        .profile-username-field {
            font-size: 18px;
            font-weight: 800;
            color: var(--text-primary);
            background: rgba(255,255,255,0.05);
            border: 1.5px solid rgba(255,255,255,0.08);
            border-radius: 10px;
            outline: none;
            width: 100%;
            font-family: var(--font-sans);
            padding: 10px 14px;
            margin-bottom: 10px;
            transition: border-color 0.2s, background 0.2s;
            box-sizing: border-box;
        }
        .profile-username-field:focus {
            border-color: var(--primary-purple);
            background: rgba(124,58,237,0.08);
        }
        .profile-username-field::placeholder { color: var(--text-tertiary); }
        .profile-bio-field {
            font-size: 13px;
            color: var(--text-secondary);
            background: rgba(255,255,255,0.05);
            border: 1.5px solid rgba(255,255,255,0.08);
            border-radius: 10px;
            outline: none;
            width: 100%;
            resize: none;
            font-family: var(--font-sans);
            line-height: 1.5;
            padding: 10px 14px;
            min-height: 90px;
            margin-bottom: 14px;
            transition: border-color 0.2s, background 0.2s;
            box-sizing: border-box;
        }
        .profile-bio-field:focus {
            border-color: var(--primary-purple);
            background: rgba(124,58,237,0.08);
        }
        .profile-bio-field::placeholder { color: var(--text-tertiary); }

        .profile-compte-box {
            background: rgba(124,58,237,0.08);
            border: 1px solid rgba(124,58,237,0.2);
            border-radius: 10px;
            padding: 12px 14px;
            margin-bottom: 14px;
        }
        .profile-compte-label {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .profile-compte-text {
            font-size: 12px;
            color: var(--text-tertiary);
            line-height: 1.5;
        }

        .profile-actions {
            display: flex;
            gap: 10px;
        }
        .profile-btn-save {
            flex: 1;
            padding: 11px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, var(--primary-purple), var(--purple-dark));
            color: white;
            font-size: 13px;
            font-weight: 700;
            font-family: var(--font-sans);
            cursor: pointer;
            transition: all 0.2s;
        }
        .profile-btn-save:hover { transform: translateY(-1px); box-shadow: 0 4px 16px var(--purple-glow); }
        .profile-btn-logout {
            flex: 1;
            padding: 11px;
            border-radius: 10px;
            border: 1.5px solid var(--border-default);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 700;
            font-family: var(--font-sans);
            cursor: pointer;
            transition: all 0.2s;
        }
        .profile-btn-logout:hover {
            background: rgba(239,68,68,0.12);
            border-color: rgba(239,68,68,0.4);
            color: #ef4444;
        }
        .profile-display-name { display: none; }
        .profile-email { display: none; }
        /* ===== LOGIN MODAL UIVERSE ===== */
        .login-modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 20000;
            animation: fadeIn 0.3s ease;
        }
        .login-modal-overlay.active {
            display: flex;
        }
        #loginModalOverlay .form {
            display: flex;
            flex-direction: column;
            gap: 14px;
            padding-left: 2.8em;
            padding-right: 2.8em;
            padding-bottom: 0.4em;
            background-color: #171717;
            border-radius: 25px;
            transition: 0.4s ease-in-out;
            min-width: 340px;
        }
        #loginModalOverlay .card {
            background-image: linear-gradient(163deg, #00ff75 0%, #3700ff 100%);
            border-radius: 22px;
            transition: all 0.3s;
            animation: slideInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #loginModalOverlay .card2 {
            border-radius: 0;
            transition: all 0.2s;
        }
        #loginModalOverlay .card2:hover {
            transform: scale(0.98);
            border-radius: 20px;
        }
        #loginModalOverlay .card:hover {
            box-shadow: 0px 0px 30px 1px rgba(0, 255, 117, 0.3);
        }
        #loginModalOverlay #headingLogin,
        #loginModalOverlay #headingSignup,
        #loginModalOverlay #headingReset {
            text-align: center;
            margin: 2.2em;
            color: rgb(255, 255, 255);
            font-size: 1.5em;
            font-family: var(--font-sans);
        }
        #loginModalOverlay .field {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5em;
            border-radius: 25px;
            padding: 0.85em;
            border: none;
            outline: none;
            color: white;
            background-color: #171717;
            box-shadow: inset 2px 5px 10px rgb(5, 5, 5);
        }
        #loginModalOverlay .input-icon {
            height: 1.3em;
            width: 1.3em;
            fill: white;
            flex-shrink: 0;
        }
        #loginModalOverlay .input-field {
            background: none;
            border: none;
            outline: none;
            width: 100%;
            color: #d3d3d3;
            font-size: 16px;
        }
        #loginModalOverlay .form .btn {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: row;
            gap: 8px;
            margin-top: 2.5em;
            background: none;
            border: none;
            padding: 0;
            box-shadow: none;
            backdrop-filter: none;
            position: static;
            overflow: visible;
            transform: none;
        }
        #loginModalOverlay .form .btn::before { display: none; }
        #loginModalOverlay .form .btn:hover { transform: none; box-shadow: none; }
        #loginModalOverlay .button1 {
            padding: 0.7em 1.6em;
            border-radius: 5px;
            border: none;
            outline: none;
            transition: 0.4s ease-in-out;
            background-color: #252525;
            color: white;
            cursor: pointer;
            font-size: 15px;
            font-family: var(--font-sans);
        }
        #loginModalOverlay .button1:hover {
            background-color: black;
            color: white;
            transform: none;
            box-shadow: none;
        }
        #loginModalOverlay .button2 {
            padding: 0.7em 3em;
            border-radius: 5px;
            border: none;
            outline: none;
            transition: 0.4s ease-in-out;
            background-color: #252525;
            color: white;
            cursor: pointer;
            font-size: 15px;
            font-family: var(--font-sans);
        }
        #loginModalOverlay .button2:hover {
            background-color: black;
            color: white;
            transform: none;
            box-shadow: none;
        }
        #loginModalOverlay .button3 {
            margin-bottom: 3em;
            padding: 0.75em;
            border-radius: 5px;
            border: none;
            outline: none;
            transition: 0.4s ease-in-out;
            background-color: #252525;
            color: white;
            cursor: pointer;
            font-size: 15px;
            font-family: var(--font-sans);
            width: 100%;
        }
        #loginModalOverlay .button3:hover {
            background-color: red;
            color: white;
            transform: none;
            box-shadow: none;
        }

        .profile-not-connected {
            padding: 32px 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .profile-not-connected p {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        /* Uiverse card login */
        .login-card-wrap {
            background-image: linear-gradient(163deg, #00ff75 0%, #3700ff 100%);
            border-radius: 22px;
            transition: all 0.3s;
            width: 100%;
            max-width: 300px;
        }
        .login-card-wrap:hover {
            box-shadow: 0px 0px 30px 1px rgba(0, 255, 117, 0.3);
        }
        .login-card-inner {
            background-color: #171717;
            border-radius: 20px;
            transition: all 0.2s;
            padding: 28px 22px 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 14px;
        }
        .login-card-inner:hover {
            transform: scale(0.98);
        }
        .login-card-icon {
            font-size: 48px;
        }
        .login-card-title {
            font-size: 17px;
            font-weight: 700;
            color: white;
            margin: 0;
            text-align: center;
        }
        .login-card-desc {
            font-size: 13px;
            color: #aaa;
            text-align: center;
            line-height: 1.5;
            margin: 0;
        }
        .profile-section {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-subtle);
        }
        .profile-section-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-tertiary);
            margin-bottom: 14px;
        }
        .profile-field {
            margin-bottom: 16px;
        }
        .profile-field label {
            display: block;
            font-size: 12px;
            color: var(--text-tertiary);
            margin-bottom: 6px;
            font-weight: 600;
        }
        .profile-input {
            width: 100%;
            background: rgba(124,58,237,0.08);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 10px 14px;
            color: var(--text-primary);
            font-family: var(--font-sans);
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
            box-sizing: border-box;
        }
        .profile-input:focus {
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 3px rgba(124,58,237,0.15);
        }
        .profile-input::placeholder { color: var(--text-tertiary); }
        textarea.profile-input {
            resize: vertical;
            min-height: 90px;
            line-height: 1.5;
        }
        .profile-save-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--primary-purple), var(--purple-dark));
            border: none;
            border-radius: 10px;
            padding: 11px;
            color: white;
            font-family: var(--font-sans);
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        .profile-save-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(124,58,237,0.4);
        }
        .profile-logout-btn {
            width: 100%;
            background: rgba(239,68,68,0.08);
            border: 1px solid rgba(239,68,68,0.3);
            border-radius: 10px;
            padding: 11px;
            color: #ef4444;
            font-family: var(--font-sans);
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }
        .profile-logout-btn:hover {
            background: rgba(239,68,68,0.18);
            border-color: rgba(239,68,68,0.6);
        }
        .profile-google-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background-color: #252525;
            border: none;
            border-radius: 5px;
            padding: 11px 18px;
            color: white;
            font-family: var(--font-sans);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.4s ease-in-out;
        }
        .profile-google-btn:hover {
            background-color: black;
            color: white;
        }
        .profile-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .profile-stat-card {
            background: rgba(124,58,237,0.08);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 14px;
            text-align: center;
        }
        .profile-stat-value {
            font-size: 22px;
            font-weight: 800;
            color: var(--text-secondary);
        }
        .profile-stat-label {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 2px;
        }

        /* ===== GOOGLE AUTH BUTTON ===== */
        .auth-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.15);
            color: var(--text-primary);
            font-family: var(--font-sans);
            font-size: 13px;
            font-weight: 600;
            padding: 7px 14px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .auth-btn:hover {
            background: rgba(255,255,255,0.13);
            border-color: rgba(255,255,255,0.28);
            transform: translateY(-1px);
            box-shadow: 0 4px 14px rgba(0,0,0,0.25);
        }
        .auth-btn svg { flex-shrink: 0; }

        .auth-user-pill {
            display: flex;
            align-items: center;
            gap: 9px;
            background: rgba(124,58,237,0.12);
            border: 1px solid rgba(124,58,237,0.3);
            border-radius: 50px;
            padding: 4px 12px 4px 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .auth-user-pill:hover { background: rgba(124,58,237,0.22); border-color: rgba(124,58,237,0.5); }
        .auth-user-pill:hover .auth-logout-hint { opacity: 1; }

        .auth-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--primary-purple);
            object-fit: cover;
            flex-shrink: 0;
        }
        .auth-avatar-fallback {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--primary-purple);
            background: linear-gradient(135deg, var(--primary-purple), var(--accent-pink));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
        }
        .auth-username {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .auth-sync-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--accent-green);
            box-shadow: 0 0 6px var(--accent-green);
            animation: syncPulse 2s ease-in-out infinite;
        }
        @keyframes syncPulse {
            0%,100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }
        .auth-logout-hint {
            position: absolute;
            bottom: -28px;
            right: 0;
            background: rgba(239,68,68,0.9);
            color: white;
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 6px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            white-space: nowrap;
        }

        /* Indicateur de sync sur le panel projets */
        .sync-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: var(--accent-green);
            background: rgba(16,185,129,0.1);
            border: 1px solid rgba(16,185,129,0.25);
            border-radius: 20px;
            padding: 2px 8px;
            margin-left: 8px;
        }
        .sync-badge-off {
            color: var(--text-tertiary);
            background: rgba(156,163,175,0.08);
            border-color: rgba(156,163,175,0.15);
        }

        /* Export Options Modal */
        .export-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 10000;
            display: none;
            align-items: stretch;
            justify-content: flex-end;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .export-modal.active {
            display: flex;
            opacity: 1;
            pointer-events: all;
        }

        .export-content {
            background: #1a1a1e;
            border-left: 1px solid rgba(255,255,255,0.07);
            width: 55%;
            max-width: 520px;
            height: 100vh;
            overflow-y: auto;
            box-shadow: -20px 0 60px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.1) transparent;
        }

        .export-modal.active .export-content {
            transform: translateX(0);
        }

        .export-option {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 10px;
            padding: 14px 16px;
            margin: 0 20px 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .export-option:hover {
            background: rgba(255,255,255,0.06);
            border-color: rgba(79,142,247,0.4);
            transform: translateX(4px);
        }

        .export-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .export-info h3 {
            margin-bottom: 2px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .export-info p {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* Snippets Panel */
        .snippets-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 10000;
            display: none;
            align-items: stretch;
            justify-content: flex-end;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .snippets-modal.active {
            display: flex;
            opacity: 1;
            pointer-events: all;
        }

        .snippets-content {
            background: #1a1a1e;
            border-left: 1px solid rgba(255,255,255,0.07);
            width: 55%;
            max-width: 520px;
            height: 100vh;
            overflow-y: auto;
            box-shadow: -20px 0 60px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.1) transparent;
        }

        .snippets-modal.active .snippets-content {
            transform: translateX(0);
        }

        .snippet-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 10px;
            padding: 12px 14px;
            margin: 0 20px 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .snippet-item:hover {
            background: rgba(255,255,255,0.06);
            border-color: rgba(79,142,247,0.4);
        }

        .snippet-title {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .snippet-code {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.06);
            padding: 8px 10px;
            border-radius: 6px;
            font-family: var(--font-mono);
            font-size: 11px;
            overflow-x: auto;
            color: var(--text-secondary);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ========== MENU HAMBURGER PROFESSIONNEL ========== */
        
        .menu-btn {
            padding: 11px 16px !important;
            position: relative;
        }

        .menu-icon {
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 20px;
        }

        .menu-icon span {
            display: block;
            height: 2px;
            background: var(--text-primary);
            border-radius: 2px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .menu-btn:hover .menu-icon span {
            background: var(--primary-purple);
        }

        .menu-btn.active .menu-icon span:nth-child(1) {
            transform: rotate(45deg) translateY(9px);
        }

        .menu-btn.active .menu-icon span:nth-child(2) {
            opacity: 0;
        }

        .menu-btn.active .menu-icon span:nth-child(3) {
            transform: rotate(-45deg) translateY(-9px);
        }

        /* ===== NEXTMOVE-STYLE SIDEBAR MENU ===== */

        /* Overlay backdrop */
        .menu-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 99998;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .menu-overlay.active {
            display: block;
            opacity: 1;
        }

        /* Settings overlay backdrop ‚Äî same as menu */
        .settings-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 99998;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .settings-overlay.active {
            display: block;
            opacity: 1;
        }

        /* Sidebar panel */
        .dropdown-menu {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 280px;
            background: #1a1a1e;
            border-left: 1px solid rgba(255,255,255,0.07);
            box-shadow: -20px 0 60px rgba(0,0,0,0.6);
            z-index: 99999;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .dropdown-menu::-webkit-scrollbar { display: none; }

        .dropdown-menu.active {
            transform: translateX(0);
        }

        /* Sidebar header ‚Äî logo row */
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 22px 20px 18px;
            border-bottom: 1px solid rgba(255,255,255,0.07);
        }
        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sidebar-brand-icon {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #2a1a2e, #1e1020);
            border: 1px solid rgba(79, 142, 247, 0.35);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(79,142,247,0.2);
        }
        .sidebar-brand-icon svg { width: 14px; height: 14px; }
        .sidebar-brand-name {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: 0.03em;
            font-family: var(--font-sans);
        }
        .sidebar-close-btn {
            width: 32px;
            height: 32px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            color: var(--text-tertiary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .sidebar-close-btn:hover {
            background: rgba(255,255,255,0.09);
            color: var(--text-primary);
            border-color: rgba(255,255,255,0.14);
        }

        /* Workspace selector */
        .sidebar-workspace {
            margin: 14px 12px 6px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.09);
            border-radius: 10px;
            padding: 11px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .sidebar-workspace:hover {
            background: rgba(255,255,255,0.08);
        }
        .sidebar-ws-avatar {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #1a3a8f, #0d1a3a);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            color: #7eb3ff;
            flex-shrink: 0;
            font-family: var(--font-sans);
        }
        .sidebar-ws-name {
            flex: 1;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            font-family: var(--font-sans);
        }
        .sidebar-ws-chevron {
            color: var(--text-tertiary);
        }

        /* Nav sections */
        .sidebar-nav {
            padding: 10px 12px;
            flex: 1;
            position: relative;
        }
        .sidebar-section-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: var(--text-tertiary);
            padding: 8px 10px 4px;
        }

        /* Nav item ‚Äî Nextmove style */
        .menu-item {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 0;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            font-family: var(--font-sans);
            display: flex;
            align-items: center;
            gap: 0;
            text-align: left;
            margin: 2px 0;
            position: relative;
            overflow: visible;
        }
        /* Inner wrapper for padding + layout */
        .menu-item-inner {
            display: flex;
            align-items: center;
            gap: 11px;
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            transition: color 0.15s ease, background 0.15s ease;
            position: relative;
            z-index: 2;
            color: var(--text-secondary);
        }

        /* Active/hover gradient ‚Äî Space blue */
        .menu-item.nav-lit .menu-item-inner {
            background: linear-gradient(90deg,
                #0d1a3a 0%,
                #0d1a3a 45%,
                #1a3a8f 72%,
                #2a5abf 88%,
                #4f8ef7 100%
            );
            color: #ffffff;
            border-radius: 10px;
            overflow: hidden;
        }

        .menu-item-pill { display: none; }

        .menu-item::after { display: none; }
        .sidebar-glider-active, .sidebar-glider-hover { display: none; }

        .menu-item-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            opacity: 0.6;
            transition: opacity 0.15s;
        }
        .menu-item:hover .menu-item-icon,
        .menu-item.active .menu-item-icon { opacity: 1; }

        .menu-item-text {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
        }

        .menu-item-shortcut {
            font-size: 11px;
            color: #7eb3ff;
            background: rgba(79,142,247,0.15);
            padding: 3px 7px;
            border-radius: 5px;
            font-family: var(--font-mono);
            border: 1px solid rgba(79,142,247,0.4);
            font-weight: 600;
        }

        .menu-divider {
            height: 1px;
            background: rgba(255,255,255,0.06);
            margin: 6px 10px;
        }

        .menu-section {
            padding: 4px 0;
        }
        .menu-item-account { padding: 0; }
        .menu-item-account #menuAccountConnected { width: 100%; }

        .menu-section-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: var(--text-tertiary);
            padding: 8px 10px 4px;
        }

        /* ========================================= */
        /* R√àGLE FINALE ULTRA-PUISSANTE */
        /* MASQUER ABSOLUMENT TOUTES LES SCROLLBARS */
        /* ========================================= */
        
        /* Pour TOUS les √©l√©ments - priorit√© maximale */
        *,
        *::before,
        *::after,
        html,
        body,
        div,
        section,
        article,
        aside,
        nav,
        header,
        footer,
        main,
        textarea,
        pre,
        code,
        iframe {
            scrollbar-width: none !important;
            -ms-overflow-style: none !important;
        }
        
        *::-webkit-scrollbar,
        *::before::-webkit-scrollbar,
        *::after::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
            background: transparent !important;
            opacity: 0 !important;
            visibility: hidden !important;
        }
        
        *::-webkit-scrollbar-thumb,
        *::-webkit-scrollbar-track,
        *::-webkit-scrollbar-corner {
            display: none !important;
            background: transparent !important;
            opacity: 0 !important;
            visibility: hidden !important;
        }


        /* ===== TOUCH HINT MOBILE ===== */
        .mobile-hint {
            display: none;
            text-align: center;
            font-size: 12px;
            color: var(--text-tertiary);
            padding: 6px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-subtle);
        }
        @media (max-width: 768px) {
            .mobile-hint {
                display: block;
            }
        }
        /* ========== RESPONSIVE MOBILE ========== */
        @media (max-width: 768px) {
            /* Header compact sur mobile */
            .header {
                padding: 8px 12px;
                flex-wrap: wrap;
                gap: 8px;
                height: auto;
                min-height: 56px;
            }
            .logo-section {
                gap: 8px;
            }
            .tagline {
                display: none;
            }
            .header-actions {
                gap: 6px;
            }
            .btn {
                padding: 7px 10px;
                font-size: 12px;
            }
            /* Sur mobile : layout en colonne (preview au-dessus, √©diteur en dessous) */
            .container {
                flex-direction: column !important;
            }
            .preview-section {
                height: 45vh !important;
                min-height: 200px;
            }
            .editor-section {
                height: 45vh !important;
            }
            /* Tabs plus compactes */
            .tab-btn {
                padding: 10px 12px;
                font-size: 11px;
            }
            .tab-btn .tab-icon {
                font-size: 14px;
            }
            /* Cacher le label texte des tabs sur tr√®s petit √©cran */
            @media (max-width: 380px) {
                .tab-btn span:last-child {
                    display: none;
                }
            }
            /* Dropdown menu plein √©cran sur mobile */
            .dropdown-menu {
                left: 8px;
                right: 8px;
                min-width: unset;
            }
            /* Modals full width on mobile */
            .templates-content,
            .snippets-content,
            .export-content,
            .shortcuts-content {
                width: 100vw;
                max-width: 100vw;
            }
            /* Settings panel prend plus de place */
            .settings-panel {
                width: 100vw;
                transform: translateX(100%);
            }
            .settings-panel.active {
                transform: translateX(0);
            }
            /* Projects panel full width on mobile */
            .projects-panel-inner {
                width: 100vw;
            }
            /* Preview controls scrollables */
            .preview-controls {
                overflow-x: auto;
                gap: 4px;
            }
            .control-btn {
                padding: 7px 10px;
                font-size: 11px;
                white-space: nowrap;
            }
            /* Console panel */
            .console-panel.active {
                max-height: 160px;
            }
        }

        @media (max-width: 480px) {
            .logo-icon {
                display: none;
            }
            /* Cacher le texte "Ex√©cuter" sur tr√®s petit √©cran */
            .btn-primary span:not(:first-child) {
                display: none;
            }
        }
        /* ===== LINTER PANEL ===== */
        .linter-panel {
            background: #0b0718;
            border-top: 1px solid transparent;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s cubic-bezier(0.4,0,0.2,1);
            flex-shrink: 0;
        }
        .linter-panel.open {
            max-height: 220px;
            overflow-y: auto;
            border-top-color: rgba(255,255,255,0.06);
        }
        .linter-panel.has-errors.open {
            max-height: 220px;
            overflow-y: auto;
            border-top-color: rgba(255,255,255,0.06);
        }
        /* linter header */
        .linter-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 14px;
            background: rgba(255,255,255,0.018);
            border-bottom: 1px solid rgba(255,255,255,0.04);
            position: sticky;
            top: 0;
            z-index: 2;
            backdrop-filter: blur(4px);
        }
        .linter-header-label {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1.2px;
            text-transform: uppercase;
            color: var(--text-tertiary);
            font-family: var(--font-sans);
        }
        .linter-header-close {
            background: none;
            border: 1px solid rgba(255,255,255,0.08);
            color: var(--text-tertiary);
            cursor: pointer;
            font-size: 11px;
            padding: 1px 8px;
            border-radius: 4px;
            transition: all 0.15s;
            font-family: var(--font-sans);
            line-height: 18px;
        }
        .linter-header-close:hover { background: rgba(255,255,255,0.06); color: var(--text-primary); border-color: rgba(255,255,255,0.15); }
        .linter-issue {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 14px;
            border-bottom: 1px solid rgba(255,255,255,0.025);
            transition: background 0.12s;
        }
        .linter-issue:last-child { border-bottom: none; }
        .linter-issue:hover { background: rgba(255,255,255,0.02); }
        .linter-issue.is-error  { border-left: 2px solid #f87171; background: rgba(248,113,113,0.03); }
        .linter-issue.is-warning { border-left: 2px solid #fbbf24; background: rgba(251,191,36,0.03); }
        .linter-issue.is-info   { border-left: 2px solid #60a5fa; }
        .linter-issue-line {
            font-family: var(--font-mono);
            font-size: 10px;
            color: var(--text-tertiary);
            min-width: 38px;
            flex-shrink: 0;
        }
        .linter-issue-icon { font-size: 11px; flex-shrink: 0; }
        .is-error  .linter-issue-icon { color: #f87171; }
        .is-warning .linter-issue-icon { color: #fbbf24; }
        .is-info   .linter-issue-icon { color: #60a5fa; }
        .linter-issue-msg {
            font-size: 11.5px;
            color: var(--text-secondary);
            font-family: var(--font-sans);
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .is-error .linter-issue-msg { color: #fca5a5; }
        .linter-issue-snippet {
            font-family: var(--font-mono);
            font-size: 10px;
            color: rgba(255,255,255,0.3);
            background: rgba(0,0,0,0.3);
            padding: 1px 8px;
            border-radius: 4px;
            max-width: 220px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex-shrink: 0;
        }

        /* ===== STATUS BAR ===== */
        .code-stats {
            display: flex;
            align-items: stretch;
            height: 24px;
            background: #080516;
            border-top: 1px solid rgba(255,255,255,0.05);
            font-family: var(--font-mono);
            font-size: 11px;
            color: var(--text-tertiary);
            flex-shrink: 0;
            overflow: hidden;
        }
        .code-stat {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 0 12px;
            white-space: nowrap;
            border-right: 1px solid rgba(255,255,255,0.04);
            cursor: default;
            transition: background 0.15s;
            flex-shrink: 0;
        }
        .code-stat:hover { background: rgba(255,255,255,0.03); }
        .code-stat-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
        .stat-err  { color: #f87171; cursor: pointer; }
        .stat-err:hover  { background: rgba(248,113,113,0.1) !important; }
        .stat-warn { color: #fbbf24; cursor: pointer; }
        .stat-warn:hover { background: rgba(251,191,36,0.1) !important; }
        .stat-info { color: #60a5fa; cursor: pointer; }
        .stat-ok   { color: #34d399; }
        .stat-lang { margin-left: auto; border-right: none; border-left: 1px solid rgba(255,255,255,0.05); color: #f89820; font-weight: 700; flex-shrink: 0; }

        /* ===== EXPORT ZIP OPTION ===== */
        .export-option-zip {
            background: linear-gradient(135deg, rgba(124,58,237,0.12), rgba(79,142,247,0.08));
            border-color: var(--primary-purple) !important;
        }

        /* ===== IMPROVED SHORTCUTS MODAL ===== */
        .shortcuts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
        }
        .shortcut-section {
            margin-bottom: 4px;
        }
        .shortcut-section + .shortcut-section {
            border-top: 1px solid rgba(255,255,255,0.06);
            padding-top: 4px;
        }
        .shortcut-section-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: var(--text-tertiary);
            padding: 14px 20px 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .shortcut-section-label::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255,255,255,0.06);
            margin-right: 4px;
        }
        .shortcut-card {
            background: transparent;
            border: none;
            border-radius: 8px;
            padding: 8px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            transition: background 0.15s;
        }
        .shortcut-card:hover {
            background: rgba(255,255,255,0.04);
        }
        .shortcut-card-label {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .shortcut-tag {
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-secondary);
            font-family: var(--font-mono);
            font-size: 10px;
            padding: 2px 7px;
            border-radius: 5px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        /* Fold gutter customization */
        .CodeMirror-foldgutter-open, .CodeMirror-foldgutter-folded {
            color: var(--text-tertiary);
            cursor: pointer;
        }
        .CodeMirror-foldgutter-open:hover, .CodeMirror-foldgutter-folded:hover {
            color: var(--primary-purple);
        }

        /* ‚úÖ Gutter d√©di√© pour les points du linter (s√©par√© des num√©ros de ligne) */
        .scrix-lint-gutter {
            width: 13px;
        }
        .scrix-lint-gutter .CodeMirror-gutter-elt {
            display: flex;
            align-items: center;
            justify-content: center;
        }

    </style>
    <!-- ‚úÖ PWA meta tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f8ef7">
</head>
<body>
    <!-- ‚úÖ Skip to content - accessibilit√© -->
    <a href="#main-editor" class="skip-link" style="position:absolute;top:-50px;left:8px;background:var(--primary-purple);color:white;padding:8px 16px;border-radius:8px;text-decoration:none;font-weight:700;z-index:99999;transition:top 0.2s;" onfocus="this.style.top='8px'" onblur="this.style.top='-50px'">Aller au contenu</a>
    <!-- ===== INTRO ===== -->
    <div class="intro-screen" id="intro">
        <canvas id="introCanvas"></canvas>
        <div class="intro-glow"></div>

        <div class="intro-center">
            <!-- Ic√¥ne logo -->
            <div class="intro-icon">
                <svg viewBox="0 0 44 44" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <!-- S -->
                    <text x="9" y="32" font-family="Space Grotesk, Arial, sans-serif" font-size="30" font-weight="800" fill="white" opacity="1">S</text>
                    <!-- X en bleu superpos√© d√©cal√© -->
                    <text x="17" y="36" font-family="Space Grotesk, Arial, sans-serif" font-size="30" font-weight="800" fill="url(#introGrad)" opacity="0.9">X</text>
                    <defs>
                        <linearGradient id="introGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#6366f1"/>
                            <stop offset="100%" stop-color="#4f8ef7"/>
                        </linearGradient>
                    </defs>
                </svg>
            </div>

            <!-- Wordmark -->
            <div class="intro-wordmark" aria-label="SCRIX">
                <span class="wl">S</span>
                <span class="wl">C</span>
                <span class="wl">R</span>
                <span class="wl">I</span>
                <span class="wl">X</span>
            </div>

            <!-- Tagline -->
            <div class="intro-tagline">Professional Code Editor</div>

            <!-- Progress bar -->
            <div class="intro-progress-wrap">
                <div class="intro-progress-bar"></div>
            </div>
        </div>
    </div>

    <!-- ===== CONTENU PRINCIPAL ===== -->
    <div class="app-wrapper">
        <!-- Floating button to restore hidden topbar -->
        <button class="show-topbar-btn" id="showTopBarBtn" onclick="togglePreviewAndHeader()">‚ñ≤ Afficher</button>

        <div class="header">
            <div class="logo-section">
                <div class="logo">
                    <div class="logo-icon">
                        <span class="mini-s">S</span>
                        <div class="mini-fusion"></div>
                        <span class="mini-x">X</span>
                    </div>
                    <div>
                        <div class="logo-text">
                            <span class="letter">S</span>
                            <span class="letter">C</span>
                            <span class="letter">R</span>
                            <span class="letter highlight">I</span>
                            <span class="letter highlight">X</span>
                        </div>
                        <div class="tagline">L'√©diteur de code professionnel ultime</div>
                    </div>
                </div>

                <div class="project-name-container">
                    <input type="text" id="project-name-input" class="project-name" value="Mon Projet" placeholder="" maxlength="60">
                    <label for="project-name-input" class="project-label" data-text="PROJECT_NAME">PROJECT_NAME</label>

                    <div class="project-scanline"></div>
                    <div class="project-glow"></div>
                    <div class="project-corners">
                        <div class="corner corner-tl"></div>
                        <div class="corner corner-tr"></div>
                        <div class="corner corner-bl"></div>
                        <div class="corner corner-br"></div>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <!-- √âl√©ments auth cach√©s ‚Äî n√©cessaires pour le JS -->
                <div id="authContainer" style="display:none;">
                    <div class="auth-user-pill" id="authUserPill" style="display:none;">
                        <div class="auth-avatar-fallback" id="authAvatarFallback">?</div>
                        <img class="auth-avatar" id="authAvatarImg" src="" alt="" style="display:none;"/>
                        <span class="auth-username" id="authUsername">...</span>
                        <div class="auth-sync-dot"></div>
                    </div>
                </div>
                <button class="btn btn-primary" id="runBtn" data-tooltip="Ex√©cuter (Ctrl+S)" onclick="runCode()" aria-label="Ex√©cuter le code (Ctrl+S)">
                    ‚ñ∂Ô∏è Ex√©cuter
                </button>
                <button class="btn" data-tooltip="Tout effacer" onclick="clearAll()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                </button>
                <button class="btn" data-tooltip="Param√®tres" onclick="toggleSettings()">
                    ‚öôÔ∏è
                </button>
<button class="btn menu-btn" onclick="toggleMenu()" id="menuBtn">
                    <span class="menu-icon">
                        <span></span>
                        <span></span>
                        <span></span>
                    </span>
                </button>
            </div>
        </div>

        <div class="container">
            <!-- Preview Section -->
            <div class="preview-section" id="previewSection">
                <!-- Floating button to show header when hidden -->

                <div class="preview-header">
                    <div class="preview-title">
                        <div class="preview-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></div>
                        R√âSULTAT EN TEMPS R√âEL
                    </div>
                    <div class="preview-controls">
                        <button class="control-btn" onclick="runCode()">Rafra√Æchir</button>
                        <button class="control-btn" onclick="toggleConsole()">Console</button>
                        <button class="control-btn" onclick="openFullscreen()">‚õ∂ Plein √©cran</button>
                        <button class="control-btn" id="previewToggleBtn" onclick="togglePreviewAndHeader()">
                            <span id="previewToggleIcon">‚ñº</span>
                            <span id="previewToggleText">Masquer</span>
                        </button>
                    </div>
                </div>
                
                <!-- Responsive Preview Toolbar -->
                <div class="responsive-toolbar">
                    <button class="device-btn active" onclick="setDeviceView('desktop')" id="desktopBtn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                            <line x1="8" y1="21" x2="16" y2="21"></line>
                            <line x1="12" y1="17" x2="12" y2="21"></line>
                        </svg>
                        Desktop
                    </button>
                    <button class="device-btn" onclick="setDeviceView('tablet')" id="tabletBtn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect>
                            <line x1="12" y1="18" x2="12.01" y2="18"></line>
                        </svg>
                        Tablet
                    </button>
                    <button class="device-btn" onclick="setDeviceView('mobile')" id="mobileBtn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="7" y="2" width="10" height="20" rx="2" ry="2"></rect>
                            <line x1="12" y1="18" x2="12.01" y2="18"></line>
                        </svg>
                        Mobile
                    </button>
                </div>
                <div class="preview-wrapper">
                    <iframe id="preview" ></iframe>
                </div>
                <div class="loading" id="loading">
                    <div class="loader-wrapper">
                        <span class="loader-letter">G</span>
                        <span class="loader-letter">e</span>
                        <span class="loader-letter">n</span>
                        <span class="loader-letter">e</span>
                        <span class="loader-letter">r</span>
                        <span class="loader-letter">a</span>
                        <span class="loader-letter">t</span>
                        <span class="loader-letter">i</span>
                        <span class="loader-letter">n</span>
                        <span class="loader-letter">g</span>
                        <div class="loader"></div>
                    </div>
                </div>
            </div>

            <!-- Editor Section with Tabs -->
            <div class="resizer" id="resizer" title="Glisser pour redimensionner"></div>
            <div class="editor-section" id="editorSection" aria-label="√âditeur de code" role="main">
                <!-- Language Tabs -->
                <div class="language-tabs">
                    <div class="tabs-left">
                        <button class="tab-btn html-tab active" onclick="switchTab('html')">
                            <span class="tab-icon">
                                <svg width="16" height="16" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M107.6 471l-33-370.4h362.8l-33 370.2L255.7 512z" fill="#e44d26"/>
                                    <path d="M256 480.5V131H365.4l-28.2 316.3z" fill="#f16529"/>
                                    <path d="M142.1 176.3h113.9v45.4h-63.5l4.2 47h59.3v45.3H154.5l-12.4-137.7zm12.4 150.6h45.5l3.2 36.3 52.8 14.3v47.4l-96.9-26.9-4.6-71.1z" fill="#ebebeb"/>
                                    <path d="M369.6 176.3H255.8v45.4h109.6l-4.2 47H255.8v45.3h99.5l-12.5 133-99 27.4V423l52.6-14.2 3.4-37.8H255.8v-45.3h108.5l12.4-149.4z" fill="#fff"/>
                                </svg>
                            </span>
                            HTML
                        </button>
                        <button class="tab-btn css-tab" onclick="switchTab('css')">
                            <span class="tab-icon">
                                <svg width="16" height="16" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M107.6 471l-33-370.4h362.8l-33 370.2L255.7 512z" fill="#264de4"/>
                                    <path d="M256 480.5V131H365.4l-28.2 316.3z" fill="#2965f1"/>
                                    <path d="M142.1 176.3h113.9v45.4H175.5l4.2 47h76.3v45.3H154.5l-12.4-137.7zm12.4 150.6h45.4l3.2 36.4 52.9 14.3v47.4l-97-26.9-4.5-71.2z" fill="#ebebeb"/>
                                    <path d="M369.6 176.3H255.8v45.4h109.6l-4.2 47H255.8v45.3h99.5l-12.5 133-99 27.4V423l52.6-14.2 3.4-37.8H255.8v-45.3h108.5l12.4-149.4z" fill="#fff"/>
                                </svg>
                            </span>
                            CSS
                        </button>
                        <button class="tab-btn js-tab" onclick="switchTab('js')">
                            <span class="tab-icon">
                                <svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="16" height="16" rx="2.5" fill="#f7df1e"/>
                                    <text x="8" y="11.5" text-anchor="middle" font-family="Arial,sans-serif" font-size="7" font-weight="bold" fill="#323330">JS</text>
                                </svg>
                            </span>
                            JavaScript
                        </button>
                        <button class="tab-btn python-tab" onclick="switchTab('python')">
                            <span class="tab-icon">
                                <svg width="16" height="16" viewBox="0 0 256 255" xmlns="http://www.w3.org/2000/svg">
                                    <defs>
                                        <linearGradient id="pyTop" x1="12.959%" y1="12.039%" x2="79.639%" y2="78.201%">
                                            <stop offset="0%" stop-color="#387EB8"/>
                                            <stop offset="100%" stop-color="#366994"/>
                                        </linearGradient>
                                        <linearGradient id="pyBot" x1="19.128%" y1="20.579%" x2="90.742%" y2="88.429%">
                                            <stop offset="0%" stop-color="#FFE052"/>
                                            <stop offset="100%" stop-color="#FFC331"/>
                                        </linearGradient>
                                    </defs>
                                    <path d="M126.916.072c-64.832 0-60.784 28.115-60.784 28.115l.072 29.128h61.868v8.745H41.631S.145 61.355.145 126.97c0 65.614 36.335 63.304 36.335 63.304h21.681v-30.432s-1.168-36.335 35.754-36.335h61.588s34.606.557 34.606-33.449V33.195S195.883.072 126.916.072zm-34.217 19.96a11.13 11.13 0 0 1 11.13 11.13 11.13 11.13 0 0 1-11.13 11.13 11.13 11.13 0 0 1-11.13-11.13 11.13 11.13 0 0 1 11.13-11.13z" fill="url(#pyTop)"/>
                                    <path d="M128.757 254.126c64.832 0 60.784-28.115 60.784-28.115l-.072-29.127H127.6v-8.745h86.441s41.486 4.705 41.486-60.91c0-65.614-36.335-63.304-36.335-63.304h-21.681v30.432s1.168 36.335-35.754 36.335H99.169s-34.606-.557-34.606 33.449v56.913s-5.248 33.072 64.194 33.072zm34.218-19.96a11.13 11.13 0 0 1-11.13-11.13 11.13 11.13 0 0 1 11.13-11.13 11.13 11.13 0 0 1 11.13 11.13 11.13 11.13 0 0 1-11.13 11.13z" fill="url(#pyBot)"/>
                                </svg>
                            </span>
                            Python
                        </button>
                    </div>
<button class="collapse-btn" id="collapseBtn" onclick="toggleEditorCollapse()">
                        <span id="collapseIcon">‚ñº</span>
                        <span id="collapseText">R√©duire</span>
                    </button>
                </div>

                <!-- Editor Container -->
                <div class="editor-container">
                    <!-- HTML Editor -->
                    <div class="editor-content active" id="html-editor">
                        <div class="editor-toolbar">
                            <button class="toolbar-btn undo-btn" id="undoBtn_html" onclick="editorUndo('html')" title="Annuler (Ctrl+Z)"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"/><path d="M3 13C5 7 10 4 16 6a9 9 0 0 1 5 8"/></svg></button><button class="toolbar-btn redo-btn" id="redoBtn_html" onclick="editorRedo('html')" title="R√©tablir (Ctrl+Y)"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 7v6h-6"/><path d="M21 13C19 7 14 4 8 6a9 9 0 0 0-5 8"/></svg></button>
                            <button class="toolbar-btn" onclick="formatCode('html')">Format</button>
                            <button class="toolbar-btn" onclick="copyCode('html')">Copier</button>
                            <button class="toolbar-btn" onclick="toggleFindReplace('html')">Rechercher (Ctrl+F)</button>
                        </div>
                        <div class="find-replace-panel" id="findReplaceHtml">
                            <input type="text" class="find-input" placeholder="Rechercher..." id="findInputHtml">
                            <input type="text" class="replace-input" placeholder="Remplacer par..." id="replaceInputHtml">
                            <button class="toolbar-btn" onclick="findNext('html')">Suivant</button>
                            <button class="toolbar-btn" onclick="replaceText('html')">Remplacer</button>
                            <button class="toolbar-btn" onclick="replaceAll('html')">Tout remplacer</button>
                            <button class="toolbar-btn" onclick="toggleFindReplace('html')">‚úï</button>
                        </div>
                        <textarea id="htmlEditor" placeholder="√âcris ton code HTML ici..." spellcheck="false"><!-- ‚úñÔ∏è SCRIX ‚Äî Particules interactives -->
<canvas id="canvas"></canvas></textarea>
                        <div class="linter-panel" id="linterPanel_html"></div>
                        <div class="code-stats" id="codeStats_html">
                            <span class="code-stat"><span class="code-stat-dot" style="background:var(--accent-green)"></span>1 ligne</span>
                        </div>
                    </div>

                    <!-- CSS Editor -->
                    <div class="editor-content" id="css-editor">
                        <div class="editor-toolbar">
                            <button class="toolbar-btn undo-btn" id="undoBtn_css" onclick="editorUndo('css')" title="Annuler (Ctrl+Z)"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"/><path d="M3 13C5 7 10 4 16 6a9 9 0 0 1 5 8"/></svg></button><button class="toolbar-btn redo-btn" id="redoBtn_css" onclick="editorRedo('css')" title="R√©tablir (Ctrl+Y)"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 7v6h-6"/><path d="M21 13C19 7 14 4 8 6a9 9 0 0 0-5 8"/></svg></button>
                            <button class="toolbar-btn" onclick="formatCode('css')">Format</button>
                            <button class="toolbar-btn" onclick="copyCode('css')">Copier</button>
                            <button class="toolbar-btn" onclick="toggleFindReplace('css')">Rechercher (Ctrl+F)</button>
                        </div>
                        <div class="find-replace-panel" id="findReplaceCss">
                            <input type="text" class="find-input" placeholder="Rechercher..." id="findInputCss">
                            <input type="text" class="replace-input" placeholder="Remplacer par..." id="replaceInputCss">
                            <button class="toolbar-btn" onclick="findNext('css')">Suivant</button>
                            <button class="toolbar-btn" onclick="replaceText('css')">Remplacer</button>
                            <button class="toolbar-btn" onclick="replaceAll('css')">Tout remplacer</button>
                            <button class="toolbar-btn" onclick="toggleFindReplace('css')">‚úï</button>
                        </div>
                        <textarea id="cssEditor" placeholder="√âcris ton code CSS ici..." spellcheck="false">/* ‚úñÔ∏è SCRIX ‚Äî Particules interactives */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: #0a0a0f;
  width: 100vw;
  height: 100vh;
  overflow: hidden;
}

canvas {
  display: block;
  width: 100%;
  height: 100%;
}</textarea>
                        <div class="linter-panel" id="linterPanel_css"></div>
                        <div class="code-stats" id="codeStats_css">
                            <span class="code-stat"><span class="code-stat-dot" style="background:var(--accent-blue)"></span>1 ligne</span>
                        </div>
                    </div>

                    <!-- JavaScript Editor -->
                    <div class="editor-content" id="js-editor">
                        <div class="editor-toolbar">
                            <button class="toolbar-btn undo-btn" id="undoBtn_js" onclick="editorUndo('js')" title="Annuler (Ctrl+Z)"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"/><path d="M3 13C5 7 10 4 16 6a9 9 0 0 1 5 8"/></svg></button><button class="toolbar-btn redo-btn" id="redoBtn_js" onclick="editorRedo('js')" title="R√©tablir (Ctrl+Y)"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 7v6h-6"/><path d="M21 13C19 7 14 4 8 6a9 9 0 0 0-5 8"/></svg></button>
                            <button class="toolbar-btn" onclick="formatCode('js')">Format</button>
                            <button class="toolbar-btn" onclick="copyCode('js')">Copier</button>
                            <button class="toolbar-btn" onclick="toggleFindReplace('js')">Rechercher (Ctrl+F)</button>
                        </div>
                        <div class="find-replace-panel" id="findReplaceJs">
                            <input type="text" class="find-input" placeholder="Rechercher..." id="findInputJs">
                            <input type="text" class="replace-input" placeholder="Remplacer par..." id="replaceInputJs">
                            <button class="toolbar-btn" onclick="findNext('js')">Suivant</button>
                            <button class="toolbar-btn" onclick="replaceText('js')">Remplacer</button>
                            <button class="toolbar-btn" onclick="replaceAll('js')">Tout remplacer</button>
                            <button class="toolbar-btn" onclick="toggleFindReplace('js')">‚úï</button>
                        </div>
                        <textarea id="jsEditor" placeholder="√âcris ton code JavaScript ici..." spellcheck="false">// ‚úñÔ∏è SCRIX ‚Äî Particules interactives
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resize();
window.addEventListener('resize', resize);

const COLORS = ['#4f8ef7', '#a78bfa', '#4f8ef7', '#3b82f6', '#10b981'];
const particles = [];

class Particle {
  constructor(x, y, burst = false) {
    this.x = x ?? Math.random() * canvas.width;
    this.y = y ?? Math.random() * canvas.height;
    this.size = Math.random() * 2.5 + 0.5;
    this.color = COLORS[Math.floor(Math.random() * COLORS.length)];
    this.burst = burst;
    if (burst) {
      this.vx = (Math.random() - 0.5) * 6;
      this.vy = (Math.random() - 0.5) * 6;
      this.life = 1;
      this.decay = 0.02;
    } else {
      this.vx = (Math.random() - 0.5) * 0.5;
      this.vy = (Math.random() - 0.5) * 0.5;
      this.life = Math.random();
      this.decay = Math.random() * 0.002 + 0.001;
    }
  }
  update() {
    this.x += this.vx;
    this.y += this.vy;
    this.life -= this.decay;
    if (!this.burst) {
      if (this.x < 0) this.x = canvas.width;
      if (this.x > canvas.width) this.x = 0;
      if (this.y < 0) this.y = canvas.height;
      if (this.y > canvas.height) this.y = 0;
      if (this.life <= 0) { this.life = 1; }
    }
  }
  draw() {
    ctx.save();
    ctx.globalAlpha = Math.max(0, this.life) * 0.85;
    ctx.fillStyle = this.color;
    ctx.shadowBlur = 10;
    ctx.shadowColor = this.color;
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
  }
}

// Initialiser
for (let i = 0; i < 160; i++) particles.push(new Particle());

function drawConnections() {
  const ambient = particles.filter(p => !p.burst);
  for (let i = 0; i < ambient.length; i++) {
    for (let j = i + 1; j < ambient.length; j++) {
      const dx = ambient[i].x - ambient[j].x;
      const dy = ambient[i].y - ambient[j].y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      if (dist < 110) {
        ctx.save();
        ctx.globalAlpha = (1 - dist / 110) * 0.15;
        ctx.strokeStyle = ambient[i].color;
        ctx.lineWidth = 0.6;
        ctx.beginPath();
        ctx.moveTo(ambient[i].x, ambient[i].y);
        ctx.lineTo(ambient[j].x, ambient[j].y);
        ctx.stroke();
        ctx.restore();
      }
    }
  }
}

function animate() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawConnections();
  for (let i = particles.length - 1; i >= 0; i--) {
    particles[i].update();
    particles[i].draw();
    if (particles[i].burst && particles[i].life <= 0) particles.splice(i, 1);
  }
  requestAnimationFrame(animate);
}
animate();

// Clic = burst de particules
canvas.addEventListener('click', e => {
  for (let i = 0; i < 25; i++) {
    particles.push(new Particle(e.clientX, e.clientY, true));
  }
});</textarea>
                        <div class="linter-panel" id="linterPanel_js"></div>
                        <div class="code-stats" id="codeStats_js">
                            <span class="code-stat"><span class="code-stat-dot" style="background:var(--accent-amber)"></span>1 ligne</span>
                        </div>
                    </div>

                    <!-- Python Editor -->
                    <div class="editor-content" id="python-editor">
                        <div class="editor-toolbar">
                            <button class="toolbar-btn undo-btn" id="undoBtn_python" onclick="editorUndo('python')" title="Annuler (Ctrl+Z)"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"/><path d="M3 13C5 7 10 4 16 6a9 9 0 0 1 5 8"/></svg></button><button class="toolbar-btn redo-btn" id="redoBtn_python" onclick="editorRedo('python')" title="R√©tablir (Ctrl+Y)"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 7v6h-6"/><path d="M21 13C19 7 14 4 8 6a9 9 0 0 0-5 8"/></svg></button>
                            <button class="toolbar-btn" onclick="runPython()">Run</button>
                            <button class="toolbar-btn" onclick="copyCode('python')">Copier</button>
                            <button class="toolbar-btn" onclick="toggleFindReplace('python')">Rechercher (Ctrl+F)</button>
                        </div>
                        <div class="find-replace-panel" id="findReplacePython">
                            <input type="text" class="find-input" placeholder="Rechercher..." id="findInputPython">
                            <input type="text" class="replace-input" placeholder="Remplacer par..." id="replaceInputPython">
                            <button class="toolbar-btn" onclick="findNext('python')">Suivant</button>
                            <button class="toolbar-btn" onclick="replaceText('python')">Remplacer</button>
                            <button class="toolbar-btn" onclick="replaceAll('python')">Tout remplacer</button>
                            <button class="toolbar-btn" onclick="toggleFindReplace('python')">‚úï</button>
                        </div>
                        <textarea id="pythonEditor" placeholder="√âcris ton code Python ici..." spellcheck="false"># ‚úñÔ∏è SCRIX ‚Äî D√©monstration Python
# Algorithmes classiques en action

def is_prime(n):
    """Teste si un nombre est premier"""
    if n < 2:
        return False
    for i in range(2, int(n**0.5) + 1):
        if n % i == 0:
            return False
    return True

def sieve(limit):
    """Crible d'√âratosth√®ne ‚Äî tous les premiers jusqu'√† limit"""
    composites = set()
    primes = []
    for n in range(2, limit + 1):
        if n not in composites:
            primes.append(n)
            composites.update(range(n * n, limit + 1, n))
    return primes

def caesar(text, shift):
    """Chiffrement de C√©sar"""
    result = ""
    for ch in text:
        if ch.isalpha():
            base = ord('A') if ch.isupper() else ord('a')
            result += chr((ord(ch) - base + shift) % 26 + base)
        else:
            result += ch
    return result

# ‚îÄ‚îÄ Nombres premiers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
primes = sieve(60)
print(f"üî¢ Nombres premiers ‚â§ 60 ({len(primes)} trouv√©s) :")
print("   " + "  ".join(str(p) for p in primes))

# ‚îÄ‚îÄ Chiffrement C√©sar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
msg = "Bonjour SCRIX"
encrypted = caesar(msg, 13)
decrypted = caesar(encrypted, 13)
print(f"\nüîê Chiffrement C√©sar (ROT-13) :")
print(f"   Original  : {msg}")
print(f"   Chiffr√©   : {encrypted}")
print(f"   D√©chiffr√© : {decrypted}")

# ‚îÄ‚îÄ Statistiques rapides ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
data = [12, 45, 7, 89, 23, 56, 34, 78, 11, 67]
mean = sum(data) / len(data)
data_sorted = sorted(data)
median = (data_sorted[4] + data_sorted[5]) / 2
print(f"\nüìä Statistiques sur {data} :")
print(f"   Min    : {min(data)}")
print(f"   Max    : {max(data)}")
print(f"   Moyenne: {mean:.1f}")
print(f"   M√©diane: {median}")

print("\n‚úÖ Python op√©rationnel dans SCRIX !")</textarea>
                    </div>
                </div>

                <!-- Python Output -->
                <div class="python-output" id="pythonOutput">
                    <div class="python-output-header">
                        <span>SORTIE PYTHON</span>
                        <button class="python-close-btn" onclick="closePythonOutput()">‚úï Fermer</button>
                    </div>
                    <div class="python-result" id="pythonResult"></div>
                </div>
            </div>

            <!-- Console Panel -->
            <div class="console-panel" id="consolePanel">
                <div class="console-header">
                    <span class="console-title">CONSOLE JAVASCRIPT</span>
                    <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
                        <div class="console-filters">
                            <button class="console-filter-btn active" data-filter="all" onclick="filterConsole('all')">Tout</button>
                            <button class="console-filter-btn" data-filter="log" onclick="filterConsole('log')">Log</button>
                            <button class="console-filter-btn" data-filter="warn" onclick="filterConsole('warn')">‚ö†</button>
                            <button class="console-filter-btn" data-filter="error" onclick="filterConsole('error')">‚úñ</button>
                        </div>
                        <button class="python-close-btn" onclick="clearConsole()">Effacer</button>
                        <button class="python-close-btn" onclick="toggleConsole()">‚úï Fermer</button>
                    </div>
                </div>
                <div class="console-content" id="consoleContent">
                    <div class="console-log" data-placeholder>Console pr√™te</div>
                </div>
            </div>
            <!-- Hint tactile mobile -->
            <div class="mobile-hint">Glisse vers le haut pour agrandir l'√©diteur ‚Ä¢ Ctrl+S pour ex√©cuter</div>
        </div>

    </div>

    <!-- Settings Panel -->
    <!-- Settings Overlay -->
    <div class="settings-overlay" id="settingsOverlay" onclick="toggleSettings()"></div>

    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <div class="settings-title">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.07 4.93l-1.41 1.41M4.93 4.93l1.41 1.41M19.07 19.07l-1.41-1.41M4.93 19.07l1.41-1.41M12 2v2M12 20v2M2 12h2M20 12h2"/></svg>
                Param√®tres
            </div>
            <button class="close-settings" onclick="toggleSettings()">‚úï</button>
        </div>
        <div class="settings-content">
            <div class="settings-section">
                <div class="settings-section-title">Apparence</div>
                <div class="setting-item">
                    <label class="setting-label">Taille de police</label>
                    <select class="setting-select" id="fontSize" onchange="updateFontSize(this.value)">
                        <option value="12">12px</option>
                        <option value="14" selected>14px</option>
                        <option value="16">16px</option>
                        <option value="18">18px</option>
                        <option value="20">20px</option>
                    </select>
                </div>

                <div class="setting-item">
                    <div class="setting-toggle" id="tutorialToggle" onclick="showTutorial(true)">
                        <span>Revoir le tutoriel</span>
                        <div class="toggle-switch"></div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">Comportement</div>
                <div class="setting-item">
                    <div class="setting-toggle active" id="autoRunToggle" onclick="toggleSetting(this, 'autoRun')">
                        <span>Auto-ex√©cution</span>
                        <div class="toggle-switch"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-toggle active" id="autoSaveToggle" onclick="toggleSetting(this, 'autoSave')">
                        <span>Sauvegarde automatique</span>
                        <div class="toggle-switch"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <label class="setting-label">D√©lai auto-ex√©cution (ms)</label>
                    <input type="number" class="setting-input" id="debounceTime" value="800" min="200" max="3000" step="100">
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">Projet</div>
                <div class="setting-item">
                    <label class="setting-label">Format d'export</label>
                    <select class="setting-select" id="exportFormat">
                        <option value="html" selected>HTML complet</option>
                        <option value="zip">ZIP (fichiers s√©par√©s)</option>
                    </select>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">√Ä propos</div>
                <div style="color: var(--text-tertiary); font-size: 13px; line-height: 1.8;">
                    <strong>SCRIX v2.0</strong><br>
                    Cr√©√© par <strong>SUQUITO</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- Menu Overlay -->
    <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>

    <!-- Dropdown Menu ‚Äî Nextmove Sidebar -->
    <div class="dropdown-menu" id="dropdownMenu">
        <!-- Sidebar Header -->
        <div class="sidebar-header">
            <div class="sidebar-brand">
                <div class="sidebar-brand-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="color:#7eb3ff">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                    </svg>
                </div>
                <span class="sidebar-brand-name">SCRIX</span>
            </div>
            <button class="sidebar-close-btn" onclick="closeMenu()" aria-label="Fermer">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Workspace -->
        <div class="sidebar-workspace" onclick="toggleProfile(); closeMenu();">
            <div class="sidebar-ws-avatar" id="sidebarWsAvatar">S</div>
            <span class="sidebar-ws-name" id="sidebarWsName">Mon Espace</span>
            <svg class="sidebar-ws-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>

        <!-- Nav -->
        <div class="sidebar-nav">

            <!-- Fichiers -->
            <div class="menu-section">
                <div class="menu-section-title">Fichiers</div>
                <button class="menu-item active" id="menuHomeBtn" onclick="closeMenu();"><span class="menu-item-pill"></span>
                    <div class="menu-item-inner">
                        <span class="menu-item-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
                            </svg>
                        </span>
                        <span class="menu-item-text">Accueil</span>
                    </div>
                </button>
                <button class="menu-item" onclick="toggleProjects(); closeMenu();"><span class="menu-item-pill"></span>
                    <div class="menu-item-inner">
                        <span class="menu-item-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/>
                            </svg>
                        </span>
                        <span class="menu-item-text">Mes Projets</span>
                        <span class="menu-item-shortcut">‚åòP</span>
                    </div>
                </button>
                <button class="menu-item" onclick="newProject(); closeMenu();"><span class="menu-item-pill"></span>
                    <div class="menu-item-inner">
                        <span class="menu-item-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/>
                            </svg>
                        </span>
                        <span class="menu-item-text">Nouveau Projet</span>
                        <span class="menu-item-shortcut">‚åòN</span>
                    </div>
                </button>
                <button class="menu-item" onclick="saveCurrentProject(); closeMenu();"><span class="menu-item-pill"></span>
                    <div class="menu-item-inner">
                        <span class="menu-item-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
                            </svg>
                        </span>
                        <span class="menu-item-text">Sauvegarder</span>
                        <span class="menu-item-shortcut">‚åòS</span>
                    </div>
                </button>
            </div>

            <div class="menu-divider"></div>

            <!-- Ressources -->
            <div class="menu-section">
                <div class="menu-section-title">Ressources</div>
                <button class="menu-item" onclick="openTemplates(); closeMenu();"><span class="menu-item-pill"></span>
                    <div class="menu-item-inner">
                        <span class="menu-item-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
                            </svg>
                        </span>
                        <span class="menu-item-text">Templates</span>
                    </div>
                </button>
                <button class="menu-item" onclick="openSnippets(); closeMenu();"><span class="menu-item-pill"></span>
                    <div class="menu-item-inner">
                        <span class="menu-item-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                            </svg>
                        </span>
                        <span class="menu-item-text">Snippets</span>
                    </div>
                </button>
            </div>

            <div class="menu-divider"></div>

            <!-- Vue Responsive -->
            <div class="menu-section">
                <div class="menu-section-title">Vue</div>
                <button class="menu-item" onclick="setDeviceView('desktop'); closeMenu();" id="menuDesktopBtn"><span class="menu-item-pill"></span>
                    <div class="menu-item-inner">
                        <span class="menu-item-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/>
                            </svg>
                        </span>
                        <span class="menu-item-text">Desktop</span>
                    </div>
                </button>
                <button class="menu-item" onclick="setDeviceView('tablet'); closeMenu();" id="menuTabletBtn"><span class="menu-item-pill"></span>
                    <div class="menu-item-inner">
                        <span class="menu-item-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="5" y="2" width="14" height="20" rx="2"/><line x1="12" y1="18" x2="12.01" y2="18"/>
                            </svg>
                        </span>
                        <span class="menu-item-text">Tablet</span>
                    </div>
                </button>
                <button class="menu-item" onclick="setDeviceView('mobile'); closeMenu();" id="menuMobileBtn"><span class="menu-item-pill"></span>
                    <div class="menu-item-inner">
                        <span class="menu-item-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="7" y="2" width="10" height="20" rx="2"/><line x1="12" y1="18" x2="12.01" y2="18"/>
                            </svg>
                        </span>
                        <span class="menu-item-text">Mobile</span>
                    </div>
                </button>
            </div>

            <div class="menu-divider"></div>

            <!-- Partage -->
            <div class="menu-section">
                <div class="menu-section-title">Partage & Export</div>
                <button class="menu-item" onclick="shareCode(); closeMenu();"><span class="menu-item-pill"></span>
                    <div class="menu-item-inner">
                        <span class="menu-item-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                            </svg>
                        </span>
                        <span class="menu-item-text">Partager</span>
                    </div>
                </button>
                <button class="menu-item" onclick="openExportModal(); closeMenu();"><span class="menu-item-pill"></span>
                    <div class="menu-item-inner">
                        <span class="menu-item-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                        </span>
                        <span class="menu-item-text">Exporter</span>
                    </div>
                </button>
                <button class="menu-item" onclick="importCode(); closeMenu();"><span class="menu-item-pill"></span>
                    <div class="menu-item-inner">
                        <span class="menu-item-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                        </span>
                        <span class="menu-item-text">Importer</span>
                    </div>
                </button>
            </div>

            <div class="menu-divider"></div>

            <!-- Divertissement & Aide -->
            <div class="menu-section">
                <div class="menu-section-title">Extras</div>
                <button class="menu-item" onclick="openMiniGames(); closeMenu();"><span class="menu-item-pill"></span>
                    <div class="menu-item-inner">
                        <span class="menu-item-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="6" y1="12" x2="10" y2="12"/><line x1="8" y1="10" x2="8" y2="14"/><circle cx="15" cy="10" r="1" fill="currentColor"/><circle cx="17.5" cy="12.5" r="1" fill="currentColor"/><rect x="2" y="6" width="20" height="12" rx="5"/>
                            </svg>
                        </span>
                        <span class="menu-item-text">Mini-Jeux</span>
                    </div>
                </button>
                <button class="menu-item" onclick="openShortcuts(); closeMenu();"><span class="menu-item-pill"></span>
                    <div class="menu-item-inner">
                        <span class="menu-item-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M8 12h.01M12 12h.01M16 12h.01M7 16h10"/>
                            </svg>
                        </span>
                        <span class="menu-item-text">Raccourcis</span>
                        <span class="menu-item-shortcut">‚åò/</span>
                    </div>
                </button>
                <button class="menu-item" onclick="showTutorial(true); closeMenu();"><span class="menu-item-pill"></span>
                    <div class="menu-item-inner">
                        <span class="menu-item-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                            </svg>
                        </span>
                        <span class="menu-item-text">Aide</span>
                    </div>
                </button>
            </div>
        </div>

        <!-- Bottom account section -->
        <div style="border-top: 1px solid rgba(255,255,255,0.07); padding: 12px;">
            <button class="menu-item menu-item-account" id="menuAccountBtn" onclick="toggleProfile(); closeMenu();"><span class="menu-item-pill"></span>
                <div class="menu-item-inner" style="padding: 10px 12px;">
                    <span id="menuAccountDisconnected" style="display:flex;align-items:center;gap:11px;width:100%;">
                        <span class="menu-item-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/>
                            </svg>
                        </span>
                        <span class="menu-item-text">Mon Profil</span>
                    </span>
                    <span id="menuAccountConnected" style="display:none; align-items:center; gap:9px; width:100%;">
                        <div id="menuAvatarFallback" class="auth-avatar-fallback" style="width:26px;height:26px;font-size:11px;">?</div>
                        <img id="menuAvatarImg" class="auth-avatar" src="" alt="" style="display:none;width:26px;height:26px;" onerror="this.style.display='none';document.getElementById('menuAvatarFallback').style.display='flex'"/>
                        <span id="menuUsername" class="auth-username" style="font-size:13px;"></span>
                        <div class="auth-sync-dot" style="margin-left:auto;"></div>
                    </span>
                </div>
            </button>
        </div>
    </div>

    <!-- ========== NOUVELLES MODALES ========== -->
    
    <!-- Templates Modal -->
    <div class="templates-modal" id="templatesModal" onclick="if(event.target===this)closeTemplates()">
        <div class="templates-content">
            <div class="templates-header">
                <div class="templates-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
                    Templates
                </div>
                <button class="minigames-close" onclick="closeTemplates()">‚úï</button>
            </div>
            <div class="templates-grid">
                <div class="template-card" onclick="loadTemplate('glitchInput')">
                    <div class="template-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div>
                    <div class="template-name">Glitch Input</div>
                    <div class="template-desc">Barre de recherche holographique</div>
                </div>
                <div class="template-card" onclick="loadTemplate('flipCard')">
                    <div class="template-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg></div>
                    <div class="template-name">Flip Card</div>
                    <div class="template-desc">Carte bancaire 3D anim√©e</div>
                </div>
                <div class="template-card" onclick="loadTemplate('starButton')">
                    <div class="template-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></div>
                    <div class="template-name">Star Button</div>
                    <div class="template-desc">Bouton avec √©toiles magiques</div>
                </div>
                <div class="template-card" onclick="loadTemplate('borderButton')">
                    <div class="template-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L9.5 9.5 2 12l7.5 2.5L12 22l2.5-7.5L22 12l-7.5-2.5z"/></svg></div>
                    <div class="template-name">Border Button</div>
                    <div class="template-desc">Bouton bordures anim√©es</div>
                </div>
                <div class="template-card" onclick="loadTemplate('input3D')">
                    <div class="template-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg></div>
                    <div class="template-name">3D Input</div>
                    <div class="template-desc">Champ de saisie n√©omorphique</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="share-modal" id="shareModal" onclick="if(event.target === this) closeShare()">
        <div class="share-content">
            <div class="templates-header">
                <div class="templates-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
                    Partager le projet
                </div>
                <button class="minigames-close" onclick="closeShare()">‚úï</button>
            </div>
            <div style="padding: 20px; flex: 1;">
                <p style="margin-bottom: 14px; color: var(--text-secondary); font-size: 13px;">
                    Partagez votre code via un lien ou un QR code
                </p>
                <div class="share-url" id="shareUrl">Le lien sera g√©n√©r√© ici...</div>
                <div id="qrcode"></div>
                <div style="display: flex; gap: 10px; margin-top: 16px;">
                    <button class="btn btn-primary" style="flex: 1;" onclick="copyShareUrl()">Copier le lien</button>
                    <button class="btn" style="flex: 1;" onclick="downloadQR()">T√©l√©charger QR</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mini Games Modal -->
    <div class="minigames-modal" id="miniGamesModal" onclick="handleMiniGamesOverlayClick(event)">
        <div class="minigames-container">
            <div class="minigames-header">
                <div class="minigames-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="6" width="20" height="12" rx="2"/><path d="M12 12h.01"/><path d="M7 12h.01"/><path d="M17 12h.01"/><path d="M12 9v6"/></svg>
                    Mini-Jeux
                </div>
                <div class="projects-size-btns" style="position:absolute;left:50%;transform:translateX(-50%);">
                    <button class="proj-size-btn active" id="gsize-lg" onclick="setGamesSize('lg')" title="Grandes">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><rect x="2" y="2" width="9" height="9" rx="1.5"/><rect x="13" y="2" width="9" height="9" rx="1.5"/><rect x="2" y="13" width="9" height="9" rx="1.5"/><rect x="13" y="13" width="9" height="9" rx="1.5"/></svg>
                    </button>
                    <button class="proj-size-btn" id="gsize-md" onclick="setGamesSize('md')" title="Moyennes">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><rect x="2" y="2" width="6" height="6" rx="1"/><rect x="9" y="2" width="6" height="6" rx="1"/><rect x="16" y="2" width="6" height="6" rx="1"/><rect x="2" y="9" width="6" height="6" rx="1"/><rect x="9" y="9" width="6" height="6" rx="1"/><rect x="16" y="9" width="6" height="6" rx="1"/><rect x="2" y="16" width="6" height="6" rx="1"/><rect x="9" y="16" width="6" height="6" rx="1"/><rect x="16" y="16" width="6" height="6" rx="1"/></svg>
                    </button>
                    <button class="proj-size-btn" id="gsize-sm" onclick="setGamesSize('sm')" title="Petites">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><rect x="1" y="1" width="4.5" height="4.5" rx="0.8"/><rect x="6.5" y="1" width="4.5" height="4.5" rx="0.8"/><rect x="12" y="1" width="4.5" height="4.5" rx="0.8"/><rect x="17.5" y="1" width="4.5" height="4.5" rx="0.8"/><rect x="1" y="6.5" width="4.5" height="4.5" rx="0.8"/><rect x="6.5" y="6.5" width="4.5" height="4.5" rx="0.8"/><rect x="12" y="6.5" width="4.5" height="4.5" rx="0.8"/><rect x="17.5" y="6.5" width="4.5" height="4.5" rx="0.8"/><rect x="1" y="12" width="4.5" height="4.5" rx="0.8"/><rect x="6.5" y="12" width="4.5" height="4.5" rx="0.8"/><rect x="12" y="12" width="4.5" height="4.5" rx="0.8"/><rect x="17.5" y="12" width="4.5" height="4.5" rx="0.8"/><rect x="1" y="17.5" width="4.5" height="4.5" rx="0.8"/><rect x="6.5" y="17.5" width="4.5" height="4.5" rx="0.8"/><rect x="12" y="17.5" width="4.5" height="4.5" rx="0.8"/><rect x="17.5" y="17.5" width="4.5" height="4.5" rx="0.8"/></svg>
                    </button>
                    <button class="proj-size-btn" id="gsize-list" onclick="setGamesSize('list')" title="Liste">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                    </button>
                </div>
                <button class="minigames-close" onclick="closeMiniGames()">‚úï</button>
            </div>
            <div class="minigames-content">
                <div id="gamesMenu" class="games-grid">
                    <div class="game-card" onclick="startSnakeGame()">
                        <div class="game-icon">üêç</div>
                        <div class="game-title">Snake</div>
                        <div class="game-desc">Le classique serpent affam√©</div>
                    </div>
                    <div class="game-card" onclick="startMemoryGame()">
                        <div class="game-icon">üß†</div>
                        <div class="game-title">Memory</div>
                        <div class="game-desc">Testez votre m√©moire</div>
                    </div>
                    <div class="game-card" onclick="startPongGame()">
                        <div class="game-icon">üèì</div>
                        <div class="game-title">Pong</div>
                        <div class="game-desc">Tennis de table r√©tro</div>
                    </div>
                    <div class="game-card" onclick="startBreakoutGame()">
                        <div class="game-icon">üß±</div>
                        <div class="game-title">Breakout</div>
                        <div class="game-desc">Casse-briques arcade</div>
                    </div>
                    <div class="game-card" onclick="startGuessNumberGame()">
                        <div class="game-icon">üéØ</div>
                        <div class="game-title">Devinez le nombre</div>
                        <div class="game-desc">Trouvez le nombre myst√®re</div>
                    </div>
                    <!-- Cartes mini-jeux custom dynamiques -->
                    <div id="customGamesCards" style="display:contents;"></div>
                    <!-- Bouton ajouter -->
                    <div class="game-card add-game-card" onclick="openProjectSelector()" id="addGameBtn">
                        <div class="add-game-icon">‚ûï</div>
                        <div class="add-game-label">Ajouter un projet</div>
                    </div>
                </div>
                <div id="gameArea" class="game-canvas-container" style="display:none;">
                    <!-- Les jeux se lancent maintenant en plein √©cran -->
                </div>
            </div>
        </div>
    </div>

    <!-- Fullscreen Game Overlay -->
    <div class="game-fullscreen-overlay" id="gameFullscreenOverlay">
        <div class="game-fullscreen-topbar" id="gameTopbar">
            <div class="game-fullscreen-title" id="gameFullscreenTitle">Jeu</div>
            <div class="game-fullscreen-actions">
                <button class="game-fs-btn" onclick="restartCurrentGame()" title="Recommencer">üîÑ Restart</button>
                <button class="game-fs-btn danger" onclick="closeFullscreenGame()">‚úï Quitter</button>
            </div>
        </div>
        <div class="game-fs-toggle-bar" id="gameToggleBar" onclick="toggleGameTopbar()">‚ñº Afficher les contr√¥les</div>
        <div class="game-info" id="gameInfo">Score: 0</div>
        <canvas id="gameCanvas" width="600" height="400"></canvas>
    </div>

    <!-- Project Selector Modal for Mini-Games -->
    <div class="proj-selector-modal" id="projSelectorModal">
        <div class="proj-selector-box">
            <div class="proj-selector-header">
                <div class="proj-selector-title"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg> Choisir un projet comme mini-jeu</div>
                <div class="proj-view-switcher">
                    <button class="proj-view-btn" onclick="setProjGrid(2)" id="projView2" title="2 colonnes">
                        <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor"><rect x="0" y="0" width="6" height="6" rx="1"/><rect x="8" y="0" width="6" height="6" rx="1"/><rect x="0" y="8" width="6" height="6" rx="1"/><rect x="8" y="8" width="6" height="6" rx="1"/></svg>
                    </button>
                    <button class="proj-view-btn active" onclick="setProjGrid(3)" id="projView3" title="3 colonnes">
                        <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor"><rect x="0" y="0" width="3.5" height="3.5" rx="0.5"/><rect x="5.25" y="0" width="3.5" height="3.5" rx="0.5"/><rect x="10.5" y="0" width="3.5" height="3.5" rx="0.5"/><rect x="0" y="5.25" width="3.5" height="3.5" rx="0.5"/><rect x="5.25" y="5.25" width="3.5" height="3.5" rx="0.5"/><rect x="10.5" y="5.25" width="3.5" height="3.5" rx="0.5"/><rect x="0" y="10.5" width="3.5" height="3.5" rx="0.5"/><rect x="5.25" y="10.5" width="3.5" height="3.5" rx="0.5"/><rect x="10.5" y="10.5" width="3.5" height="3.5" rx="0.5"/></svg>
                    </button>
                    <button class="proj-view-btn" onclick="setProjGrid(4)" id="projView4" title="4 colonnes">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><rect x="0" y="0" width="3" height="3" rx="0.4"/><rect x="4.3" y="0" width="3" height="3" rx="0.4"/><rect x="8.6" y="0" width="3" height="3" rx="0.4"/><rect x="13" y="0" width="3" height="3" rx="0.4"/><rect x="0" y="4.3" width="3" height="3" rx="0.4"/><rect x="4.3" y="4.3" width="3" height="3" rx="0.4"/><rect x="8.6" y="4.3" width="3" height="3" rx="0.4"/><rect x="13" y="4.3" width="3" height="3" rx="0.4"/><rect x="0" y="8.6" width="3" height="3" rx="0.4"/><rect x="4.3" y="8.6" width="3" height="3" rx="0.4"/><rect x="8.6" y="8.6" width="3" height="3" rx="0.4"/><rect x="13" y="8.6" width="3" height="3" rx="0.4"/><rect x="0" y="13" width="3" height="3" rx="0.4"/><rect x="4.3" y="13" width="3" height="3" rx="0.4"/><rect x="8.6" y="13" width="3" height="3" rx="0.4"/><rect x="13" y="13" width="3" height="3" rx="0.4"/></svg>
                    </button>
                    <button class="proj-view-btn" onclick="setProjGrid('list')" id="projViewList" title="Liste">
                        <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor"><rect x="0" y="0" width="14" height="2.5" rx="1"/><rect x="0" y="5.75" width="14" height="2.5" rx="1"/><rect x="0" y="11.5" width="14" height="2.5" rx="1"/></svg>
                    </button>
                </div>
                <button class="minigames-close" onclick="closeProjectSelector()">‚úï</button>
            </div>
            <div class="proj-selector-list" id="projSelectorList"></div>
        </div>
    </div>

    <!-- Shortcuts Modal -->
    <div class="shortcuts-modal" id="shortcutsModal" onclick="if(event.target===this)closeShortcuts()">
        <div class="shortcuts-content">
            <div class="templates-header">
                <div class="templates-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="6" width="20" height="12" rx="2"/><path d="M6 10h.01M10 10h.01M14 10h.01M18 10h.01M6 14h4M14 14h4"/></svg>
                    Raccourcis clavier
                </div>
                <button class="minigames-close" onclick="closeShortcuts()">‚úï</button>
            </div>
            <div style="padding: 4px 0 20px;">

                <div class="shortcut-section">
                    <div class="shortcut-section-label">G√©n√©ral</div>
                    <div class="shortcuts-grid" style="padding: 0 12px;">
                    <div class="shortcut-card"><span class="shortcut-card-label">Ex√©cuter le code</span><span class="shortcut-tag">Ctrl+S</span></div>
                    <div class="shortcut-card"><span class="shortcut-card-label">Tout effacer</span><span class="shortcut-tag">Ctrl+K</span></div>
                    <div class="shortcut-card"><span class="shortcut-card-label">T√©l√©charger</span><span class="shortcut-tag">Ctrl+D</span></div>
                    <div class="shortcut-card"><span class="shortcut-card-label">Rechercher</span><span class="shortcut-tag">Ctrl+F</span></div>
                    <div class="shortcut-card"><span class="shortcut-card-label">Assistant IA</span><span class="shortcut-tag">Ctrl+I</span></div>
                    <div class="shortcut-card"><span class="shortcut-card-label">Mode focus</span><span class="shortcut-tag">Ctrl+Shift+F</span></div>
                    <div class="shortcut-card"><span class="shortcut-card-label">Console</span><span class="shortcut-tag">Ctrl+`</span></div>
                    <div class="shortcut-card"><span class="shortcut-card-label">Raccourcis clavier</span><span class="shortcut-tag">Ctrl+/</span></div>
                    </div>
                </div>

                <div class="shortcut-section">
                    <div class="shortcut-section-label">Projets</div>
                    <div class="shortcuts-grid" style="padding: 0 12px;">
                    <div class="shortcut-card"><span class="shortcut-card-label">Nouveau projet</span><span class="shortcut-tag">Ctrl+N</span></div>
                    <div class="shortcut-card"><span class="shortcut-card-label">Sauvegarder</span><span class="shortcut-tag">Ctrl+Shift+S</span></div>
                    <div class="shortcut-card"><span class="shortcut-card-label">Export ZIP</span><span class="shortcut-tag">Ctrl+E</span></div>
                    <div class="shortcut-card"><span class="shortcut-card-label">Th√®me clair/sombre</span><span class="shortcut-tag">Ctrl+Shift+L</span></div>
                    </div>
                </div>

                <div class="shortcut-section">
                    <div class="shortcut-section-label">√âditeur</div>
                    <div class="shortcuts-grid" style="padding: 0 12px;">
                    <div class="shortcut-card"><span class="shortcut-card-label">Formatter le code</span><span class="shortcut-tag">Alt+F</span></div>
                    <div class="shortcut-card"><span class="shortcut-card-label">Commenter ligne</span><span class="shortcut-tag">Ctrl+;</span></div>
                    <div class="shortcut-card"><span class="shortcut-card-label">Dupliquer ligne</span><span class="shortcut-tag">Alt+D</span></div>
                    <div class="shortcut-card"><span class="shortcut-card-label">Plier/d√©plier bloc</span><span class="shortcut-tag">Ctrl+Q</span></div>
                    </div>
                </div>

                <div class="shortcut-section">
                    <div class="shortcut-section-label">Onglets</div>
                    <div class="shortcuts-grid" style="padding: 0 12px;">
                    <div class="shortcut-card"><span class="shortcut-card-label">HTML</span><span class="shortcut-tag">Alt+1</span></div>
                    <div class="shortcut-card"><span class="shortcut-card-label">CSS</span><span class="shortcut-tag">Alt+2</span></div>
                    <div class="shortcut-card"><span class="shortcut-card-label">JavaScript</span><span class="shortcut-tag">Alt+3</span></div>
                    <div class="shortcut-card"><span class="shortcut-card-label">Python</span><span class="shortcut-tag">Alt+4</span></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Snippets Modal -->
    <div class="snippets-modal" id="snippetsModal" onclick="if(event.target===this)closeSnippets()">
        <div class="snippets-content">
            <div class="templates-header">
                <div class="templates-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
                    Snippets
                </div>
                <button class="minigames-close" onclick="closeSnippets()">‚úï</button>
            </div>
            <div style="padding: 12px 0 20px;">
            <div class="snippet-item" onclick="insertSnippet('flexCenter')">
                <div class="snippet-title">CSS - Flex Center</div>
                <div class="snippet-code">display: flex; justify-content: center; align-items: center;</div>
            </div>
            <div class="snippet-item" onclick="insertSnippet('gradient')">
                <div class="snippet-title">CSS - Gradient Background</div>
                <div class="snippet-code">background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);</div>
            </div>
            <div class="snippet-item" onclick="insertSnippet('button')">
                <div class="snippet-title">HTML - Button moderne</div>
                <div class="snippet-code">&lt;button class="btn-modern"&gt;Cliquez-moi&lt;/button&gt;</div>
            </div>
            <div class="snippet-item" onclick="insertSnippet('card')">
                <div class="snippet-title">HTML - Card component</div>
                <div class="snippet-code">&lt;div class="card"&gt;&lt;h3&gt;Titre&lt;/h3&gt;&lt;p&gt;Contenu&lt;/p&gt;&lt;/div&gt;</div>
            </div>
            <div class="snippet-item" onclick="insertSnippet('fetch')">
                <div class="snippet-title">JS - Fetch API</div>
                <div class="snippet-code">fetch(url).then(res => res.json()).then(data => console.log(data));</div>
            </div>
            <div class="snippet-item" onclick="insertSnippet('eventListener')">
                <div class="snippet-title">JS - Event Listener</div>
                <div class="snippet-code">element.addEventListener('click', (e) => { });</div>
            </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="export-modal" id="exportModal" onclick="if(event.target===this)closeExport()">
        <div class="export-content">
            <div class="templates-header">
                <div class="templates-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Exporter
                </div>
                <button class="minigames-close" onclick="closeExport()">‚úï</button>
            </div>
            <div style="padding: 12px 0 20px;">
            <div class="export-option export-option-zip" onclick="exportAsZip()">
                <div class="export-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="12" cy="12" r="4"/></svg></div>
                <div class="export-info">
                    <h3>Export ZIP</h3>
                    <p>index.html + style.css + script.js dans un ZIP</p>
                </div>
            </div>
            <div class="export-option" onclick="exportAsHTML()">
                <div class="export-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg></div>
                <div class="export-info">
                    <h3>HTML Complet</h3>
                    <p>T√©l√©charger en un seul fichier HTML</p>
                </div>
            </div>
            <div class="export-option" onclick="exportSeparate()">
                <div class="export-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg></div>
                <div class="export-info">
                    <h3>Fichiers s√©par√©s</h3>
                    <p>HTML, CSS et JS dans des fichiers distincts</p>
                </div>
            </div>
            <div class="export-option" onclick="exportToCodePen()">
                <div class="export-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></div>
                <div class="export-info">
                    <h3>CodePen</h3>
                    <p>Ouvrir dans CodePen</p>
                </div>
            </div>
            <div class="export-option" onclick="exportToJSFiddle()">
                <div class="export-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg></div>
                <div class="export-info">
                    <h3>JSFiddle</h3>
                    <p>Ouvrir dans JSFiddle</p>
                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- Tutorial Overlay -->
    <div class="tutorial-overlay" id="tutorialOverlay">
        <div class="tutorial-content">
            <div class="tutorial-step active" id="step1">
                <h2 style="font-size: 32px; margin-bottom: 20px;">‚úñÔ∏è Bienvenue dans SCRIX!</h2>
                <p style="font-size: 16px; margin-bottom: 20px; color: var(--text-secondary);">
                    Votre √©diteur de code professionnel avec des fonctionnalit√©s avanc√©es
                </p>
                <div class="tutorial-buttons">
                    <button class="btn btn-primary" onclick="nextTutorialStep()">Commencer le tour ‚Üí</button>
                    <button class="btn" onclick="skipTutorial()">Passer</button>
                </div>
            </div>
            <div class="tutorial-step" id="step2">
                <h2 style="font-size: 28px; margin-bottom: 20px;">‚ú® Auto-Sauvegarde</h2>
                <p style="font-size: 16px; margin-bottom: 20px; color: var(--text-secondary);">
                    Votre code est automatiquement sauvegard√© dans le navigateur. Vous ne perdrez jamais votre travail!
                </p>
                <div class="tutorial-buttons">
                    <button class="btn" onclick="prevTutorialStep()">‚Üê Pr√©c√©dent</button>
                    <button class="btn btn-primary" onclick="nextTutorialStep()">Suivant ‚Üí</button>
                </div>
            </div>
            <div class="tutorial-step" id="step3">
                <h2 style="font-size: 28px; margin-bottom: 20px;">üé® Templates & Snippets</h2>
                <p style="font-size: 16px; margin-bottom: 20px; color: var(--text-secondary);">
                    Utilisez des templates pr√©d√©finis et des snippets pour coder plus rapidement
                </p>
                <div class="tutorial-buttons">
                    <button class="btn" onclick="prevTutorialStep()">‚Üê Pr√©c√©dent</button>
                    <button class="btn btn-primary" onclick="nextTutorialStep()">Suivant ‚Üí</button>
                </div>
            </div>
            <div class="tutorial-step" id="step4">
                <h2 style="font-size: 28px; margin-bottom: 20px;">Pr√™t √† coder !</h2>
                <p style="font-size: 16px; margin-bottom: 20px; color: var(--text-secondary);">
                    Utilisez Ctrl+/ pour voir tous les raccourcis clavier. Bon codage! üå∏
                </p>
                <div class="tutorial-buttons">
                    <button class="btn" onclick="prevTutorialStep()">‚Üê Pr√©c√©dent</button>
                    <button class="btn btn-primary" onclick="nextTutorialStep()">Suivant ‚Üí</button>
                </div>
            </div>
            <div class="tutorial-step" id="step5">
                <h2 style="font-size: 28px; margin-bottom: 16px;">‚òÅÔ∏è Sync entre appareils</h2>
                <p style="font-size: 15px; margin-bottom: 20px; color: var(--text-secondary); line-height: 1.6;">
                    Connecte-toi pour retrouver tous tes projets sur n'importe quel appareil ‚Äî PC, mobile, tablette.
                </p>
                <div style="margin-bottom: 20px;">
                    <button id="tutoSignInBtn" class="btn btn-primary" style="width:100%;padding:12px;font-size:14px;display:flex;align-items:center;justify-content:center;gap:8px;" onclick="closeTutorial(); openLoginModal();">
                        <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                        Se connecter avec Google
                    </button>
                </div>
                <div class="tutorial-buttons">
                    <button class="btn" onclick="prevTutorialStep()">‚Üê Pr√©c√©dent</button>
                    <button class="btn btn-primary" onclick="closeTutorial(); openLoginModal();">C'est parti !</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Panel -->
    <div class="profile-panel-overlay" id="profilePanelOverlay" onclick="toggleProfile()"></div>
    <div class="profile-panel" id="profilePanel">
        <!-- Header -->
        <div class="profile-header">
            <div class="profile-header-title">
                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                Mon Profil
            </div>
            <button class="profile-close-btn" onclick="toggleProfile()">‚úï</button>
        </div>

        <!-- VUE NON CONNECT√â -->
        <div id="profileNotConnected">
            <div style="padding: 48px 24px; text-align: center;">
                <div style="font-size: 48px; margin-bottom: 16px;">üë§</div>
                <div style="font-size: 16px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">Connecte-toi √† ton compte</div>
                <div style="font-size: 13px; color: var(--text-tertiary); margin-bottom: 24px; line-height: 1.6;">Synchronise tes projets entre tous tes appareils et personnalise ton profil.</div>
                <button class="profile-google-btn" onclick="openLoginModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Se connecter avec Google
                </button>
            </div>
        </div>

        <!-- VUE CONNECT√â -->
        <div id="profileConnected" style="display:none; flex-direction:column; flex:1; overflow:hidden;">

            <!-- BANNI√àRE -->
            <div class="profile-banner" id="profileBannerEl" onclick="triggerBannerUpload()" title="Changer la banni√®re">
                <img id="profileBannerImg" src="" alt="" style="display:none;" onerror="this.style.display='none'"/>
                <div class="profile-banner-overlay"><span>üì∑ Changer la banni√®re</span></div>
            </div>
            <input type="file" id="bannerFileInput" accept="image/*" style="display:none;" onchange="handleBannerUpload(event)"/>

            <!-- AVATAR ROW -->
            <div class="profile-avatar-row">
                <div class="profile-avatar-wrap" onclick="triggerAvatarUpload()" title="Changer la photo">
                    <div class="profile-avatar-fallback-large" id="profileAvatarFallback">?</div>
                    <img id="profileAvatarImg" class="profile-avatar-large" src="" alt="" style="display:none;"
                         onerror="this.style.display='none';document.getElementById('profileAvatarFallback').style.display='flex'"/>
                    <div style="position:absolute;inset:0;background:rgba(0,0,0,0.45);border-radius:50%;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.2s;" id="avatarOverlay">
                        <span style="font-size:22px;">‚úèÔ∏è</span>
                    </div>
                </div>
                <input type="file" id="avatarFileInput" accept="image/*" style="display:none;" onchange="handleAvatarUpload(event)"/>
            </div>

            <!-- BODY -->
            <div class="profile-body">
                <div style="margin-bottom:14px;">
                    <div style="font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-tertiary);margin-bottom:6px;">Pseudo</div>
                    <input type="text" class="profile-username-field" id="profileUsername"
                        placeholder="Ton pseudo..."
                        maxlength="30"/>
                </div>
                <div id="profileDisplayName" class="profile-display-name"></div>
                <div id="profileEmail" class="profile-email"></div>

                <div style="margin-bottom:14px;">
                    <div style="font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-tertiary);margin-bottom:6px;">Description</div>
                    <textarea class="profile-bio-field" id="profileBio"
                        placeholder="Parle de toi..."
                        maxlength="160"></textarea>
                </div>

                <!-- Section compte -->
                <div class="profile-compte-box">
                    <div class="profile-compte-label">‚öô Compte</div>
                    <div class="profile-compte-text">Tes projets restent synchronis√©s dans le cloud. Tu peux te reconnecter √† tout moment.</div>
                </div>

                <!-- Actions -->
                <div class="profile-actions">
                    <button class="profile-btn-save" onclick="saveProfile()">Sauvegarder le profil</button>
                    <button class="profile-btn-logout" onclick="googleSignOut()">se deconnecter</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Projects Panel -->
    <div class="projects-panel" id="projectsPanel" onclick="handleProjectsOverlayClick(event)">
        <div class="projects-panel-inner">
            <div class="projects-modal-header">
                <div class="projects-modal-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                    Mes Projets
                </div>
                <div class="projects-size-btns" style="position:absolute;left:50%;transform:translateX(-50%);">
                    <button class="proj-size-btn" id="psize-xl" onclick="setProjectsSize('xl')" title="Tr√®s grandes">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><rect x="2" y="2" width="9" height="9" rx="1.5"/><rect x="13" y="2" width="9" height="9" rx="1.5"/><rect x="2" y="13" width="9" height="9" rx="1.5"/><rect x="13" y="13" width="9" height="9" rx="1.5"/></svg>
                    </button>
                    <button class="proj-size-btn active" id="psize-md" onclick="setProjectsSize('md')" title="Moyennes">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><rect x="2" y="2" width="6" height="6" rx="1"/><rect x="9" y="2" width="6" height="6" rx="1"/><rect x="16" y="2" width="6" height="6" rx="1"/><rect x="2" y="9" width="6" height="6" rx="1"/><rect x="9" y="9" width="6" height="6" rx="1"/><rect x="16" y="9" width="6" height="6" rx="1"/><rect x="2" y="16" width="6" height="6" rx="1"/><rect x="9" y="16" width="6" height="6" rx="1"/><rect x="16" y="16" width="6" height="6" rx="1"/></svg>
                    </button>
                    <button class="proj-size-btn" id="psize-sm" onclick="setProjectsSize('sm')" title="Petites">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><rect x="1" y="1" width="4.5" height="4.5" rx="0.8"/><rect x="6.5" y="1" width="4.5" height="4.5" rx="0.8"/><rect x="12" y="1" width="4.5" height="4.5" rx="0.8"/><rect x="17.5" y="1" width="4.5" height="4.5" rx="0.8"/><rect x="1" y="6.5" width="4.5" height="4.5" rx="0.8"/><rect x="6.5" y="6.5" width="4.5" height="4.5" rx="0.8"/><rect x="12" y="6.5" width="4.5" height="4.5" rx="0.8"/><rect x="17.5" y="6.5" width="4.5" height="4.5" rx="0.8"/><rect x="1" y="12" width="4.5" height="4.5" rx="0.8"/><rect x="6.5" y="12" width="4.5" height="4.5" rx="0.8"/><rect x="12" y="12" width="4.5" height="4.5" rx="0.8"/><rect x="17.5" y="12" width="4.5" height="4.5" rx="0.8"/><rect x="1" y="17.5" width="4.5" height="4.5" rx="0.8"/><rect x="6.5" y="17.5" width="4.5" height="4.5" rx="0.8"/><rect x="12" y="17.5" width="4.5" height="4.5" rx="0.8"/><rect x="17.5" y="17.5" width="4.5" height="4.5" rx="0.8"/></svg>
                    </button>
                    <button class="proj-size-btn" id="psize-list" onclick="setProjectsSize('list')" title="Liste">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                    </button>
                </div>
                <button class="projects-modal-close" onclick="toggleProjects()">‚úï</button>
            </div>
            <div class="projects-modal-body">

                <div id="projectsList" class="size-md">
                    <p style="text-align: center; color: var(--text-tertiary); padding: 40px 20px;">
                        Aucun projet sauvegard√©
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.9/beautify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.9/beautify-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.9/beautify-html.min.js"></script>
    <script>
        // ===== CONSOLE BRIDGE - d√©fini en premier =====
        // Compteur d'entr√©es console
        window._scrixConsoleCount = { log: 0, warn: 0, error: 0, info: 0, total: 0 };
        const _MAX_CONSOLE_ENTRIES = 200;

        window.scrixConsoleLog = function(method, args, timestamp) {
            const panel = document.getElementById('consoleContent');
            if (!panel) return;

            window._scrixHasLogs = true;
            clearTimeout(window._scrixNoLogTimer);

            const prefix = { log: '‚ñ∏', warn: '‚ö†', error: '‚úñ', info: '‚Ñπ' }[method] || '‚ñ∏';
            const color = { log: '#f3f4f6', warn: '#f59e0b', error: '#ef4444', info: '#60a5fa' }[method] || '#f3f4f6';

            const text = args.map(function(a) {
                try {
                    var parsed = JSON.parse(a);
                    if (typeof parsed === 'object' && parsed !== null)
                        return '<span style="color:#a78bfa;">' + a.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</span>';
                } catch(e) {}
                return String(a).replace(/</g,'&lt;').replace(/>/g,'&gt;');
            }).join(' ');

            var placeholder = panel.querySelector('[data-placeholder]');
            if (placeholder) placeholder.remove();

            var entries = panel.querySelectorAll('.console-log');
            if (entries.length >= _MAX_CONSOLE_ENTRIES) {
                for (var i = 0; i <= entries.length - _MAX_CONSOLE_ENTRIES; i++) entries[i].remove();
            }

            var entry = document.createElement('div');
            entry.className = 'console-log' + (method === 'error' ? ' error' : method === 'warn' ? ' warn' : '');
            entry.innerHTML =
                '<span style="color:#6b7280;font-size:10px;margin-right:8px;">' + timestamp + '</span>'
                + '<span style="color:' + color + ';margin-right:6px;">' + prefix + '</span>'
                + '<span style="color:' + color + ';">' + text + '</span>';
            panel.appendChild(entry);
            _makeLogCopyable(entry);
            panel.scrollTop = panel.scrollHeight;

            window._scrixConsoleCount.total++;
            if (window._scrixConsoleCount[method] !== undefined) window._scrixConsoleCount[method]++;
            _updateConsoleTitle();
        };

        function _updateConsoleTitle() {
            const titleEl = document.querySelector('.console-title');
            if (!titleEl) return;
            const c = window._scrixConsoleCount;
            let badges = '';
            if (c.error > 0) badges += ' <span style="background:#ef4444;color:#fff;border-radius:4px;padding:1px 6px;font-size:10px;">' + c.error + ' erreur' + (c.error > 1 ? 's' : '') + '</span>';
            if (c.warn > 0) badges += ' <span style="background:#f59e0b;color:#000;border-radius:4px;padding:1px 6px;font-size:10px;">' + c.warn + ' warn</span>';
            if (c.log > 0) badges += ' <span style="background:rgba(167,139,250,0.2);color:#a78bfa;border-radius:4px;padding:1px 6px;font-size:10px;">' + c.log + ' log</span>';
            titleEl.innerHTML = 'CONSOLE JAVASCRIPT' + badges;

            // Alerte visuelle sur le bouton Console si erreur
            const consoleBtn = document.querySelector('.control-btn[onclick="toggleConsole()"]');
            if (consoleBtn) {
                if (c.error > 0) {
                    consoleBtn.style.color = '#ef4444';
                    consoleBtn.style.borderColor = '#ef4444';
                    consoleBtn.textContent = 'Console (' + c.error + ' err)';
                } else if (c.warn > 0) {
                    consoleBtn.style.color = '#f59e0b';
                    consoleBtn.style.borderColor = '#f59e0b';
                    consoleBtn.textContent = 'Console (' + c.warn + ' warn)';
                } else {
                    consoleBtn.style.color = '';
                    consoleBtn.style.borderColor = '';
                    consoleBtn.textContent = 'Console';
                }
            }
        }
        // ===== FILTRES CONSOLE =====
        window._consoleFilter = 'all';
        function filterConsole(type) {
            window._consoleFilter = type;
            document.querySelectorAll('.console-filter-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.console-filter-btn[data-filter="' + type + '"]').classList.add('active');
            const entries = document.querySelectorAll('#consoleContent .console-log');
            entries.forEach(e => {
                if (type === 'all') { e.style.display = ''; return; }
                const isError = e.classList.contains('error');
                const isWarn  = e.classList.contains('warn');
                const isLog   = !isError && !isWarn;
                if (type === 'error') e.style.display = isError ? '' : 'none';
                else if (type === 'warn') e.style.display = isWarn ? '' : 'none';
                else if (type === 'log') e.style.display = isLog ? '' : 'none';
            });
        }

        // ===== RECHERCHE CONSOLE =====
        function toggleConsoleSearch() {
            const wrap = document.getElementById('consoleSearchWrap');
            const visible = wrap.style.display !== 'none';
            wrap.style.display = visible ? 'none' : 'flex';
            if (!visible) document.getElementById('consoleSearchInput').focus();
            else { document.getElementById('consoleSearchInput').value = ''; searchConsole(''); }
        }
        function searchConsole(query) {
            const q = query.toLowerCase();
            document.querySelectorAll('#consoleContent .console-log').forEach(e => {
                e.style.display = (!q || e.textContent.toLowerCase().includes(q)) ? '' : 'none';
            });
        }

        // ===== COPIER UN LOG =====
        function _makeLogCopyable(entry) {
            entry.addEventListener('click', function() {
                const text = entry.textContent.trim();
                navigator.clipboard.writeText(text).then(() => {
                    entry.classList.add('copied');
                    setTimeout(() => entry.classList.remove('copied'), 800);
                }).catch(() => {});
            });
        }

        // ===== MODE FOCUS =====
        function toggleFocusMode() {
            document.body.classList.toggle('focus-mode');
            const btn = document.getElementById('focusModeBtn');
            const previewBtn = document.getElementById('previewToggleBtn');
            const previewIcon = document.getElementById('previewToggleIcon');
            const previewText = document.getElementById('previewToggleText');
            if (document.body.classList.contains('focus-mode')) {
                if (btn) { btn.textContent = '‚ä†'; btn.title = 'Quitter le mode focus'; }
                if (previewIcon) previewIcon.textContent = '‚ñ∂';
                if (previewText) previewText.textContent = 'Quitter focus';
                showNotification('Mode focus activ√© ‚Äî √âchap pour quitter', 'info');
            } else {
                if (btn) { btn.textContent = '‚õ∂'; btn.title = 'Mode focus'; }
                if (previewIcon) previewIcon.textContent = '‚ä†';
                if (previewText) previewText.textContent = 'Focus';
            }
        }
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape' && document.body.classList.contains('focus-mode')) toggleFocusMode();
        });

        // ===== HISTORIQUE DES EX√âCUTIONS =====
        window._execHistory = [];
        function toggleHistory() {
            const panel = document.getElementById('historyPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        function addToHistory(errors, warns, logs, ms) {
            const now = new Date().toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
            const entry = { time: now, errors, warns, logs, ms };
            window._execHistory.unshift(entry);
            if (window._execHistory.length > 20) window._execHistory.pop();
            renderHistory();
        }
        function renderHistory() {
            const list = document.getElementById('historyList');
            if (!list) return;
            const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            list.innerHTML = window._execHistory.map((h, i) =>
                `<div class="history-entry ${h.errors > 0 ? 'has-error' : 'success'}" onclick="loadHistorySnapshot(${i})">
                    ${esc(h.time)} ‚Äî ‚è± ${parseInt(h.ms, 10)}ms
                    ${h.errors > 0 ? ' ¬∑ <span style="color:#ef4444">'+parseInt(h.errors,10)+' ‚ùå</span>' : ''}
                    ${h.warns > 0 ? ' ¬∑ <span style="color:#f59e0b">'+parseInt(h.warns,10)+' ‚ö†</span>' : ''}
                    ${h.logs > 0 ? ' ¬∑ <span style="color:#a78bfa">'+parseInt(h.logs,10)+' log</span>' : ''}
                </div>`
            ).join('');
        }

        // ===== TIMER D'EX√âCUTION =====
        window._execStartTime = null;
        function showExecTimer(ms) {
            const el = document.getElementById('execTimer');
            if (!el) return;
            el.style.display = 'block';
            el.innerHTML = '‚è± Ex√©cut√© en <strong>' + ms + 'ms</strong>';
        }

        // ===== TH√àMES √âDITEUR =====
        const EDITOR_THEMES = ['dracula','monokai','material-darker','nord','solarized dark'];
        function setEditorTheme(theme) {
            localStorage.setItem('scrix-editor-theme', theme);
            if (window._cmEditors) {
                Object.values(window._cmEditors).forEach(cm => cm && cm.setOption('theme', theme));
            }
            document.querySelectorAll('.editor-theme-btn').forEach(b => b.classList.remove('active'));
            const btn = document.querySelector('.editor-theme-btn[data-theme="' + theme + '"]');
            if (btn) btn.classList.add('active');
            showNotification('Th√®me ' + theme, 'success');
        }

        // Settings state
        let settings = {
            autoRun: true,
            autoSave: true,
            fontSize: 14,
            debounceTime: 800
        };

        // Toggle editor collapse
        function toggleEditorCollapse() {
            const editorSection = document.getElementById('editorSection');
            const previewSection = document.getElementById('previewSection');
            const resizer = document.getElementById('resizer');
            const collapseIcon = document.getElementById('collapseIcon');
            const collapseText = document.getElementById('collapseText');
            const isCollapsed = editorSection.classList.contains('collapsed');

            if (isCollapsed) {
                // Agrandir ‚Äî restaurer hauteur preview et editor
                editorSection.classList.remove('collapsed');
                previewSection.style.height = '50%';
                if (resizer) resizer.style.pointerEvents = '';
                collapseIcon.textContent = '‚ñº';
                collapseText.textContent = 'R√©duire';
                previewSection.classList.remove('editor-collapsed');
            } else {
                // R√©duire ‚Äî editor minimal, preview prend tout
                editorSection.classList.add('collapsed');
                previewSection.style.height = 'calc(100% - 44px)';
                if (resizer) resizer.style.pointerEvents = 'none';
                collapseIcon.textContent = '‚ñ≤';
                collapseText.textContent = 'Agrandir';
                previewSection.classList.add('editor-collapsed');
            }
        }

        // ===== RESIZER LOGIC =====
        (function initResizer() {
            const resizer = document.getElementById('resizer');
            const previewSection = document.getElementById('previewSection');
            const editorSection = document.getElementById('editorSection');
            if (!resizer || !previewSection || !editorSection) return;

            let dragStartY = 0;
            let dragStartPreviewH = 0;

            resizer.addEventListener('pointerdown', function(e) {
                dragStartY = e.clientY;
                dragStartPreviewH = previewSection.offsetHeight;
                resizer.setPointerCapture(e.pointerId);
                resizer.classList.add('dragging');
                document.body.style.cursor = 'row-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });

            resizer.addEventListener('pointermove', function(e) {
                if (!resizer.hasPointerCapture(e.pointerId)) return;
                const container = previewSection.parentElement;
                const containerH = container.offsetHeight;
                const resizerH = resizer.offsetHeight;
                const delta = e.clientY - dragStartY;
                let newH = dragStartPreviewH + delta;
                newH = Math.max(80, Math.min(containerH - resizerH - 80, newH));
                previewSection.style.flex = 'none';
                previewSection.style.height = newH + 'px';
                editorSection.style.flex = '1';
                editorSection.style.height = '0';
            });

            resizer.addEventListener('pointerup', function(e) {
                resizer.releasePointerCapture(e.pointerId);
                resizer.classList.remove('dragging');
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            });

            resizer.addEventListener('pointercancel', function(e) {
                resizer.releasePointerCapture(e.pointerId);
                resizer.classList.remove('dragging');
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            });
        })();

        // Toggle preview section size
        function togglePreviewSize() {
            const previewSection = document.getElementById('previewSection');
            const toggleIcon = document.getElementById('previewToggleIcon');
            const toggleText = document.getElementById('previewToggleText');

            
            previewSection.classList.toggle('preview-collapsed');
            
            if (previewSection.classList.contains('preview-collapsed')) {
                toggleIcon.textContent = '‚ñ≤';
                toggleText.textContent = 'Afficher';

            } else {
                toggleIcon.textContent = '‚ñº';
                toggleText.textContent = 'Masquer';

            }
        }

        // Switch language tabs

        function editorUndo(lang) {
            const idMap = { html: 'htmlEditor', css: 'cssEditor', js: 'jsEditor', python: 'pythonEditor' };
            const cm = window._cmEditors?.[idMap[lang]];
            if (cm) { cm.undo(); updateUndoRedoBtns(lang, cm); }
        }
        function editorRedo(lang) {
            const idMap = { html: 'htmlEditor', css: 'cssEditor', js: 'jsEditor', python: 'pythonEditor' };
            const cm = window._cmEditors?.[idMap[lang]];
            if (cm) { cm.redo(); updateUndoRedoBtns(lang, cm); }
        }
        function updateUndoRedoBtns(lang, cm) {
            const hist = cm.historySize();
            const undoBtn = document.getElementById('undoBtn_' + lang);
            const redoBtn = document.getElementById('redoBtn_' + lang);
            if (undoBtn) undoBtn.classList.toggle('has-history', hist.undo > 0);
            if (redoBtn) redoBtn.classList.toggle('has-history', hist.redo > 0);
        }

        // ===== SORT PROJECTS =====
        window._sortMode = 'date';
        document.querySelector('.project-name').value = 'Mon Projet';
        function sortProjects(mode) {
            window._sortMode = mode;
            document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('sort' + mode.charAt(0).toUpperCase() + mode.slice(1))?.classList.add('active');
            loadProjectsList();
        }

        // ===== DUPLICATE PROJECT =====
        async function duplicateProject(realIndex) {
            let projects = JSON.parse(localStorage.getItem('scrix_projects') || '[]');
            const original = projects[realIndex];
            if (!original) return;
            const copy = { ...original, name: original.name + ' (copie)', timestamp: Date.now(), _cloudId: 'proj_' + Date.now() };
            projects.push(copy);
            safeSetProjects(projects);
            if (window._fbUser) await saveProjectToCloud(copy);
            showNotification(`"${copy.name}" dupliqu√©`, 'success');
            loadProjectsList();
        }

        function switchTab(language) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.${language}-tab`).classList.add('active');

            // Update editor content
            document.querySelectorAll('.editor-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${language}-editor`).classList.add('active');

            // Hide Python output when switching away
            if (language !== 'python') {
                document.getElementById('pythonOutput').classList.remove('active');
            }

            // Refresh CodeMirror pour √©viter le rendu vide
            const cmMap = { html: 'htmlEditor', css: 'cssEditor', js: 'jsEditor', python: 'pythonEditor' };
            const cmId = cmMap[language];
            if (cmId && window._cmEditors && window._cmEditors[cmId]) {
                setTimeout(() => window._cmEditors[cmId].refresh(), 10);
            }
        }

        // Toggle settings panel
        function toggleSettings() {
            // Fermer le menu si ouvert
            closeMenu();
            
            const panel = document.getElementById('settingsPanel');
            const overlay = document.getElementById('settingsOverlay');
            const isActive = panel.classList.toggle('active');
            if (isActive) {
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }

        function closeSettings() {
            document.getElementById('settingsPanel').classList.remove('active');
            document.getElementById('settingsOverlay').classList.remove('active');
        }

        // Toggle setting
        function toggleSetting(element, setting) {
            element.classList.toggle('active');
            settings[setting] = element.classList.contains('active');
            
            const settingNames = {
                autoRun: 'Auto-ex√©cution',
                autoSave: 'Sauvegarde automatique'
            };
            
            const status = settings[setting] ? 'activ√©e' : 'd√©sactiv√©e';
            showNotification(`${settingNames[setting]} ${status}`, 'info');
        }

        // Update font size
        function updateFontSize(size) {
            settings.fontSize = parseInt(size);
            // Changer la variable CSS ‚Äî bat le !important
            document.documentElement.style.setProperty('--editor-font-size', size + 'px');
            // Refresh CodeMirror pour recalculer la mise en page
            if (window._cmEditors) {
                Object.values(window._cmEditors).forEach(editor => {
                    if (editor && editor.refresh) editor.refresh();
                });
            }
            showNotification(`Taille de police: ${size}px`, 'info');
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            runCode();
        });

        // Auto-run with debounce ‚Äî branch√© sur CodeMirror
        let debounceTimer;
        const editors = ['htmlEditor', 'cssEditor', 'jsEditor'];

        function setupEditorAutoRun(editorId) {
            const cm = window._cmEditors && window._cmEditors[editorId];
            if (cm) {
                cm.on('change', () => {
                    if (!settings.autoRun) return;
                    clearTimeout(debounceTimer);
                    const delay = parseInt(document.getElementById('debounceTime').value) || 800;
                    debounceTimer = setTimeout(runCode, delay);
                });
            } else {
                // Fallback textarea
                const el = document.getElementById(editorId);
                if (el) el.addEventListener('input', () => {
                    if (!settings.autoRun) return;
                    clearTimeout(debounceTimer);
                    const delay = parseInt(document.getElementById('debounceTime').value) || 800;
                    debounceTimer = setTimeout(runCode, delay);
                });
            }
        }

        // Brancher apr√®s l'init CodeMirror
        function setupAllAutoRun() {
            editors.forEach(setupEditorAutoRun);
        }

        // Run code
        function runCode() {
            // ‚úÖ √âtat chargement sur le bouton Ex√©cuter
            const runBtn = document.getElementById('runBtn');
            if (runBtn) {
                runBtn.disabled = true;
                runBtn.innerHTML = '‚è≥ Ex√©cution...';
                // R√©activer apr√®s max 3s (fallback)
                setTimeout(() => {
                    runBtn.disabled = false;
                    runBtn.innerHTML = '‚ñ∂Ô∏è Ex√©cuter';
                }, 3000);
            }

            // Vider la console √† chaque ex√©cution
            const consoleContent = document.getElementById('consoleContent');
            if (consoleContent) {
                consoleContent.innerHTML = '<div class="console-log" style="color:#6b7280;" data-placeholder>‚ñ∏ Ex√©cution du code...</div>';
            }
            // R√©initialiser les compteurs
            window._scrixConsoleCount = { log: 0, warn: 0, error: 0, info: 0, total: 0 };
            window._scrixHasLogs = false;

            // D√©marrer le timer
            window._execStartTime = performance.now();
            const timerEl = document.getElementById('execTimer');
            if (timerEl) timerEl.style.display = 'none';
            _updateConsoleTitle();

            // Afficher "‚úÖ Aucune erreur" apr√®s 2.5s SEULEMENT si aucun log n'est apparu
            clearTimeout(window._scrixNoLogTimer);
            window._scrixNoLogTimer = setTimeout(function() {
                if (window._scrixHasLogs) return; // annuler si des logs sont arriv√©s
                const p = document.getElementById('consoleContent');
                if (!p) return;
                const placeholder = p.querySelector('[data-placeholder]');
                if (placeholder) {
                    placeholder.style.color = '#10b981';
                    placeholder.innerHTML = '‚úÖ Code ex√©cut√© sans erreur ‚Äî aucun console.log d√©tect√©';
                }
            }, 2500);
            const loading = document.getElementById('loading');
            loading.classList.add('active');

            const html = getEditorValue('htmlEditor');
            const css = getEditorValue('cssEditor');
            const js = getEditorValue('jsEditor');

            // ===== D√âTECTION JAVA ‚Äî non ex√©cutable dans le navigateur =====
            const isJavaCode = /\bpublic\s+class\b/.test(js) || /\bimport\s+java\./.test(js) || /\bpublic\s+static\s+void\s+main\b/.test(js);
            if (isJavaCode) {
                loading.classList.remove('active');
                clearTimeout(window._scrixNoLogTimer);
                const ts = new Date().toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
                const consoleEl = document.getElementById('consoleContent');
                if (consoleEl) {
                    consoleEl.innerHTML = '';
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'console-log';
                    msgDiv.style.cssText = 'padding: 10px 14px; line-height: 1.7;';
                    msgDiv.innerHTML =
                        '<span style="color:#6b7280;font-size:10px;margin-right:8px;">' + ts + '</span>'
                        + '<span style="color:#f59e0b;font-size:15px;margin-right:8px;">‚òï</span>'
                        + '<span style="color:#fbbf24;font-weight:700;">Code Java d√©tect√©</span>'
                        + '<br><span style="color:#9ca3af;font-size:12px;margin-left:24px;">'
                        + 'Java ne s\'ex√©cute pas dans le navigateur. SCRIX supporte :'
                        + '</span>'
                        + '<br><span style="color:#a78bfa;font-size:12px;margin-left:24px;">‚Ä¢ HTML / CSS / JavaScript ‚Üí onglets HTML, CSS, JS</span>'
                        + '<br><span style="color:#a78bfa;font-size:12px;margin-left:24px;">‚Ä¢ Python ‚Üí onglet Python (ex√©cut√© via Skulpt)</span>'
                        + '<br><span style="color:#6b7280;font-size:12px;margin-left:24px;margin-top:4px;display:block;">'
                        + 'Le linter SCRIX analyse ton Java et d√©tecte les erreurs, mais l\'ex√©cution n√©cessite un JDK local (javac).'
                        + '</span>';
                    consoleEl.appendChild(msgDiv);
                }
                // Ouvrir la console automatiquement pour que l'utilisateur voit le message
                const consolePanel = document.getElementById('consolePanel');
                if (consolePanel && !consolePanel.classList.contains('active')) {
                    consolePanel.classList.add('active');
                }
                window._scrixConsoleCount.warn++;
                _updateConsoleTitle();
                // Restaurer le bouton Ex√©cuter
                if (runBtn) { runBtn.disabled = false; runBtn.innerHTML = '‚ñ∂Ô∏è Ex√©cuter'; }
                return;
            }
            // ===== FIN D√âTECTION JAVA ====

            const output = `
                <!DOCTYPE html>
                <html lang="fr">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
                    <style>
                        * {
                            -ms-overflow-style: none !important;
                            scrollbar-width: none !important;
                            box-sizing: border-box;
                        }
                        *::-webkit-scrollbar {
                            display: none !important;
                            width: 0 !important;
                            height: 0 !important;
                        }
                        html, body {
                            margin: 0;
                            padding: 0;
                            overflow: auto !important;
                            -webkit-overflow-scrolling: touch;
                            width: 100%;
                            height: 100%;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                        }
                        
                        /* Force responsive scaling pour tout le contenu */
                        body > * {
                            max-width: 100% !important;
                        }
                        
                        /* Adaptation automatique des conteneurs de jeux */
                        .game, .tetris-container, .game-container, 
                        .dashboard, .blog-post, .contact-form,
                        div[style*="width"], div[style*="max-width"] {
                            max-width: 100% !important;
                            width: 100% !important;
                        }
                        
                        /* Adaptation des canvas (pour les jeux) */
                        canvas {
                            max-width: 100% !important;
                            display: block;
                        }
                        /* Canvas fullscreen : Three.js, WebGL, p5.js, etc. */
                        #canvas-container {
                            width: 100vw !important;
                            height: 100vh !important;
                            overflow: hidden !important;
                        }
                        #canvas-container canvas {
                            width: 100% !important;
                            height: 100% !important;
                            max-width: none !important;
                            max-height: none !important;
                            display: block !important;
                        }
                        /* Canvas directement dans body (Three.js sans container) */
                        body > canvas {
                            position: fixed !important;
                            top: 0 !important; left: 0 !important;
                            width: 100vw !important;
                            height: 100vh !important;
                            max-width: none !important;
                            max-height: none !important;
                        }
                        
                        /* Media query pour mobile (largeur de l'iframe mobile = 280px) */
                        @media (max-width: 380px) {
                            body {
                                font-size: 14px;
                                padding: 10px;
                            }
                            
                            h1 { font-size: 24px !important; }
                            h2 { font-size: 20px !important; }
                            h3 { font-size: 18px !important; }
                            
                            button, input {
                                font-size: 14px !important;
                                padding: 10px !important;
                            }
                            
                            canvas {
                                width: 100% !important;
                                max-width: 250px !important;
                            }
                        }
                        
                        /* Media query pour tablette (largeur de l'iframe tablet = 700px) */
                        @media (min-width: 381px) and (max-width: 800px) {
                            body {
                                font-size: 16px;
                                padding: 15px;
                            }
                            
                            canvas {
                                max-width: 600px !important;
                            }
                        }
                        
                        ${css}
                    </style>
                </head>
                <body>
                    ${html}
                    <script>
                        // Patch WebGL preserveDrawingBuffer pour toDataURL (thumbnails)
                        (function() {
                            const origGetContext = HTMLCanvasElement.prototype.getContext;
                            HTMLCanvasElement.prototype.getContext = function(type, attrs) {
                                if (type === 'webgl' || type === 'webgl2') {
                                    attrs = Object.assign({}, attrs || {}, { preserveDrawingBuffer: true });
                                }
                                return origGetContext.call(this, type, attrs);
                            };
                        })();
                        // Forcer le canvas WebGL/Three.js √† remplir toute la fen√™tre
                        function fixWebGLCanvas() {
                            const canvases = document.querySelectorAll('canvas');
                            canvases.forEach(canvas => {
                                const ctx = canvas.getContext && (canvas.getContext('webgl') || canvas.getContext('webgl2') || canvas.getContext('2d'));
                                const isFullscreen = canvas.parentElement && (
                                    canvas.parentElement.id === 'canvas-container' ||
                                    canvas.parentElement === document.body ||
                                    canvas.style.position === 'fixed' ||
                                    canvas.style.position === 'absolute'
                                );
                                if (isFullscreen) {
                                    // Forcer la taille correcte
                                    canvas.style.width = '100%';
                                    canvas.style.height = '100%';
                                    canvas.style.maxWidth = 'none';
                                    canvas.style.maxHeight = 'none';
                                    canvas.style.transform = '';
                                    // S'assurer que le parent prend tout l'√©cran
                                    if (canvas.parentElement && canvas.parentElement !== document.body) {
                                        canvas.parentElement.style.width = '100vw';
                                        canvas.parentElement.style.height = '100vh';
                                        canvas.parentElement.style.overflow = 'hidden';
                                    }
                                } else {
                                    // Canvas non-fullscreen : adapter √† son conteneur
                                    const parent = canvas.parentElement;
                                    if (parent) {
                                        const parentWidth = parent.offsetWidth;
                                        const canvasWidth = canvas.width;
                                        if (canvasWidth > parentWidth && parentWidth > 0) {
                                            const scale = parentWidth / canvasWidth;
                                            canvas.style.transform = 'scale(' + scale + ')';
                                            canvas.style.transformOrigin = 'top left';
                                        }
                                    }
                                }
                            });
                        }
                        window.addEventListener('load', fixWebGLCanvas);
                        // Observer les nouveaux canvas (Three.js les cr√©e apr√®s le load)
                        const _canvasObserver = new MutationObserver(function(mutations) {
                            let hasNewCanvas = false;
                            mutations.forEach(m => m.addedNodes.forEach(n => {
                                if (n.nodeName === 'CANVAS' || (n.querySelectorAll && n.querySelectorAll('canvas').length)) hasNewCanvas = true;
                            }));
                            if (hasNewCanvas) setTimeout(fixWebGLCanvas, 100);
                        });
                        _canvasObserver.observe(document.body || document.documentElement, { childList: true, subtree: true });
                        // Aussi au resize
                        window.addEventListener('resize', fixWebGLCanvas);
                        
                        // ===== PONT CONSOLE ‚Üí SCRIX =====
                        (function() {
                            function _send(method, args) {
                                try {
                                    var ts = new Date().toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
                                    var strArgs = [];
                                    for (var i = 0; i < args.length; i++) {
                                        var a = args[i];
                                        if (a === null) strArgs.push('null');
                                        else if (a === undefined) strArgs.push('undefined');
                                        else if (typeof a === 'object') { try { strArgs.push(JSON.stringify(a)); } catch(ex) { strArgs.push(String(a)); } }
                                        else strArgs.push(String(a));
                                    }
                                    if (window.parent && window.parent.scrixConsoleLog) {
                                        window.parent.scrixConsoleLog(method, strArgs, ts);
                                    }
                                } catch(ex) {}
                            }
                            ['log','warn','error','info','debug'].forEach(function(m) {
                                var _o = (console[m] || console.log).bind(console);
                                console[m] = function() { _o.apply(console, arguments); _send(m, arguments); };
                            });
                            window.addEventListener('error', function(e) {
                                _send('error', ['\u274C ' + e.message]);
                            });
                        })();
                        // ===== FIN PONT CONSOLE =====

                        try {
                            ${js}
                        } catch(err) {
                            var _ts = new Date().toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
                            if (window.parent && window.parent.scrixConsoleLog) {
                                window.parent.scrixConsoleLog('error', ['\u274C ' + err.message], _ts);
                            }
                        }
                    <\/script></body>
                </html>
            `;

            // Utiliser srcdoc pour garder la m√™me origine (window.parent accessible)
            const preview = document.getElementById('preview');

            // ===== D√âTECTION ERREURS DE SYNTAXE =====
            // new Function() compile le JS sans l'ex√©cuter ‚Üí attrape les SyntaxError
            try {
                new Function(js);
            } catch(syntaxErr) {
                // Erreur de syntaxe d√©tect√©e ‚Äî afficher dans la console sans lancer l'iframe
                const ts = new Date().toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
                window.scrixConsoleLog('error', ['\u274C Erreur de syntaxe : ' + syntaxErr.message], ts);
                loading.classList.remove('active');
                if (runBtn) { runBtn.disabled = false; runBtn.innerHTML = '‚ñ∂Ô∏è Ex√©cuter'; }
                return; // ne pas ex√©cuter le code invalide
            }
            // ===== FIN D√âTECTION SYNTAXE =====

            preview.srcdoc = output;

            // Masquer le loading quand l'iframe est charg√©e
            preview.onload = () => {
                loading.classList.remove('active');
                // Afficher le timer
                if (window._execStartTime) {
                    const ms = Math.round(performance.now() - window._execStartTime);
                    showExecTimer(ms);
                    // Enregistrer dans l'historique apr√®s 2s (pour avoir les logs)
                    setTimeout(() => {
                        const c = window._scrixConsoleCount;
                        addToHistory(c.error, c.warn, c.log, ms);
                    }, 2000);
                }
                // ‚úÖ Restaurer le bouton Ex√©cuter
                const _rb = document.getElementById('runBtn');
                if (_rb) { _rb.disabled = false; _rb.innerHTML = '‚ñ∂Ô∏è Ex√©cuter'; }
            };
            setTimeout(() => { loading.classList.remove('active'); }, 1500); // fallback

            setTimeout(() => {
                try {
                    const previewFrame = document.getElementById('preview');
                    const doc = previewFrame.contentDocument || (previewFrame.contentWindow && previewFrame.contentWindow.document);
                    if (!doc) { return; }
                    
                    // Injecter du CSS suppl√©mentaire pour masquer les scrollbars
                    const style = doc.createElement('style');
                    style.textContent = `
                        * { 
                            scrollbar-width: none !important;
                            -ms-overflow-style: none !important;
                        }
                        *::-webkit-scrollbar {
                            display: none !important;
                            width: 0 !important;
                            height: 0 !important;
                        }
                    `;
                    doc.head.appendChild(style);
                } catch(e) {
                    console.log('Could not inject scrollbar styles:', e);
                }
                
                loading.classList.remove('active');
                // updateStatus() removed - status bar removed
            }, 400);
        }

        // Vrai Python via Skulpt (JS pur, pas de WebAssembly)
        async function runPython() {
            const pythonCode = getEditorValue('pythonEditor');
            const output = document.getElementById('pythonOutput');
            const result = document.getElementById('pythonResult');

            output.classList.add('active');

            // V√©rifier que Skulpt est charg√©
            if (typeof Sk === 'undefined') {
                result.innerHTML = '<div style="color:#ef4444;">‚ùå Skulpt non charg√©. V√©rifie ta connexion internet et recharge la page.</div>';
                return;
            }

            result.innerHTML = '<div style="color:#a78bfa;">‚è≥ Ex√©cution...</div>';

            let captured = '';

            function outf(text) {
                captured += text;
            }
            function builtinRead(x) {
                if (Sk.builtinFiles === undefined || Sk.builtinFiles['files'][x] === undefined) {
                    throw "File not found: '" + x + "'";
                }
                return Sk.builtinFiles['files'][x];
            }

            // ‚úÖ execLimit : timeout 5s pour √©viter les boucles infinies qui bloquent le navigateur
            Sk.configure({
                output: outf,
                read: builtinRead,
                __future__: Sk.python3,
                execLimit: 5000  // 5 secondes max
            });

            try {
                await Sk.misceval.asyncToPromise(() =>
                    Sk.importMainWithBody('<stdin>', false, pythonCode, true)
                );

                if (captured.trim()) {
                    const lines = captured.trim().split('\n');
                    result.innerHTML = lines.map(line =>
                        `<div style="padding:4px 0;color:#10b981;font-family:var(--font-mono);font-size:13px;">${escapeHtml(line)}</div>`
                    ).join('') + '<div style="padding:8px 0;color:#a78bfa;">‚úÖ Code Python ex√©cut√© avec succ√®s!</div>';
                } else {
                    result.innerHTML = '<div style="color:#f59e0b;">‚ö†Ô∏è Aucune sortie. Utilise print() pour afficher des r√©sultats.</div>';
                }
            } catch (err) {
                const errMsg = err.toString();
                const isTimeout = errMsg.includes('Execution exceeded') || errMsg.includes('execLimit');
                const displayMsg = isTimeout
                    ? '‚è± Temps d\'ex√©cution d√©pass√© (5s) ‚Äî boucle infinie d√©tect√©e ? V√©rifie tes while/for.'
                    : errMsg;
                result.innerHTML = `<div style="color:#ef4444;font-weight:600;">‚ùå Erreur Python:</div><pre style="color:#ef4444;font-family:var(--font-mono);font-size:12px;margin:8px 0;white-space:pre-wrap;">${escapeHtml(displayMsg)}</pre>`;
            }
        }

        // Fonction pour fermer la console Python
        function closePythonOutput() {
            document.getElementById('pythonOutput').classList.remove('active');
        }
        
        // Fonction utilitaire pour √©chapper le HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Clear all
        function clearAll() {
            scrixConfirm({
                icon: 'trash',
                title: 'Tout effacer ?',
                desc: 'Cette action supprimera tout le code dans les √©diteurs.',
                okText: 'Effacer',
                cancelText: 'Annuler',
                danger: true
            }, (ok) => {
                if (ok) {
                    setEditorValue('htmlEditor', '');
                    setEditorValue('cssEditor', '');
                    setEditorValue('jsEditor', '');
                    setEditorValue('pythonEditor', '');
                    document.getElementById('pythonOutput').classList.remove('active');
                    runCode();
                    showNotification('Tous les √©diteurs ont √©t√© effac√©s', 'success');
                }
            });
        }

        // Download code
        function downloadCode() {
            const html = getEditorValue('htmlEditor');
            const css = getEditorValue('cssEditor');
            const js = getEditorValue('jsEditor');
            const projectName = document.querySelector('.project-name').value || 'mon-projet';

            const fullCode = `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${projectName}</title>
    <style>
${css}
    </style>
</head>
<body>
${html}
    <script>
${js}
    <\/script></body>
</html>`;

            const blob = new Blob([fullCode], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = projectName.toLowerCase().replace(/\s+/g, '-') + '.html';
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Fichier t√©l√©charg√© avec succ√®s', 'success');
        }

        // Import code from HTML file
        function importCode() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.html,.htm';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const content = event.target.result;
                        
                        // Extraire HTML (sans les balises script et style)
                        const htmlMatch = content.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
                        const html = htmlMatch ? htmlMatch[1].replace(/<script[\s\S]*?<\/script>/gi, '').replace(/<style[\s\S]*?<\/style>/gi, '').trim() : '';
                        
                        // Extraire CSS (toutes les balises style)
                        const cssMatches = [...content.matchAll(/<style[^>]*>([\s\S]*?)<\/style>/gi)];
                        const css = cssMatches.map(m => m[1].trim()).join('\n\n');
                        
                        // Extraire JavaScript ‚Äî tous les <script> INLINE (sans attribut src)
                        const jsMatches = [...content.matchAll(/<script(?![^>]*\bsrc\b)[^>]*>([\s\S]*?)<\/script>/gi)];
                        const js = jsMatches.map(m => m[1].trim()).filter(s => s.length > 0).join('\n\n');
                        
                        // Extraire le titre pour le nom du projet
                        const titleMatch = content.match(/<title[^>]*>([\s\S]*?)<\/title>/i);
                        const projectName = titleMatch ? titleMatch[1].trim() : file.name.replace('.html', '').replace('.htm', '');
                        
                        // Charger le code dans les √©diteurs
                        setEditorValue('htmlEditor', html);
                        setEditorValue('cssEditor', css);
                        setEditorValue('jsEditor', js);
                        document.querySelector('.project-name').value = projectName;
                        
                        // Ex√©cuter le code
                        runCode();
                        
                        showNotification('Fichier import√© avec succ√®s', 'success');
                    } catch (error) {
                        showNotification('Erreur lors de l\'importation du fichier', 'error');
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Copy code
        function copyCode(type) {
            const editorId = type + 'Editor';
            const code = getEditorValue(editorId);
            
            // Try modern clipboard API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(code)
                    .then(() => {
                        showNotification(`Code ${type.toUpperCase()} copi√©`, 'success');
                    })
                    .catch(err => {
                        console.error('Erreur clipboard API:', err);
                        // Fallback to old method
                        editor.select();
                        try {
                            const successful = document.execCommand('copy');
                            if (successful) {
                                showNotification(`Code ${type.toUpperCase()} copi√©`, 'success');
                            } else {
                                showNotification('Impossible de copier le code', 'error');
                            }
                        } catch (e) {
                            showNotification('Erreur lors de la copie', 'error');
                        }
                    });
            } else {
                // Fallback for older browsers
                editor.select();
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        showNotification(`Code ${type.toUpperCase()} copi√©`, 'success');
                    } else {
                        showNotification('Impossible de copier le code', 'error');
                    }
                } catch (e) {
                    showNotification('Erreur lors de la copie', 'error');
                }
            }
        }

        // Format code
        function formatCode(type) {
            const editorId = type + 'Editor';
            let code = getEditorValue(editorId);
            let formatted = '';

            try {
                if (type === 'html') {
                    formatted = html_beautify(code, {
                        indent_size: 2,
                        indent_char: ' ',
                        max_preserve_newlines: 1,
                        preserve_newlines: true,
                        keep_array_indentation: false,
                        break_chained_methods: false,
                        indent_scripts: 'normal',
                        brace_style: 'collapse',
                        space_before_conditional: true,
                        unescape_strings: false,
                        jslint_happy: false,
                        end_with_newline: false,
                        wrap_line_length: 0,
                        indent_inner_html: false,
                        comma_first: false,
                        e4x: false,
                        indent_empty_lines: false
                    });
                } else if (type === 'css') {
                    formatted = css_beautify(code, {
                        indent_size: 2,
                        indent_char: ' ',
                        preserve_newlines: true,
                        max_preserve_newlines: 2,
                        newline_between_rules: true
                    });
                } else if (type === 'js') {
                    formatted = js_beautify(code, {
                        indent_size: 2,
                        indent_char: ' ',
                        max_preserve_newlines: 2,
                        preserve_newlines: true,
                        keep_array_indentation: false,
                        break_chained_methods: false,
                        indent_scripts: 'normal',
                        brace_style: 'collapse',
                        space_before_conditional: true,
                        unescape_strings: false,
                        jslint_happy: false,
                        end_with_newline: false,
                        wrap_line_length: 0,
                        comma_first: false
                    });
                } else if (type === 'python') {
                    // Formatage Python basique PEP8
                    const pyLines = code.split('\n');
                    const pyOut = [];
                    let prevBlank = false;
                    for (let i = 0; i < pyLines.length; i++) {
                        let line = pyLines[i];
                        // Normaliser indentation : remplacer tabs par 4 espaces
                        line = line.replace(/\t/g, '    ');
                        // Supprimer espaces en fin de ligne
                        line = line.trimEnd();
                        // Op√©rateurs : espace autour de = (hors d√©fauts de fonctions), +, -, etc.
                        // (On √©vite d'√™tre trop agressif pour ne pas casser les cha√Ænes)
                        const isBlank = line.trim() === '';
                        // Max 2 lignes vides cons√©cutives
                        if (isBlank) {
                            if (!prevBlank) pyOut.push('');
                            prevBlank = true;
                        } else {
                            pyOut.push(line);
                            prevBlank = false;
                        }
                    }
                    // Supprimer les lignes vides en fin de fichier
                    while (pyOut.length && pyOut[pyOut.length - 1].trim() === '') pyOut.pop();
                    formatted = pyOut.join('\n') + '\n';
                    showNotification('Code Python format√© (PEP8 basique)', 'success');
                }
                
                setEditorValue(editorId, formatted || code);
                showNotification(`Code ${type.toUpperCase()} format√© avec succ√®s`, 'success');
            } catch (error) {
                showNotification(`Erreur de formatage: ${error.message}`, 'error');
            }
        }

        // Update status
        // updateStatus function removed - status bar removed

        // Toggle console
        function toggleConsole() {
            const panel = document.getElementById('consolePanel');
            panel.classList.toggle('active');
            if (panel.classList.contains('active')) {
                // Reset le badge d'erreur visible
                const btn = document.querySelector('[onclick="toggleConsole()"]');
                if (btn) btn.style.color = '';
                // Reset le filtre √† "all" pour tout afficher
                filterConsole('all');
            }
        }

        // Open fullscreen
        function openFullscreen() {
            const preview = document.getElementById('preview');
            if (preview.requestFullscreen) {
                preview.requestFullscreen();
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            // Supprimer les anciennes notifications
            const oldNotifs = document.querySelectorAll('.notification');
            oldNotifs.forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            // Ic√¥nes selon le type
            const icons = {
                success: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>',
                error: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
                info: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
                warn: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
            };
            
            // Titres selon le type
            const titles = {
                success: 'Succ√®s',
                error: 'Erreur',
                info: 'Information',
                warn: 'Attention'
            };
            
            // √âchapper le message pour √©viter les injections XSS
            const safeMsg = String(message).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            
            notification.innerHTML = `
                <div class="notification-icon">${icons[type] || 'üí°'}</div>
                <div class="notification-content">
                    <div class="notification-title">${titles[type] || 'Info'}</div>
                    <div class="notification-message">${safeMsg}</div>
                </div>
            `;
            
            // Ajouter directement au body pour √©viter les probl√®mes de z-index
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
                setTimeout(() => notification.remove(), 500);
            }, 4000);
        }

        // Tab support in textareas
        document.querySelectorAll('textarea').forEach(textarea => {
            textarea.addEventListener('keydown', function(e) {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = this.selectionStart;
                    const end = this.selectionEnd;
                    this.value = this.value.substring(0, start) + '  ' + this.value.substring(end);
                    this.selectionStart = this.selectionEnd = start + 2;
                }
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                runCode();
                showNotification('Code ex√©cut√© avec succ√®s', 'success');
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                clearAll();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                downloadCode();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === '/') {
                e.preventDefault();
                openShortcuts();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                const activeTab = document.querySelector('.tab-btn.active').textContent.trim().toLowerCase();
                toggleFindReplace(activeTab);
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                newProject();
            }
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'S') {
                e.preventDefault();
                saveCurrentProject();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                e.preventDefault();
                toggleProjects();
            }
        });

        // ========== NOUVELLES FONCTIONS ==========

        // Menu Hamburger
        function refreshMenuPill() {
            const user = window._fbUser;
            const menuConnected = document.getElementById('menuAccountConnected');
            const menuDisconnected = document.getElementById('menuAccountDisconnected');
            if (!menuConnected || !menuDisconnected) return;
            if (user) {
                const _savedProf = JSON.parse(localStorage.getItem('scrix_profile_' + user.uid) || '{}');
                const firstName = _savedProf.username || (user.displayName || 'User').split(' ')[0];
                menuDisconnected.style.display = 'none';
                menuConnected.style.display = 'flex';
                document.getElementById('menuUsername').textContent = firstName;
                const avatarSrc = _savedProf.customAvatar || user.photoURL || null;
                const mImg = document.getElementById('menuAvatarImg');
                const mFallback = document.getElementById('menuAvatarFallback');
                if (avatarSrc) {
                    mImg.src = avatarSrc;
                    mImg.style.display = 'block';
                    mFallback.style.display = 'none';
                } else {
                    mImg.style.display = 'none';
                    mFallback.style.display = 'flex';
                    mFallback.textContent = firstName[0].toUpperCase();
                }
                // Update sidebar workspace
                const wsName = document.getElementById('sidebarWsName');
                const wsAvatar = document.getElementById('sidebarWsAvatar');
                if (wsName) wsName.textContent = firstName + "'s workspace";
                if (wsAvatar) wsAvatar.textContent = firstName[0].toUpperCase();
            } else {
                menuConnected.style.display = 'none';
                menuDisconnected.style.display = 'flex';
            }
        }

        function toggleMenu() {
            // Fermer les param√®tres si ouverts
            const settingsPanel = document.getElementById('settingsPanel');
            if (settingsPanel.classList.contains('active')) {
                settingsPanel.classList.remove('active');
                document.getElementById('settingsOverlay').classList.remove('active');
            }
            
            const menu = document.getElementById('dropdownMenu');
            const menuBtn = document.getElementById('menuBtn');
            const overlay = document.getElementById('menuOverlay');
            
            menu.classList.toggle('active');
            menuBtn.classList.toggle('active');
            overlay.classList.toggle('active');

            // Rafra√Æchir la pill compte √† chaque ouverture
            if (menu.classList.contains('active')) refreshMenuPill();
        }

        // Helper: set active nav item in sidebar
        function setActiveMenuItem(el) {
            document.querySelectorAll('.sidebar-nav .menu-item').forEach(i => i.classList.remove('active'));
            if (el) el.classList.add('active');
        }

        // ===== SIDEBAR HOVER HIGHLIGHT =====
        let _navReturnTimer = null;

        function _initSidebarGlider() {
            const nav = document.querySelector('.sidebar-nav');
            if (!nav || nav._gliderInited) return;
            nav._gliderInited = true;

            const items = nav.querySelectorAll('.menu-item');

            // Set initial active item as nav-lit
            const activeItem = nav.querySelector('.menu-item.active');
            if (activeItem) activeItem.classList.add('nav-lit');

            items.forEach(item => {
                item.addEventListener('mouseenter', () => {
                    // Cancel any pending return animation
                    if (_navReturnTimer) { clearTimeout(_navReturnTimer); _navReturnTimer = null; }
                    // Remove nav-lit from all (triggers fade-out via CSS), add to hovered instantly
                    items.forEach(i => {
                        if (i.classList.contains('nav-lit')) {
                            i.classList.remove('nav-lit');
                            i.classList.add('nav-fade-out');
                            setTimeout(() => i.classList.remove('nav-fade-out'), 200);
                        }
                    });
                    item.classList.add('nav-lit');
                });

                item.addEventListener('mouseleave', () => {
                    const active = nav.querySelector('.menu-item.active');
                    if (!active) return;

                    // Step 1: fade out current
                    item.classList.remove('nav-lit');

                    // Step 2: light up active after CSS fade completes (200ms matches transition)
                    _navReturnTimer = setTimeout(() => {
                        active.classList.add('nav-lit');
                        _navReturnTimer = null;
                    }, 200);
                });

                item.addEventListener('click', () => {
                    setActiveMenuItem(item);
                    items.forEach(i => i.classList.remove('nav-lit'));
                    item.classList.add('nav-lit');
                });
            });
        }

        let _gliderActive = null;
        let _gliderHover = null;
        let _gliderNav = null;

        document.addEventListener('DOMContentLoaded', () => {
            const menuBtn = document.getElementById('menuBtn');
            if (menuBtn) {
                menuBtn.addEventListener('click', () => {
                    setTimeout(_initSidebarGlider, 50);
                });
            }
        });

        function closeMenu() {
            const menu = document.getElementById('dropdownMenu');
            const menuBtn = document.getElementById('menuBtn');
            const overlay = document.getElementById('menuOverlay');
            
            menu.classList.remove('active');
            menuBtn.classList.remove('active');
            overlay.classList.remove('active');
        }

        // Close menu on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const overlay = document.getElementById('gameFullscreenOverlay');
                if (overlay && overlay.classList.contains('active')) {
                    closeFullscreenGame();
                    return;
                }
                closeMenu();
            }
        });

        // LocalStorage - Auto-save & Load
        function autoSaveToStorage() {
            if (settings.autoSave) {
                const code = {
                    html: getEditorValue('htmlEditor'),
                    css: getEditorValue('cssEditor'),
                    js: getEditorValue('jsEditor'),
                    python: getEditorValue('pythonEditor'),
                    projectName: document.querySelector('.project-name').value,
                    timestamp: Date.now()
                };
                try {
                    localStorage.setItem('scrix_autosave', JSON.stringify(code));
                } catch(e) {
                    if (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
                        // Espace plein : essayer de vider l'ancienne autosave d'abord
                        try {
                            localStorage.removeItem('scrix_autosave');
                            localStorage.setItem('scrix_autosave', JSON.stringify(code));
                        } catch(e2) {
                            showNotification('Autosave impossible : espace local plein. Sauvegarde manuelle recommand√©e.', 'error');
                        }
                    }
                }
            }
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('scrix_autosave');
            if (saved) {
                try {
                    const code = JSON.parse(saved);
                    setEditorValue('htmlEditor', code.html || '');
                    setEditorValue('cssEditor', code.css || '');
                    setEditorValue('jsEditor', code.js || '');
                    setEditorValue('pythonEditor', code.python || '');
                    if (code.projectName) {
                        document.querySelector('.project-name').value = code.projectName;
                    }
                    // notification supprim√©e volontairement
                } catch (e) {
                    console.error('Erreur de chargement:', e);
                }
            }
        }

        // Auto-save on editor change ‚Äî g√©r√© via CodeMirror cm.on('change')
        // (les addEventListener sur textarea sont remplac√©s par CodeMirror)
        ['htmlEditor', 'cssEditor', 'jsEditor', 'pythonEditor'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', () => {
                clearTimeout(window.autoSaveTimeout);
                window.autoSaveTimeout = setTimeout(autoSaveToStorage, 2000);
            });
        });

        // Auto-complete et Tab ‚Äî CodeMirror s'en charge nativement, pas besoin de keydown manuel

        // Responsive Preview
        function setDeviceView(device) {
            const preview = document.getElementById('preview');
            const buttons = document.querySelectorAll('.device-btn');
            const wrapper = document.querySelector('.preview-wrapper');
            
            buttons.forEach(btn => btn.classList.remove('active'));
            
            if (device === 'mobile') {
                preview.className = 'mobile-view';
                document.getElementById('mobileBtn').classList.add('active');
                if (wrapper) wrapper.classList.add('show-grid');
            } else if (device === 'tablet') {
                preview.className = 'tablet-view';
                document.getElementById('tabletBtn').classList.add('active');
                if (wrapper) wrapper.classList.add('show-grid');
            } else {
                preview.className = '';
                document.getElementById('desktopBtn').classList.add('active');
                if (wrapper) wrapper.classList.remove('show-grid');
            }
            
            // Forcer le masquage des scrollbars apr√®s changement de vue
            setTimeout(() => {
                try {
                    const doc = preview.contentDocument || preview.contentWindow.document;
                    if (doc && doc.body) {
                        const style = doc.createElement('style');
                        style.textContent = `
                            * { 
                                scrollbar-width: none !important;
                                -ms-overflow-style: none !important;
                            }
                            *::-webkit-scrollbar {
                                display: none !important;
                                width: 0 !important;
                                height: 0 !important;
                            }
                        `;
                        if (doc.head) {
                            doc.head.appendChild(style);
                        }
                    }
                } catch(e) {
                    // Ignore cross-origin errors
                }
            }, 100);
        }

        // Share Code
        function shareCode() {
            const html = getEditorValue('htmlEditor');
            const css = getEditorValue('cssEditor');
            const js = getEditorValue('jsEditor');
            
            const code = btoa(unescape(encodeURIComponent(JSON.stringify({ html, css, js }))));
            const shareUrl = `${window.location.origin}${window.location.pathname}?code=${code}`;
            
            document.getElementById('shareUrl').textContent = shareUrl;
            document.getElementById('shareModal').classList.add('active');
            
            // Clear previous QR code and generate new one using API
            const qrcodeDiv = document.getElementById('qrcode');
            qrcodeDiv.innerHTML = '<div style="color: var(--text-tertiary); text-align: center; padding: 20px; font-size: 13px;">G√©n√©ration du QR code...</div>';
            
            // Check URL length - QR codes have data limits
            const MAX_QR_URL_LENGTH = 800; // practical limit for reliable scanning
            
            if (shareUrl.length > MAX_QR_URL_LENGTH) {
                qrcodeDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <div style="color: var(--text-secondary); margin-bottom: 8px; font-size: 13px; font-weight: 600;">URL trop longue pour un QR code lisible</div>
                        <div style="color: var(--text-tertiary); font-size: 12px; line-height: 1.5;">Votre projet contient trop de code pour √™tre encod√© dans un QR code.<br>Utilisez le bouton "Copier le lien" √† la place.</div>
                    </div>`;
                return;
            }
            
            // Use QR Server API which handles long URLs better
            const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(shareUrl)}&color=4f8ef7&bgcolor=111112&qzone=2&format=png`;
            
            // Create image element for QR code
            const img = document.createElement('img');
            img.src = qrApiUrl;
            img.alt = 'QR Code';
            img.style.display = 'block';
            img.style.margin = '0 auto';
            img.style.maxWidth = '200px';
            img.style.height = 'auto';
            img.style.borderRadius = '8px';
            
            img.onload = () => {
                qrcodeDiv.innerHTML = '';
                qrcodeDiv.appendChild(img);
            };
            
            img.onerror = () => {
                // Fallback: try with local QRCode.js library
                qrcodeDiv.innerHTML = '';
                try {
                    new QRCode(qrcodeDiv, {
                        text: shareUrl,
                        width: 200,
                        height: 200,
                        colorDark: '#4f8ef7',
                        colorLight: '#111112',
                        correctLevel: QRCode.CorrectLevel.L // Use Low correction for longer URLs
                    });
                } catch (e) {
                    qrcodeDiv.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <div style="color: var(--text-secondary); margin-bottom: 8px; font-size: 13px; font-weight: 600;">QR code indisponible</div>
                            <div style="color: var(--text-tertiary); font-size: 12px;">Utilisez le bouton "Copier le lien" √† la place</div>
                        </div>
                    `;
                }
            };
        }

        function closeShare() {
            document.getElementById('shareModal').classList.remove('active');
        }

        function copyShareUrl() {
            const url = document.getElementById('shareUrl').textContent;
            
            // Try modern clipboard API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url)
                    .then(() => {
                        showNotification('Lien copi√© dans le presse-papier', 'success');
                    })
                    .catch(err => {
                        console.error('Erreur clipboard API:', err);
                        // Fallback to old method
                        fallbackCopyToClipboard(url);
                    });
            } else {
                // Fallback for older browsers
                fallbackCopyToClipboard(url);
            }
        }

        function fallbackCopyToClipboard(text) {
            // Create a temporary textarea
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.top = '-9999px';
            textArea.style.left = '-9999px';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            
            try {
                textArea.focus();
                textArea.select();
                
                // Try to copy
                const successful = document.execCommand('copy');
                if (successful) {
                    showNotification('Lien copi√© dans le presse-papier', 'success');
                } else {
                    showNotification('Impossible de copier le lien', 'error');
                }
            } catch (err) {
                console.error('Erreur lors de la copie:', err);
                showNotification('Erreur lors de la copie du lien', 'error');
            } finally {
                document.body.removeChild(textArea);
            }
        }

        function downloadQR() {
            const qrcodeDiv = document.getElementById('qrcode');
            const canvas = qrcodeDiv.querySelector('canvas');
            const img = qrcodeDiv.querySelector('img');
            
            if (img && img.src) {
                // Si on a une image (de l'API), on la t√©l√©charge
                fetch(img.src)
                    .then(response => response.blob())
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'qrcode-scrix.png';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        showNotification('QR Code t√©l√©charg√©', 'success');
                    })
                    .catch(() => {
                        // Fallback: utiliser directement le src
                        const a = document.createElement('a');
                        a.href = img.src;
                        a.download = 'qrcode-scrix.png';
                        a.target = '_blank';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        showNotification('QR Code t√©l√©charg√©', 'success');
                    });
            } else if (canvas) {
                // Si on a un canvas (de QRCode.js)
                const url = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = url;
                a.download = 'qrcode-scrix.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                showNotification('QR Code t√©l√©charg√©', 'success');
            } else {
                showNotification('Aucun QR Code √† t√©l√©charger', 'error');
            }
        }

        // Game Selector
        // Templates
        function openTemplates() {
            document.getElementById('templatesModal').classList.add('active');
        }

        function closeTemplates() {
            document.getElementById('templatesModal').classList.remove('active');
        }

        function closeGameSelector() {
            // Ferme le s√©lecteur de jeux (si n√©cessaire)
            // Cette fonction est appel√©e lors du chargement d'un template
            const gamesMenu = document.getElementById('gamesMenu');
            const gameArea = document.getElementById('gameArea');
            if (gamesMenu) gamesMenu.style.display = 'none';
            if (gameArea) gameArea.classList.remove('active');
        }

        const templates = {
            glitchInput: {
                html: `<div class="glitch-input-wrapper">
  <div class="input-container">
    <input type="text" id="holo-input" class="holo-input" placeholder="" required="">
    <label for="holo-input" class="input-label" data-text="ACCESS_CODE">ACCESS_CODE</label>
    <div class="input-border"></div>
    <div class="input-scanline"></div>
    <div class="input-glow"></div>
    <div class="input-data-stream">
      <div class="stream-bar" style="--i: 0;"></div>
      <div class="stream-bar" style="--i: 1;"></div>
      <div class="stream-bar" style="--i: 2;"></div>
      <div class="stream-bar" style="--i: 3;"></div>
      <div class="stream-bar" style="--i: 4;"></div>
      <div class="stream-bar" style="--i: 5;"></div>
      <div class="stream-bar" style="--i: 6;"></div>
      <div class="stream-bar" style="--i: 7;"></div>
      <div class="stream-bar" style="--i: 8;"></div>
      <div class="stream-bar" style="--i: 9;"></div>
    </div>
    <div class="input-corners">
      <div class="corner corner-tl"></div>
      <div class="corner corner-tr"></div>
      <div class="corner corner-bl"></div>
      <div class="corner corner-br"></div>
    </div>
  </div>
</div>`,
                css: `.glitch-input-wrapper { --bg-color: #0d0d0d; --primary-color: #00f2ea; --secondary-color: #a855f7; --text-color: #e5e5e5; --font-family: "Fira Code", Consolas, "Courier New", Courier, monospace; --glitch-anim-duration: 0.4s; display: flex; justify-content: center; align-items: center; font-family: var(--font-family); font-size: 16px; padding: 3rem; min-height: 100vh; background: #0d0d0d; }
.input-container { position: relative; width: 19rem; }
.holo-input { width: 100%; height: 3.5rem; background: rgba(13, 13, 13, 0.7); border: none; border-bottom: 2px solid #333; outline: none; padding: 0 1rem; color: var(--primary-color); font-family: inherit; font-size: 1.1rem; caret-color: var(--primary-color); z-index: 10; transition: background 0.3s ease, border-color 0.3s ease; }
.input-label { position: absolute; top: 1rem; left: 1rem; color: var(--text-color); opacity: 0.6; text-transform: uppercase; letter-spacing: 0.1em; pointer-events: none; transition: all 0.3s ease; z-index: 11; }
.holo-input:focus + .input-label, .holo-input:not(:placeholder-shown) + .input-label { top: -1.5rem; left: 0; font-size: 0.8rem; opacity: 1; color: var(--primary-color); }
.holo-input:focus + .input-label::before, .holo-input:focus + .input-label::after { content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #212121; }
.holo-input:focus + .input-label::before { color: var(--secondary-color); animation: glitch-label var(--glitch-anim-duration) cubic-bezier(0.25, 0.46, 0.45, 0.94) both; }
.holo-input:focus + .input-label::after { color: var(--primary-color); animation: glitch-label var(--glitch-anim-duration) cubic-bezier(0.25, 0.46, 0.45, 0.94) reverse both; }
.input-border, .input-scanline, .input-glow, .input-corners { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
.input-border { border: 1px solid rgba(0, 242, 234, 0.2); opacity: 0.5; transition: all 0.3s ease; }
.corner { position: absolute; width: 1rem; height: 1rem; border: 2px solid var(--primary-color); transition: all 0.3s ease; opacity: 0.5; }
.corner-tl { top: -0.3rem; left: -0.3rem; border-right: none; border-bottom: none; }
.corner-tr { top: -0.3rem; right: -0.3rem; border-left: none; border-bottom: none; }
.corner-bl { bottom: -0.3rem; left: -0.3rem; border-right: none; border-top: none; }
.corner-br { bottom: -0.3rem; right: -0.3rem; border-left: none; border-top: none; }
.input-glow { background: radial-gradient(ellipse at center, rgba(0, 242, 234, 0.2) 0%, transparent 70%); opacity: 0; transition: opacity 0.4s ease; }
.input-scanline { height: 100%; background: linear-gradient(to bottom, transparent 0%, rgba(0, 242, 234, 0.1) 48%, rgba(0, 242, 234, 0.3) 50%, rgba(0, 242, 234, 0.1) 52%, transparent 100%); opacity: 0; }
.input-data-stream { position: absolute; bottom: 2px; left: 0; width: 100%; height: 0.3rem; display: flex; opacity: 0; transition: opacity 0.3s ease 0.1s; }
.stream-bar { flex-grow: 1; background-color: var(--primary-color); transition: transform 0.2s, opacity 0.2s; transform: scaleY(0); transform-origin: bottom; }
.holo-input:focus { border-color: transparent; }
.holo-input:focus ~ .input-border { opacity: 1; border-color: rgba(0, 242, 234, 0.5); }
.holo-input:focus ~ .input-corners .corner { width: 1.25rem; height: 1.25rem; border-width: 3px; opacity: 1; }
.holo-input:focus ~ .input-glow { opacity: 1; }
.holo-input:focus ~ .input-scanline { animation: scan-vertical 4s linear infinite; }
.holo-input:focus ~ .input-data-stream { opacity: 1; }
.holo-input:focus ~ .input-data-stream .stream-bar { animation: data-pulse 2s infinite; animation-delay: calc(var(--i) * 0.1s); }
@keyframes glitch-label { 0% { transform: translate(0); clip-path: inset(0 0 0 0); } 20% { transform: translate(-0.2rem, 0.1rem); clip-path: inset(50% 0 20% 0); } 40% { transform: translate(0.1rem, -0.1rem); clip-path: inset(20% 0 60% 0); } 60% { transform: translate(-0.15rem, 0.1rem); clip-path: inset(80% 0 5% 0); } 80% { transform: translate(0.15rem, -0.15rem); clip-path: inset(30% 0 45% 0); } 100% { transform: translate(0); clip-path: inset(0 0 0 0); } }
@keyframes scan-vertical { 0% { opacity: 0; transform: translateY(-100%); } 25% { opacity: 0.5; } 75% { opacity: 0.5; } 100% { opacity: 0; transform: translateY(100%); } }
@keyframes data-pulse { 0%, 100% { transform: scaleY(0.2); opacity: 0.3; } 50% { transform: scaleY(1); opacity: 0.8; } }`,
                js: ''
            },
            flipCard: {
                html: `<div class="flip-card">
  <div class="flip-card-inner">
    <div class="flip-card-front">
      <p class="heading_8264">MASTERCARD</p>
      <svg class="logo" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="36" height="36" viewBox="0 0 48 48">
        <path fill="#ff9800" d="M32 10A14 14 0 1 0 32 38A14 14 0 1 0 32 10Z"></path>
        <path fill="#d50000" d="M16 10A14 14 0 1 0 16 38A14 14 0 1 0 16 10Z"></path>
        <path fill="#ff3d00" d="M18,24c0,4.755,2.376,8.95,6,11.48c3.624-2.53,6-6.725,6-11.48s-2.376-8.95-6-11.48 C20.376,15.05,18,19.245,18,24z"></path>
      </svg>
      <svg version="1.1" class="chip" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="30px" height="30px" viewBox="0 0 50 50">
        <image width="50" height="50" x="0" y="0" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAMAAAAp4XiDAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAB6VBMVEUAAACNcTiVeUKVeUOYfEaafEeUeUSYfEWZfEaykleyklaXe0SWekSZZjOYfEWYe0WXfUWXe0WcgEicfkiXe0SVekSXekSWekKYe0a9nF67m12ZfUWUeEaXfESVekOdgEmVeUWWekSniU+VeUKVeUOrjFKYfEWliE6WeESZe0GSe0WYfES7ml2Xe0WXeESUeEOWfEWcf0eWfESXe0SXfEWYekSVeUKXfEWxklawkVaZfEWWekOUekOWekSYfESZe0eXekWYfEWZe0WZe0eVeUSWeETAnmDCoWLJpmbxy4P1zoXwyoLIpWbjvXjivnjgu3bfu3beunWvkFWxkle/nmDivXiWekTnwXvkwHrCoWOuj1SXe0TEo2TDo2PlwHratnKZfEbQrWvPrWuafUfbt3PJp2agg0v0zYX0zYSfgkvKp2frxX7mwHrlv3rsxn/yzIPgvHfduXWXe0XuyIDzzISsjVO1lVm0lFitjVPzzIPqxX7duna0lVncuHTLqGjvyIHeuXXxyYGZfUayk1iyk1e2lln1zYTEomO2llrbtnOafkjFpGSbfkfZtXLhvHfkv3nqxH3mwXujhU3KqWizlFilh06khk2fgkqsjlPHpWXJp2erjVOhg0yWe0SliE+XekShhEvAn2D///+gx8TWAAAARnRSTlMACVCTtsRl7Pv7+vxkBab7pZv5+ZlL/UnU/f3SJCVe+Fx39naA9/75XSMh0/3SSkia+pil/KRj7Pr662JPkrbP7OLQ0JFOijI1MwAAAAFiS0dEorDd34wAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfnAg0IDx2lsiuJAAACLElEQVRIx2NgGAXkAUYmZhZWPICFmYkRVQcbOwenmzse4MbFzc6DpIGXj8PD04sA8PbhF+CFaxEU8iWkAQT8hEVgOkTF/InR4eUVICYO1SIhCRMLDAoKDvFDVhUaEhwUFAjjSUlDdMiEhcOEItzdI6OiYxA6YqODIt3dI2DcuDBZsBY5eVTr4xMSYcyk5BRUOXkFsBZFJTQnp6alQxgZmVloUkrKYC0qqmji2WE5EEZuWB6alKoKdi35YQUQRkFYPpFaCouKIYzi6EDitJSUlsGY5RWVRGjJLyxNy4ZxqtIqqvOxaVELQwZFZdkIJVU1RSiSalAt6rUwUBdWG1CP6pT6gNqwOrgCdQyHNYR5YQFhDXj8MiK1IAeyN6aORiyBjByVTc0FqBoKWpqwRCVSgilOaY2OaUPw29qjOzqLvTAchpos47u6EZyYnngUSRwpuTe6D+6qaFQdOPNLRzOM1dzhRZyW+CZouHk3dWLXglFcFIflQhj9YWjJGlZcaKAVSvjyPrRQ0oQVKDAQHlYFYUwIm4gqExGmBSkutaVQJeomwViTJqPK6OhCy2Q9sQBk8cY0DxjTJw0lAQWK6cOKfgNhpKK7ZMpUeF3jPa28BCET amiEqJKM+X1gxvWXpoUjVIVPnwErw71nmpgiqiQGBjNzbgs3j1nus+fMndc+Cwm0T52/oNR9lsdCS24ra7Tq1cbWjpXV3sHRCb1idXZ0sGdltXNxRateRwHRAACYHutzk/2I5QAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAyMy0wMi0xM1QwODoxNToyOSswMDowMEUnN7UAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMjMtMDItMTNUMDg6MTU6MjkrMDA6MDA0eo8JAAAAKHRFWHRkYXRlOnRpbWVzdGFtcAAyMDIzLTAyLTEzVDA4OjE1OjI5KzAwOjAwY2+u1gAAAABJRU5ErkJggg=="></image>
      </svg>
      <svg version="1.1" class="contactless" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="20px" height="20px" viewBox="0 0 50 50">
        <image width="50" height="50" x="0" y="0" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAQAAAC0NkA6AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QA/4ePzL8AAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfnAg0IEzgIwaKTAAADDklEQVRYw+1XS0iUURQ+f5qPyjQflGRFEEFK76koKGxRbWyVVLSOgsCgwjZBJJYuKogSIoOonUK4q3U0WVBWFPZYiIE6kuArG3VGzK/FfPeMM/MLt99/NuHdfPd888/57jn3nvsQWWj/VcMlvMMd5KRTogqx9iCdIjUUmcGR9ImUYowyP3xNGQJoRLVaZ2DaZf8kyjEJALhI28ELioyiwC+Rc3QZwRYyO/DH51hQgWm6DMIh10KmD4u9O16K49itVoPOAmcGAWWOepXIRScAoJZ2Frro8oN+EyTT6lWkkg6msZfMSR35QTJmjU0g15tIGSJ08ZZMJkJkHpNZgSkyXosS13TkJpZ62mPIJvOSzC1bp8vRhhCakEk7G9/o4gmZdbpsTcKu0m63FbnBP9Qrc15zbkbemfgNDtEOI8NO5L5O9VYyRYgmJayZ9nPaxZrSjW4+F6Uw9yQqIiIZwhp2huQTf6OIvCZyGM6gDJBZbyXifJXr7FZjGXsdxADxI7HUJFB6iWvsIhFpkoiIiGTJfjJfiCuJg2ZEspq9EHGVpYgzKqwJqSAOEwuJQ/pxPvE3cYltJCLdxBLiSKKIE5HxJKcTRNeadxfhDiuYw44zVs1dxKwRk/uCxIiQkxKBsSctRVAge9g1E15EHE6yRUaJecRxcWlukdRIbGFOSZCMWQA/iWauIP3slREHXPyliqBcrrD71Amz Z+rD1Mt2Yr8TZc/UR4/YtFnbijnHi3UrN9vKQ9rPaJf867ZiaqDB+czeKYmd3pNa6fuI75MiC0uXXSR5aEMf7s7a6r/PudVXkjFb/SsrCRfROk0Fx6+H1i9kkTGn/E1vEmt1m089fh+RKdQ5O+xNJPUi cUIjO0Dm7HwvErEr0YxeibL1StSh37STafE4I7zcBdRq1DiOkdmlTJVnkQTBTS7X1FYyvfO4piaInKbDCDaT2anLudYXCRFsQBgAcIF2/Okwgvz5+Z4tsw118dzruvIvjhTB+HOuWy8UvovEH6beitBKxDyxm9MmISKCWrzB7bSlaqGlsf0FC0gMjzTg6GgAAAAldEVYdGRhdGU6Y3JlYXRlADIwMjMtMDItMTNUMDg6MTk6NTYrMDA6MDCjlq7LAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDIzLTAyLTEzVDA4OjE5OjU2KzAwOjAw0ssWdwAAACh0RVh0ZGF0ZTp0aW1lc3RhbXAAMjAyMy0wMi0xM1QwODoxOTo1NiswMDowMIXeN6gAAAAASUVORK5CYII="></image>
      </svg>
      <p class="number">9759 2484 5269 6576</p>
      <p class="valid_thru">VALID THRU</p>
      <p class="date_8264">12/24</p>
      <p class="name">BRUCE WAYNE</p>
    </div>
    <div class="flip-card-back">
      <div class="strip"></div>
      <div class="mstrip"></div>
      <div class="sstrip"><p class="code">***</p></div>
    </div>
  </div>
</div>`,
                css: `body { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #1a1a1a; }
.flip-card { background-color: transparent; width: 240px; height: 154px; perspective: 1000px; color: white; }
.heading_8264 { position: absolute; letter-spacing: .2em; font-size: 0.5em; top: 2em; left: 18.6em; }
.logo { position: absolute; top: 6.8em; left: 11.7em; }
.chip { position: absolute; top: 2.3em; left: 1.5em; }
.contactless { position: absolute; top: 3.5em; left: 12.4em; }
.number { position: absolute; font-weight: bold; font-size: .6em; top: 8.3em; left: 1.6em; }
.valid_thru { position: absolute; font-weight: bold; top: 635.8em; font-size: .01em; left: 140.3em; }
.date_8264 { position: absolute; font-weight: bold; font-size: 0.5em; top: 13.6em; left: 3.2em; }
.name { position: absolute; font-weight: bold; font-size: 0.5em; top: 16.1em; left: 2em; }
.strip { position: absolute; background-color: black; width: 15em; height: 1.5em; top: 2.4em; background: repeating-linear-gradient(45deg, #303030, #303030 10px, #202020 10px, #202020 20px); }
.mstrip { position: absolute; background-color: rgb(255, 255, 255); width: 8em; height: 0.8em; top: 5em; left: .8em; border-radius: 2.5px; }
.sstrip { position: absolute; background-color: rgb(255, 255, 255); width: 4.1em; height: 0.8em; top: 5em; left: 10em; border-radius: 2.5px; }
.code { font-weight: bold; text-align: center; margin: .2em; color: black; }
.flip-card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.8s; transform-style: preserve-3d; }
.flip-card:hover .flip-card-inner { transform: rotateY(180deg); }
.flip-card-front, .flip-card-back { box-shadow: 0 8px 14px 0 rgba(0,0,0,0.2); position: absolute; display: flex; flex-direction: column; justify-content: center; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 1rem; }
.flip-card-front { box-shadow: rgba(0, 0, 0, 0.4) 0px 2px 2px, rgba(0, 0, 0, 0.3) 0px 7px 13px -3px, rgba(0, 0, 0, 0.2) 0px -1px 0px inset; background-color: #171717; }
.flip-card-back { box-shadow: rgba(0, 0, 0, 0.4) 0px 2px 2px, rgba(0, 0, 0, 0.3) 0px 7px 13px -3px, rgba(0, 0, 0, 0.2) 0px -1px 0px inset; background-color: #171717; transform: rotateY(180deg); }`,
                js: ''
            },
            starButton: {
                html: `<button class="star-button">
  Button
  <div class="star-1">
    <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" version="1.1" style="shape-rendering:geometricPrecision; text-rendering:geometricPrecision; image-rendering:optimizeQuality; fill-rule:evenodd; clip-rule:evenodd" viewBox="0 0 784.11 815.53">
      <g><path class="fil0" d="M392.05 0c-20.9,210.08 -184.06,378.41 -392.05,407.78 207.96,29.37 371.12,197.68 392.05,407.74 20.93,-210.06 184.09,-378.37 392.05,-407.74 -207.98,-29.38 -371.16,-197.69 -392.06,-407.78z"></path></g>
    </svg>
  </div>
  <div class="star-2">
    <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" version="1.1" style="shape-rendering:geometricPrecision; text-rendering:geometricPrecision; image-rendering:optimizeQuality; fill-rule:evenodd; clip-rule:evenodd" viewBox="0 0 784.11 815.53">
      <g><path class="fil0" d="M392.05 0c-20.9,210.08 -184.06,378.41 -392.05,407.78 207.96,29.37 371.12,197.68 392.05,407.74 20.93,-210.06 184.09,-378.37 392.05,-407.74 -207.98,-29.38 -371.16,-197.69 -392.06,-407.78z"></path></g>
    </svg>
  </div>
  <div class="star-3">
    <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" version="1.1" style="shape-rendering:geometricPrecision; text-rendering:geometricPrecision; image-rendering:optimizeQuality; fill-rule:evenodd; clip-rule:evenodd" viewBox="0 0 784.11 815.53">
      <g><path class="fil0" d="M392.05 0c-20.9,210.08 -184.06,378.41 -392.05,407.78 207.96,29.37 371.12,197.68 392.05,407.74 20.93,-210.06 184.09,-378.37 392.05,-407.74 -207.98,-29.38 -371.16,-197.69 -392.06,-407.78z"></path></g>
    </svg>
  </div>
  <div class="star-4">
    <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" version="1.1" style="shape-rendering:geometricPrecision; text-rendering:geometricPrecision; image-rendering:optimizeQuality; fill-rule:evenodd; clip-rule:evenodd" viewBox="0 0 784.11 815.53">
      <g><path class="fil0" d="M392.05 0c-20.9,210.08 -184.06,378.41 -392.05,407.78 207.96,29.37 371.12,197.68 392.05,407.74 20.93,-210.06 184.09,-378.37 392.05,-407.74 -207.98,-29.38 -371.16,-197.69 -392.06,-407.78z"></path></g>
    </svg>
  </div>
  <div class="star-5">
    <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" version="1.1" style="shape-rendering:geometricPrecision; text-rendering:geometricPrecision; image-rendering:optimizeQuality; fill-rule:evenodd; clip-rule:evenodd" viewBox="0 0 784.11 815.53">
      <g><path class="fil0" d="M392.05 0c-20.9,210.08 -184.06,378.41 -392.05,407.78 207.96,29.37 371.12,197.68 392.05,407.74 20.93,-210.06 184.09,-378.37 392.05,-407.74 -207.98,-29.38 -371.16,-197.69 -392.06,-407.78z"></path></g>
    </svg>
  </div>
  <div class="star-6">
    <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" version="1.1" style="shape-rendering:geometricPrecision; text-rendering:geometricPrecision; image-rendering:optimizeQuality; fill-rule:evenodd; clip-rule:evenodd" viewBox="0 0 784.11 815.53">
      <g><path class="fil0" d="M392.05 0c-20.9,210.08 -184.06,378.41 -392.05,407.78 207.96,29.37 371.12,197.68 392.05,407.74 20.93,-210.06 184.09,-378.37 392.05,-407.74 -207.98,-29.38 -371.16,-197.69 -392.06,-407.78z"></path></g>
    </svg>
  </div>
</button>`,
                css: `body { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #1a1a1a; }
.star-button { position: relative; padding: 12px 35px; background: #fec195; font-size: 17px; font-weight: 500; color: #181818; border: 3px solid #fec195; border-radius: 8px; box-shadow: 0 0 0 #fec1958c; transition: all 0.3s ease-in-out; cursor: pointer; }
.star-1, .star-2, .star-3, .star-4, .star-5, .star-6 { position: absolute; filter: drop-shadow(0 0 0 #fffdef); z-index: -5; }
.star-1 { top: 20%; left: 20%; width: 25px; height: auto; transition: all 1s cubic-bezier(0.05, 0.83, 0.43, 0.96); }
.star-2 { top: 45%; left: 45%; width: 15px; height: auto; transition: all 1s cubic-bezier(0, 0.4, 0, 1.01); }
.star-3 { top: 40%; left: 40%; width: 5px; height: auto; transition: all 1s cubic-bezier(0, 0.4, 0, 1.01); }
.star-4 { top: 20%; left: 40%; width: 8px; height: auto; transition: all 0.8s cubic-bezier(0, 0.4, 0, 1.01); }
.star-5 { top: 25%; left: 45%; width: 15px; height: auto; transition: all 0.6s cubic-bezier(0, 0.4, 0, 1.01); }
.star-6 { top: 5%; left: 50%; width: 5px; height: auto; transition: all 0.8s ease; }
.star-button:hover { background: transparent; color: #fec195; box-shadow: 0 0 25px #fec1958c; }
.star-button:hover .star-1 { top: -80%; left: -30%; filter: drop-shadow(0 0 10px #fffdef); z-index: 2; }
.star-button:hover .star-2 { top: -25%; left: 10%; filter: drop-shadow(0 0 10px #fffdef); z-index: 2; }
.star-button:hover .star-3 { top: 55%; left: 25%; filter: drop-shadow(0 0 10px #fffdef); z-index: 2; }
.star-button:hover .star-4 { top: 30%; left: 80%; filter: drop-shadow(0 0 10px #fffdef); z-index: 2; }
.star-button:hover .star-5 { top: 25%; left: 115%; filter: drop-shadow(0 0 10px #fffdef); z-index: 2; }
.star-button:hover .star-6 { top: 5%; left: 60%; filter: drop-shadow(0 0 10px #fffdef); z-index: 2; }
.fil0 { fill: #fffdef; }`,
                js: ''
            },
            borderButton: {
                html: `<button class="border-button">
  <span></span>
  <span></span>
  <span></span>
  <span></span>
  Hover Me
</button>`,
                css: `body { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #1a1a1a; }
.border-button { cursor: pointer; position: relative; padding: 15px 20px; text-decoration: none; border: none; color: #fff; font-size: 1.2em; text-transform: uppercase; font-family: sans-serif; letter-spacing: 4px; overflow: hidden; background: rgba(255, 255, 255, 0.1); box-shadow: 0 5px 5px rgba(0, 0, 0, 0.2); }
.border-button:before { content: ""; position: absolute; top: 0; left: 0; width: 50%; height: 100%; background: rgba(255, 255, 255, 0.1); }
.border-button::after { content: ""; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent); transition: 0.5s; transition-delay: 0.5s; }
.border-button:hover:after { left: 100%; }
.border-button span { position: absolute; display: block; transition: 0.5s ease; }
.border-button span:nth-child(1) { top: 0; left: 0; width: 0; height: 1px; background: #fff; }
.border-button:hover span:nth-child(1) { width: 100%; transform: translateX(100%); }
.border-button span:nth-child(2) { top: 0; left: 0; width: 1px; height: 0; background: #fff; }
.border-button:hover span:nth-child(2) { height: 100%; transform: translateY(100%); }
.border-button span:nth-child(3) { bottom: 0; right: 0; width: 0; height: 1px; background: #fff; }
.border-button:hover span:nth-child(3) { width: 100%; transform: translateX(-100%); }
.border-button span:nth-child(4) { bottom: 0; right: 0; width: 1px; height: 0; background: #fff; }
.border-button:hover span:nth-child(4) { height: 100%; transform: translateY(-100%); }`,
                js: ''
            },
            input3D: {
                html: `<div class="input__container">
  <div class="shadow__input"></div>
  <button class="input__button__shadow">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#000000" width="20px" height="20px">
      <path d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path>
    </svg>
  </button>
  <input type="text" name="username" class="input__search" placeholder="Enter username">
</div>`,
                css: `body { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #1a1a1a; font-family: Arial, sans-serif; }
.input__container { position: relative; background: #f0f0f0; padding: 20px; display: flex; justify-content: flex-start; align-items: center; gap: 15px; border: 4px solid #000; max-width: 350px; transition: all 400ms cubic-bezier(0.23, 1, 0.32, 1); transform-style: preserve-3d; transform: rotateX(10deg) rotateY(-10deg); perspective: 1000px; box-shadow: 10px 10px 0 #000; }
.input__container:hover { transform: rotateX(5deg) rotateY(1deg) scale(1.05); box-shadow: 25px 25px 0 -5px #e9b50b, 25px 25px 0 0 #000; }
.shadow__input { content: ""; position: absolute; width: 100%; height: 100%; left: 0; bottom: 0; z-index: -1; transform: translateZ(-50px); background: linear-gradient(45deg, rgba(255, 107, 107, 0.4) 0%, rgba(255, 107, 107, 0.1) 100%); filter: blur(20px); }
.input__button__shadow { cursor: pointer; border: 3px solid #000; background: #e9b50b; transition: all 400ms cubic-bezier(0.23, 1, 0.32, 1); display: flex; justify-content: center; align-items: center; padding: 10px; transform: translateZ(20px); position: relative; z-index: 3; font-weight: bold; text-transform: uppercase; }
.input__button__shadow:hover { background: #e9b50b; transform: translateZ(10px) translateX(-5px) translateY(-5px); box-shadow: 5px 5px 0 0 #000; }
.input__button__shadow svg { fill: #000; width: 25px; height: 25px; }
.input__search { width: 100%; outline: none; border: 3px solid #000; padding: 15px; font-size: 18px; background: #fff; color: #000; transform: translateZ(10px); transition: all 400ms cubic-bezier(0.23, 1, 0.32, 1); position: relative; z-index: 3; font-family: "Roboto", Arial, sans-serif; letter-spacing: -0.5px; }
.input__search::placeholder { color: #666; font-weight: bold; text-transform: uppercase; }
.input__search:hover, .input__search:focus { background: #f0f0f0; transform: translateZ(20px) translateX(-5px) translateY(-5px); box-shadow: 5px 5px 0 0 #000; }
.input__container::before { content: "USERNAME"; position: absolute; top: -15px; left: 20px; background: #e9b50b; color: #000; font-weight: bold; padding: 5px 10px; font-size: 14px; transform: translateZ(50px); z-index: 4; border: 2px solid #000; }`,
                js: ''
            },
        };

        function loadTemplate(type) {
            const template = templates[type];
            if (template) {
                setEditorValue('htmlEditor', template.html);
                setEditorValue('cssEditor', template.css);
                setEditorValue('jsEditor', template.js || '');
                runCode();
                closeTemplates();
                closeGameSelector();
                showNotification(`Template "${type}" charg√© avec succ√®s`, 'success');
            }
        }

        // Snippets
        function openSnippets() {
            document.getElementById('snippetsModal').classList.add('active');
        }

        function closeSnippets() {
            document.getElementById('snippetsModal').classList.remove('active');
        }

        const snippets = {
            flexCenter: 'display: flex;\njustify-content: center;\nalign-items: center;',
            gradient: 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);',
            button: '<button class="btn-modern">Cliquez-moi</button>',
            card: '<div class="card">\n  <h3>Titre</h3>\n  <p>Contenu de la carte</p>\n</div>',
            fetch: 'fetch(url)\n  .then(res => res.json())\n  .then(data => console.log(data));',
            eventListener: 'element.addEventListener(\'click\', (e) => {\n  // Votre code ici\n});'
        };

        function insertSnippet(type) {
            const snippet = snippets[type];
            if (snippet) {
                // Trouver l'√©diteur CodeMirror actif
                const activeContent = document.querySelector('.editor-content.active');
                const activeTextarea = activeContent ? activeContent.querySelector('textarea') : null;
                const cmId = activeTextarea ? activeTextarea.id : null;
                const cm = cmId && window._cmEditors ? window._cmEditors[cmId] : null;

                if (cm) {
                    const doc = cm.getDoc();
                    const cursor = doc.getCursor();
                    doc.replaceRange(snippet, cursor);
                    cm.focus();
                } else if (activeTextarea) {
                    const start = activeTextarea.selectionStart;
                    const end = activeTextarea.selectionEnd;
                    const text = activeTextarea.value;
                    activeTextarea.value = text.substring(0, start) + snippet + text.substring(end);
                    activeTextarea.focus();
                    activeTextarea.selectionStart = activeTextarea.selectionEnd = start + snippet.length;
                }
                closeSnippets();
                showNotification('Snippet ins√©r√©', 'success');
            }
        }

        // Shortcuts Modal
        function openShortcuts() {
            document.getElementById('shortcutsModal').classList.add('active');
        }

        function closeShortcuts() {
            document.getElementById('shortcutsModal').classList.remove('active');
        }

        // Export Options
        function openExportModal() {
            document.getElementById('exportModal').classList.add('active');
        }

        function closeExport() {
            document.getElementById('exportModal').classList.remove('active');
        }

        function exportAsHTML() {
            downloadCode();
            closeExport();
        }

        function exportSeparate() {
            const html = getEditorValue('htmlEditor');
            const css = getEditorValue('cssEditor');
            const js = getEditorValue('jsEditor');
            const projectName = document.querySelector('.project-name').value || 'projet';

            // Download HTML
            const htmlBlob = new Blob([html], { type: 'text/html' });
            const htmlUrl = URL.createObjectURL(htmlBlob);
            const htmlLink = document.createElement('a');
            htmlLink.href = htmlUrl;
            htmlLink.download = `${projectName}.html`;
            htmlLink.click();

            // Download CSS
            const cssBlob = new Blob([css], { type: 'text/css' });
            const cssUrl = URL.createObjectURL(cssBlob);
            const cssLink = document.createElement('a');
            cssLink.href = cssUrl;
            cssLink.download = `${projectName}.css`;
            cssLink.click();

            // Download JS
            const jsBlob = new Blob([js], { type: 'text/javascript' });
            const jsUrl = URL.createObjectURL(jsBlob);
            const jsLink = document.createElement('a');
            jsLink.href = jsUrl;
            jsLink.download = `${projectName}.js`;
            jsLink.click();

            closeExport();
            showNotification('Fichiers export√©s s√©par√©ment', 'success');
        }

        function exportToCodePen() {
            const html = getEditorValue('htmlEditor');
            const css = getEditorValue('cssEditor');
            const js = getEditorValue('jsEditor');

            const form = document.createElement('form');
            form.action = 'https://codepen.io/pen/define';
            form.method = 'POST';
            form.target = '_blank';

            const data = {
                title: document.querySelector('.project-name').value || 'SCRIX Export',
                html: html,
                css: css,
                js: js
            };

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'data';
            input.value = JSON.stringify(data);
            form.appendChild(input);

            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);

            closeExport();
            showNotification('Ouverture dans CodePen...', 'info');
        }

        function exportToJSFiddle() {
            const html = getEditorValue('htmlEditor');
            const css = getEditorValue('cssEditor');
            const js = getEditorValue('jsEditor');

            const form = document.createElement('form');
            form.action = 'https://jsfiddle.net/api/post/library/pure/';
            form.method = 'POST';
            form.target = '_blank';

            const fields = {
                title: document.querySelector('.project-name').value || 'SCRIX Export',
                html: html,
                css: css,
                js: js
            };

            Object.keys(fields).forEach(key => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = fields[key];
                form.appendChild(input);
            });

            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);

            closeExport();
            showNotification('Ouverture dans JSFiddle...', 'info');
        }

        // Find & Replace
        function toggleFindReplace(type) {
            const panel = document.getElementById(`findReplace${type.charAt(0).toUpperCase() + type.slice(1)}`);
            panel.classList.toggle('active');
        }

        function findNext(type) {
            const editorId = type + 'Editor';
            const cm = window._cmEditors && window._cmEditors[editorId];
            const findText = document.getElementById(`findInput${type.charAt(0).toUpperCase() + type.slice(1)}`).value;
            if (!findText) return;
            if (cm) {
                const cursor = cm.getSearchCursor(findText, cm.getCursor());
                if (cursor.findNext()) {
                    cm.setSelection(cursor.from(), cursor.to());
                    cm.scrollIntoView({from: cursor.from(), to: cursor.to()});
                } else {
                    // Recommencer depuis le d√©but
                    const cursor2 = cm.getSearchCursor(findText, {line:0,ch:0});
                    if (cursor2.findNext()) { cm.setSelection(cursor2.from(), cursor2.to()); cm.scrollIntoView({from:cursor2.from(),to:cursor2.to()}); }
                    else showNotification('Texte non trouv√©', 'info');
                }
            } else {
                const editor = document.getElementById(editorId);
                const content = editor.value;
                const currentPos = editor.selectionStart;
                const foundPos = content.indexOf(findText, currentPos);
                if (foundPos !== -1) { editor.focus(); editor.setSelectionRange(foundPos, foundPos + findText.length); }
                else showNotification('Texte non trouv√©', 'info');
            }
        }

        function replaceText(type) {
            const editorId = type + 'Editor';
            const cm = window._cmEditors && window._cmEditors[editorId];
            const findText = document.getElementById(`findInput${type.charAt(0).toUpperCase() + type.slice(1)}`).value;
            const replTxt = document.getElementById(`replaceInput${type.charAt(0).toUpperCase() + type.slice(1)}`).value;
            if (cm) {
                const sel = cm.getSelection();
                if (sel === findText) { cm.replaceSelection(replTxt); showNotification('Texte remplac√©', 'success'); }
                else findNext(type);
            } else {
                const editor = document.getElementById(editorId);
                const start = editor.selectionStart, end = editor.selectionEnd;
                if (editor.value.substring(start, end) === findText) {
                    editor.value = editor.value.substring(0, start) + replTxt + editor.value.substring(end);
                    editor.setSelectionRange(start, start + replTxt.length);
                    showNotification('Texte remplac√©', 'success');
                } else findNext(type);
            }
        }

        function replaceAll(type) {
            const editorId = type + 'Editor';
            const cm = window._cmEditors && window._cmEditors[editorId];
            const findText = document.getElementById(`findInput${type.charAt(0).toUpperCase() + type.slice(1)}`).value;
            const replTxt = document.getElementById(`replaceInput${type.charAt(0).toUpperCase() + type.slice(1)}`).value;
            if (!findText) return;
            const regex = new RegExp(findText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
            if (cm) {
                const content = cm.getValue();
                const count = (content.match(regex) || []).length;
                cm.setValue(content.replace(regex, replTxt));
                showNotification(`${count} occurrence(s) remplac√©e(s)`, 'success');
            } else {
                const editor = document.getElementById(editorId);
                const count = (editor.value.match(regex) || []).length;
                editor.value = editor.value.replace(regex, replTxt);
                showNotification(`${count} occurrence(s) remplac√©e(s)`, 'success');
            }
        }

        // Clear Console
        // ===== R√âCEPTION DES MESSAGES DE LA CONSOLE IFRAME =====
        window.addEventListener('message', function(event) {
            if (!event.data || event.data.type !== 'scrix-console') return;
            
            const { method, args, timestamp } = event.data;
            const content = document.getElementById('consoleContent');
            if (!content) return;

            const entry = document.createElement('div');
            entry.className = 'console-log' + (method === 'error' ? ' error' : method === 'warn' ? ' warn' : '');

            const prefix = { log: '‚ñ∏', warn: '‚ö†', error: '‚úñ', info: '‚Ñπ' }[method] || '‚ñ∏';
            const color = { log: '#f3f4f6', warn: '#f59e0b', error: '#ef4444', info: '#60a5fa' }[method] || '#f3f4f6';

            const text = args.map(a => {
                try {
                    const parsed = JSON.parse(a);
                    if (typeof parsed === 'object' && parsed !== null) {
                        return '<span style="color:#a78bfa;">' + a.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</span>';
                    }
                } catch(e) {}
                return String(a).replace(/</g,'&lt;').replace(/>/g,'&gt;');
            }).join(' ');

            entry.innerHTML = '<span class="console-timestamp" style="color:#6b7280;font-size:10px;margin-right:8px;">' + timestamp + '</span>'
                + '<span style="color:' + color + ';margin-right:6px;">' + prefix + '</span>'
                + '<span style="color:' + color + ';">' + text + '</span>';

            // Supprimer le message init au premier vrai message
            const initMsg = content.querySelector('.console-log');
            if (initMsg && (initMsg.textContent.includes('Console pr√™te') || initMsg.textContent.includes('Console effac√©e') || initMsg.textContent.includes('Ex√©cution du code'))) {
                initMsg.remove();
            }

            content.appendChild(entry);
            content.scrollTop = content.scrollHeight;
        });
        // ===== FIN PONT CONSOLE =====

        function clearConsole() {
            document.getElementById('consoleContent').innerHTML = '<div class="console-log" data-placeholder>‚úÖ Console effac√©e...</div>';
            window._scrixConsoleCount = { log: 0, warn: 0, error: 0, info: 0, total: 0 };
            _updateConsoleTitle();
        }

        // Projects Management

        // ‚úÖ Sauvegarde localStorage s√©curis√©e avec gestion du quota
        function safeSetProjects(projects) {
            // Tentative 1 : sauvegarde normale
            try {
                localStorage.setItem('scrix_projects', JSON.stringify(projects));
                return true;
            } catch(e) {
                if (e.name !== 'QuotaExceededError' && e.name !== 'NS_ERROR_DOM_QUOTA_REACHED') throw e;
            }
            // Quota d√©pass√© : supprimer les thumbnails des anciens projets (garder les 3 derniers)
            try {
                const stripped = projects.map((p, i) => {
                    if (i < projects.length - 3) return { ...p, thumbnail: null };
                    return p;
                });
                localStorage.setItem('scrix_projects', JSON.stringify(stripped));
                showNotification('Espace local plein ‚Äî thumbnails anciens supprim√©s. Connecte-toi pour le cloud !', 'warn');
                return true;
            } catch(e2) {}
            // Dernier recours : ne garder que les 5 derniers projets sans thumbnails
            try {
                const minimal = projects.slice(-5).map(p => ({ ...p, thumbnail: null }));
                localStorage.setItem('scrix_projects', JSON.stringify(minimal));
                showNotification('Espace local critique ‚Äî seuls les 5 derniers projets conserv√©s.', 'error');
                return true;
            } catch(e3) {
                showNotification('Impossible de sauvegarder : espace local plein. Connecte-toi pour utiliser le cloud.', 'error');
                return false;
            }
        }
        function toggleProjects() {
            document.getElementById('projectsPanel').classList.toggle('active');
            // Restaurer la taille sauvegard√©e
            const savedSize = localStorage.getItem('scrix_proj_size') || 'md';
            setProjectsSize(savedSize);
            loadProjectsList();
        }

        function handleProjectsOverlayClick(e) {
            if (e.target === document.getElementById('projectsPanel')) {
                toggleProjects();
            }
        }

        async function capturePreviewThumbnail() {
            return new Promise(async (resolve) => {
                try {
                    const iframe = document.getElementById('preview');
                    if (!iframe) { resolve(null); return; }
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (!iframeDoc || !iframeDoc.body) { resolve(null); return; }

                    const iframeW = iframe.offsetWidth || 800;
                    const iframeH = iframe.offsetHeight || 500;
                    const thumbW = 560;
                    const thumbH = Math.min(Math.round(thumbW * iframeH / iframeW), 320);

                    // --- Essai 1 : capturer un canvas WebGL/Three.js directement ---
                    const canvases = iframeDoc.querySelectorAll('canvas');
                    let webglDataUrl = null;
                    for (const c of canvases) {
                        try {
                            const ctx = c.getContext('webgl') || c.getContext('webgl2');
                            if (ctx) {
                                const dataUrl = c.toDataURL('image/jpeg', 0.92);
                                if (dataUrl && dataUrl.length > 5000) {
                                    webglDataUrl = dataUrl;
                                    break;
                                }
                            }
                        } catch(e) {}
                    }

                    if (webglDataUrl) {
                        const img = new Image();
                        img.onload = () => {
                            const thumbCanvas = document.createElement('canvas');
                            thumbCanvas.width = thumbW;
                            thumbCanvas.height = thumbH;
                            const tCtx = thumbCanvas.getContext('2d');
                            tCtx.imageSmoothingEnabled = true;
                            tCtx.imageSmoothingQuality = 'high';
                            tCtx.fillStyle = '#0a0a0f';
                            tCtx.fillRect(0, 0, thumbW, thumbH);
                            const srcRatio = img.width / img.height;
                            const dstRatio = thumbW / thumbH;
                            let sx = 0, sy = 0, sw = img.width, sh = img.height;
                            if (srcRatio > dstRatio) {
                                sw = img.height * dstRatio;
                                sx = (img.width - sw) / 2;
                            } else {
                                sh = img.width / dstRatio;
                                sy = (img.height - sh) / 2;
                            }
                            tCtx.drawImage(img, sx, sy, sw, sh, 0, 0, thumbW, thumbH);
                            resolve(thumbCanvas.toDataURL('image/jpeg', 0.92));
                        };
                        img.onerror = () => resolve(null);
                        img.src = webglDataUrl;
                        return;
                    }

                    // --- Essai 2 : html2canvas pour le HTML/CSS classique ---
                    const hiResCanvas = await html2canvas(iframeDoc.body, {
                        width: iframeW, height: iframeH, scale: 1,
                        useCORS: true, allowTaint: true,
                        backgroundColor: '#111112', logging: false,
                        windowWidth: iframeW, windowHeight: iframeH
                    });
                    const thumbCanvas = document.createElement('canvas');
                    thumbCanvas.width = thumbW; thumbCanvas.height = thumbH;
                    const tCtx = thumbCanvas.getContext('2d');
                    tCtx.imageSmoothingEnabled = true;
                    tCtx.imageSmoothingQuality = 'high';
                    tCtx.drawImage(hiResCanvas, 0, 0, thumbW, thumbH);
                    resolve(thumbCanvas.toDataURL('image/jpeg', 0.92));
                } catch(e) {
                    console.warn('Thumbnail capture failed:', e);
                    resolve(null);
                }
            });
        }

        // ============================================================
        // FIREBASE AUTH & SYNC
        // ============================================================

        window.onFirebaseAuthChange = function(user) {
            const signInBtn = document.getElementById('authSignInBtn');
            const userPill   = document.getElementById('authUserPill');

            if (user) {
                // Connect√©
                if (signInBtn) signInBtn.style.display = 'none';
                if (userPill) userPill.style.display = 'flex';

                const _savedProf = JSON.parse(localStorage.getItem('scrix_profile_' + user.uid) || '{}');
                const firstName = _savedProf.username || (user.displayName || 'User').split(' ')[0];

                const authUsername = document.getElementById('authUsername');
                if (authUsername) authUsername.textContent = firstName;

                const _headerAvatarSrc = _savedProf.customAvatar || user.photoURL || null;
                if (_headerAvatarSrc) {
                    const img = document.getElementById('authAvatarImg');
                    if (img) { img.src = _headerAvatarSrc; img.style.display = 'block'; }
                    const fb = document.getElementById('authAvatarFallback');
                    if (fb) fb.style.display = 'none';
                } else {
                    const fb = document.getElementById('authAvatarFallback');
                    if (fb) fb.textContent = firstName[0].toUpperCase();
                }

                // Sync menu pill
                refreshMenuPill();

                // Sync: charger les projets cloud et fusionner avec local
                syncProjectsOnLogin(user).then(() => loadCustomGamesFromCloud(user));

                // Sync th√®me, pseudo et tutoriel
                syncPrefsOnLogin(user).then(() => {
                    const prof = JSON.parse(localStorage.getItem('scrix_profile_' + user.uid) || '{}');
                    if (!prof.username) {
                        showNotification(`Bienvenue ${firstName} ‚Äî Projets synchronis√©s`, 'success');
                    }
                });
            } else {
                // D√©connect√©
                if (signInBtn) signInBtn.style.display = 'flex';
                if (userPill) userPill.style.display = 'none';
                refreshMenuPill();
            }
        };

        function googleSignIn() {
            if (!window._fbAuth || !window._fbGoogleProvider) {
                showNotification('Firebase non configur√© ‚Äî voir instructions', 'error');
                return;
            }
            window._fbFns.signInWithPopup(window._fbAuth, window._fbGoogleProvider)
                .catch(err => {
                    console.error(err);
                    showNotification('Connexion annul√©e ou refus√©e', 'error');
                });
        }

        function googleSignOut() {
            if (!window._fbAuth) return;
            scrixConfirm({
                icon: 'üö™',
                title: 'Se d√©connecter ?',
                desc: 'Tu vas √™tre d√©connect√© de ton compte SCRIX.',
                okText: 'Se d√©connecter',
                cancelText: 'Annuler',
                danger: true
            }, function(confirmed) {
                if (!confirmed) return;
                window._fbFns.signOut(window._fbAuth).then(() => {
                    localStorage.removeItem('scrix_profile');
                    localStorage.removeItem('scrix_projects');
                    localStorage.removeItem('scrix_custom_games');
                    loadProjectsList();
                    showNotification('D√©connect√©', 'success');
                });
            });
        }

        async function syncProjectsOnLogin(user) {
            if (!window._fbDb || !window._fbFns) return;
            const { collection, getDocs, doc, setDoc, serverTimestamp } = window._fbFns;
            const db = window._fbDb;
            const uid = user.uid;

            try {
                // 1. R√©cup√©rer les projets cloud
                const snap = await getDocs(collection(db, 'users', uid, 'projects'));
                const cloudProjects = [];
                snap.forEach(d => cloudProjects.push({ id: d.id, ...d.data() }));

                // 2. R√©cup√©rer les projets locaux
                const localProjects = JSON.parse(localStorage.getItem('scrix_projects') || '[]');

                // 3. Fusionner: local + cloud (sans doublons par nom+timestamp)
                const merged = [...cloudProjects];
                for (const lp of localProjects) {
                    const exists = cloudProjects.some(cp =>
                        cp.name === lp.name && Math.abs((cp.timestamp || 0) - (lp.timestamp || 0)) < 2000
                    );
                    if (!exists) {
                        merged.push(lp);
                        // Uploader ce projet local vers le cloud
                        const id = 'proj_' + (lp.timestamp || Date.now());
                        await setDoc(doc(db, 'users', uid, 'projects', id), {
                            name: lp.name,
                            html: lp.html || '',
                            css: lp.css || '',
                            js: lp.js || '',
                            python: lp.python || '',
                            thumbnail: lp.thumbnail || null,
                            timestamp: lp.timestamp || Date.now()
                        });
                    }
                }

                // 4. Mettre √† jour le localStorage avec la liste fusionn√©e
                const cleanMerged = merged.map(p => ({
                    name: p.name,
                    html: p.html || '',
                    css: p.css || '',
                    js: p.js || '',
                    python: p.python || '',
                    thumbnail: p.thumbnail || null,
                    timestamp: p.timestamp || Date.now(),
                    _cloudId: p.id || ('proj_' + (p.timestamp || Date.now()))
                }));
                cleanMerged.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                safeSetProjects(cleanMerged);

                // Rafra√Æchir l'affichage dans tous les cas
                loadProjectsList();
            } catch(e) {
                console.error('Sync error:', e);
            }
        }

        async function syncPrefsOnLogin(user) {
            if (!window._fbDb || !window._fbFns) return;
            const { doc, getDoc, setDoc } = window._fbFns;
            const db = window._fbDb;
            const uid = user.uid;
            try {
                const snap = await getDoc(doc(db, 'users', uid, 'prefs', 'main'));
                if (snap.exists()) {
                    const data = snap.data();
                    if (data.theme) {
                        // Th√®me fix√© sur sombre ‚Äî on ignore la pr√©f√©rence sauvegard√©e
                    }
                    if (data.tutorialCompleted) {
                        localStorage.setItem('scrix_tutorial_completed', 'true');
                    }
                    // Restaurer le profil custom (avatar, pseudo, bio)
                    const localProfile = JSON.parse(localStorage.getItem('scrix_profile_' + uid) || '{}');
                    const merged = { ...localProfile };
                    if (data.customAvatar) merged.customAvatar = data.customAvatar;
                    if (data.username) merged.username = data.username;
                    if (data.bio) merged.bio = data.bio;
                    localStorage.setItem('scrix_profile_' + uid, JSON.stringify(merged));

                    // ‚úÖ Mettre √† jour la navbar avec le pseudo charg√© depuis Firestore
                    if (merged.username) {
                        const label = document.getElementById('authUsername');
                        if (label) label.textContent = merged.username;
                        const fallback = document.getElementById('authAvatarFallback');
                        if (fallback && fallback.style.display !== 'none') fallback.textContent = merged.username[0].toUpperCase();
                        showNotification(`Bienvenue ${merged.username} ‚Äî Projets synchronis√©s`, 'success');
                    }
                } else {
                    // Uploader les prefs locales + profil
                    const localProfile = JSON.parse(localStorage.getItem('scrix_profile_' + uid) || '{}');
                    await setDoc(doc(db, 'users', uid, 'prefs', 'main'), {
                        theme: 'dark',
                        tutorialCompleted: !!localStorage.getItem('scrix_tutorial_completed'),
                        ...localProfile
                    });
                }
            } catch(e) { console.error('Prefs sync error:', e); }
        }

        async function saveProjectToCloud(project) {
            if (!window._fbUser || !window._fbDb || !window._fbFns) return null;
            const { doc, setDoc } = window._fbFns;
            const db = window._fbDb;
            const uid = window._fbUser.uid;
            const id = project._cloudId || ('proj_' + project.timestamp);
            try {
                await setDoc(doc(db, 'users', uid, 'projects', id), {
                    name: project.name,
                    html: project.html || '',
                    css: project.css || '',
                    js: project.js || '',
                    python: project.python || '',
                    thumbnail: project.thumbnail || null,
                    timestamp: project.timestamp || Date.now()
                });
                return id;
            } catch(e) {
                console.error('Save to cloud error:', e);
                return null;
            }
        }

        async function deleteProjectFromCloud(cloudId) {
            if (!window._fbUser || !window._fbDb || !window._fbFns || !cloudId) return;
            const { doc, deleteDoc } = window._fbFns;
            try {
                await deleteDoc(doc(window._fbDb, 'users', window._fbUser.uid, 'projects', cloudId));
            } catch(e) { console.error('Delete cloud error:', e); }
        }

        async function savePrefsToCloud(key, value) {
            if (!window._fbUser || !window._fbDb || !window._fbFns) return;
            const { doc, setDoc } = window._fbFns;
            try {
                const prefsDoc = doc(window._fbDb, 'users', window._fbUser.uid, 'prefs', 'main');
                const snap = await window._fbFns.getDoc(prefsDoc);
                const existing = snap.exists() ? snap.data() : {};
                await setDoc(prefsDoc, { ...existing, [key]: value });
            } catch(e) { console.error('Prefs save error:', e); }
        }

        // ============================================================
        // PROJETS ‚Äî avec sync cloud automatique
        // ============================================================

        async function saveCurrentProject() {
            // Bloquer si pas connect√©
            if (!window._fbUser) {
                showNotification('Connecte-toi avec Google pour sauvegarder un projet', 'error');
                setTimeout(() => openLoginModal(), 800);
                return;
            }

            scrixPrompt({
                icon: 'save',
                title: 'Sauvegarder le projet',
                desc: 'Donne un nom √† ton projet',
                placeholder: 'Ex: Mon super projet',
                defaultValue: document.querySelector('.project-name').value || 'Mon Projet'
            }, async (projectName) => {
                if (!projectName) return;

                let projects = JSON.parse(localStorage.getItem('scrix_projects') || '[]');

                // V√©rifier si un projet avec ce nom existe d√©j√†
                const existingIndex = projects.findIndex(p => p.name.toLowerCase() === projectName.toLowerCase());

                if (existingIndex !== -1) {
                    // Proposer de mettre √† jour l'existant
                    const existingProject = projects[existingIndex];
                    scrixConfirm({
                        icon: 'üîÑ',
                        title: 'Projet existant',
                        desc: `"${projectName}" existe d√©j√†. Veux-tu le mettre √† jour ?`,
                        confirmLabel: 'Mettre √† jour',
                        cancelLabel: 'Cr√©er une copie'
                    }, async (confirmed) => {
                        showNotification('Capture en cours...', 'success');
                        const thumbnail = await capturePreviewThumbnail();
                        const timestamp = Date.now();

                        if (confirmed) {
                            // Mise √† jour du projet existant
                            projects[existingIndex] = {
                                ...existingProject,
                                html: getEditorValue('htmlEditor'),
                                css: getEditorValue('cssEditor'),
                                js: getEditorValue('jsEditor'),
                                python: getEditorValue('pythonEditor'),
                                thumbnail: thumbnail,
                                timestamp: timestamp
                            };
                            safeSetProjects(projects);
                            if (window._fbUser) {
                                await saveProjectToCloud(projects[existingIndex]);
                                showNotification(`"${projectName}" mis √† jour`, 'success');
                            } else {
                                showNotification(`"${projectName}" mis √† jour localement`, 'success');
                            }
                        } else {
                            // Cr√©er une copie avec suffixe
                            const copyName = projectName + ' (copie)';
                            const cloudId = 'proj_' + timestamp;
                            const newProject = {
                                name: copyName,
                                html: getEditorValue('htmlEditor'),
                                css: getEditorValue('cssEditor'),
                                js: getEditorValue('jsEditor'),
                                python: getEditorValue('pythonEditor'),
                                thumbnail: thumbnail,
                                timestamp: timestamp,
                                _cloudId: cloudId
                            };
                            projects.push(newProject);
                            safeSetProjects(projects);
                            if (window._fbUser) {
                                await saveProjectToCloud(newProject);
                                showNotification(`"${copyName}" sauvegard√©`, 'success');
                            } else {
                                showNotification(`"${copyName}" sauvegard√© localement`, 'success');
                            }
                        }
                        window._lastSavedCode = _getCurrentCodeSnapshot ? _getCurrentCodeSnapshot() : null;
                        loadProjectsList();
                    });
                    return;
                }

                // Nouveau projet
                showNotification('Capture en cours...', 'success');
                const thumbnail = await capturePreviewThumbnail();
                const timestamp = Date.now();
                const cloudId = 'proj_' + timestamp;

                const project = {
                    name: projectName,
                    html: getEditorValue('htmlEditor'),
                    css: getEditorValue('cssEditor'),
                    js: getEditorValue('jsEditor'),
                    python: getEditorValue('pythonEditor'),
                    thumbnail: thumbnail,
                    timestamp: timestamp,
                    _cloudId: cloudId
                };

                projects.push(project);
                safeSetProjects(projects);

                if (window._fbUser) {
                    await saveProjectToCloud(project);
                    showNotification(`"${projectName}" sauvegard√©`, 'success');
                } else {
                    showNotification(`"${projectName}" sauvegard√© localement`, 'success');
                }
                window._lastSavedCode = _getCurrentCodeSnapshot ? _getCurrentCodeSnapshot() : null;
                loadProjectsList();
            });
        }

        function setProjectsSize(size) {
            const list = document.getElementById('projectsList');
            if (!list) return;
            // Remove all size classes
            list.classList.remove('size-xl', 'size-md', 'size-sm', 'size-list');
            list.classList.add('size-' + size);
            // Update active button
            document.querySelectorAll('.proj-size-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById('psize-' + size);
            if (btn) btn.classList.add('active');
            localStorage.setItem('scrix_proj_size', size);
        }

        function loadProjectsList() {
            const projectsList = document.getElementById('projectsList');

            // Si pas connect√©, afficher message
            if (!window._fbUser) {
                projectsList.innerHTML = `
                    <div style="grid-column:1/-1;text-align:center;color:var(--text-tertiary);padding:60px 20px;">
                        <div style="font-size:48px;margin-bottom:16px;"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></div>
                        <div style="font-size:15px;font-weight:600;color:var(--text-primary);">Connecte-toi pour voir tes projets</div>
                        <div style="font-size:12px;margin-top:8px;opacity:0.6;">Tes projets sont synchronis√©s dans le cloud avec ton compte</div>
                        <button onclick="openLoginModal()" style="margin-top:20px;padding:10px 24px;background:var(--primary-purple);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;">Se connecter</button>
                    </div>`;
                return;
            }

            const projects = JSON.parse(localStorage.getItem('scrix_projects') || '[]');

            if (projects.length === 0) {
                projectsList.innerHTML = `
                    <div style="grid-column:1/-1;text-align:center;color:var(--text-tertiary);padding:60px 20px;">
                        <div style="font-size:48px;margin-bottom:16px;">üìÇ</div>
                        <div style="font-size:15px;">Aucun projet sauvegard√©</div>
                        <div style="font-size:12px;margin-top:6px;opacity:0.6;">Clique sur "Sauvegarder le projet actuel" pour commencer</div>
                    </div>`;
                return;
            }

            let sorted = [...projects];
            if (window._sortMode === 'name') {
                sorted.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            } else {
                sorted.sort((a, b) => b.timestamp - a.timestamp);
            }
            const reversed = sorted;
            projectsList.innerHTML = reversed.map((project, displayIndex) => {
                const realIndex = projects.indexOf(sorted[displayIndex]);
                // √âchapper le nom du projet pour √©viter les injections XSS
                const safeName = String(project.name || 'Sans titre').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
                // Valider que le thumbnail est bien une image base64 (s√©curit√©)
                const isValidThumb = project.thumbnail && /^data:image\/(jpeg|png|webp|gif);base64,/.test(project.thumbnail);
                const thumbHtml = isValidThumb
                    ? `<img src="${project.thumbnail}" alt="preview"/>`
                    : `<span style="font-size:32px;color:var(--purple-light);opacity:0.6;">&lt;/&gt;</span>`;

                return `
                <div class="project-card" onclick="loadProject(${realIndex})">
                    <div class="project-card-thumb">
                        ${thumbHtml}
                        <div class="project-card-thumb-overlay"></div>
                        <button class="proj-change-img-btn" onclick="event.stopPropagation(); changeProjectImage(${realIndex})" title="Changer l'image">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                                <circle cx="12" cy="13" r="4"/>
                            </svg>
                        </button>
                    </div>
                    <div class="project-card-body">
                        <div class="project-card-info" onclick="event.stopPropagation()">
                            <div class="project-card-name" id="projName_${realIndex}"
                                 ondblclick="startRenameProject(${realIndex})"
                                 title="Double-clic pour renommer">
                                ${safeName}
                            </div>
                            <div class="project-card-date">${new Date(project.timestamp).toLocaleDateString('fr-FR')}</div>
                        </div>
                        <div class="project-card-actions" onclick="event.stopPropagation()">
                            <button class="project-card-btn" onclick="duplicateProject(${realIndex})" title="Dupliquer">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                </svg>
                            </button>
                            <button class="project-card-btn" onclick="startRenameProject(${realIndex})" title="Renommer">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </button>
                            <button class="project-card-btn danger" onclick="deleteProject(${realIndex})" title="Supprimer">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
                                    <path d="M10 11v6M14 11v6"/>
                                    <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function changeProjectImage(realIndex) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                // Max 2MB
                if (file.size > 2 * 1024 * 1024) {
                    showNotification('Image trop lourde (max 2Mo)', 'error');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const projects = JSON.parse(localStorage.getItem('scrix_projects') || '[]');
                    if (!projects[realIndex]) return;
                    projects[realIndex].thumbnail = ev.target.result;
                    safeSetProjects(projects);
                    // Sync cloud si connect√©
                    if (window._fbUser && projects[realIndex]._cloudId && window._fbDb && window._fbFns) {
                        const { doc, setDoc } = window._fbFns;
                        setDoc(doc(window._fbDb, 'users', window._fbUser.uid, 'projects', projects[realIndex]._cloudId),
                            { thumbnail: ev.target.result }, { merge: true });
                    }
                    loadProjectsList();
                    showNotification('Image mise √† jour', 'success');
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        function startRenameProject(realIndex) {
            const projects = JSON.parse(localStorage.getItem('scrix_projects') || '[]');
            const project = projects[realIndex];
            if (!project) return;

            const nameEl = document.getElementById('projName_' + realIndex);
            if (!nameEl) return;

            // Remplacer le texte par un input inline
            const input = document.createElement('input');
            input.value = project.name;
            input.maxLength = 60;
            input.style.cssText = 'background:rgba(124,58,237,0.15);border:1px solid var(--primary-purple);border-radius:6px;padding:2px 8px;color:var(--text-primary);font-family:var(--font-sans);font-size:14px;font-weight:700;width:100%;outline:none;';
            nameEl.replaceWith(input);
            input.focus();
            input.select();

            function commitRename() {
                const newName = input.value.trim();
                if (newName && newName !== project.name) {
                    projects[realIndex].name = newName;
                    safeSetProjects(projects);
                    // Sync cloud
                    if (window._fbUser && project._cloudId && window._fbDb && window._fbFns) {
                        const { doc, setDoc } = window._fbFns;
                        setDoc(doc(window._fbDb, 'users', window._fbUser.uid, 'projects', project._cloudId),
                            { name: newName }, { merge: true });
                    }
                    const safeNewName = String(newName).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                    showNotification(`Renomm√© en "${safeNewName}"`, 'success');
                }
                loadProjectsList();
            }

            input.addEventListener('blur', commitRename);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
                if (e.key === 'Escape') { input.value = project.name; input.blur(); }
            });
        }

        function loadProject(realIndex) {
            const projects = JSON.parse(localStorage.getItem('scrix_projects') || '[]');
            const project = projects[realIndex];
            if (project) {
                setEditorValue('htmlEditor', project.html || '');
                setEditorValue('cssEditor', project.css || '');
                setEditorValue('jsEditor', project.js || '');
                setEditorValue('pythonEditor', project.python || '');
                document.querySelector('.project-name').value = project.name;
                // Marquer comme sauvegard√© (pas de faux avertissement beforeunload)
                window._lastSavedCode = _getCurrentCodeSnapshot ? _getCurrentCodeSnapshot() : null;
                runCode();
                toggleProjects();
                const safeLoadName = String(project.name).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                showNotification(`Projet "${safeLoadName}" charg√©`, 'success');
            }
        }

        async function deleteProject(realIndex) {
            let projects = JSON.parse(localStorage.getItem('scrix_projects') || '[]');
            const project = projects[realIndex];
            if (!project) return;
            const projectName = project.name;
            const safeProjectName = String(projectName).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

            scrixConfirm({
                icon: 'trash',
                title: 'Supprimer ce projet ?',
                desc: `"${safeProjectName}" sera d√©finitivement supprim√©.`,
                okText: 'Supprimer',
                cancelText: 'Annuler',
                danger: true
            }, async (ok) => {
                if (ok) {
                    if (window._fbUser && project._cloudId) {
                        await deleteProjectFromCloud(project._cloudId);
                    }
                    projects.splice(realIndex, 1);
                    safeSetProjects(projects);
                    loadProjectsList();
                    showNotification(`"${projectName}" supprim√©`, 'success');
                }
            });
        }

        function newProject() {
            scrixConfirm({
                icon: 'üìÑ',
                title: 'Nouveau projet ?',
                desc: 'Le code actuel sera perdu s\'il n\'est pas sauvegard√©.',
                okText: 'Cr√©er',
                cancelText: 'Annuler',
                danger: false
            }, (ok) => {
                if (ok) {
                    setEditorValue('htmlEditor', '');
                    setEditorValue('cssEditor', '');
                    setEditorValue('jsEditor', '');
                    setEditorValue('pythonEditor', '');
                    document.querySelector('.project-name').value = 'Nouveau Projet';
                    runCode();
                    showNotification('Nouveau projet cr√©√©', 'success');
                }
            });
        }

        // Theme Toggle
        // ============================================================
        // PROFILE PANEL
        // ============================================================

        function toggleProfile() {
            if (!window._fbUser) {
                // Pas connect√© ‚Üí ouvre directement le modal login
                openLoginModal();
                return;
            }
            const panel = document.getElementById('profilePanel');
            const overlay = document.getElementById('profilePanelOverlay');
            panel.classList.toggle('active');
            overlay.classList.toggle('active');
            if (panel.classList.contains('active')) {
                refreshProfilePanel();
            }
        }

        function triggerAvatarUpload() {
            document.getElementById('avatarFileInput').click();
        }

        function togglePreviewAndHeader() {
            const previewSection = document.getElementById('previewSection');
            const isCollapsed = previewSection.classList.contains('preview-collapsed');

            // Toggle preview
            previewSection.classList.toggle('preview-collapsed');

            // Toggle header
            document.body.classList.toggle('header-hidden', !isCollapsed);

            // Mettre √† jour le bouton
            const icon = document.getElementById('previewToggleIcon');
            const text = document.getElementById('previewToggleText');
            if (!isCollapsed) {
                icon.textContent = '‚ñ≤';
                text.textContent = 'Afficher';
            } else {
                icon.textContent = '‚ñº';
                text.textContent = 'Masquer';
            }
        }

        function toggleTopBar() {
            document.body.classList.toggle('header-hidden');
            const hidden = document.body.classList.contains('header-hidden');
            localStorage.setItem('scrix-header-hidden', hidden ? '1' : '0');
        }

        // Restore header state on load
        (function initHeaderState() {
            if (localStorage.getItem('scrix-header-hidden') === '1') {
                document.body.classList.add('header-hidden');
            }
        })();

        function triggerBannerUpload() {
            document.getElementById('bannerFileInput').click();
        }

        function handleBannerUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                showNotification('Image trop lourde (max 5Mo)', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const dataUrl = e.target.result;

                // Compresser/redimensionner (max 1200x400, JPEG 75%)
                const img = new Image();
                img.onload = async function() {
                    const maxW = 1200, maxH = 400;
                    let w = img.width, h = img.height;
                    const ratio = Math.min(maxW / w, maxH / h, 1);
                    w = Math.round(w * ratio);
                    h = Math.round(h * ratio);

                    const canvas = document.createElement('canvas');
                    canvas.width = w; canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, w, h);
                    const compressed = canvas.toDataURL('image/jpeg', 0.75);

                    // Afficher imm√©diatement dans l'UI
                    const bannerImg = document.getElementById('profileBannerImg');
                    bannerImg.src = compressed;
                    bannerImg.style.display = 'block';

                    // ‚úÖ PRIORIT√â 1 : Sauvegarder dans Firebase (source de v√©rit√© = synchro tous appareils)
                    if (window._fbUser && window._fbDb && window._fbFns) {
                        try {
                            const { doc, setDoc } = window._fbFns;
                            await setDoc(
                                doc(window._fbDb, 'users', window._fbUser.uid, 'prefs', 'main'),
                                { customBanner: compressed },
                                { merge: true }
                            );
                            showNotification('Banni√®re mise √† jour', 'success');
                        } catch(e) {
                            console.warn('Erreur Firebase banni√®re:', e);
                            showNotification('Erreur de sauvegarde cloud', 'error');
                        }
                    } else {
                        showNotification('Connecte-toi pour sauvegarder ta banni√®re', 'error');
                    }

                    // PRIORIT√â 2 : Aussi en localStorage comme cache local
                    try {
                        const uid = window._fbUser ? window._fbUser.uid : 'guest';
                        const key = 'scrix_profile_' + uid;
                        const existing = JSON.parse(localStorage.getItem(key) || '{}');
                        existing.customBanner = compressed;
                        localStorage.setItem(key, JSON.stringify(existing));
                    } catch(err) {
                        console.warn('Cache localStorage banni√®re √©chou√© (non bloquant):', err);
                    }
                };
                img.src = dataUrl;
            };
            reader.readAsDataURL(file);
        }

        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) {
                showNotification('Image trop lourde (max 2Mo)', 'error');
                return;
            }
            const reader = new FileReader();
            reader.onload = async function(e) {
                const dataUrl = e.target.result;
                // Redimensionner en 200x200
                const img = new Image();
                img.onload = async function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = 200; canvas.height = 200;
                    const ctx = canvas.getContext('2d');
                    ctx.imageSmoothingQuality = 'high';
                    // Crop carr√© centr√©
                    const size = Math.min(img.width, img.height);
                    const sx = (img.width - size) / 2;
                    const sy = (img.height - size) / 2;
                    ctx.drawImage(img, sx, sy, size, size, 0, 0, 200, 200);
                    const resized = canvas.toDataURL('image/jpeg', 0.85);

                    // Sauvegarder en localStorage
                    const _avatarUid = window._fbUser ? window._fbUser.uid : null;
                    const _avatarKey = _avatarUid ? 'scrix_profile_' + _avatarUid : 'scrix_profile';
                    const profile = JSON.parse(localStorage.getItem(_avatarKey) || '{}');
                    profile.customAvatar = resized;
                    localStorage.setItem(_avatarKey, JSON.stringify(profile));

                    // Afficher imm√©diatement
                    const avatarImg = document.getElementById('profileAvatarImg');
                    avatarImg.src = resized;
                    avatarImg.style.display = 'block';
                    document.getElementById('profileAvatarFallback').style.display = 'none';

                    // Aussi mettre √† jour la pill dans le header
                    const headerImg = document.getElementById('authAvatarImg');
                    if (headerImg) { headerImg.src = resized; headerImg.style.display = 'block'; document.getElementById('authAvatarFallback').style.display = 'none'; }

                    // Sync cloud
                    if (window._fbUser && window._fbDb && window._fbFns) {
                        try {
                            const { doc, setDoc } = window._fbFns;
                            await setDoc(doc(window._fbDb, 'users', window._fbUser.uid, 'prefs', 'main'), { customAvatar: resized }, { merge: true });
                        } catch(e) {}
                    }
                    showNotification('Photo de profil mise √† jour', 'success');
                };
                img.src = dataUrl;
            };
            reader.readAsDataURL(file);
        }

        async function refreshProfilePanel() {
            const user = window._fbUser;
            document.getElementById('profileNotConnected').style.display = user ? 'none' : 'block';
            document.getElementById('profileConnected').style.display = user ? 'flex' : 'none';

            if (user) {
                const localKey = 'scrix_profile_' + user.uid;
                const savedProfile = JSON.parse(localStorage.getItem(localKey) || '{}');

                // Charger depuis Firebase (source de v√©rit√© = synchro tous appareils)
                let cloudData = {};
                if (window._fbDb && window._fbFns) {
                    try {
                        const { doc, getDoc } = window._fbFns;
                        const snap = await getDoc(doc(window._fbDb, 'users', user.uid, 'prefs', 'main'));
                        if (snap.exists()) cloudData = snap.data();
                        // Mettre √† jour le cache local
                        try {
                            const merged = Object.assign({}, savedProfile, cloudData);
                            localStorage.setItem(localKey, JSON.stringify(merged));
                        } catch(e) {}
                    } catch(e) {
                        console.warn('Impossible de charger profil Firebase:', e);
                    }
                }

                // Cloud prioritaire sur local
                const profile = Object.assign({}, savedProfile, cloudData);

                // Avatar
                const avatarSrc = profile.customAvatar || user.photoURL || null;
                if (avatarSrc) {
                    const img = document.getElementById('profileAvatarImg');
                    img.src = avatarSrc;
                    img.style.display = 'block';
                    document.getElementById('profileAvatarFallback').style.display = 'none';
                    const headerImg = document.getElementById('authAvatarImg');
                    if (headerImg) { headerImg.src = avatarSrc; headerImg.style.display = 'block'; document.getElementById('authAvatarFallback').style.display = 'none'; }
                } else {
                    const name = user.displayName || 'U';
                    document.getElementById('profileAvatarFallback').textContent = name[0].toUpperCase();
                    document.getElementById('profileAvatarFallback').style.display = 'flex';
                    document.getElementById('profileAvatarImg').style.display = 'none';
                }

                // ‚úÖ Banni√®re depuis Firebase (m√™me image sur tous les appareils)
                const bannerImg = document.getElementById('profileBannerImg');
                if (profile.customBanner && bannerImg) {
                    bannerImg.src = profile.customBanner;
                    bannerImg.style.display = 'block';
                } else if (bannerImg) {
                    bannerImg.src = '';
                    bannerImg.style.display = 'none';
                }

                // Infos
                document.getElementById('profileDisplayName').textContent = user.displayName || '';
                document.getElementById('profileUsername').value = profile.username || user.displayName || '';
                document.getElementById('profileBio').value = profile.bio || '';
            }

            // Mettre √† jour le label dans le menu
            const label = document.getElementById('menuProfileLabel');
            if (label) {
                if (user) {
                    const savedProf = JSON.parse(localStorage.getItem('scrix_profile_' + user.uid) || '{}');
                    label.textContent = savedProf.username || (user.displayName || 'Profil').split(' ')[0];
                } else {
                    label.textContent = 'Mon Profil';
                }
            }
        }

        async function saveProfile() {
            const username = document.getElementById('profileUsername').value.trim();
            const bio = document.getElementById('profileBio').value.trim();
            const uid = window._fbUser ? window._fbUser.uid : null;
            const profileKey = uid ? 'scrix_profile_' + uid : 'scrix_profile';

            // Merger avec les donn√©es existantes (pour ne pas √©craser customAvatar)
            const existing = JSON.parse(localStorage.getItem(profileKey) || '{}');
            const profileData = { ...existing, username, bio };
            localStorage.setItem(profileKey, JSON.stringify(profileData));

            // Sync cloud si connect√©
            if (window._fbUser && window._fbDb && window._fbFns) {
                try {
                    const { doc, setDoc } = window._fbFns;
                    await setDoc(doc(window._fbDb, 'users', window._fbUser.uid, 'prefs', 'main'), { username, bio }, { merge: true });
                } catch(e) { console.error('Profile save error:', e); }
            }

            // Mettre √† jour le label menu
            const label = document.getElementById('menuProfileLabel');
            if (label && username) label.textContent = username;

            showNotification('Profil sauvegard√©', 'success');
        }

        // Mettre √† jour le panel profil quand l'auth change
        const _origAuthChange = window.onFirebaseAuthChange;
        window.onFirebaseAuthChange = function(user) {
            if (_origAuthChange) _origAuthChange(user);
            // Refresh panel si ouvert
            if (document.getElementById('profilePanel').classList.contains('active')) {
                refreshProfilePanel();
            }
            // Refresh label menu
            refreshProfilePanel();
            // Si on vient de se connecter, juste fermer le modal login
            if (user) {
                closeLoginModalDirect();
            } else {
                // D√©connect√© : fermer le panel
                document.getElementById('profilePanel').classList.remove('active');
                document.getElementById('profilePanelOverlay').classList.remove('active');
            }
        };



        // Tutorial
        let currentTutorialStep = 1;

        function showTutorial(force) {
            if (force || !localStorage.getItem('scrix_tutorial_completed')) {
                currentTutorialStep = 1;
                document.querySelectorAll('.tutorial-step').forEach(s => s.classList.remove('active'));
                document.getElementById('step1').classList.add('active');
                document.getElementById('tutorialOverlay').classList.add('active');
            }
        }

        function nextTutorialStep() {
            document.getElementById(`step${currentTutorialStep}`).classList.remove('active');
            currentTutorialStep++;
            if (currentTutorialStep <= 5) {
                document.getElementById(`step${currentTutorialStep}`).classList.add('active');
                // Mettre √† jour le bouton de connexion dans le tuto si d√©j√† connect√©
                if (currentTutorialStep === 5 && window._fbUser) {
                    const btn = document.getElementById('tutoSignInBtn');
                    if (btn) {
                        btn.style.background = 'rgba(16,185,129,0.15)';
                        btn.style.color = '#10b981';
                        btn.style.border = '1px solid rgba(16,185,129,0.3)';
                        const safeName = String(window._fbUser.displayName || window._fbUser.email || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                        btn.innerHTML = '‚úÖ Connect√© en tant que ' + safeName;
                        btn.onclick = null;
                        btn.style.cursor = 'default';
                    }
                }
            }
        }

        function prevTutorialStep() {
            document.getElementById(`step${currentTutorialStep}`).classList.remove('active');
            currentTutorialStep--;
            if (currentTutorialStep >= 1) {
                document.getElementById(`step${currentTutorialStep}`).classList.add('active');
            }
        }

        function closeTutorial() {
            document.getElementById('tutorialOverlay').classList.remove('active');
            localStorage.setItem('scrix_tutorial_completed', 'true');
            savePrefsToCloud('tutorialCompleted', true);
        }

        function skipTutorial() {
            closeTutorial();
        }

        // Load from URL if shared
        function loadFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const codeParam = urlParams.get('code');
            
            if (codeParam) {
                try {
                    const decoded = JSON.parse(decodeURIComponent(escape(atob(codeParam))));
                    setEditorValue('htmlEditor', decoded.html || '');
                    setEditorValue('cssEditor', decoded.css || '');
                    setEditorValue('jsEditor', decoded.js || '');
                    runCode();
                    showNotification('Code partag√© charg√©', 'success');
                } catch (e) {
                    console.error('Erreur de d√©codage:', e);
                }
            }
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            if (!window.CodeMirror) {
                // fallback si pas encore charg√©
            } else {
                initCodeMirror();
                setupAllAutoRun();
            }
            setTimeout(() => {
                loadFromURL();
                checkRestoreSession();
            }, 100);
            setTimeout(showTutorial, 2000);
        });

        // ===== CUSTOM CONFIRM =====
        // ===== SVG ICONS pour les modals =====
        const MODAL_ICONS = {
            trash: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>`,
            save:  `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>`,
            warn:  `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`,
            info:  `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>`,
            edit:  `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`,
        };
        function getModalIcon(icon, danger) {
            const svg = MODAL_ICONS[icon] || MODAL_ICONS.warn;
            const color = danger ? '#ef4444' : icon === 'trash' ? '#ef4444' : icon === 'save' ? 'var(--primary-purple)' : icon === 'edit' ? 'var(--primary-purple)' : '#f59e0b';
            const bg    = danger ? 'rgba(239,68,68,0.12)' : icon === 'trash' ? 'rgba(239,68,68,0.12)' : icon === 'save' ? 'rgba(79,142,247,0.12)' : icon === 'edit' ? 'rgba(79,142,247,0.12)' : 'rgba(245,158,11,0.12)';
            return `<div style="width:60px;height:60px;border-radius:16px;background:${bg};display:flex;align-items:center;justify-content:center;margin:0 auto 18px;color:${color}">${svg}</div>`;
        }

        function scrixConfirm({ icon = 'warn', title = 'Confirmation', desc = '', okText = 'Confirmer', cancelText = 'Annuler', danger = false } = {}, callback) {
            const existing = document.getElementById('scrixConfirmModal');
            if (existing) existing.remove();

            const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

            const modal = document.createElement('div');
            modal.className = 'confirm-modal';
            modal.id = 'scrixConfirmModal';
            modal.setAttribute('role', 'dialog');
            modal.setAttribute('aria-modal', 'true');
            modal.innerHTML = `
                <div class="confirm-card">
                    ${getModalIcon(icon, danger)}
                    <div class="confirm-title">${esc(title)}</div>
                    ${desc ? `<div class="confirm-desc">${esc(desc)}</div>` : ''}
                    <div class="confirm-btns">
                        <button class="confirm-btn confirm-btn-cancel" id="scrixConfirmCancel">${esc(cancelText)}</button>
                        <button class="confirm-btn ${danger ? 'confirm-btn-danger' : 'confirm-btn-ok'}" id="scrixConfirmOk">${esc(okText)}</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            function close(result) {
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.2s ease';
                setTimeout(() => modal.remove(), 200);
                callback(result);
            }

            document.getElementById('scrixConfirmOk').onclick = () => close(true);
            document.getElementById('scrixConfirmCancel').onclick = () => close(false);

            const onKey = (e) => { if (e.key === 'Escape') { close(false); document.removeEventListener('keydown', onKey); } };
            document.addEventListener('keydown', onKey);
        }

        // ===== CUSTOM PROMPT =====
        function scrixPrompt({ icon = 'edit', title = '', desc = '', placeholder = '', defaultValue = '' } = {}, callback) {
            const existing = document.getElementById('scrixPromptModal');
            if (existing) existing.remove();

            const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

            const modal = document.createElement('div');
            modal.className = 'confirm-modal';
            modal.id = 'scrixPromptModal';
            modal.setAttribute('role', 'dialog');
            modal.setAttribute('aria-modal', 'true');
            modal.innerHTML = `
                <div class="confirm-card">
                    ${getModalIcon(icon, false)}
                    <div class="confirm-title">${esc(title)}</div>
                    ${desc ? `<div class="confirm-desc">${esc(desc)}</div>` : ''}
                    <input id="scrixPromptInput" type="text"
                        value="${esc(defaultValue)}"
                        placeholder="${esc(placeholder)}"
                        style="
                            width:100%;box-sizing:border-box;
                            background:var(--bg-tertiary);
                            border:1.5px solid var(--border-default);
                            border-radius:10px;
                            padding:11px 14px;
                            color:var(--text-primary);
                            font-family:var(--font-sans);
                            font-size:14px;
                            outline:none;
                            margin-bottom:20px;
                            transition:border-color 0.2s;
                        "
                        onfocus="this.style.borderColor='var(--primary-purple)'"
                        onblur="this.style.borderColor='var(--border-default)'"
                    />
                    <div class="confirm-btns">
                        <button class="confirm-btn confirm-btn-cancel" id="scrixPromptCancel">Annuler</button>
                        <button class="confirm-btn confirm-btn-ok" id="scrixPromptOk">Sauvegarder</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            const input = document.getElementById('scrixPromptInput');
            input.focus();
            input.select();

            function close(value) {
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.2s ease';
                setTimeout(() => modal.remove(), 200);
                callback(value);
            }

            document.getElementById('scrixPromptOk').onclick = () => close(input.value.trim() || null);
            document.getElementById('scrixPromptCancel').onclick = () => close(null);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') close(input.value.trim() || null);
                if (e.key === 'Escape') close(null);
            });
        }

        function checkRestoreSession() {
            const saved = localStorage.getItem('scrix_autosave');
            if (!saved) return; // rien √† restaurer, on laisse le code par d√©faut

            let code;
            try { code = JSON.parse(saved); } catch(e) { return; }

            // V√©rifier qu'il y a vraiment du contenu
            const hasContent = (code.html && code.html.trim()) || (code.css && code.css.trim()) || (code.js && code.js.trim());
            if (!hasContent) return;

            const projectName = code.projectName || 'Sans titre';
            const safeProjectName = String(projectName).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

            // Cr√©er la modale
            const modal = document.createElement('div');
            modal.className = 'restore-modal';
            modal.id = 'restoreModal';
            modal.setAttribute('role', 'dialog');
            modal.setAttribute('aria-modal', 'true');
            modal.innerHTML = `
                <div class="restore-card">
                    <div class="restore-icon">üíæ</div>
                    <div class="restore-title">Session pr√©c√©dente d√©tect√©e</div>
                    <div class="restore-desc">Tu avais du code en cours la derni√®re fois.<br>Tu veux le r√©cup√©rer ?</div>
                    <div class="restore-project-name">üìÑ ${safeProjectName}</div>
                    <div class="restore-btns">
                        <button class="restore-btn restore-btn-clear" onclick="dismissRestore()">Effacer</button>
                        <button class="restore-btn restore-btn-load" onclick="confirmRestore()">Charger</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function confirmRestore() {
            loadFromStorage();
            closeRestoreModal();
            runCode();
        }

        function dismissRestore() {
            localStorage.removeItem('scrix_autosave');
            closeRestoreModal();
        }

        function closeRestoreModal() {
            const modal = document.getElementById('restoreModal');
            if (modal) {
                modal.style.animation = 'none';
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.25s ease';
                setTimeout(() => modal.remove(), 250);
            }
        }

        // Escape key to close modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // Close share modal if open
                const shareModal = document.getElementById('shareModal');
                if (shareModal && shareModal.classList.contains('active')) {
                    closeShare();
                    return;
                }
                
                // Close templates modal if open
                const templatesModal = document.getElementById('templatesModal');
                if (templatesModal && templatesModal.classList.contains('active')) {
                    closeTemplates();
                    return;
                }
                
                // Close settings panel if open
                const settingsPanel = document.getElementById('settingsPanel');
                if (settingsPanel && settingsPanel.classList.contains('active')) {
                    closeSettings();
                    return;
                }
                
                // Close login modal if open
                const loginModal = document.getElementById('loginModalOverlay');
                if (loginModal && loginModal.style.display !== 'none' && loginModal.style.display !== '') {
                    closeLoginModalDirect();
                    return;
                }

                // Close projects panel if open
                const projectsPanel = document.getElementById('projectsPanel');
                if (projectsPanel && projectsPanel.classList.contains('active')) {
                    toggleProjects();
                    return;
                }
            }
        });

        // ========== MINI GAMES SYSTEM ==========
        let currentGame = null;
        let gameInterval = null;

        function openMiniGames() {
            document.getElementById('miniGamesModal').classList.add('active');
            document.getElementById('gamesMenu').style.display = 'grid';
            const savedSize = localStorage.getItem('scrix_games_size') || 'lg';
            setGamesSize(savedSize);
            renderCustomGameCards();
        }

        function closeMiniGames() {
            document.getElementById('miniGamesModal').classList.remove('active');
            // Fermer aussi le plein √©cran si actif
            const overlay = document.getElementById('gameFullscreenOverlay');
            if (overlay) overlay.classList.remove('active');
            if (gameInterval) { clearInterval(gameInterval); gameInterval = null; }
            currentGame = null;
        }

        function handleMiniGamesOverlayClick(event) {
            if (event.target === document.getElementById('miniGamesModal')) {
                closeMiniGames();
            }
        }

        function backToGamesMenu() {
            // Fermer l'overlay plein √©cran si ouvert
            const overlay = document.getElementById('gameFullscreenOverlay');
            if (overlay) overlay.classList.remove('active');
            // R√©ouvrir le modal mini-jeux
            document.getElementById('miniGamesModal').classList.add('active');
            document.getElementById('gamesMenu').style.display = 'grid';
            if (gameInterval) { clearInterval(gameInterval); gameInterval = null; }
            currentGame = null;
            renderCustomGameCards();
            // Restore canvas if custom game iframe was shown
            const iframe = document.getElementById('customGameIframe');
            const canvas = document.getElementById('gameCanvas');
            if (iframe) { iframe.style.display = 'none'; if (iframe.src) { URL.revokeObjectURL(iframe.src); iframe.src = ''; } }
            if (canvas) canvas.style.display = 'block';
        }

        // ========== CUSTOM MINI-JEUX ==========

        function setGamesSize(size) {
            const grid = document.getElementById('gamesMenu');
            if (!grid) return;
            grid.classList.remove('gsize-lg', 'gsize-md', 'gsize-sm', 'gsize-list');
            grid.classList.add('gsize-' + size);
            document.querySelectorAll('[id^="gsize-"]').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById('gsize-' + size);
            if (btn) btn.classList.add('active');
            localStorage.setItem('scrix_games_size', size);
        }

        function getCustomGames() {
            return JSON.parse(localStorage.getItem('scrix_custom_games') || '[]');
        }

        function saveCustomGames(games) {
            localStorage.setItem('scrix_custom_games', JSON.stringify(games));
        }

        function renameCustomGame(index) {
            const games = getCustomGames();
            const game = games[index];
            if (!game) return;
            const nameEl = document.getElementById('cgName_' + index);
            if (!nameEl) return;

            const oldName = game.name;
            const input = document.createElement('input');
            input.value = oldName;
            input.maxLength = 40;
            input.style.cssText = 'background:rgba(124,58,237,0.2);border:1px solid var(--primary-purple);border-radius:6px;padding:3px 8px;color:var(--text-primary);font-family:inherit;font-size:13px;font-weight:700;width:100%;outline:none;text-align:center;';
            nameEl.replaceWith(input);
            input.focus();
            input.select();

            async function commit() {
                const newName = input.value.trim() || oldName;
                games[index].name = newName;
                saveCustomGames(games);
                await syncCustomGamesToCloud();
                if (newName !== oldName) showNotification(`Renomm√© en "${newName}"`, 'success');
                renderCustomGameCards();
            }
            input.addEventListener('blur', commit);
            input.addEventListener('keydown', e => {
                if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
                if (e.key === 'Escape') { input.value = oldName; input.blur(); }
            });
        }

        function renderCustomGameCards() {
            const container = document.getElementById('customGamesCards');
            if (!container) return;
            const games = getCustomGames();
            if (games.length === 0) { container.innerHTML = ''; return; }
            container.style.display = 'contents';
            container.innerHTML = games.map((game, i) => {
                const safeName = String(game.name || 'Projet').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
                const isValidThumb = game.thumbnail && /^data:image\/(jpeg|png|webp|gif);base64,/.test(game.thumbnail);
                const thumbHtml = isValidThumb
                    ? `<img src="${game.thumbnail}" style="width:100%;height:100%;object-fit:cover;display:block;" alt="preview"/>`
                    : `<span style="font-size:32px;">${game.icon || 'üéÆ'}</span>`;
                const date = game.timestamp ? new Date(game.timestamp).toLocaleDateString('fr-FR') : '';
                return `
                <div class="project-card" onclick="launchCustomGame(${i})" style="cursor:pointer;">
                    <div class="project-card-thumb">
                        ${thumbHtml}
                        <div class="project-card-thumb-overlay"></div>
                    </div>
                    <div class="project-card-body">
                        <div class="project-card-info" onclick="event.stopPropagation()">
                            <div class="project-card-name" id="cgName_${i}"
                                 ondblclick="event.stopPropagation();renameCustomGame(${i})"
                                 title="Double-clic pour renommer">
                                ${safeName}
                            </div>
                            <div class="project-card-date">${date}</div>
                        </div>
                        <div class="project-card-actions" onclick="event.stopPropagation()">
                            <button class="project-card-btn" onclick="event.stopPropagation();renameCustomGame(${i})" title="Renommer">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </button>
                            <button class="project-card-btn danger" onclick="event.stopPropagation();removeCustomGame(${i})" title="Supprimer">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
                                    <path d="M10 11v6M14 11v6"/>
                                    <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>`;
            }).join('');

            const savedSize = localStorage.getItem('scrix_games_size') || 'lg';
            setGamesSize(savedSize);
        }

        async function syncCustomGamesToCloud() {
            if (!window._fbUser || !window._fbDb || !window._fbFns) return;
            const { doc, setDoc } = window._fbFns;
            try {
                const games = getCustomGames();
                const refs = games.map(g => ({ name: g.name, timestamp: g.timestamp, icon: g.icon || 'üéÆ', thumbnail: g.thumbnail || null }));
                await setDoc(doc(window._fbDb, 'users', window._fbUser.uid, 'prefs', 'customGames'), { games: refs });
            } catch(e) { console.error('Custom games sync error:', e); }
        }

        async function loadCustomGamesFromCloud(user) {
            if (!window._fbDb || !window._fbFns) return;
            const { doc, getDoc } = window._fbFns;
            try {
                const snap = await getDoc(doc(window._fbDb, 'users', user.uid, 'prefs', 'customGames'));
                if (!snap.exists()) return;
                const cloudRefs = snap.data().games || [];
                // On recompose √† partir des projets locaux (qui ont d√©j√† √©t√© synchronis√©s)
                const projects = JSON.parse(localStorage.getItem('scrix_projects') || '[]');
                const merged = cloudRefs.map(ref => {
                    const proj = projects.find(p => p.name === ref.name && Math.abs((p.timestamp || 0) - (ref.timestamp || 0)) < 5000);
                    if (proj) return { name: proj.name, timestamp: proj.timestamp, icon: ref.icon || 'üéÆ', thumbnail: proj.thumbnail || ref.thumbnail || null, html: proj.html || '', css: proj.css || '', js: proj.js || '' };
                    return null;
                }).filter(Boolean);
                if (merged.length > 0) {
                    saveCustomGames(merged);
                    renderCustomGameCards();
                }
            } catch(e) { console.error('Custom games load error:', e); }
        }

        function setProjGrid(cols) {
            const list = document.getElementById('projSelectorList');
            // Reset all buttons
            ['2','3','4','List'].forEach(v => {
                const btn = document.getElementById('projView' + v);
                if (btn) btn.classList.remove('active');
            });
            if (cols === 'list') {
                list.style.gridTemplateColumns = '1fr';
                document.getElementById('projViewList').classList.add('active');
                // List mode: horizontal cards
                list.querySelectorAll('.proj-selector-card').forEach(card => {
                    card.style.flexDirection = 'row';
                    card.style.aspectRatio = 'unset';
                    card.style.height = '60px';
                    const wrap = card.querySelector('.proj-selector-thumb-wrap');
                    if (wrap) { wrap.style.width = '60px'; wrap.style.aspectRatio = '1'; wrap.style.flexShrink = '0'; }
                });
            } else {
                list.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
                document.getElementById('projView' + cols).classList.add('active');
                list.querySelectorAll('.proj-selector-card').forEach(card => {
                    card.style.flexDirection = 'column';
                    card.style.aspectRatio = 'unset';
                    card.style.height = 'unset';
                    const wrap = card.querySelector('.proj-selector-thumb-wrap');
                    if (wrap) { wrap.style.width = '100%'; wrap.style.aspectRatio = '1'; wrap.style.flexShrink = '0'; }
                });
            }
        }

        function openProjectSelector() {
            if (!window._fbUser) {
                showNotification('Connecte-toi pour ajouter tes projets', 'error');
                setTimeout(() => openLoginModal(), 800);
                return;
            }
            const projects = JSON.parse(localStorage.getItem('scrix_projects') || '[]');
            const list = document.getElementById('projSelectorList');
            if (projects.length === 0) {
                list.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:var(--text-tertiary);padding:40px 20px;">
                    <div style="font-size:40px;margin-bottom:12px;">üìÇ</div>
                    <div>Aucun projet sauvegard√©</div>
                </div>`;
            } else {
                list.innerHTML = projects.map((p, i) => {
                    const safeName = String(p.name || 'Sans titre').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                    const isValidThumb = p.thumbnail && /^data:image\/(jpeg|png|webp|gif);base64,/.test(p.thumbnail);
                    const thumbHtml = isValidThumb
                        ? `<div class="proj-selector-thumb-wrap"><img class="proj-selector-thumb" src="${p.thumbnail}" alt="preview"/></div>`
                        : `<div class="proj-selector-thumb-wrap" style="display:flex;align-items:center;justify-content:center;font-size:36px;">üéÆ</div>`;
                    return `<div class="proj-selector-card" onclick="addCustomGame(${i})">
                        ${thumbHtml}
                        <div class="proj-selector-name">${safeName}</div>
                    </div>`;
                }).join('');
            }
            document.getElementById('projSelectorModal').classList.add('active');
        }

        function closeProjectSelector() {
            document.getElementById('projSelectorModal').classList.remove('active');
        }

        async function addCustomGame(projIndex) {
            const projects = JSON.parse(localStorage.getItem('scrix_projects') || '[]');
            const proj = projects[projIndex];
            if (!proj) return;

            const games = getCustomGames();
            // V√©rifier doublon
            if (games.some(g => g.name === proj.name && Math.abs((g.timestamp || 0) - (proj.timestamp || 0)) < 5000)) {
                showNotification('Ce projet est d√©j√† dans les mini-jeux !', 'error');
                closeProjectSelector();
                return;
            }

            games.push({
                name: proj.name,
                timestamp: proj.timestamp,
                icon: 'üéÆ',
                thumbnail: proj.thumbnail || null,
                html: proj.html || '',
                css: proj.css || '',
                js: proj.js || ''
            });
            saveCustomGames(games);
            await syncCustomGamesToCloud();
            closeProjectSelector();
            renderCustomGameCards();
            showNotification(`"${proj.name}" ajout√© aux mini-jeux`, 'success');
        }

        async function removeCustomGame(index) {
            const games = getCustomGames();
            const name = games[index] ? games[index].name : 'ce mini-jeu';
            scrixConfirm({
                icon: 'trash',
                title: 'Supprimer le mini-jeu',
                desc: `Tu veux vraiment supprimer "${name}" ? Cette action est irr√©versible.`,
                okText: 'Supprimer',
                danger: true
            }, async (confirmed) => {
                if (!confirmed) return;
                const g = getCustomGames();
                g.splice(index, 1);
                saveCustomGames(g);
                await syncCustomGamesToCloud();
                renderCustomGameCards();
                showNotification(`"${name}" retir√© des mini-jeux`, 'success');
            });
        }

        function launchCustomGame(index) {
            const games = getCustomGames();
            const game = games[index];
            if (!game) return;

            currentGame = 'custom_' + index;

            // Ouvrir le fullscreen
            document.getElementById('miniGamesModal').classList.remove('active');
            const overlay = document.getElementById('gameFullscreenOverlay');
            overlay.classList.add('active');
            document.getElementById('gameTopbar').classList.remove('hidden');
            document.getElementById('gameToggleBar').classList.remove('visible');

            // Titre
            document.getElementById('gameFullscreenTitle').textContent = 'üéÆ ' + game.name;
            document.getElementById('gameInfo').textContent = game.name;

            // Cacher le canvas, afficher l'iframe
            const canvas = document.getElementById('gameCanvas');
            if (canvas) canvas.style.display = 'none';

            let iframe = document.getElementById('customGameIframe');
            if (!iframe) {
                iframe = document.createElement('iframe');
                iframe.id = 'customGameIframe';
                iframe.style.cssText = 'position:fixed;top:52px;left:0;width:100vw;height:calc(100vh - 52px);border:none;z-index:20000;';
                overlay.appendChild(iframe);
            } else {
                iframe.style.display = 'block';
            }

            const htmlContent = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>*{margin:0;padding:0;box-sizing:border-box;}body{overflow:auto;}${game.css || ''}</style></head><body>${game.html || ''}<script>${game.js || ''}<\/script></body></html>`;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            iframe._blobUrl = url;
            iframe.src = url;
        }


        function resizeGameCanvas() {
            const canvas = document.getElementById('gameCanvas');
            if (!canvas) return;
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight - 52;
        }

        function startGame(gameName) {
            // Fermer le modal mini-jeux
            document.getElementById('miniGamesModal').classList.remove('active');
            // Ouvrir l'overlay plein √©cran
            const overlay = document.getElementById('gameFullscreenOverlay');
            overlay.classList.add('active');
            currentGame = gameName;
            // Titre
            const titles = { snake: 'üêç Snake', memory: 'üß† Memory', pong: 'üèì Pong', breakout: 'üß± Breakout', guess: 'üéØ Devinez le nombre' };
            document.getElementById('gameFullscreenTitle').textContent = titles[gameName] || 'üéÆ Jeu';
            // R√©initialiser la topbar
            document.getElementById('gameTopbar').classList.remove('hidden');
            document.getElementById('gameToggleBar').classList.remove('visible');
            // Resize canvas plein √©cran
            resizeGameCanvas();
            // Assurer que canvas est visible, iframe cach√©e
            const canvas = document.getElementById('gameCanvas');
            if (canvas) canvas.style.display = 'block';
            const iframe = document.getElementById('customGameIframe');
            if (iframe) { iframe.style.display = 'none'; }
        }

        function closeFullscreenGame() {
            const overlay = document.getElementById('gameFullscreenOverlay');
            overlay.classList.remove('active');
            if (gameInterval) { clearInterval(gameInterval); gameInterval = null; }
            currentGame = null;
            // Nettoyage iframe custom
            const iframe = document.getElementById('customGameIframe');
            if (iframe) {
                if (iframe._blobUrl) { URL.revokeObjectURL(iframe._blobUrl); iframe._blobUrl = null; }
                iframe.src = '';
                iframe.style.display = 'none';
            }
            // Remettre le canvas
            const canvas = document.getElementById('gameCanvas');
            if (canvas) canvas.style.display = 'block';
            // R√©ouvrir le menu mini-jeux
            document.getElementById('miniGamesModal').classList.add('active');
            document.getElementById('gamesMenu').style.display = 'grid';
            renderCustomGameCards();
        }

        function toggleGameTopbar() {
            const bar = document.getElementById('gameTopbar');
            const toggle = document.getElementById('gameToggleBar');
            bar.classList.toggle('hidden');
            toggle.classList.toggle('visible');
            toggle.textContent = bar.classList.contains('hidden') ? '‚ñº Afficher les contr√¥les' : '‚ñ≤ Masquer les contr√¥les';
        }

        function restartCurrentGame() {
            if (currentGame === 'snake') startSnakeGame();
            else if (currentGame === 'memory') startMemoryGame();
            else if (currentGame === 'pong') startPongGame();
            else if (currentGame === 'breakout') startBreakoutGame();
            else if (currentGame === 'guess') startGuessNumberGame();
            else if (currentGame && currentGame.startsWith('custom_')) {
                const idx = parseInt(currentGame.split('_')[1]);
                launchCustomGame(idx);
            }
        }

        // ========== SNAKE GAME ==========
        function startSnakeGame() {
            startGame('snake');
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const gridSize = Math.floor(Math.min(canvas.width, canvas.height) / 30);
            const tilesX = Math.floor(canvas.width / gridSize);
            const tilesY = Math.floor(canvas.height / gridSize);

            let snake = [{x: Math.floor(tilesX/2), y: Math.floor(tilesY/2)}];
            let food = {x: Math.floor(tilesX * 0.7), y: Math.floor(tilesY * 0.7)};
            let dx = 1, dy = 0;
            let score = 0;
            let gameOver = false;

            // Remove previous event listener
            document.onkeydown = null;
            
            function handleKeyPress(e) {
                if (currentGame !== 'snake') return;
                if (e.key === 'ArrowUp' && dy === 0) { dx = 0; dy = -1; }
                else if (e.key === 'ArrowDown' && dy === 0) { dx = 0; dy = 1; }
                else if (e.key === 'ArrowLeft' && dx === 0) { dx = -1; dy = 0; }
                else if (e.key === 'ArrowRight' && dx === 0) { dx = 1; dy = 0; }
            }
            
            document.addEventListener('keydown', handleKeyPress);

            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(() => {
                if (gameOver || currentGame !== 'snake') {
                    clearInterval(gameInterval);
                    document.removeEventListener('keydown', handleKeyPress);
                    return;
                }

                // Move snake
                const head = {x: snake[0].x + dx, y: snake[0].y + dy};
                
                // Check collisions
                if (head.x < 0 || head.x >= tilesX || head.y < 0 || head.y >= tilesY ||
                    snake.some(segment => segment.x === head.x && segment.y === head.y)) {
                    gameOver = true;
                    document.getElementById('gameInfo').textContent = `Game Over! Score: ${score}`;
                    clearInterval(gameInterval);
                    document.removeEventListener('keydown', handleKeyPress);
                    return;
                }

                snake.unshift(head);

                // Check food
                if (head.x === food.x && head.y === food.y) {
                    score += 10;
                    food = {
                        x: Math.floor(Math.random() * tilesX),
                        y: Math.floor(Math.random() * tilesY)
                    };
                } else {
                    snake.pop();
                }

                // Draw
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw snake
                ctx.fillStyle = '#4f8ef7';
                snake.forEach((segment, index) => {
                    if (index === 0) {
                        ctx.fillStyle = '#a78bfa'; // Head color
                    } else {
                        ctx.fillStyle = '#4f8ef7';
                    }
                    ctx.fillRect(segment.x * gridSize + 1, segment.y * gridSize + 1, gridSize - 2, gridSize - 2);
                });
                
                // Draw food
                ctx.fillStyle = '#4f8ef7';
                ctx.fillRect(food.x * gridSize + 1, food.y * gridSize + 1, gridSize - 2, gridSize - 2);

                document.getElementById('gameInfo').textContent = `Score: ${score}`;
            }, 120);
        }

        // ========== MEMORY GAME ==========
        function startMemoryGame() {
            startGame('memory');
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');

            // Symbols avec couleurs associ√©es
            const CARDS_DATA = [
                { sym: 'üå∏', color: '#f472b6' },
                { sym: 'üéÆ', color: '#818cf8' },
                { sym: '‚≠ê', color: '#fbbf24' },
                { sym: 'üé®', color: '#34d399' },
                { sym: 'üöÄ', color: '#60a5fa' },
                { sym: 'üíé', color: '#a78bfa' },
                { sym: 'üî•', color: '#fb923c' },
                { sym: 'üåà', color: '#f87171' },
            ];

            let deck = [...CARDS_DATA, ...CARDS_DATA];
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }

            const COLS = 4, ROWS = 4, TOTAL = 16;
            const GAP = 16;
            const PAD_X = Math.floor(canvas.width * 0.04);
            const PAD_Y = Math.floor(canvas.height * 0.05);
            // Forcer des cartes carr√©es : prendre la plus petite dimension disponible
            const maxCW = Math.floor((canvas.width  - PAD_X * 2 - GAP * (COLS - 1)) / COLS);
            const maxCH = Math.floor((canvas.height - PAD_Y * 2 - GAP * (ROWS - 1)) / ROWS);
            const cW = Math.min(maxCW, maxCH);
            const cH = cW;
            // Centrer la grille dans le canvas
            const gridW = cW * COLS + GAP * (COLS - 1);
            const gridH = cH * ROWS + GAP * (ROWS - 1);

            // √âtat des cartes: flip (0=dos, 1=face), scale, glow, particles
            let state = Array.from({length: TOTAL}, () => ({
                flip: 0,        // 0‚Üí1 flip vers face, -1‚Üí0 flip vers dos
                flipping: false,
                matched: false,
                matchScale: 1,
                matchGlow: 0,
                shake: 0,
                shakeDir: 1,
            }));

            let particles = []; // particules de match
            let flipped = [];
            let matched = [];
            let score = 0;
            let moves = 0;
            let isLocked = false;
            let bgStars = Array.from({length: 40}, () => ({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                r: Math.random() * 1.5 + 0.3,
                a: Math.random(),
                speed: Math.random() * 0.008 + 0.003,
            }));

            const offX = Math.floor((canvas.width  - gridW) / 2);
            const offY = Math.floor((canvas.height - gridH) / 2);

            function getCardPos(i) {
                const col = i % COLS, row = Math.floor(i / COLS);
                return {
                    x: offX + col * (cW + GAP),
                    y: offY + row * (cH + GAP),
                };
            }

            // Flip animation fluide
            function animFlip(i, toFront, onDone) {
                const s = state[i];
                s.flipping = true;
                const start = s.flip;
                const end = toFront ? 1 : 0;
                const dur = 320;
                const t0 = performance.now();
                function step(t) {
                    const p = Math.min((t - t0) / dur, 1);
                    const ease = p < 0.5 ? 2*p*p : -1+(4-2*p)*p;
                    s.flip = start + (end - start) * ease;
                    if (p < 1) { requestAnimationFrame(step); }
                    else { s.flip = end; s.flipping = false; if (onDone) onDone(); }
                }
                requestAnimationFrame(step);
            }

            // Animation match: petite vibration rapide
            function animMatch(i) {
                const s = state[i];
                const dur = 300;
                const t0 = performance.now();
                function step(t) {
                    const p = Math.min((t - t0) / dur, 1);
                    // Vibration : oscillation rapide qui s'att√©nue
                    s.shake = Math.sin(p * Math.PI * 5) * 5 * (1 - p);
                    s.matchGlow = (1 - p) * 20;
                    if (p < 1) requestAnimationFrame(step);
                    else { s.shake = 0; s.matchGlow = 0; }
                }
                requestAnimationFrame(step);
            }

            // Animation shake (mauvaise paire)
            function animShake(i) {
                const s = state[i];
                const dur = 400;
                const t0 = performance.now();
                function step(t) {
                    const p = Math.min((t - t0) / dur, 1);
                    s.shake = Math.sin(p * Math.PI * 6) * 8 * (1 - p);
                    if (p < 1) requestAnimationFrame(step);
                    else s.shake = 0;
                }
                requestAnimationFrame(step);
            }

            // Spawn particules
            function spawnParticles(i) {
                const {x, y} = getCardPos(i);
                const cx = x + cW/2, cy = y + cH/2;
                const color = deck[i].color;
                for (let k = 0; k < 18; k++) {
                    const angle = (k / 18) * Math.PI * 2 + Math.random() * 0.4;
                    const speed = 2.5 + Math.random() * 3;
                    particles.push({
                        x: cx, y: cy,
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed,
                        life: 1, decay: 0.025 + Math.random() * 0.02,
                        r: 3 + Math.random() * 4,
                        color,
                    });
                }
            }

            canvas.onclick = (e) => {
                if (currentGame !== 'memory' || isLocked) return;
                const rect = canvas.getBoundingClientRect();
                const mx = (e.clientX - rect.left) * (canvas.width / rect.width);
                const my = (e.clientY - rect.top)  * (canvas.height / rect.height);
                for (let i = 0; i < TOTAL; i++) {
                    const {x, y} = getCardPos(i);
                    if (mx >= x && mx <= x+cW && my >= y && my <= y+cH) {
                        if (state[i].matched || flipped.includes(i) || state[i].flipping) return;
                        flipped.push(i);
                        animFlip(i, true);
                        if (flipped.length === 2) {
                            isLocked = true;
                            moves++;
                            const [a, b] = flipped;
                            setTimeout(() => {
                                if (deck[a].sym === deck[b].sym) {
                                    // Match !
                                    score += Math.max(10, 30 - moves);
                                    state[a].matched = state[b].matched = true;
                                    matched.push(a, b);
                                    animMatch(a); animMatch(b);
                                    flipped = [];
                                    isLocked = false;
                                    if (matched.length === TOTAL) {
                                        setTimeout(() => {
                                            document.getElementById('gameInfo').textContent = `üéâ Gagn√© en ${moves} coups ! Score: ${score}`;
                                        }, 600);
                                    }
                                } else {
                                    // Pas de match
                                    animShake(a); animShake(b);
                                    setTimeout(() => {
                                        animFlip(a, false);
                                        animFlip(b, false, () => { flipped = []; isLocked = false; });
                                    }, 500);
                                }
                            }, 650);
                        }
                        return;
                    }
                }
            };

            function roundRect(ctx, x, y, w, h, r) {
                ctx.beginPath();
                ctx.moveTo(x+r, y);
                ctx.lineTo(x+w-r, y);
                ctx.quadraticCurveTo(x+w, y, x+w, y+r);
                ctx.lineTo(x+w, y+h-r);
                ctx.quadraticCurveTo(x+w, y+h, x+w-r, y+h);
                ctx.lineTo(x+r, y+h);
                ctx.quadraticCurveTo(x, y+h, x, y+h-r);
                ctx.lineTo(x, y+r);
                ctx.quadraticCurveTo(x, y, x+r, y);
                ctx.closePath();
            }

            function drawCardBack(x, y, w, h, alpha) {
                ctx.save();
                ctx.globalAlpha = alpha;
                // Fond d√©grad√©
                const g = ctx.createLinearGradient(x, y, x+w, y+h);
                g.addColorStop(0, '#2e1065');
                g.addColorStop(0.5, '#4c1d95');
                g.addColorStop(1, '#1e1b4b');
                ctx.fillStyle = g;
                ctx.shadowBlur = 12;
                ctx.shadowColor = 'rgba(124,58,237,0.4)';
                roundRect(ctx, x, y, w, h, 14);
                ctx.fill();
                // Bordure
                ctx.shadowBlur = 0;
                ctx.strokeStyle = '#6d28d9';
                ctx.lineWidth = 2;
                roundRect(ctx, x, y, w, h, 14);
                ctx.stroke();
                // Motif losange d√©coratif
                ctx.strokeStyle = 'rgba(167,139,250,0.25)';
                ctx.lineWidth = 1;
                const cx = x+w/2, cy = y+h/2;
                const sz = Math.min(w,h)*0.32;
                ctx.beginPath();
                ctx.moveTo(cx, cy-sz); ctx.lineTo(cx+sz, cy);
                ctx.lineTo(cx, cy+sz); ctx.lineTo(cx-sz, cy);
                ctx.closePath(); ctx.stroke();
                const sz2 = sz * 0.62;
                ctx.beginPath();
                ctx.moveTo(cx, cy-sz2); ctx.lineTo(cx+sz2, cy);
                ctx.lineTo(cx, cy+sz2); ctx.lineTo(cx-sz2, cy);
                ctx.closePath(); ctx.stroke();
                // Symbole ?
                ctx.font = `bold ${Math.floor(h*0.38)}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = 'rgba(167,139,250,0.6)';
                ctx.fillText('?', cx, cy);
                ctx.restore();
            }

            function drawCardFront(i, x, y, w, h, alpha) {
                const card = deck[i];
                const isMatched = state[i].matched;
                ctx.save();
                ctx.globalAlpha = alpha;
                // Fond
                const g = ctx.createLinearGradient(x, y, x+w, y+h);
                if (isMatched) {
                    g.addColorStop(0, '#064e3b');
                    g.addColorStop(1, '#065f46');
                    ctx.shadowBlur = state[i].matchGlow + 15;
                    ctx.shadowColor = '#34d399';
                } else {
                    g.addColorStop(0, '#1e1b4b');
                    g.addColorStop(1, '#312e81');
                    ctx.shadowBlur = 0;
                }
                ctx.fillStyle = g;
                roundRect(ctx, x, y, w, h, 14);
                ctx.fill();
                // Bordure
                ctx.strokeStyle = isMatched ? '#34d399' : card.color;
                ctx.lineWidth = isMatched ? 3 : 2.5;
                ctx.shadowBlur = isMatched ? state[i].matchGlow : 8;
                ctx.shadowColor = isMatched ? '#34d399' : card.color;
                roundRect(ctx, x, y, w, h, 14);
                ctx.stroke();
                // Halo color√© en fond de l'emoji
                if (!isMatched) {
                    ctx.shadowBlur = 0;
                    const radGrad = ctx.createRadialGradient(x+w/2, y+h/2, 0, x+w/2, y+h/2, w*0.4);
                    radGrad.addColorStop(0, card.color + '33');
                    radGrad.addColorStop(1, 'transparent');
                    ctx.fillStyle = radGrad;
                    roundRect(ctx, x, y, w, h, 14);
                    ctx.fill();
                }
                // Emoji
                ctx.shadowBlur = 0;
                ctx.font = `${Math.floor(h * 0.48)}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = 'white';
                ctx.fillText(card.sym, x+w/2, y+h/2);
                // Checkmark si matched
                if (isMatched) {
                    ctx.font = `bold ${Math.floor(h*0.2)}px Arial`;
                    ctx.fillStyle = '#34d399';
                    ctx.fillText('‚úì', x+w-14, y+16);
                }
                ctx.restore();
            }

            function draw() {
                // BG
                const bg = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                bg.addColorStop(0, '#0f0a1e');
                bg.addColorStop(0.5, '#111112');
                bg.addColorStop(1, '#0d0520');
                ctx.fillStyle = bg;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // √âtoiles de fond
                bgStars.forEach(s => {
                    s.a += s.speed;
                    const alpha = (Math.sin(s.a) + 1) / 2 * 0.5 + 0.1;
                    ctx.beginPath();
                    ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
                    ctx.fillStyle = `rgba(167,139,250,${alpha})`;
                    ctx.fill();
                });

                // Particules
                particles = particles.filter(p => p.life > 0);
                particles.forEach(p => {
                    p.x += p.vx; p.y += p.vy;
                    p.vy += 0.12;
                    p.life -= p.decay;
                    ctx.beginPath();
                    const pr = Math.max(0, p.r * p.life); ctx.arc(p.x, p.y, pr, 0, Math.PI*2);
                    ctx.fillStyle = p.color + Math.floor(p.life * 255).toString(16).padStart(2,'0');
                    ctx.fill();
                });

                // Cartes
                for (let i = 0; i < TOTAL; i++) {
                    const s = state[i];
                    const {x, y} = getCardPos(i);
                    const cx = x + cW/2, cy = y + cH/2;
                    const flip = s.flip; // 0 = dos, 1 = face
                    const scaleX = Math.cos(flip * Math.PI); // 1‚Üí-1‚Üí1 mais on split en deux phases
                    const absScale = Math.abs(scaleX);
                    const showFront = flip >= 0.5;

                    ctx.save();
                    // Scale match bounce
                    if (s.matchScale !== 1) {
                        ctx.translate(cx + s.shake, cy);
                        ctx.scale(s.matchScale, s.matchScale);
                        ctx.translate(-cx, -cy);
                    } else if (s.shake !== 0) {
                        ctx.translate(s.shake, 0);
                    }

                    // Flip 3D simul√© : on √©crase horizontalement
                    ctx.translate(cx + (s.shake && s.matchScale===1 ? 0 : 0), cy);
                    ctx.scale(absScale, 1);
                    ctx.translate(-cx, -cy);

                    if (showFront) {
                        const alpha2 = flip >= 0.5 ? (flip - 0.5) * 2 : 0;
                        drawCardFront(i, x, y, cW, cH, Math.min(1, alpha2 * 1.4));
                    } else {
                        const alpha2 = flip <= 0.5 ? 1 - flip * 2 : 0;
                        drawCardBack(x, y, cW, cH, Math.min(1, alpha2 * 1.4 + 0.3));
                    }
                    ctx.restore();
                }

                // HUD
                document.getElementById('gameInfo').textContent =
                    `Score: ${score} | Paires: ${matched.length/2}/8 | Coups: ${moves}`;
            }

            function loop() {
                if (currentGame !== 'memory') return;
                draw();
                requestAnimationFrame(loop);
            }
            loop();
        }

        // ========== PONG GAME ==========
        function startPongGame() {
            startGame('pong');
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            
            const paddle = {x: canvas.width/2 - 50, y: canvas.height - 20, width: 100, height: 10, speed: 8};
            const ball = {x: canvas.width/2, y: canvas.height/2, dx: 4, dy: -4, radius: 8};
            let score = 0;
            let gameOver = false;

            canvas.onmousemove = (e) => {
                if (currentGame !== 'pong') return;
                const rect = canvas.getBoundingClientRect();
                paddle.x = e.clientX - rect.left - paddle.width/2;
                paddle.x = Math.max(0, Math.min(canvas.width - paddle.width, paddle.x));
            };

            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(() => {
                if (gameOver || currentGame !== 'pong') return;

                // Move ball
                ball.x += ball.dx;
                ball.y += ball.dy;

                // Wall collisions
                if (ball.x - ball.radius < 0 || ball.x + ball.radius > canvas.width) ball.dx *= -1;
                if (ball.y - ball.radius < 0) ball.dy *= -1;

                // Paddle collision
                if (ball.y + ball.radius > paddle.y && 
                    ball.x > paddle.x && ball.x < paddle.x + paddle.width) {
                    ball.dy *= -1;
                    score += 10;
                }

                // Game over
                if (ball.y - ball.radius > canvas.height) {
                    gameOver = true;
                    document.getElementById('gameInfo').textContent = `Game Over! Score: ${score}`;
                    return;
                }

                // Draw
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#4f8ef7';
                ctx.fillRect(paddle.x, paddle.y, paddle.width, paddle.height);
                
                ctx.fillStyle = '#4f8ef7';
                ctx.beginPath();
                ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
                ctx.fill();

                document.getElementById('gameInfo').textContent = `Score: ${score}`;
            }, 1000/60);
        }

        // ========== BREAKOUT GAME ==========
        function startBreakoutGame() {
            startGame('breakout');
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            
            const paddle = {x: canvas.width/2 - 60, y: canvas.height - 30, width: 120, height: 14, speed: 8};
            const ball = {x: canvas.width/2, y: canvas.height - 60, dx: 5, dy: -5, radius: 8};
            let score = 0;
            let gameOver = false;
            let gameWon = false;

            // Create bricks ‚Äî adapt to canvas width
            const brickRowCount = 5;
            const brickColumnCount = Math.floor((canvas.width - 20) / 80) || 10;
            const brickPadding = 6;
            const brickOffsetTop = 52;
            const brickOffsetLeft = 10;
            const brickWidth = Math.floor((canvas.width - brickOffsetLeft * 2 - brickPadding * (brickColumnCount - 1)) / brickColumnCount);
            const brickHeight = 22;
            let bricks = [];

            for (let c = 0; c < brickColumnCount; c++) {
                bricks[c] = [];
                for (let r = 0; r < brickRowCount; r++) {
                    bricks[c][r] = { x: 0, y: 0, status: 1 };
                }
            }

            canvas.onmousemove = (e) => {
                if (currentGame !== 'breakout') return;
                const rect = canvas.getBoundingClientRect();
                paddle.x = e.clientX - rect.left - paddle.width/2;
                paddle.x = Math.max(0, Math.min(canvas.width - paddle.width, paddle.x));
            };

            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(() => {
                if (gameOver || gameWon || currentGame !== 'breakout') return;

                // Move ball
                ball.x += ball.dx;
                ball.y += ball.dy;

                // Wall collisions
                if (ball.x - ball.radius < 0 || ball.x + ball.radius > canvas.width) {
                    ball.dx *= -1;
                }
                if (ball.y - ball.radius < 0) {
                    ball.dy *= -1;
                }

                // Paddle collision
                if (ball.y + ball.radius > paddle.y && 
                    ball.x > paddle.x && ball.x < paddle.x + paddle.width &&
                    ball.dy > 0) {
                    ball.dy *= -1;
                    const hitPos = (ball.x - paddle.x) / paddle.width;
                    ball.dx = (hitPos - 0.5) * 10;
                }

                // Game over
                if (ball.y - ball.radius > canvas.height) {
                    gameOver = true;
                    document.getElementById('gameInfo').textContent = `Game Over! Score: ${score}`;
                    return;
                }

                // Brick collision detection
                for (let c = 0; c < brickColumnCount; c++) {
                    for (let r = 0; r < brickRowCount; r++) {
                        const b = bricks[c][r];
                        if (b.status === 1) {
                            const brickX = brickOffsetLeft + c * (brickWidth + brickPadding);
                            const brickY = brickOffsetTop + r * (brickHeight + brickPadding);
                            
                            if (ball.x + ball.radius > brickX && 
                                ball.x - ball.radius < brickX + brickWidth &&
                                ball.y + ball.radius > brickY && 
                                ball.y - ball.radius < brickY + brickHeight) {
                                ball.dy *= -1;
                                b.status = 0;
                                score += 10;
                                
                                if (score === brickRowCount * brickColumnCount * 10) {
                                    gameWon = true;
                                    document.getElementById('gameInfo').textContent = `Victoire! Score: ${score} üéâ`;
                                }
                            }
                        }
                    }
                }

                // Draw
                ctx.fillStyle = '#0a0010';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw bricks
                for (let c = 0; c < brickColumnCount; c++) {
                    for (let r = 0; r < brickRowCount; r++) {
                        if (bricks[c][r].status === 1) {
                            const brickX = brickOffsetLeft + c * (brickWidth + brickPadding);
                            const brickY = brickOffsetTop + r * (brickHeight + brickPadding);
                            const colors = ['#4f8ef7', '#a78bfa', '#4f8ef7', '#f59e0b', '#10b981'];
                            ctx.fillStyle = colors[r];
                            ctx.fillRect(brickX, brickY, brickWidth, brickHeight);
                        }
                    }
                }
                
                // Draw paddle
                ctx.fillStyle = '#4f8ef7';
                ctx.beginPath();
                ctx.roundRect(paddle.x, paddle.y, paddle.width, paddle.height, 6);
                ctx.fill();
                
                // Draw ball
                ctx.fillStyle = '#4f8ef7';
                ctx.beginPath();
                ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
                ctx.fill();

                document.getElementById('gameInfo').textContent = `Score: ${score}`;
            }, 1000/60);
        }

        // ========== GUESS NUMBER GAME ==========
        function startGuessNumberGame() {
            startGame('guess');
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            
            let targetNumber = Math.floor(Math.random() * 100) + 1;
            let attempts = 0;
            let message = 'Entrez un nombre entre 1 et 100';
            let currentInput = '';
            let gameWon = false;
            let inputActive = true;

            const cx = canvas.width / 2;
            const cy = canvas.height / 2;

            function drawGame() {
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, '#111112');
                gradient.addColorStop(1, '#1c1c1f');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Title
                ctx.fillStyle = '#a78bfa';
                ctx.font = `bold ${Math.floor(canvas.height * 0.07)}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('üéØ Devinez le nombre', cx, cy - canvas.height * 0.28);
                
                // Instructions
                ctx.fillStyle = '#9ca3af';
                ctx.font = `${Math.floor(canvas.height * 0.032)}px Arial`;
                ctx.fillText('Utilisez votre clavier pour taper un nombre', cx, cy - canvas.height * 0.18);
                
                // Input box
                const boxW = Math.min(400, canvas.width * 0.45);
                const boxH = Math.floor(canvas.height * 0.1);
                const boxX = cx - boxW / 2;
                const boxY = cy - canvas.height * 0.13;
                ctx.fillStyle = '#161618';
                ctx.beginPath();
                ctx.roundRect(boxX, boxY, boxW, boxH, 12);
                ctx.fill();
                ctx.strokeStyle = inputActive ? '#4f8ef7' : '#4a5568';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // Input text
                ctx.fillStyle = '#f3f4f6';
                ctx.font = `bold ${Math.floor(boxH * 0.6)}px Arial`;
                ctx.textBaseline = 'middle';
                ctx.fillText(currentInput || '‚Äî', cx, boxY + boxH / 2);
                
                // Message
                ctx.fillStyle = gameWon ? '#10b981' : '#4f8ef7';
                ctx.font = `bold ${Math.floor(canvas.height * 0.05)}px Arial`;
                ctx.textBaseline = 'middle';
                ctx.fillText(message, cx, cy + canvas.height * 0.06);
                
                // Attempts counter
                ctx.fillStyle = '#d1d5db';
                ctx.font = `${Math.floor(canvas.height * 0.038)}px Arial`;
                ctx.fillText(`Tentatives: ${attempts}`, cx, cy + canvas.height * 0.16);
                
                if (!gameWon) {
                    ctx.fillStyle = '#6b7280';
                    ctx.font = `${Math.floor(canvas.height * 0.026)}px Arial`;
                    ctx.fillText('Tapez un nombre puis appuyez sur ENTR√âE', cx, cy + canvas.height * 0.26);
                } else {
                    ctx.fillStyle = '#10b981';
                    ctx.font = `bold ${Math.floor(canvas.height * 0.06)}px Arial`;
                    ctx.fillText('üéâ BRAVO! üéâ', cx, cy + canvas.height * 0.26);
                }
            }

            function handleKeyPress(e) {
                if (currentGame !== 'guess' || gameWon) return;
                if (e.key >= '0' && e.key <= '9') {
                    if (currentInput.length < 3) { currentInput += e.key; drawGame(); }
                } else if (e.key === 'Backspace') {
                    currentInput = currentInput.slice(0, -1); drawGame();
                } else if (e.key === 'Enter' && currentInput !== '') {
                    const guessNum = parseInt(currentInput);
                    if (isNaN(guessNum) || guessNum < 1 || guessNum > 100) {
                        message = '‚ùå Entre 1 et 100 seulement!'; currentInput = ''; drawGame(); return;
                    }
                    attempts++;
                    if (guessNum === targetNumber) {
                        message = `‚ú® Trouv√© en ${attempts} tentative${attempts > 1 ? 's' : ''}! ‚ú®`;
                        gameWon = true; inputActive = false;
                        document.getElementById('gameInfo').textContent = `üéâ Victoire en ${attempts} tentatives!`;
                    } else if (guessNum < targetNumber) {
                        message = '‚¨ÜÔ∏è C\'est plus haut!';
                    } else {
                        message = '‚¨áÔ∏è C\'est plus bas!';
                    }
                    currentInput = ''; drawGame();
                    document.getElementById('gameInfo').textContent = `Tentatives: ${attempts}`;
                }
            }

            document.addEventListener('keydown', handleKeyPress);
            
            const originalBackToMenu = window.backToGamesMenu;
            window.backToGamesMenu = function() {
                document.removeEventListener('keydown', handleKeyPress);
                window.backToGamesMenu = originalBackToMenu;
                originalBackToMenu();
            };

            drawGame();
            document.getElementById('gameInfo').textContent = 'Tapez un nombre et appuyez sur ENTR√âE';
        }

        // ===== INTRO CANVAS PARTICLES =====
        (function initIntro() {
            const canvas = document.getElementById('introCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            function resize() {
                canvas.width  = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            resize();
            window.addEventListener('resize', resize);

            // Particles
            const PARTICLE_COUNT = 120;
            const particles = [];

            function randBetween(a, b) { return a + Math.random() * (b - a); }

            for (let i = 0; i < PARTICLE_COUNT; i++) {
                particles.push({
                    x: Math.random() * window.innerWidth,
                    y: Math.random() * window.innerHeight,
                    r: randBetween(0.5, 2.2),
                    alpha: randBetween(0.1, 0.8),
                    speed: randBetween(0.1, 0.45),
                    drift: randBetween(-0.15, 0.15),
                    twinkleSpeed: randBetween(0.005, 0.025),
                    twinklePhase: Math.random() * Math.PI * 2,
                    color: Math.random() < 0.3
                        ? `rgba(126,179,255,`   // bleu
                        : Math.random() < 0.5
                            ? `rgba(129,140,248,` // violet
                            : `rgba(240,244,255,` // blanc
                });
            }

            // Shooting stars
            const shoots = [];
            function spawnShoot() {
                shoots.push({
                    x: randBetween(-200, window.innerWidth * 0.7),
                    y: randBetween(-50, window.innerHeight * 0.5),
                    len: randBetween(120, 280),
                    speed: randBetween(8, 18),
                    alpha: 0,
                    life: 0,
                    maxLife: randBetween(55, 90),
                    angle: Math.PI / 4 + randBetween(-0.2, 0.2),
                });
            }

            // Spawn shooting stars at random intervals
            let lastShoot = 0;
            let nextShootIn = randBetween(400, 900);

            let frame = 0;
            function animate() {
                requestAnimationFrame(animate);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                frame++;

                // Draw particles
                for (const p of particles) {
                    p.twinklePhase += p.twinkleSpeed;
                    const a = p.alpha * (0.5 + 0.5 * Math.sin(p.twinklePhase));
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                    ctx.fillStyle = p.color + a + ')';
                    ctx.fill();
                    p.y -= p.speed;
                    p.x += p.drift;
                    if (p.y < -5) { p.y = canvas.height + 5; p.x = Math.random() * canvas.width; }
                    if (p.x < -5) p.x = canvas.width + 5;
                    if (p.x > canvas.width + 5) p.x = -5;
                }

                // Spawn shooting stars
                if (frame - lastShoot > nextShootIn / 16.6) {
                    spawnShoot();
                    lastShoot = frame;
                    nextShootIn = randBetween(300, 900);
                }

                // Draw shooting stars
                for (let i = shoots.length - 1; i >= 0; i--) {
                    const s = shoots[i];
                    s.life++;
                    s.x += Math.cos(s.angle) * s.speed;
                    s.y += Math.sin(s.angle) * s.speed;

                    // Fade in then out
                    s.alpha = s.life < 10
                        ? s.life / 10
                        : s.life > s.maxLife - 15
                            ? (s.maxLife - s.life) / 15
                            : 1;

                    const tailX = s.x - Math.cos(s.angle) * s.len;
                    const tailY = s.y - Math.sin(s.angle) * s.len;

                    const grad = ctx.createLinearGradient(tailX, tailY, s.x, s.y);
                    grad.addColorStop(0, `rgba(79,142,247,0)`);
                    grad.addColorStop(0.6, `rgba(160,200,255,${s.alpha * 0.5})`);
                    grad.addColorStop(1, `rgba(255,255,255,${s.alpha})`);

                    ctx.beginPath();
                    ctx.moveTo(tailX, tailY);
                    ctx.lineTo(s.x, s.y);
                    ctx.strokeStyle = grad;
                    ctx.lineWidth = 1.5;
                    ctx.stroke();

                    // Head glow
                    ctx.beginPath();
                    ctx.arc(s.x, s.y, 2, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255,255,255,${s.alpha * 0.9})`;
                    ctx.fill();

                    if (s.life >= s.maxLife) shoots.splice(i, 1);
                }
            }

            animate();

            // Close intro after progress bar completes (~3.8s) + fade
            const INTRO_DURATION = 3800;
            const FADE_DURATION  = 900;

            setTimeout(() => {
                const intro = document.getElementById('intro');
                if (intro) {
                    intro.classList.add('hide');
                    setTimeout(() => { intro.style.display = 'none'; }, FADE_DURATION);
                }
            }, INTRO_DURATION);

            // Click to skip
            document.getElementById('intro').addEventListener('click', function() {
                this.classList.add('hide');
                setTimeout(() => { this.style.display = 'none'; }, FADE_DURATION);
            });
        })();

        // ===== CODEMIRROR INIT =====
        window._cmEditors = {};

        function getEditorValue(id) {
            if (window._cmEditors[id]) return window._cmEditors[id].getValue();
            const el = document.getElementById(id);
            return el ? el.value : '';
        }

        function setEditorValue(id, val) {
            if (window._cmEditors[id]) {
                window._cmEditors[id].setValue(val || '');
                window._cmEditors[id].clearHistory();
            } else {
                const el = document.getElementById(id);
                if (el) el.value = val || '';
            }
        }

        function initCodeMirror() {
            if (!window.CodeMirror) return;

            const savedTheme = localStorage.getItem('scrix-editor-theme') || 'dracula';

            const configs = [
                { id: 'htmlEditor',   mode: 'htmlmixed'  },
                { id: 'cssEditor',    mode: 'css'        },
                { id: 'jsEditor',     mode: 'javascript' },
                { id: 'pythonEditor', mode: 'python'     }
            ];

            configs.forEach(({ id, mode }) => {
                const textarea = document.getElementById(id);
                if (!textarea) return;

                const cm = CodeMirror.fromTextArea(textarea, {
                    mode: mode,
                    theme: savedTheme,
                    lineNumbers: true,
                    matchBrackets: true,
                    autoCloseBrackets: true,
                    autoCloseTags: true,
                    indentUnit: 2,
                    tabSize: 2,
                    indentWithTabs: false,
                    lineWrapping: false,
                    styleActiveLine: true,
                    foldGutter: true,
                    gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter', 'scrix-lint-gutter'],
                    extraKeys: {
                        'Tab': cm => cm.replaceSelection('  '),
                        'Ctrl-/': 'toggleComment',
                        'Ctrl-;': 'toggleComment',
                        'Ctrl-Z': 'undo',
                        'Ctrl-Y': 'redo',
                        'Ctrl-Space': cm => cm.showHint({ completeSingle: false }),
                        'Ctrl-S': () => runCode(),
                        'Ctrl-Q': cm => cm.foldCode(cm.getCursor()),
                        'Alt-F': () => { const tab = document.querySelector('.tab-btn.active'); if(tab) { const t = tab.textContent.includes('HTML')?'html':tab.textContent.includes('CSS')?'css':tab.textContent.includes('JS')?'js':'python'; formatCode(t); }},
                        'Alt-D': cm => { const cur = cm.getCursor(); const line = cm.getLine(cur.line); cm.replaceRange('\n'+line, {line:cur.line,ch:line.length}); },
                    }
                });

                cm.setSize('100%', '100%');

                // Autocompl√©tion automatique en tapant
                cm.on('inputRead', function(editor, change) {
                    if (change.text[0] && change.text[0].match(/[\w\.]/)) {
                        const hintMap = {
                            javascript: CodeMirror.hint.javascript,
                            css: CodeMirror.hint.css,
                            htmlmixed: CodeMirror.hint.html
                        };
                        if (hintMap[mode] && !editor.state.completionActive) {
                            editor.showHint({ hint: hintMap[mode], completeSingle: false });
                        }
                    }
                });

                cm.on('change', () => {
                    textarea.value = cm.getValue();
                    if (typeof autoSave === 'function') autoSave();
                });

                window._cmEditors[id] = cm;
            });
        }

        // Changer le th√®me de l'√©diteur
        function setEditorTheme(theme) {
            localStorage.setItem('scrix-editor-theme', theme);
            if (window._cmEditors) {
                Object.values(window._cmEditors).forEach(cm => cm && cm.setOption('theme', theme));
            }
            document.querySelectorAll('.editor-theme-btn').forEach(b => b.classList.remove('active'));
            const btn = document.querySelector('.editor-theme-btn[data-theme="' + theme + '"]');
            if (btn) btn.classList.add('active');
            showNotification('Th√®me ' + theme + ' appliqu√©', 'success');
        }

        // CodeMirror s'initialise via window.addEventListener('load') ci-dessus

        // ===========================
        // ‚ö° EXPORT ZIP
        // ===========================
        async function exportAsZip() {
            if (typeof JSZip === 'undefined') {
                showNotification('JSZip non charg√©', 'error');
                return;
            }
            const html = getEditorValue('htmlEditor');
            const css = getEditorValue('cssEditor');
            const js = getEditorValue('jsEditor');
            const rawName = document.querySelector('.project-name').value || 'scrix-project';
            // S√©curiser le nom de fichier
            const projectName = rawName.replace(/[<>:"/\\|?*]/g, '').trim() || 'scrix-project';

            const fullHTML = `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${projectName.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
${html}
<script src="script.js"><\/script></body>
</html>`;

            try {
                showNotification('Cr√©ation du ZIP...', 'info');
                const zip = new JSZip();
                zip.file('index.html', fullHTML);
                zip.file('style.css', css);
                zip.file('script.js', js);

                const blob = await zip.generateAsync({ type: 'blob' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = projectName.replace(/\s+/g, '-').toLowerCase() + '.zip';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
                showNotification('ZIP t√©l√©charg√©', 'success');
                closeExport();
            } catch(e) {
                console.error('Export ZIP error:', e);
                showNotification('‚ùå Erreur lors de la cr√©ation du ZIP : ' + e.message, 'error');
            }
        }

        // ===========================

        // ============================================================
        // üî¨ SCRIX PROFESSIONAL LINTER ENGINE v2.0
        // D√©tection ligne par ligne, multi-langage (JS, HTML, CSS, Python, Java)
        // ============================================================
        let _lintTimeout = null;
        const _lintTimers = {};

        // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function _stripStrings(line) {
            // Remove string content so we don't lint inside strings
            return line.replace(/"(?:[^"\\]|\\.)*"/g, '""')
                       .replace(/'(?:[^'\\]|\\.)*'/g, "''")
                       .replace(/`(?:[^`\\]|\\.)*`/g, '``');
        }

        function _isCommentLine(line, lang) {
            const t = line.trim();
            if (lang === 'js' || lang === 'java') return t.startsWith('//') || t.startsWith('*') || t.startsWith('/*');
            if (lang === 'python') return t.startsWith('#');
            if (lang === 'css') return t.startsWith('/*') || t.startsWith('*');
            if (lang === 'html') return t.startsWith('<!--');
            return false;
        }

        // ‚îÄ‚îÄ JAVASCRIPT LINTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function lintJS(code) {
            const issues = [];
            const lines = code.split('\n');
            let braceDepth = 0, parenDepth = 0, bracketDepth = 0;
            let inMultiComment = false;

            lines.forEach((rawLine, i) => {
                const ln = i + 1;
                const line = rawLine;
                const stripped = _stripStrings(rawLine);

                // Multi-line comment tracking
                if (stripped.includes('/*')) inMultiComment = true;
                if (stripped.includes('*/')) { inMultiComment = false; return; }
                if (inMultiComment) return;
                if (_isCommentLine(rawLine, 'js')) return;

                // Count brackets
                for (const ch of stripped) {
                    if (ch === '{') braceDepth++;
                    if (ch === '}') braceDepth--;
                    if (ch === '(') parenDepth++;
                    if (ch === ')') parenDepth--;
                    if (ch === '[') bracketDepth++;
                    if (ch === ']') bracketDepth--;
                }

                const t = stripped.trim();

                // ‚îÄ‚îÄ Erreurs syntaxiques ‚îÄ‚îÄ
                if (/\bif\s*\([^)]*\)\s*$/.test(t) && !t.endsWith('{') && !lines[i+1]?.trim().startsWith('{'))
                    issues.push({ line: ln, type: 'warning', msg: 'Corps de if sans accolade ‚Äî risque de bug', code: rawLine.trim() });

                if (/\bfor\s*\(/.test(t) && !/;\s*[^;]*;\s*/.test(t) && !t.includes('of') && !t.includes('in'))
                    issues.push({ line: ln, type: 'warning', msg: 'Boucle for ‚Äî structure inhabituelle (v√©rifier les ;)', code: rawLine.trim() });

                // == au lieu de ===
                if (/[^=!<>]={2}(?!=)[^=]/.test(t) && !/for\s*\(/.test(t))
                    issues.push({ line: ln, type: 'warning', msg: 'Utilise === au lieu de == (comparaison stricte)', code: rawLine.trim() });

                // != au lieu de !==
                if (/!={1}(?!=)/.test(t))
                    issues.push({ line: ln, type: 'warning', msg: 'Utilise !== au lieu de != (comparaison stricte)', code: rawLine.trim() });

                // var usage
                if (/^\s*var\s+/.test(rawLine))
                    issues.push({ line: ln, type: 'warning', msg: 'Utilise let ou const au lieu de var', code: rawLine.trim() });

                // undefined comparison
                if (/===\s*undefined|==\s*undefined/.test(t))
                    issues.push({ line: ln, type: 'warning', msg: 'Utilise typeof x === "undefined" pour v√©rifier undefined', code: rawLine.trim() });

                // Assignment in condition
                if (/if\s*\(\s*\w+\s*=[^=]/.test(t))
                    issues.push({ line: ln, type: 'error', msg: '= dans un if ‚Äî tu voulais == ou === ?', code: rawLine.trim() });

                // console.log en production
                if (/console\.log\s*\(/.test(t))
                    issues.push({ line: ln, type: 'info', msg: 'console.log() ‚Äî penser √† supprimer en production', code: rawLine.trim() });

                // return sans valeur dans fonction non-void
                // Unreachable code after return/break
                if (/^\s*(return|break|continue)\b/.test(rawLine)) {
                    const next = lines[i+1]?.trim();
                    if (next && next !== '}' && next !== '' && !next.startsWith('//') && !next.startsWith('case') && !next.startsWith('default'))
                        issues.push({ line: ln+1, type: 'error', msg: 'Code inaccessible ‚Äî instruction apr√®s return/break/continue', code: next });
                }

                // typeof check
                if (/typeof\s+\w+\s*==[^=]/.test(t))
                    issues.push({ line: ln, type: 'warning', msg: 'typeof devrait √™tre compar√© avec === (triple √©gal)', code: rawLine.trim() });

                // Potential null dereference
                if (/\bnull\s*\.\w+/.test(t) || /\.innerHTML\s*=\s*$/.test(t))
                    issues.push({ line: ln, type: 'warning', msg: 'Acc√®s potentiel sur null', code: rawLine.trim() });

                // parseInt sans base
                if (/parseInt\s*\(\s*[^,)]+\s*\)/.test(t))
                    issues.push({ line: ln, type: 'warning', msg: 'parseInt() sans base ‚Äî ajoute 10 : parseInt(x, 10)', code: rawLine.trim() });

                // eval usage
                if (/\beval\s*\(/.test(t))
                    issues.push({ line: ln, type: 'error', msg: 'eval() est dangereux et d√©conseill√©', code: rawLine.trim() });

                // document.write
                if (/document\.write\s*\(/.test(t))
                    issues.push({ line: ln, type: 'warning', msg: 'document.write() est obsol√®te', code: rawLine.trim() });

                // await sans try/catch : v√©rifier si la ligne await est dans un bloc try
                if (/\bawait\s+\w+/.test(t)) {
                    // Chercher un try dans les 20 lignes pr√©c√©dentes sans trouver de catch fermant avant
                    let inTry = false;
                    for (let back = i - 1; back >= Math.max(0, i - 20); back--) {
                        const bl = lines[back].trim();
                        if (/^\}\s*catch\b/.test(bl) || /^\}\s*finally\b/.test(bl)) { inTry = true; break; }
                        if (/\btry\s*\{/.test(bl)) { inTry = true; break; }
                    }
                    if (!inTry)
                        issues.push({ line: ln, type: 'warning', msg: 'await sans try/catch ‚Äî les erreurs r√©seau/async ne seront pas g√©r√©es', code: rawLine.trim() });
                }

                // Promise sans .catch()
                if (/\bfetch\s*\(/.test(t) && !t.includes('.catch') && !t.includes('await'))
                    issues.push({ line: ln, type: 'warning', msg: 'fetch() sans .catch() ‚Äî g√®re les erreurs r√©seau', code: rawLine.trim() });

                // Infinite while
                if (/while\s*\(\s*true\s*\)/.test(t) && !code.includes('break'))
                    issues.push({ line: ln, type: 'error', msg: 'Boucle infinie while(true) sans break d√©tect√©', code: rawLine.trim() });

                // Semicolons after }
                if (/^\s*\}\s*;/.test(rawLine) && !/function|class|=>/.test(lines[i-1] || ''))
                    issues.push({ line: ln, type: 'info', msg: '; apr√®s } inutile (sauf expression de fonction)', code: rawLine.trim() });
            });

            // Global bracket checks
            if (braceDepth > 0) issues.push({ line: null, type: 'error', msg: `${braceDepth} accolade${braceDepth>1?'s':''} { non ferm√©e${braceDepth>1?'s':''}`, code: '' });
            if (braceDepth < 0) issues.push({ line: null, type: 'error', msg: `${Math.abs(braceDepth)} accolade${Math.abs(braceDepth)>1?'s':''} } en trop`, code: '' });
            if (parenDepth !== 0) issues.push({ line: null, type: 'error', msg: `Parenth√®ses d√©s√©quilibr√©es (${parenDepth > 0 ? parenDepth + ' non ferm√©e' : Math.abs(parenDepth) + ' en trop'})`, code: '' });
            if (bracketDepth !== 0) issues.push({ line: null, type: 'error', msg: `Crochets d√©s√©quilibr√©s (${bracketDepth > 0 ? bracketDepth + ' non ferm√©' : Math.abs(bracketDepth) + ' en trop'})`, code: '' });

            return issues;
        }

        // ‚îÄ‚îÄ HTML LINTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function lintHTML(code) {
            const issues = [];
            const lines = code.split('\n');
            const stack = [];
            const voidTags = new Set(['area','base','br','col','embed','hr','img','input','link','meta','param','source','track','wbr']);

            lines.forEach((rawLine, i) => {
                const ln = i + 1;

                // Find all tags on this line
                const tagMatches = [...rawLine.matchAll(/<\/?([a-zA-Z][a-zA-Z0-9]*)[^>]*\/?>/g)];
                tagMatches.forEach(m => {
                    const full = m[0];
                    const tag = m[1].toLowerCase();
                    if (voidTags.has(tag)) return;
                    if (full.startsWith('</')) {
                        if (stack.length === 0)
                            issues.push({ line: ln, type: 'error', msg: `</${tag}> fermant sans balise ouvrante`, code: rawLine.trim() });
                        else if (stack[stack.length-1].tag !== tag)
                            issues.push({ line: ln, type: 'error', msg: `</${tag}> ferme <${stack[stack.length-1].tag}> (ligne ${stack[stack.length-1].line}) ‚Äî ordre incorrect`, code: rawLine.trim() });
                        else stack.pop();
                    } else if (!full.endsWith('/>')) {
                        stack.push({ tag, line: ln });
                    }
                });

                // Missing alt on img
                if (/<img\b[^>]*>/i.test(rawLine) && !/\balt\s*=/i.test(rawLine))
                    issues.push({ line: ln, type: 'warning', msg: '<img> sans attribut alt ‚Äî mauvais pour l\'accessibilit√©', code: rawLine.trim() });

                // Inline styles
                if (/style\s*=\s*"/i.test(rawLine))
                    issues.push({ line: ln, type: 'info', msg: 'Style inline d√©tect√© ‚Äî pr√©f√®re une classe CSS', code: rawLine.trim() });

                // Deprecated tags
                const deprecated = ['center','font','marquee','blink','strike','u','s','tt','frame','frameset'];
                deprecated.forEach(tag => {
                    if (new RegExp(`<${tag}[\\s>]`, 'i').test(rawLine))
                        issues.push({ line: ln, type: 'warning', msg: `<${tag}> est une balise obsol√®te`, code: rawLine.trim() });
                });

                // onclick in HTML (event best practice)
                if (/\bon\w+\s*=\s*"/i.test(rawLine) && !/href|src|alt|title/.test(rawLine.toLowerCase()))
                    issues.push({ line: ln, type: 'info', msg: 'Handler inline ‚Äî pr√©f√®re addEventListener() en JS', code: rawLine.trim() });

                // Missing doctype ‚Äî ignorer si c'est un commentaire ou ligne vide
                if (ln === 1 && !/<!DOCTYPE/i.test(rawLine) && rawLine.trim() !== '' && !/^\s*<!--/.test(rawLine))
                    issues.push({ line: 1, type: 'warning', msg: 'Pas de <!DOCTYPE html> en premi√®re ligne', code: rawLine.trim() });
            });

            // Unclosed tags
            stack.forEach(({ tag, line: openLine }) => {
                issues.push({ line: openLine, type: 'error', msg: `<${tag}> non ferm√© (ouvert ligne ${openLine})`, code: '' });
            });

            return issues;
        }

        // ‚îÄ‚îÄ CSS LINTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function lintCSS(code) {
            const issues = [];
            const lines = code.split('\n');
            let braceDepth = 0;
            let inComment = false;

            lines.forEach((rawLine, i) => {
                const ln = i + 1;
                const t = rawLine.trim();

                if (t.includes('/*')) inComment = true;
                if (t.includes('*/')) { inComment = false; return; }
                if (inComment || t.startsWith('//')) return;

                if (t.includes('{')) braceDepth++;
                if (t.includes('}')) braceDepth--;

                // Missing semicolon in property
                if (/^\s*[\w-]+\s*:\s*.+[^;{}\s]$/.test(rawLine) && !t.endsWith('{') && !t.endsWith('}') && !t.endsWith(','))
                    issues.push({ line: ln, type: 'error', msg: 'Point-virgule manquant √† la fin de la propri√©t√©', code: t });

                // Unknown property (common typos)
                const typos = { 'colour': 'color', 'boarder': 'border', 'marggin': 'margin', 'paddin': 'padding', 'backgroud': 'background', 'fontt': 'font', 'wdith': 'width', 'heigth': 'height' };
                Object.entries(typos).forEach(([wrong, right]) => {
                    if (t.startsWith(wrong + ':') || t.startsWith(wrong + ' :'))
                        issues.push({ line: ln, type: 'error', msg: `Typo CSS : "${wrong}" ‚Üí utilise "${right}"`, code: t });
                });

                // Vendor prefix without standard
                if (/^-webkit-|^-moz-|^-ms-|^-o-/.test(t)) {
                    const prop = t.replace(/^-\w+-/, '');
                    if (code.includes('-webkit-' + prop) && !code.includes(prop.split(':')[0].trim() + ':'))
                        issues.push({ line: ln, type: 'info', msg: 'Pr√©fixe vendor sans propri√©t√© standard correspondante', code: t });
                }

                // !important overuse
                if (/!important/.test(t))
                    issues.push({ line: ln, type: 'warning', msg: '!important d√©tect√© ‚Äî √©viter autant que possible', code: t });

                // Zero without unit (not for flex/opacity/z-index)
                if (/:\s*0[a-zA-Z]+/.test(t) && !/opacity|z-index|flex|order|transform/.test(t))
                    issues.push({ line: ln, type: 'info', msg: 'Valeur 0 avec unit√© ‚Äî 0 n\'a pas besoin d\'unit√© (ex: 0px ‚Üí 0)', code: t });

                // Empty rule
                if (/\{\s*\}/.test(t))
                    issues.push({ line: ln, type: 'warning', msg: 'R√®gle CSS vide', code: t });
            });

            if (braceDepth > 0) issues.push({ line: null, type: 'error', msg: `${braceDepth} accolade${braceDepth>1?'s':''} { non ferm√©e${braceDepth>1?'s':''}`, code: '' });
            if (braceDepth < 0) issues.push({ line: null, type: 'error', msg: `${Math.abs(braceDepth)} accolade${Math.abs(braceDepth)>1?'s':''} } en trop`, code: '' });

            return issues;
        }

        // ‚îÄ‚îÄ PYTHON LINTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function lintPython(code) {
            const issues = [];
            const lines = code.split('\n');

            lines.forEach((rawLine, i) => {
                const ln = i + 1;
                if (_isCommentLine(rawLine, 'python')) return;
                const t = rawLine.trim();

                // Indentation (tabs vs spaces)
                if (/^\t/.test(rawLine) && code.includes('    '))
                    issues.push({ line: ln, type: 'warning', msg: 'M√©lange tabs/espaces ‚Äî utilise 4 espaces (PEP8)', code: t });

                // == True/False au lieu de is
                if (/==\s*True|==\s*False/.test(t))
                    issues.push({ line: ln, type: 'warning', msg: 'Utilise "is True" / "is False" plut√¥t que == True/False (PEP8)', code: t });

                // Comparison with None
                if (/==\s*None|!=\s*None/.test(t))
                    issues.push({ line: ln, type: 'warning', msg: 'Utilise "is None" / "is not None" plut√¥t que == None (PEP8)', code: t });

                // Bare except
                if (/^\s*except\s*:/.test(rawLine))
                    issues.push({ line: ln, type: 'warning', msg: 'except: sans type ‚Äî capture toutes les exceptions (risqu√©)', code: t });

                // print sans parenth√®ses (Python 2 style)
                if (/^\s*print\s+[^(]/.test(rawLine))
                    issues.push({ line: ln, type: 'error', msg: 'print sans parenth√®ses ‚Äî syntaxe Python 2, utilise print()', code: t });

                // Division enti√®re non intentionnelle
                if (/\/\//.test(t) && !/^\s*#/.test(rawLine))
                    issues.push({ line: ln, type: 'info', msg: '// = division enti√®re en Python (diff√©rent de JS)', code: t });

                // Mutable default argument
                if (/def\s+\w+\s*\([^)]*=\s*[\[\{]/.test(t))
                    issues.push({ line: ln, type: 'error', msg: 'Argument par d√©faut mutable (list/dict) ‚Äî bug classique Python', code: t });

                // Import * (wildcard)
                if (/^from\s+\S+\s+import\s+\*/.test(t))
                    issues.push({ line: ln, type: 'warning', msg: 'import * d√©conseill√© ‚Äî importe explicitement ce dont tu as besoin', code: t });

                // Variable non assign√©e probable
                if (/^\s*\w+\s*\+\+/.test(rawLine) || /^\s*\w+\s*--/.test(rawLine))
                    issues.push({ line: ln, type: 'error', msg: '++ / -- n\'existe pas en Python, utilise += 1 ou -= 1', code: t });

                // l comme nom de variable (confus avec 1)
                if (/^\s*(l|I|O)\s*=/.test(rawLine))
                    issues.push({ line: ln, type: 'warning', msg: `Variable "${t.split('=')[0].trim()}" ‚Äî nom ambigu (confus avec 1, l, 0)`, code: t });

                // Long line
                if (rawLine.length > 120)
                    issues.push({ line: ln, type: 'info', msg: `Ligne trop longue (${rawLine.length} chars) ‚Äî max recommand√© : 79 (PEP8)`, code: t.slice(0, 60) + '‚Ä¶' });

                // Op√©rateur == au lieu de is pour True/False/None (doublons intentionnels √©vit√©s ci-dessus)

                // await hors async def
                if (/\bawait\b/.test(t)) {
                    let inAsync = false;
                    for (let back = i - 1; back >= 0; back--) {
                        const bl = lines[back].trim();
                        if (/^async\s+def\b/.test(bl)) { inAsync = true; break; }
                        if (/^def\b/.test(bl)) break;
                        if (/^class\b/.test(bl)) break;
                    }
                    if (!inAsync)
                        issues.push({ line: ln, type: 'error', msg: 'await utilis√© hors d\'une fonction async def', code: t });
                }

                // def sans corps indent√© (ligne suivante vide ou m√™me niveau)
                if (/^def\s+\w+\s*\(/.test(t) || /^async\s+def\s+\w+\s*\(/.test(t)) {
                    const nextLine = lines[i + 1];
                    if (nextLine !== undefined) {
                        const nextT = nextLine.trim();
                        const currentIndent = rawLine.search(/\S/);
                        const nextIndent = nextLine.search(/\S/);
                        if (nextT !== '' && !nextT.startsWith('#') && nextIndent <= currentIndent && !nextT.startsWith('def') && !nextT.startsWith('class'))
                            issues.push({ line: ln + 1, type: 'error', msg: 'Corps de fonction non indent√© ‚Äî IndentationError probable', code: nextT });
                    }
                }

                // String f-string mal form√©e (accolade non ferm√©e)
                if (/^f['"]/.test(t) || /[^\\]f['"]/.test(t)) {
                    const opens = (t.match(/\{/g) || []).length;
                    const closes = (t.match(/\}/g) || []).length;
                    if (opens !== closes)
                        issues.push({ line: ln, type: 'error', msg: 'f-string : accolades d√©s√©quilibr√©es', code: t });
                }

                // Division par z√©ro litt√©rale
                if (/\/\s*0\b/.test(t) && !/\/\/\s*0/.test(t))
                    issues.push({ line: ln, type: 'error', msg: 'Division par z√©ro d√©tect√©e', code: t });

                // range() avec step 0
                if (/\brange\s*\([^)]*,\s*0\s*\)/.test(t))
                    issues.push({ line: ln, type: 'error', msg: 'range() avec step=0 ‚Üí ValueError √† l\'ex√©cution', code: t });

            });

            // V√©rification globale : indentation coh√©rente (tabs ou espaces, pas les deux)
            const hasTabIndent = lines.some(l => /^\t/.test(l));
            const hasSpaceIndent = lines.some(l => /^ {1,}/.test(l));
            if (hasTabIndent && hasSpaceIndent)
                issues.push({ line: null, type: 'error', msg: 'M√©lange tabs et espaces dans tout le fichier ‚Äî TabError Python', code: '' });

            return issues;
        }

        // ‚îÄ‚îÄ JAVA LINTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function lintJava(code) {
            const issues = [];
            const lines = code.split('\n');
            let braceDepth = 0;
            let inMultiComment = false;

            lines.forEach((rawLine, i) => {
                const ln = i + 1;
                const stripped = _stripStrings(rawLine);

                if (stripped.includes('/*')) inMultiComment = true;
                if (stripped.includes('*/')) { inMultiComment = false; return; }
                if (inMultiComment) return;
                if (_isCommentLine(rawLine, 'java')) return;

                const t = stripped.trim();

                for (const ch of stripped) {
                    if (ch === '{') braceDepth++;
                    if (ch === '}') braceDepth--;
                }

                // Semicolons manquants
                const needsSemi = /^(return|throw|break|continue|import|package)\b/.test(t) ||
                    (/[^{};]\s*$/.test(t) && !t.endsWith('{') && !t.endsWith('}') && !t.endsWith('(') && !t.endsWith(',') && !t.endsWith('//') && t.length > 3 && !t.startsWith('//') && !t.startsWith('@') && !t.startsWith('*') && /^\w/.test(t) && !t.endsWith(')'));

                if (needsSemi && t.includes('=') && !t.endsWith(';') && !t.endsWith('{'))
                    issues.push({ line: ln, type: 'error', msg: 'Point-virgule ; manquant en fin de ligne', code: rawLine.trim() });

                // = au lieu de == dans if
                if (/if\s*\([^)]*[^=!<>]=[^=]/.test(t))
                    issues.push({ line: ln, type: 'error', msg: '= dans un if ‚Äî tu voulais == ?', code: rawLine.trim() });

                // Mauvais type : int = String
                if (/\bint\s+\w+\s*=\s*"/.test(t))
                    issues.push({ line: ln, type: 'error', msg: 'Type int ne peut pas recevoir une String', code: rawLine.trim() });

                if (/\bboolean\s+\w+\s*=\s*"/.test(t))
                    issues.push({ line: ln, type: 'error', msg: 'Type boolean ne peut pas recevoir une String (utilise true/false)', code: rawLine.trim() });

                if (/\bchar\s+\w+\s*=\s*"/.test(t))
                    issues.push({ line: ln, type: 'error', msg: 'char utilise des apostrophes simples \'\' et non des guillemets ""', code: rawLine.trim() });

                if (/\bString\s+\w+\s*=\s+input\.nextInt\(\)/.test(t) || /\bString\s+\w+\s*=\s+\w+\.nextInt\(\)/.test(t))
                    issues.push({ line: ln, type: 'error', msg: 'nextInt() retourne un int, pas une String ‚Äî utilise nextLine()', code: rawLine.trim() });

                // Acc√®s tableau hors limites ‚Äî cherche le tableau d√©clar√© sur la M√äME ligne ou les lignes pr√©c√©dentes proches
                const _arrWrite = t.match(/\[(\d+)\]\s*=/);
                if (_arrWrite) {
                    const _writeIdx = parseInt(_arrWrite[1]);
                    // Find the most recent array declaration before this line
                    let _arrSize = null;
                    for (let k = i - 1; k >= Math.max(0, i - 20); k--) {
                        const _m = lines[k].match(/new\s+\w+\[(\d+)\]/);
                        if (_m) { _arrSize = parseInt(_m[1]); break; }
                    }
                    if (_arrSize !== null && _writeIdx >= _arrSize)
                        issues.push({ line: ln, type: 'error', msg: `ArrayIndexOutOfBoundsException : indice [${_writeIdx}] hors du tableau de taille ${_arrSize}`, code: rawLine.trim() });
                }

                // NullPointerException probable
                if (/\bnull\s*\.\w+/.test(t))
                    issues.push({ line: ln, type: 'error', msg: 'NullPointerException : appel de m√©thode sur null', code: rawLine.trim() });

                if (/\w+\s*=\s*null\s*;/.test(t)) {
                    const varName = t.match(/(\w+)\s*=/)?.[1];
                    const laterUse = lines.slice(i+1).findIndex(l => new RegExp(`\\b${varName}\\s*\\.`).test(l));
                    if (laterUse !== -1)
                        issues.push({ line: ln + laterUse + 1, type: 'warning', msg: `NullPointerException potentiel : "${varName}" initialis√© √† null et utilis√© plus bas`, code: lines[i + laterUse + 1]?.trim() || '' });
                }

                // Division par z√©ro
                if (/\/\s*0\b/.test(t) && !/\/\//.test(t.replace(/\/\s*0/, '')))
                    issues.push({ line: ln, type: 'error', msg: 'Division par z√©ro ‚Äî ArithmeticException', code: rawLine.trim() });

                // Import manquant (*)
                if (/import\s+\w+\.\*\s*$/.test(t) && !t.endsWith(';'))
                    issues.push({ line: ln, type: 'error', msg: 'Point-virgule manquant apr√®s import', code: rawLine.trim() });

                if (/import\s+java\.\w+\*/.test(t) && !t.endsWith(';'))
                    issues.push({ line: ln, type: 'error', msg: 'Point-virgule manquant apr√®s import', code: rawLine.trim() });

                // Boucle infinie
                if (/for\s*\(\s*int\s+\w+\s*=\s*\d+\s*;\s*\w+\s*>=\s*0\s*;\s*\w+\s*\+\+\s*\)/.test(t))
                    issues.push({ line: ln, type: 'error', msg: 'Boucle infinie : i >= 0 avec i++ ne se termine jamais', code: rawLine.trim() });

                // Scanner non ferm√©
                if (/new Scanner\(System\.in\)/.test(t) && !code.includes('.close()'))
                    issues.push({ line: ln, type: 'warning', msg: 'Scanner ouvert sans .close() ‚Äî risque de fuite m√©moire', code: rawLine.trim() });

                // unreachable code after break
                if (/^\s*break\s*;/.test(rawLine)) {
                    const next = lines[i+1]?.trim();
                    if (next && !next.startsWith('case') && !next.startsWith('default') && !next.startsWith('}') && next !== '')
                        issues.push({ line: ln+1, type: 'error', msg: 'Code inaccessible apr√®s break', code: next });
                }

                // Switch avec String (Java < 7 issue) - just info
                if (/switch\s*\(\s*\w+\s*\)/.test(t)) {
                    const switchVar = t.match(/switch\s*\(\s*(\w+)\s*\)/)?.[1];
                    if (switchVar) {
                        const declLine = lines.find(l => new RegExp(`String\\s+${switchVar}\\b`).test(l));
                        if (declLine) {
                            // Check if case has wrong type
                            const caseLines = lines.slice(i+1);
                            caseLines.forEach((cl, ci) => {
                                if (/case\s+"/.test(cl) && !/String/.test(declLine))
                                    issues.push({ line: ln+ci+1, type: 'error', msg: 'case avec String mais switch sur int ‚Äî types incompatibles', code: cl.trim() });
                            });
                        }
                    }
                }

                // File/Scanner sans throws ou try-catch
                if (/new Scanner\s*\(\s*new File/.test(t) && !code.includes('throws') && !code.includes('try'))
                    issues.push({ line: ln, type: 'error', msg: 'FileNotFoundException non g√©r√©e ‚Äî ajoute throws ou try-catch', code: rawLine.trim() });

                // continue apr√®s break (inaccessible)
                if (/^\s*continue\s*;/.test(rawLine)) {
                    const prev = lines[i-1]?.trim();
                    if (prev && /break\s*;/.test(prev))
                        issues.push({ line: ln, type: 'error', msg: 'continue inaccessible apr√®s break', code: rawLine.trim() });
                }
            });

            if (braceDepth > 0) issues.push({ line: null, type: 'error', msg: `${braceDepth} accolade${braceDepth>1?'s':''} { non ferm√©e${braceDepth>1?'s':''}`, code: '' });
            if (braceDepth < 0) issues.push({ line: null, type: 'error', msg: `${Math.abs(braceDepth)} accolade${Math.abs(braceDepth)>1?'s':''} } en trop`, code: '' });

            return issues;
        }

        // ‚îÄ‚îÄ D√âTECTION DE LANGAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function detectLanguage(code, editorLang) {
            // If explicitly Java
            if (/\bpublic\s+class\b/.test(code) && /\bSystem\.out\.print/.test(code)) return 'java';
            if (/\bimport\s+java\./.test(code)) return 'java';
            if (/\bpublic\s+static\s+void\s+main\b/.test(code)) return 'java';
            return editorLang;
        }

        // ‚îÄ‚îÄ ROUTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function lintCode(editorLang, code) {
            const lang = detectLanguage(code, editorLang);
            try {
                if (lang === 'js' || lang === 'javascript') return lintJS(code);
                if (lang === 'html') return lintHTML(code);
                if (lang === 'css') return lintCSS(code);
                if (lang === 'python') return lintPython(code);
                if (lang === 'java') return lintJava(code);
            } catch(e) { return []; }
            return [];
        }

        // ‚îÄ‚îÄ UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showLinterResults(lang, issues) {
            const statsEl = document.getElementById('codeStats_' + lang);
            if (!statsEl) return;

            const errCount  = issues.filter(e => e.type === 'error').length;
            const warnCount = issues.filter(e => e.type === 'warning').length;
            const infoCount = issues.filter(e => e.type === 'info').length;
            const lineCount = countLines(lang);
            const charCount = countChars(lang);

            // --- Status bar ---
            let html = `<span class="code-stat"><span class="code-stat-dot" style="background:#34d399"></span>${lineCount} ligne${lineCount>1?'s':''}</span>`;
            html += `<span class="code-stat"><span class="code-stat-dot" style="background:#60a5fa"></span>${charCount} chars</span>`;
            if (errCount > 0)
                html += `<span class="code-stat stat-err" onclick="toggleLinterPanel('${lang}')">‚úñ ${errCount} erreur${errCount>1?'s':''}</span>`;
            if (warnCount > 0)
                html += `<span class="code-stat stat-warn" onclick="toggleLinterPanel('${lang}')">‚ö† ${warnCount} warning${warnCount>1?'s':''}</span>`;
            if (infoCount > 0)
                html += `<span class="code-stat stat-info" onclick="toggleLinterPanel('${lang}')">‚Ñπ ${infoCount}</span>`;
            if (errCount === 0 && warnCount === 0 && infoCount === 0)
                html += `<span class="code-stat stat-ok">‚úì Aucun probl√®me</span>`;

            // Language badge
            const _idMapL = { html: 'htmlEditor', css: 'cssEditor', js: 'jsEditor', python: 'pythonEditor' };
            const _detLang = detectLanguage(getEditorValue(_idMapL[lang] || lang), lang);
            if (_detLang === 'java') html += `<span class="code-stat stat-lang">‚òï Java</span>`;

            statsEl.innerHTML = html;

            // --- Panel ---
            const panel = document.getElementById('linterPanel_' + lang);
            if (!panel) return;

            if (issues.length === 0) {
                panel.classList.remove('has-errors', 'open');
                panel.innerHTML = '';
                // Nettoyer les markers CodeMirror (points + soulignements)
                const _idMap0 = { html: 'htmlEditor', css: 'cssEditor', js: 'jsEditor', python: 'pythonEditor' };
                const _cm0 = window._cmEditors?.[_idMap0[lang]];
                if (_cm0 && _cm0._scrixLintMarkers) {
                    _cm0._scrixLintMarkers.forEach(fn => { try { fn(); } catch(ex){} });
                    _cm0._scrixLintMarkers = [];
                }
                // Mettre √† jour quand m√™me le badge de langage (ex: ‚òï Java)
                const _detLang0 = detectLanguage(getEditorValue(_idMap0[lang] || lang), lang);
                if (_detLang0 === 'java') statsEl.innerHTML += `<span class="code-stat stat-lang">‚òï Java</span>`;
                return;
            }

            const _sIcon = t => t==='error'?'‚úñ':t==='warning'?'‚ö†':'‚Ñπ';
            // Ne pas ouvrir automatiquement ‚Äî s'ouvre seulement au clic sur les badges
            panel.innerHTML =
                `<div class="linter-header">
                    <span class="linter-header-label">üî¨ ${issues.length} probl√®me${issues.length>1?'s':''}</span>
                    <button class="linter-header-close" onclick="toggleLinterPanel('${lang}')">‚úï Fermer</button>
                </div>` +
                issues.map(e =>
                    `<div class="linter-issue is-${e.type}">
                        <span class="linter-issue-line">${e.line?'L.'+e.line:'‚Äî'}</span>
                        <span class="linter-issue-icon">${_sIcon(e.type)}</span>
                        <span class="linter-issue-msg">${e.msg}</span>
                        ${e.code?`<span class="linter-issue-snippet">${e.code.replace(/</g,'&lt;').replace(/>/g,'&gt;').slice(0,50)}${e.code.length>50?'‚Ä¶':''}</span>`:''}
                    </div>`
                ).join('');

            // Gutter markers ‚Äî deduplicated per line
            const _idMap2 = { html: 'htmlEditor', css: 'cssEditor', js: 'jsEditor', python: 'pythonEditor' };
            const cm = window._cmEditors?.[_idMap2[lang]];
            if (cm) {
                if (!cm._scrixLintMarkers) cm._scrixLintMarkers = [];
                cm._scrixLintMarkers.forEach(fn => { try { fn(); } catch(ex){} });
                cm._scrixLintMarkers = [];
                const byLine = {};
                issues.forEach(e => {
                    if (!e.line) return;
                    if (!byLine[e.line] || e.type === 'error') byLine[e.line] = e;
                });
                Object.values(byLine).forEach(e => {
                    const lineNum = e.line - 1;
                    if (lineNum < 0 || lineNum >= cm.lineCount()) return;
                    const color = e.type==='error'?'#f87171':e.type==='warning'?'#fbbf24':'#60a5fa';
                    const dot = document.createElement('div');
                    dot.style.cssText = `width:7px;height:7px;border-radius:50%;background:${color};margin:6px 3px;box-shadow:0 0 6px ${color};cursor:pointer;`;
                    dot.title = e.msg;
                    cm.setGutterMarker(lineNum, 'scrix-lint-gutter', dot);
                    cm._scrixLintMarkers.push(() => { try { cm.setGutterMarker(lineNum, 'scrix-lint-gutter', null); } catch(ex){} });
                    // Soulignement de la ligne
                    const cls = e.type==='error' ? 'scrix-underline-error' : e.type==='warning' ? 'scrix-underline-warning' : 'scrix-underline-info';
                    cm.addLineClass(lineNum, 'text', cls);
                    cm._scrixLintMarkers.push(() => { try { cm.removeLineClass(lineNum, 'text', cls); } catch(ex){} });
                });
            }
        }

        function toggleLinterPanel(lang) {
            const panel = document.getElementById('linterPanel_' + lang);
            if (!panel) return;
            // S'ouvre seulement au clic, jamais automatiquement
            if (panel.innerHTML.trim()) {
                panel.classList.toggle('open');
            }
        }

        function countLines(lang) {
            const idMap = { html: 'htmlEditor', css: 'cssEditor', js: 'jsEditor', python: 'pythonEditor' };
            const val = getEditorValue(idMap[lang] || lang);
            return (val.match(/\n/g) || []).length + 1;
        }
        function countChars(lang) {
            const idMap = { html: 'htmlEditor', css: 'cssEditor', js: 'jsEditor', python: 'pythonEditor' };
            return getEditorValue(idMap[lang] || lang).length;
        }

        function runLintForLang(lang) {
            clearTimeout(_lintTimers[lang]);
            _lintTimers[lang] = setTimeout(() => {
                const idMap = { html: 'htmlEditor', css: 'cssEditor', js: 'jsEditor', python: 'pythonEditor' };
                const code = getEditorValue(idMap[lang]);
                const issues = lintCode(lang, code);
                showLinterResults(lang, issues);
            }, 1000);
        }

        function setupLinter() {
            const idMap = { html: 'htmlEditor', css: 'cssEditor', js: 'jsEditor', python: 'pythonEditor' };
            ['html','css','js','python'].forEach(lang => {
                const cmId = idMap[lang];
                if (window._cmEditors?.[cmId]) {
                    window._cmEditors[cmId].on('change', () => {
                        runLintForLang(lang);
                        updateUndoRedoBtns(lang, window._cmEditors[cmId]);
                    });
                }
                // Initial lint
                const code = getEditorValue(cmId);
                const issues = lintCode(lang, code);
                showLinterResults(lang, issues);
            });
        }

        // Call setupLinter after CodeMirror inits
        window.addEventListener('load', () => {
            setTimeout(() => { setupLinter(); }, 600);

            // ‚úÖ PWA : Enregistrement Service Worker inline (cache les assets pour le mode hors-ligne)
            if ('serviceWorker' in navigator) {
                const swCode = `
const CACHE = 'scrix-v1';
const OFFLINE_ASSETS = [
    'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css',
    'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css',
    'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js',
    'https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt.min.js',
    'https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt-stdlib.js'
];
self.addEventListener('install', e => {
    e.waitUntil(caches.open(CACHE).then(c => c.addAll(OFFLINE_ASSETS).catch(() => {})));
    self.skipWaiting();
});
self.addEventListener('activate', e => {
    e.waitUntil(caches.keys().then(keys => Promise.all(keys.filter(k => k !== CACHE).map(k => caches.delete(k)))));
    self.clients.claim();
});
self.addEventListener('fetch', e => {
    if (e.request.method !== 'GET') return;
    e.respondWith(caches.match(e.request).then(cached => cached || fetch(e.request).then(res => {
        if (res && res.status === 200 && res.type === 'basic') {
            const clone = res.clone();
            caches.open(CACHE).then(c => c.put(e.request, clone));
        }
        return res;
    }).catch(() => cached)));
});`;
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                navigator.serviceWorker.register(swUrl, { scope: '/' })
                    .then(() => console.log('[SCRIX] Service Worker enregistr√© (mode hors-ligne actif)'))
                    .catch(() => { /* SW non disponible en contexte blob/iframe, normal */ });
            }
        });

        // ‚úÖ Gestionnaire global des Promises rejet√©es sans .catch()
        window.addEventListener('unhandledrejection', (e) => {
            const msg = e.reason?.message || String(e.reason) || 'Erreur inconnue';
            // Ignorer les erreurs Firebase r√©seau (normales hors-ligne)
            if (msg.includes('network') || msg.includes('offline') || msg.includes('Failed to fetch')) return;
            console.error('[SCRIX] Promise non g√©r√©e:', msg);
        });

        // ‚úÖ Gestionnaire global des erreurs JS non catch√©es
        window.onerror = function(message, source, lineno, colno, error) {
            // Ne pas polluer la console utilisateur avec des erreurs internes
            console.error('[SCRIX] Erreur globale:', message, 'L.' + lineno);
            return false; // laisser le comportement par d√©faut
        };

        // ‚úÖ Avertissement si fermeture avec code non sauvegard√©
        window._lastSavedCode = null;
        function _getCurrentCodeSnapshot() {
            return (getEditorValue('htmlEditor') || '') +
                   (getEditorValue('cssEditor') || '') +
                   (getEditorValue('jsEditor') || '') +
                   (getEditorValue('pythonEditor') || '');
        }
        // Marquer comme sauvegard√© apr√®s une vraie sauvegarde
        const _origSaveProject = window.saveCurrentProject;
        window.addEventListener('load', () => {
            setTimeout(() => { window._lastSavedCode = _getCurrentCodeSnapshot(); }, 1000);
        });
        window.addEventListener('beforeunload', (e) => {
            const current = _getCurrentCodeSnapshot();
            const isEmpty = current.trim().length < 10;
            if (isEmpty) return;
            if (window._lastSavedCode !== null && current === window._lastSavedCode) return;
            // Code modifi√© et non sauvegard√© ‚Üí avertir
            e.preventDefault();
            e.returnValue = 'Tu as du code non sauvegard√©. Veux-tu vraiment quitter ?';
        });

        // ===========================
        // ‚å®Ô∏è GLOBAL KEYBOARD SHORTCUTS
        // ===========================
        document.addEventListener('keydown', (e) => {
            // Ctrl+I ‚Üí AI
            
            // Ctrl+E ‚Üí Export
            if (e.ctrlKey && e.key === 'e') { e.preventDefault(); openExport(); return; }
            // Alt+1-4 ‚Üí Switch tabs
            if (e.altKey && e.key === '1') { e.preventDefault(); switchTab('html'); return; }
            if (e.altKey && e.key === '2') { e.preventDefault(); switchTab('css'); return; }
            if (e.altKey && e.key === '3') { e.preventDefault(); switchTab('js'); return; }
            if (e.altKey && e.key === '4') { e.preventDefault(); switchTab('python'); return; }
            // Ctrl+` ‚Üí Toggle console
            if (e.ctrlKey && e.key === '`') { e.preventDefault(); toggleConsole(); return; }
        });

    </script>

    <!-- ===== MODAL LOGIN UIVERSE FONCTIONNEL ===== -->
    <div class="login-modal-overlay" id="loginModalOverlay" onclick="closeLoginModal(event)" role="dialog" aria-modal="true" aria-labelledby="headingLogin">
        <div class="card">
            <div class="card2">
                <!-- VUE LOGIN -->
                <form class="form" id="formLogin" onsubmit="return false;">
                    <p id="headingLogin">Login</p>
                    <div class="field">
                        <svg viewBox="0 0 16 16" fill="currentColor" height="16" width="16" class="input-icon"><path d="M13.106 7.222c0-2.967-2.249-5.032-5.482-5.032-3.35 0-5.646 2.318-5.646 5.702 0 3.493 2.235 5.708 5.762 5.708.862 0 1.689-.123 2.304-.335v-.862c-.43.199-1.354.328-2.29.328-2.926 0-4.813-1.88-4.813-4.798 0-2.844 1.921-4.881 4.594-4.881 2.735 0 4.608 1.688 4.608 4.156 0 1.682-.554 2.769-1.416 2.769-.492 0-.772-.28-.772-.76V5.206H8.923v.834h-.11c-.266-.595-.881-.964-1.6-.964-1.4 0-2.378 1.162-2.378 2.823 0 1.737.957 2.906 2.379 2.906.8 0 1.415-.39 1.709-1.087h.11c.081.67.703 1.148 1.503 1.148 1.572 0 2.57-1.415 2.57-3.643zm-7.177.704c0-1.197.54-1.907 1.456-1.907.93 0 1.524.738 1.524 1.907S8.308 9.84 7.371 9.84c-.895 0-1.442-.725-1.442-1.914z"></path></svg>
                        <input type="email" class="input-field" id="loginEmail" placeholder="Email" autocomplete="off" />
                    </div>
                    <div class="field">
                        <svg viewBox="0 0 16 16" fill="currentColor" height="16" width="16" class="input-icon"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"></path></svg>
                        <input type="password" class="input-field" id="loginPassword" placeholder="Password" />
                    </div>
                    <div id="loginError" style="color:#ff4444;font-size:12px;text-align:center;min-height:16px;"></div>
                    <div class="btn">
                        <button class="button1" onclick="doEmailLogin()">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Login&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</button>
                        <button class="button2" onclick="switchToSignUp()">Sign Up</button>
                    </div>
                    <div style="text-align:center;color:#666;font-size:11px;margin-top:8px;">‚Äî ou ‚Äî</div>
                    <button type="button" class="button1" style="width:100%;display:flex;align-items:center;justify-content:center;gap:8px;margin-top:4px;" onclick="googleSignIn(); closeLoginModalDirect();">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                        Continuer avec Google
                    </button>
                    <button type="button" class="button3" onclick="switchToForgot()">Forgot Password</button>
                </form>

                <!-- VUE SIGN UP -->
                <form class="form" id="formSignUp" style="display:none;" onsubmit="return false;">
                    <p id="headingSignup">Sign Up</p>
                    <div class="field">
                        <svg viewBox="0 0 16 16" fill="currentColor" height="16" width="16" class="input-icon"><path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/></svg>
                        <input type="text" class="input-field" id="signupUsername" placeholder="Username" autocomplete="off" />
                    </div>
                    <div class="field">
                        <svg viewBox="0 0 16 16" fill="currentColor" height="16" width="16" class="input-icon"><path d="M13.106 7.222c0-2.967-2.249-5.032-5.482-5.032-3.35 0-5.646 2.318-5.646 5.702 0 3.493 2.235 5.708 5.762 5.708.862 0 1.689-.123 2.304-.335v-.862c-.43.199-1.354.328-2.29.328-2.926 0-4.813-1.88-4.813-4.798 0-2.844 1.921-4.881 4.594-4.881 2.735 0 4.608 1.688 4.608 4.156 0 1.682-.554 2.769-1.416 2.769-.492 0-.772-.28-.772-.76V5.206H8.923v.834h-.11c-.266-.595-.881-.964-1.6-.964-1.4 0-2.378 1.162-2.378 2.823 0 1.737.957 2.906 2.379 2.906.8 0 1.415-.39 1.709-1.087h.11c.081.67.703 1.148 1.503 1.148 1.572 0 2.57-1.415 2.57-3.643zm-7.177.704c0-1.197.54-1.907 1.456-1.907.93 0 1.524.738 1.524 1.907S8.308 9.84 7.371 9.84c-.895 0-1.442-.725-1.442-1.914z"></path></svg>
                        <input type="email" class="input-field" id="signupEmail" placeholder="Email" autocomplete="off" />
                    </div>
                    <div class="field">
                        <svg viewBox="0 0 16 16" fill="currentColor" height="16" width="16" class="input-icon"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"></path></svg>
                        <input type="password" class="input-field" id="signupPassword" placeholder="Password" />
                    </div>
                    <div class="field">
                        <svg viewBox="0 0 16 16" fill="currentColor" height="16" width="16" class="input-icon"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"></path></svg>
                        <input type="password" class="input-field" id="signupConfirm" placeholder="Confirm Password" />
                    </div>
                    <div id="signupError" style="color:#ff4444;font-size:12px;text-align:center;min-height:16px;"></div>
                    <div class="btn">
                        <button class="button1" onclick="switchToLogin()">‚Üê Login</button>
                        <button class="button2" onclick="doEmailSignUp()">Create Account</button>
                    </div>
                    <button type="button" class="button3" onclick="closeLoginModalDirect()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"/><path d="M3 13C5 7 10 4 16 6a9 9 0 0 1 5 8"/></svg></button>
                </form>

                <!-- VUE FORGOT PASSWORD -->
                <form class="form" id="formForgot" style="display:none;" onsubmit="return false;">
                    <p id="headingReset">Reset Password</p>
                    <div style="color:#aaa;font-size:12px;text-align:center;margin-bottom:4px;">Entre ton email pour recevoir un lien de r√©initialisation</div>
                    <div class="field">
                        <svg viewBox="0 0 16 16" fill="currentColor" height="16" width="16" class="input-icon"><path d="M13.106 7.222c0-2.967-2.249-5.032-5.482-5.032-3.35 0-5.646 2.318-5.646 5.702 0 3.493 2.235 5.708 5.762 5.708.862 0 1.689-.123 2.304-.335v-.862c-.43.199-1.354.328-2.29.328-2.926 0-4.813-1.88-4.813-4.798 0-2.844 1.921-4.881 4.594-4.881 2.735 0 4.608 1.688 4.608 4.156 0 1.682-.554 2.769-1.416 2.769-.492 0-.772-.28-.772-.76V5.206H8.923v.834h-.11c-.266-.595-.881-.964-1.6-.964-1.4 0-2.378 1.162-2.378 2.823 0 1.737.957 2.906 2.379 2.906.8 0 1.415-.39 1.709-1.087h.11c.081.67.703 1.148 1.503 1.148 1.572 0 2.57-1.415 2.57-3.643zm-7.177.704c0-1.197.54-1.907 1.456-1.907.93 0 1.524.738 1.524 1.907S8.308 9.84 7.371 9.84c-.895 0-1.442-.725-1.442-1.914z"></path></svg>
                        <input type="email" class="input-field" id="forgotEmail" placeholder="Email" autocomplete="off" />
                    </div>
                    <div id="forgotMsg" style="font-size:12px;text-align:center;min-height:16px;"></div>
                    <div class="btn">
                        <button class="button1" onclick="switchToLogin()">‚Üê Retour</button>
                        <button class="button2" onclick="doForgotPassword()">Envoyer</button>
                    </div>
                    <button type="button" class="button3" onclick="closeLoginModalDirect()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"/><path d="M3 13C5 7 10 4 16 6a9 9 0 0 1 5 8"/></svg></button>
                </form>
            </div>
        </div>
    </div>

    <script>
        function openLoginModal() {
            switchToLogin();
            document.getElementById('loginModalOverlay').classList.add('active');
        }
        function closeLoginModalDirect() {
            document.getElementById('loginModalOverlay').classList.remove('active');
        }
        function closeLoginModal(e) {
            if (e.target === document.getElementById('loginModalOverlay')) {
                closeLoginModalDirect();
            }
        }

        function switchToLogin() {
            document.getElementById('formLogin').style.display = '';
            document.getElementById('formSignUp').style.display = 'none';
            document.getElementById('formForgot').style.display = 'none';
            document.getElementById('loginError').textContent = '';
        }
        function switchToSignUp() {
            document.getElementById('formLogin').style.display = 'none';
            document.getElementById('formSignUp').style.display = '';
            document.getElementById('formForgot').style.display = 'none';
            document.getElementById('signupError').textContent = '';
        }
        function switchToForgot() {
            document.getElementById('formLogin').style.display = 'none';
            document.getElementById('formSignUp').style.display = 'none';
            document.getElementById('formForgot').style.display = '';
            document.getElementById('forgotMsg').textContent = '';
        }

        async function doEmailLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errEl = document.getElementById('loginError');
            errEl.textContent = '';
            if (!email || !password) { errEl.textContent = 'Remplis tous les champs.'; return; }
            try {
                const { signInWithEmailAndPassword } = window._fbFns;
                await signInWithEmailAndPassword(window._fbAuth, email, password);
                closeLoginModalDirect();
            } catch(e) {
                const msgs = {
                    'auth/user-not-found': 'Aucun compte avec cet email.',
                    'auth/wrong-password': 'Mot de passe incorrect.',
                    'auth/invalid-email': 'Email invalide.',
                    'auth/too-many-requests': 'Trop de tentatives. R√©essaie plus tard.',
                    'auth/invalid-credential': 'Email ou mot de passe incorrect.'
                };
                errEl.textContent = msgs[e.code] || 'Erreur : ' + e.message;
            }
        }

        async function doEmailSignUp() {
            const username = document.getElementById('signupUsername').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirm = document.getElementById('signupConfirm').value;
            const errEl = document.getElementById('signupError');
            errEl.textContent = '';
            if (!username || !email || !password || !confirm) { errEl.textContent = 'Remplis tous les champs.'; return; }
            if (password !== confirm) { errEl.textContent = 'Les mots de passe ne correspondent pas.'; return; }
            if (password.length < 6) { errEl.textContent = 'Mot de passe trop court (min 6 caract√®res).'; return; }
            try {
                const { createUserWithEmailAndPassword, updateProfile } = window._fbFns;
                const cred = await createUserWithEmailAndPassword(window._fbAuth, email, password);
                await updateProfile(cred.user, { displayName: username });
                closeLoginModalDirect();
                showNotification('Compte cr√©√©. Bienvenue ' + username, 'success');
            } catch(e) {
                const msgs = {
                    'auth/email-already-in-use': 'Cet email est d√©j√† utilis√©.',
                    'auth/invalid-email': 'Email invalide.',
                    'auth/weak-password': 'Mot de passe trop faible.'
                };
                errEl.textContent = msgs[e.code] || 'Erreur : ' + e.message;
            }
        }

        // ===== THEME SWITCHER =====
        function applyTheme(themeName, silent = false) {
            const root = document.documentElement;

            // Retirer l'attribut existant
            root.removeAttribute('data-theme');

            // Appliquer le nouveau th√®me
            if (themeName !== 'dark') {
                root.setAttribute('data-theme', themeName);
            }

            // Sauvegarder dans localStorage
            localStorage.setItem('scrix-theme', themeName);

            // Mettre √† jour les boutons actifs
            document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.getElementById('theme-' + themeName);
            if (activeBtn) activeBtn.classList.add('active');

            // Adapter le th√®me CodeMirror si n√©cessaire
            if (window._editors) {
                const cmTheme = (themeName === 'light') ? 'default' : 'dracula';
                Object.values(window._editors).forEach(editor => {
                    if (editor && editor.setOption) editor.setOption('theme', cmTheme);
                });
            }
        }

        function getThemeLabel(t) {
            const labels = { dark: 'Dark', neo: 'N√©o', cyberpunk: 'Cyberpunk', terminal: 'Terminal', glace: 'Glace' };
            return labels[t] || t;
        }

        // Restaurer le th√®me au chargement
        (function initTheme() {
            const saved = localStorage.getItem('scrix-theme') || 'dark';
            // Attendre que le DOM soit pr√™t
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => applyTheme(saved));
            } else {
                applyTheme(saved);
            }
        })();

        async function doForgotPassword() {
            const email = document.getElementById('forgotEmail').value.trim();
            const msgEl = document.getElementById('forgotMsg');
            msgEl.style.color = '#ff4444';
            msgEl.textContent = '';
            if (!email) { msgEl.textContent = 'Entre ton email.'; return; }
            try {
                const { sendPasswordResetEmail } = window._fbFns;
                await sendPasswordResetEmail(window._fbAuth, email);
                msgEl.style.color = '#00ff75';
                msgEl.textContent = '‚úÖ Email envoy√© ! V√©rifie ta bo√Æte mail.';
            } catch(e) {
                const msgs = {
                    'auth/user-not-found': 'Aucun compte avec cet email.',
                    'auth/invalid-email': 'Email invalide.'
                };
                msgEl.textContent = msgs[e.code] || 'Erreur : ' + e.message;
            }
        }
    </script></body>
</html>
